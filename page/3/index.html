<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous" defer></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"kyosora.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.25.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":null},"fold":{"enable":true,"height":500},"language":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜尋...","empty":"我們無法找到任何有關 ${query} 的搜索結果","hits_time":"找到 ${hits} 個搜索結果（用時 ${time} 毫秒）","hits":"找到 ${hits} 個搜索結果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="個人技術筆記和學習心得分享">
<meta property="og:type" content="website">
<meta property="og:title" content="kyosora 虛空筆記">
<meta property="og:url" content="https://kyosora.github.io/page/3/">
<meta property="og:site_name" content="kyosora 虛空筆記">
<meta property="og:description" content="個人技術筆記和學習心得分享">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="kyosora">
<meta property="article:tag" content="網路安全, 系統管理, 程式設計, 技術筆記">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://kyosora.github.io/page/3/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-TW","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>kyosora 虛空筆記</title>
  





  <script class="next-config" data-name="matomo" type="application/json">{"enable":true,"server_url":null,"site_id":null}</script>
  <script src="/js/third-party/analytics/matomo.js" defer></script>

  <script async defer data-website-id="" src=""></script>

  <script defer data-domain="" src=""></script>

  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/comments.js" defer></script><script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="/js/bookmark.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/algoliasearch/5.36.0/lite/builds/browser.umd.js" integrity="sha256-o49zoHLDPBm9WLg6AiliAVi3axCRTqe3ltTxLvhzAVg=" crossorigin="anonymous" defer></script><script src="/js/third-party/search/algolia-search.js" defer></script>
<script class="next-config" data-name="chatra" type="application/json">{"enable":true,"async":true,"id":null}</script>
<script src="/js/third-party/chat/chatra.js" defer></script>
<script async src="https://call.chatra.io/chatra.js"></script>

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.3.1/pdfobject.min.js","integrity":"sha256-jI72I8ZLVflVOisZIOaLvRew3tyvzeu6aZXFm7P7dEo="},"url":"/lib/pdf/web/viewer"}</script>
  <script src="/js/third-party/tags/pdf.js" defer></script>

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.10.1/mermaid.min.js","integrity":"sha256-BmQmdWDS8X2OTbrwELWK366LV6escyWhHHe0XCTU/Hk="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>

  <script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/wavedrom.min.js","integrity":"sha256-INLAoJc6quTNfiMWkGZniYO2cxE8mHpddnLow1m6RFs="}}</script>
  <script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script>
  <script src="/js/third-party/tags/wavedrom.js" defer></script>


  <script src="/js/third-party/pace.js" defer></script>

  <script src="/js/third-party/addtoany.js" defer></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/12.2.1/firebase-app-compat.js" integrity="sha256-d21UgtIcA6c6qwr8nWk6lxs/KrpbWhknQN7qBjWA2Kk=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/12.2.1/firebase-firestore-compat.js" integrity="sha256-leHatffkFuVGIg7ABaA5BDsqsEUtktL4tftb3OdQfg0=" crossorigin="anonymous" defer></script>
  <script class="next-config" data-name="firestore" type="application/json">{"enable":true,"collection":"articles","apiKey":null,"projectId":null}</script>
  <script src="/js/third-party/statistics/firestore.js" defer></script>



  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js" defer></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/3.0.1/quicklink.umd.js" integrity="sha256-44BednzIpUeQJcY8qtLyarFu0UCCTbgmWOvaoehiFQQ=" crossorigin="anonymous" defer></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":false,"home":false,"archive":false,"delay":true,"timeout":3000,"priority":true,"url":"https://kyosora.github.io/page/3/"}</script>
  <script src="/js/third-party/quicklink.js" defer></script>

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">kyosora 虛空筆記</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">技術探索與學習分享</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜尋" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜尋..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fab fa-algolia fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">kyosora</p>
  <div class="site-description" itemprop="description">個人技術筆記和學習心得分享</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">110</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">分類</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">155</span>
        <span class="site-state-item-name">標籤</span>
      </div>
  </nav>
</div>
  <div class="sidebar-button animated">
    <button><i class="fa fa-comment"></i>
      聊天
    </button>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">SQL Server資料庫加密實戰:透明資料加密(TDE)完整實作指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2024-12-20 18:43:00" itemprop="dateCreated datePublished" datetime="2024-12-20T18:43:00+08:00">2024-12-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2025-01-02 13:55:44" itemprop="dateModified" datetime="2025-01-02T13:55:44+08:00">2025-01-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%B3%87%E6%96%99%E5%BA%AB/" itemprop="url" rel="index"><span itemprop="name">資料庫</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%B3%87%E6%96%99%E5%BA%AB/%E8%B3%87%E8%A8%8A%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">資訊安全</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>1.8k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>2 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>隨著資安事件頻傳,如何保護資料庫中的敏感資料成為當前的重要課題。Microsoft SQL Server提供的透明資料加密(Transparent Data Encryption, TDE)是一個強大的解決方案,它能夠在資料寫入磁碟時自動加密,讀取時自動解密,對應用程式完全透明。本文將帶您一步步實作TDE,並深入探討其運作原理。</p>
<h1 id="TDE運作原理"><a href="#TDE運作原理" class="headerlink" title="TDE運作原理"></a>TDE運作原理</h1><p>TDE的主要目的是保護資料庫檔案(.mdf、.ldf)中的靜態資料。當資料要寫入磁碟時,TDE會自動進行加密;當需要讀取資料時,則會自動解密。整個過程對應用程式來說是完全透明的,不需要修改任何程式碼。</p>
<p>以下是TDE的運作流程:</p>
<svg viewBox="0 0 800 400" xmlns="http://www.w3.org/2000/svg">
    <!-- 背景 -->
    <rect width="800" height="400" fill="#f8f9fa"/>
    <!-- 資料庫檔案 -->
    <rect x="50" y="50" width="160" height="80" rx="10" fill="#fff" stroke="#333" stroke-width="2"/>
    <text x="130" y="95" text-anchor="middle" font-family="Arial" font-size="14">資料庫檔案</text>
    <!-- 資料庫引擎 -->
    <rect x="320" y="50" width="160" height="80" rx="10" fill="#fff" stroke="#333" stroke-width="2"/>
    <text x="400" y="95" text-anchor="middle" font-family="Arial" font-size="14">資料庫引擎</text>
    <!-- 記憶體 -->
    <rect x="590" y="50" width="160" height="80" rx="10" fill="#fff" stroke="#333" stroke-width="2"/>
    <text x="670" y="95" text-anchor="middle" font-family="Arial" font-size="14">記憶體</text>
    <!-- Database Encryption Key -->
    <rect x="320" y="200" width="160" height="80" rx="10" fill="#fff" stroke="#333" stroke-width="2"/>
    <text x="400" y="245" text-anchor="middle" font-family="Arial" font-size="14">資料庫加密金鑰</text>
    <!-- Certificate -->
    <rect x="320" y="300" width="160" height="80" rx="10" fill="#fff" stroke="#333" stroke-width="2"/>
    <text x="400" y="345" text-anchor="middle" font-family="Arial" font-size="14">憑證</text>
    <!-- 箭頭 -->
    <defs>
        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
        </marker>
    </defs>
    <!-- 資料流向箭頭 -->
    <line x1="210" y1="90" x2="320" y2="90" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
    <line x1="480" y1="90" x2="590" y2="90" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
    <!-- 加密金鑰關係箭頭 -->
    <line x1="400" y1="130" x2="400" y2="200" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
    <line x1="400" y1="280" x2="400" y2="300" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
    <!-- 說明文字 -->
    <text x="265" y="80" font-family="Arial" font-size="12">加密</text>
    <text x="535" y="80" font-family="Arial" font-size="12">解密</text>
</svg>

<h1 id="TDE優缺點分析"><a href="#TDE優缺點分析" class="headerlink" title="TDE優缺點分析"></a>TDE優缺點分析</h1><h2 id="優點"><a href="#優點" class="headerlink" title="優點"></a>優點</h2><ol>
<li>對應用程式透明,不需修改程式碼</li>
<li>保護整個資料庫檔案,包含日誌檔</li>
<li>自動處理加解密,管理便利</li>
<li>支援資料庫的備份加密</li>
</ol>
<h2 id="缺點"><a href="#缺點" class="headerlink" title="缺點"></a>缺點</h2><ol>
<li>會有些許效能影響(通常在5%以內)</li>
<li>只保護靜態資料,資料在記憶體中仍是明文</li>
<li>需要額外管理加密金鑰</li>
</ol>
<h1 id="實作步驟"><a href="#實作步驟" class="headerlink" title="實作步驟"></a>實作步驟</h1><h2 id="1-建立主金鑰-Master-Key"><a href="#1-建立主金鑰-Master-Key" class="headerlink" title="1. 建立主金鑰(Master Key)"></a>1. 建立主金鑰(Master Key)</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 在master資料庫建立主金鑰</span></span><br><span class="line"><span class="comment">-- 請修改自己的密碼</span></span><br><span class="line">USE master;</span><br><span class="line">GO</span><br><span class="line"><span class="keyword">CREATE</span> MASTER KEY ENCRYPTION <span class="keyword">BY</span> PASSWORD <span class="operator">=</span> <span class="string">&#x27;YourStrongPassword123!&#x27;</span>;</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>

<h2 id="2-建立憑證"><a href="#2-建立憑證" class="headerlink" title="2. 建立憑證"></a>2. 建立憑證</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 建立用於TDE的憑證</span></span><br><span class="line"><span class="comment">-- 請記得定期備份憑證</span></span><br><span class="line"><span class="keyword">CREATE</span> CERTIFICATE TDECert</span><br><span class="line"><span class="keyword">WITH</span> SUBJECT <span class="operator">=</span> <span class="string">&#x27;TDE Certificate&#x27;</span>;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 備份憑證和私鑰</span></span><br><span class="line">BACKUP CERTIFICATE TDECert</span><br><span class="line"><span class="keyword">TO</span> FILE <span class="operator">=</span> <span class="string">&#x27;C:\TDECert.cer&#x27;</span></span><br><span class="line"><span class="keyword">WITH</span> PRIVATE KEY</span><br><span class="line">(</span><br><span class="line">    FILE <span class="operator">=</span> <span class="string">&#x27;C:\TDECert_PrivateKey.pvk&#x27;</span>,</span><br><span class="line">    ENCRYPTION <span class="keyword">BY</span> PASSWORD <span class="operator">=</span> <span class="string">&#x27;YourStrongPassword123!&#x27;</span></span><br><span class="line">);</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>

<h2 id="3-建立資料庫加密金鑰"><a href="#3-建立資料庫加密金鑰" class="headerlink" title="3. 建立資料庫加密金鑰"></a>3. 建立資料庫加密金鑰</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 切換到要加密的資料庫</span></span><br><span class="line">USE YourDatabase;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 建立資料庫加密金鑰</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE ENCRYPTION KEY</span><br><span class="line"><span class="keyword">WITH</span> ALGORITHM <span class="operator">=</span> AES_256</span><br><span class="line">ENCRYPTION <span class="keyword">BY</span> SERVER CERTIFICATE TDECert;</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>

<h2 id="4-啟用資料庫加密"><a href="#4-啟用資料庫加密" class="headerlink" title="4. 啟用資料庫加密"></a>4. 啟用資料庫加密</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 啟用資料庫加密</span></span><br><span class="line"><span class="keyword">ALTER</span> DATABASE YourDatabase</span><br><span class="line"><span class="keyword">SET</span> ENCRYPTION <span class="keyword">ON</span>;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 檢查加密狀態</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    db.name,</span><br><span class="line">    db.is_encrypted,</span><br><span class="line">    dm.encryption_state,</span><br><span class="line">    dm.percent_complete,</span><br><span class="line">    dm.key_algorithm,</span><br><span class="line">    dm.key_length</span><br><span class="line"><span class="keyword">FROM</span> sys.databases db</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> sys.dm_database_encryption_keys dm</span><br><span class="line"><span class="keyword">ON</span> db.database_id <span class="operator">=</span> dm.database_id</span><br><span class="line"><span class="keyword">WHERE</span> db.name <span class="operator">=</span> <span class="string">&#x27;YourDatabase&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h1 id="效能考量"><a href="#效能考量" class="headerlink" title="效能考量"></a>效能考量</h1><p>根據Microsoft的測試,TDE的效能影響通常在5%以內。不過,實際的效能影響會依據以下因素而異:</p>
<ol>
<li>硬體規格(尤其是CPU)</li>
<li>資料庫大小</li>
<li>工作負載類型</li>
<li>使用的加密演算法</li>
</ol>
<h1 id="最佳實務建議"><a href="#最佳實務建議" class="headerlink" title="最佳實務建議"></a>最佳實務建議</h1><ol>
<li><p><strong>金鑰管理</strong></p>
<ul>
<li>定期備份主金鑰和憑證</li>
<li>將備份存放在安全的位置</li>
<li>建立金鑰輪換計畫</li>
</ul>
</li>
<li><p><strong>備份策略</strong></p>
<ul>
<li>確保備份包含TDE憑證</li>
<li>定期測試還原流程</li>
<li>記錄並保存所有金鑰資訊</li>
</ul>
</li>
<li><p><strong>監控</strong></p>
<ul>
<li>定期檢查加密狀態</li>
<li>監控效能指標</li>
<li>設定警示機制</li>
</ul>
</li>
<li><p><strong>災難復原</strong></p>
<ul>
<li>準備完整的復原計畫</li>
<li>定期演練復原程序</li>
<li>確保所有必要的金鑰和憑證可用</li>
</ul>
</li>
</ol>
<h1 id="故障排除"><a href="#故障排除" class="headerlink" title="故障排除"></a>故障排除</h1><p>如果遇到以下常見問題,可以參考對應的解決方案:</p>
<ol>
<li><p><strong>無法啟用TDE</strong></p>
<ul>
<li>檢查是否有足夠權限</li>
<li>確認主金鑰和憑證是否正確建立</li>
<li>檢查錯誤日誌</li>
</ul>
</li>
<li><p><strong>效能問題</strong></p>
<ul>
<li>檢查硬體資源使用情況</li>
<li>考慮調整加密演算法</li>
<li>優化查詢和索引</li>
</ul>
</li>
</ol>
<h1 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h1><p>透明資料加密是保護SQL Server資料庫的重要機制,透過本文的說明和實作步驟,您應該能夠成功實施TDE。記得要特別注意金鑰管理和備份策略,這對於確保資料安全和可用性至關重要。</p>
<h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><ol>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/sql/relational-databases/security/encryption/transparent-data-encryption">Microsoft官方文件: Transparent Data Encryption (TDE)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.mssqltips.com/sqlservertip/3253/sql-server-transparent-data-encryption-tde-best-practices/">SQL Server TDE Best Practices</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">圖解 C# yield - 5分鐘讓你輕鬆掌握迭代器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>
      

      <time title="創建時間：2024-12-19 10:00:00 / 修改時間：11:52:18" itemprop="dateCreated datePublished" datetime="2024-12-19T10:00:00+08:00">2024-12-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A8%8B%E5%BC%8F%E9%96%8B%E7%99%BC/" itemprop="url" rel="index"><span itemprop="name">程式開發</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>1.6k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>1 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <svg viewBox="0 0 500 400" xmlns="http://www.w3.org/2000/svg">
    <!-- 背景 -->
    <rect width="500" height="400" fill="#f5f5f5"/>
    <!-- 標題 -->
    <text x="250" y="50" text-anchor="middle" font-size="24" font-weight="bold" fill="#333">C# yield 執行流程</text>
    <!-- 開始節點 -->
    <circle cx="250" cy="100" r="25" fill="#4CAF50"/>
    <text x="250" y="105" text-anchor="middle" font-size="14" fill="white">開始</text>
    <!-- 框線 -->
    <rect x="100" y="150" width="300" height="240" rx="10" fill="none" stroke="#2196F3" stroke-width="2" stroke-dasharray="5,5"/>
    <text x="250" y="180" text-anchor="middle" font-size="16" fill="#2196F3">迭代器狀態機</text>
    <!-- MoveNext -->
    <rect x="150" y="200" width="200" height="40" rx="5" fill="#90CAF9"/>
    <text x="250" y="225" text-anchor="middle">呼叫 MoveNext()</text>
    <!-- yield return -->
    <rect x="150" y="260" width="200" height="40" rx="5" fill="#81C784"/>
    <text x="250" y="285" text-anchor="middle">yield return 值</text>
    <!-- 保存狀態 -->
    <rect x="150" y="320" width="200" height="40" rx="5" fill="#FFB74D"/>
    <text x="250" y="345" text-anchor="middle">保存目前狀態</text>
    <!-- 連接線 -->
    <path d="M250 125 L250 200 M250 240 L250 260 M250 300 L250 320" 
          stroke="#666" stroke-width="2" stroke-linecap="round"/>
    <!-- 返回箭頭 -->
    <path d="M350 340 C400 340 400 220 350 220" 
          stroke="#666" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
    <!-- 箭頭定義 -->
    <defs>
        <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
            <path d="M0,0 L10,5 L0,10" fill="none" stroke="#666"/>
        </marker>
    </defs>
</svg>
# 為什麼需要 yield?

<p>在C#開發中,我們經常需要處理大量數據的集合。傳統的做法是先將所有數據載入到記憶體中,再進行處理。但這種方式在處理大量數據時會佔用大量記憶體,影響程式效能。</p>
<p>這時候就需要用到 yield 關鍵字。yield 可以讓我們實現延遲執行(Lazy Evaluation),也就是說,只有在真正需要數據時才進行處理,大大節省記憶體使用。</p>
<h1 id="yield-基本用法"><a href="#yield-基本用法" class="headerlink" title="yield 基本用法"></a>yield 基本用法</h1><p>讓我們從一個簡單的例子開始:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 yield return 產生費波那契數列</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IEnumerable&lt;<span class="built_in">int</span>&gt; <span class="title">Fibonacci</span>(<span class="params"><span class="built_in">int</span> count</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> current = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">int</span> next = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 產生指定數量的費波那契數</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">return</span> current;  <span class="comment">// 返回當前數字</span></span><br><span class="line">        <span class="built_in">int</span> temp = next;</span><br><span class="line">        next = current + next;</span><br><span class="line">        current = temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用方式</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="function"><span class="built_in">int</span> number <span class="keyword">in</span> <span class="title">Fibonacci</span>(<span class="params"><span class="number">10</span></span>))</span></span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(number);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在這個例子中,yield return 會在每次迭代時返回一個數字,而不是一次性計算出所有數字。這意味著即使我們要產生一百萬個費波那契數,程式也不會一次佔用大量記憶體。</p>
<h1 id="yield-break-的使用"><a href="#yield-break-的使用" class="headerlink" title="yield break 的使用"></a>yield break 的使用</h1><p>有時候我們需要在某個條件下提前結束迭代,這時可以使用 yield break:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 讀取文件直到遇到空行</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IEnumerable&lt;<span class="built_in">string</span>&gt; <span class="title">ReadUntilEmptyLine</span>(<span class="params"><span class="built_in">string</span> filePath</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> (StreamReader reader = <span class="keyword">new</span> StreamReader(filePath))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> line;</span><br><span class="line">        <span class="keyword">while</span> ((line = reader.ReadLine()) != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(line))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">yield</span> <span class="keyword">break</span>;  <span class="comment">// 遇到空行就結束迭代</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> line;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="yield-的應用場景"><a href="#yield-的應用場景" class="headerlink" title="yield 的應用場景"></a>yield 的應用場景</h1><ol>
<li>大文件處理</li>
<li>數據庫分頁查詢</li>
<li>自定義集合類別</li>
<li>無限序列生成</li>
</ol>
<p>以數據庫分頁查詢為例:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IEnumerable&lt;User&gt; <span class="title">GetUsersByPage</span>(<span class="params"><span class="built_in">int</span> pageSize</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 每次只查詢一頁的數據</span></span><br><span class="line">        <span class="keyword">var</span> users = dbContext.Users</span><br><span class="line">            .Skip(offset)</span><br><span class="line">            .Take(pageSize)</span><br><span class="line">            .ToList();</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (!users.Any())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> user <span class="keyword">in</span> users)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> user;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        offset += pageSize;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="最佳實踐與注意事項"><a href="#最佳實踐與注意事項" class="headerlink" title="最佳實踐與注意事項"></a>最佳實踐與注意事項</h1><ol>
<li>yield 方法內不能使用 try-catch-finally</li>
<li>yield return 只能在方法內直接使用</li>
<li>yield 方法的返回類型必須是 IEnumerable 或相關介面</li>
<li>避免在 yield return 中執行耗時操作</li>
</ol>
<h1 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h1><p>yield 是C#中非常強大的功能,能夠幫助我們編寫更高效的程式碼。通過延遲執行的特性,我們可以更好地控制記憶體使用,提升程式效能。</p>
<p>要進一步了解 yield 的使用,可以參考:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-tw/dotnet/csharp/language-reference/keywords/yield">Microsoft C# 文檔</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">SQL Server CSV匯出終極攻略：3種工具效能實測，速度最高提升300%！</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2024-12-17 18:10:09" itemprop="dateCreated datePublished" datetime="2024-12-17T18:10:09+08:00">2024-12-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-12-19 11:45:36" itemprop="dateModified" datetime="2024-12-19T11:45:36+08:00">2024-12-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%B3%87%E6%96%99%E5%BA%AB%E7%AE%A1%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">資料庫管理</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>8.4k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>8 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>每個資料庫管理員都曾遇過這種情況：老闆說「我要這個報表，越快越好」，結果你發現要匯出的資料有好幾億筆...</p>
<p>別擔心！本篇文章將完整介紹SQL Server三大CSV匯出工具：SQLCMD、BCP和SSIS的實戰技巧。透過實際案例分析和效能測試，教你如何選擇最適合的工具，並運用最佳化技巧大幅提升匯出效能！</p>
<h2 id="三大工具特色比較"><a href="#三大工具特色比較" class="headerlink" title="三大工具特色比較"></a>三大工具特色比較</h2><ol>
<li>SQLCMD<ul>
<li>優點：彈性高、容易整合自動化流程、指令碼管理方便</li>
<li>缺點：需要撰寫較多程式碼</li>
<li>適用場景：自動化排程作業、需要客製化處理的匯出工作</li>
</ul>
</li>
<li>BCP (Bulk Copy Program)<ul>
<li>優點：效能最佳、記憶體使用率低、適合大量資料處理</li>
<li>缺點：彈性較低、特殊資料處理較複雜</li>
<li>適用場景：大量資料快速匯出、簡單資料結構</li>
</ul>
</li>
<li>SSIS (SQL Server Integration Services)<ul>
<li>優點：視覺化設計、功能完整、整合性高</li>
<li>缺點：設定複雜、維護成本較高</li>
<li>適用場景：複雜ETL流程、需要資料轉換處理</li>
</ul>
</li>
</ol>
<svg viewBox="0 0 800 800" xmlns="http://www.w3.org/2000/svg">
  <text x="400" y="40" text-anchor="middle" font-size="24" fill="#333">SQL Server CSV匯出工具完整比較</text>
  <g transform="translate(0,80)">
    <rect x="50" y="20" width="200" height="120" rx="10" fill="#4A90E2"/>
    <text x="150" y="45" text-anchor="middle" font-size="16" fill="white">SQLCMD</text>
    <text x="150" y="70" text-anchor="middle" font-size="12" fill="white">優點:</text>
    <text x="150" y="90" text-anchor="middle" font-size="12" fill="white">- 彈性高</text>
    <text x="150" y="110" text-anchor="middle" font-size="12" fill="white">- 易於自動化</text>
    <text x="150" y="130" text-anchor="middle" font-size="12" fill="white">- 指令碼管理方便</text>
    <rect x="300" y="20" width="200" height="120" rx="10" fill="#81C784"/>
    <text x="400" y="45" text-anchor="middle" font-size="16" fill="white">BCP</text>
    <text x="400" y="70" text-anchor="middle" font-size="12" fill="white">優點:</text>
    <text x="400" y="90" text-anchor="middle" font-size="12" fill="white">- 效能最佳</text>
    <text x="400" y="110" text-anchor="middle" font-size="12" fill="white">- 資源使用率低</text>
    <text x="400" y="130" text-anchor="middle" font-size="12" fill="white">- 適合大量資料</text>
    <rect x="550" y="20" width="200" height="120" rx="10" fill="#7986CB"/>
    <text x="650" y="45" text-anchor="middle" font-size="16" fill="white">SSIS</text>
    <text x="650" y="70" text-anchor="middle" font-size="12" fill="white">優點:</text>
    <text x="650" y="90" text-anchor="middle" font-size="12" fill="white">- 視覺化設計</text>
    <text x="650" y="110" text-anchor="middle" font-size="12" fill="white">- 功能最完整</text>
    <text x="650" y="130" text-anchor="middle" font-size="12" fill="white">- 整合性高</text>
  </g>
  <g transform="translate(50,250)">
    <text x="350" y="20" text-anchor="middle" font-size="18" fill="#333">效能比較 (100GB資料匯出時間)</text>
    <line x1="100" y1="200" x2="700" y2="200" stroke="#666" stroke-width="2"/>
    <line x1="100" y1="50" x2="100" y2="200" stroke="#666" stroke-width="2"/>
    <rect x="200" y="100" width="60" height="100" fill="#4A90E2" opacity="0.8"/>
    <text x="230" y="220" text-anchor="middle" font-size="12">SQLCMD</text>
    <text x="230" y="90" text-anchor="middle" font-size="12">120分鐘</text>
    <rect x="400" y="70" width="60" height="130" fill="#81C784" opacity="0.8"/>
    <text x="430" y="220" text-anchor="middle" font-size="12">BCP</text>
    <text x="430" y="60" text-anchor="middle" font-size="12">90分鐘</text>
    <rect x="600" y="130" width="60" height="70" fill="#7986CB" opacity="0.8"/>
    <text x="630" y="220" text-anchor="middle" font-size="12">SSIS</text>
    <text x="630" y="120" text-anchor="middle" font-size="12">150分鐘</text>
  </g>
  <g transform="translate(50,500)">
    <text x="350" y="20" text-anchor="middle" font-size="18" fill="#333">適用場景比較</text>
    <rect x="50" y="40" width="200" height="80" rx="5" fill="#4A90E2" opacity="0.8"/>
    <text x="150" y="70" text-anchor="middle" font-size="14" fill="white">SQLCMD</text>
    <text x="150" y="90" text-anchor="middle" font-size="12" fill="white">自動化排程作業</text>
    <text x="150" y="110" text-anchor="middle" font-size="12" fill="white">需要客製化處理</text>
    <rect x="300" y="40" width="200" height="80" rx="5" fill="#81C784" opacity="0.8"/>
    <text x="400" y="70" text-anchor="middle" font-size="14" fill="white">BCP</text>
    <text x="400" y="90" text-anchor="middle" font-size="12" fill="white">大量資料快速匯出</text>
    <text x="400" y="110" text-anchor="middle" font-size="12" fill="white">簡單資料結構</text>
    <rect x="550" y="40" width="200" height="80" rx="5" fill="#7986CB" opacity="0.8"/>
    <text x="650" y="70" text-anchor="middle" font-size="14" fill="white">SSIS</text>
    <text x="650" y="90" text-anchor="middle" font-size="12" fill="white">複雜ETL流程</text>
    <text x="650" y="110" text-anchor="middle" font-size="12" fill="white">需要資料轉換</text>
  </g>
</svg>

<h2 id="SQLCMD-實戰技巧"><a href="#SQLCMD-實戰技巧" class="headerlink" title="SQLCMD 實戰技巧"></a>SQLCMD 實戰技巧</h2><h3 id="1-基本匯出腳本"><a href="#1-基本匯出腳本" class="headerlink" title="1. 基本匯出腳本"></a>1. 基本匯出腳本</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 設定CSV匯出參數</span></span><br><span class="line">:setvar OutputPath &quot;D:\Exports&quot;</span><br><span class="line">:setvar FileName &quot;ExportData.csv&quot;</span><br><span class="line">:setvar Delimiter &quot;,&quot;</span><br><span class="line">:setvar BatchSize <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 設定查詢結果格式</span></span><br><span class="line">:<span class="keyword">on</span> error exit</span><br><span class="line"><span class="keyword">SET</span> NOCOUNT <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">SET</span> QUOTED_IDENTIFIER <span class="keyword">ON</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 建立匯出查詢</span></span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@sql</span> nvarchar(max)</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@sql</span> <span class="operator">=</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">bcp &quot;</span></span><br><span class="line"><span class="string">SELECT Column1, Column2, Column3</span></span><br><span class="line"><span class="string">FROM YourTable</span></span><br><span class="line"><span class="string">&quot; queryout &quot;$(OutputPath)\$(FileName)&quot; -c -t&quot;$(Delimiter)&quot; -T -S $(ServerName)</span></span><br><span class="line"><span class="string">&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 執行匯出</span></span><br><span class="line"><span class="keyword">EXEC</span> sp_executesql <span class="variable">@sql</span></span><br></pre></td></tr></table></figure>

<h3 id="2-大型資料處理優化"><a href="#2-大型資料處理優化" class="headerlink" title="2. 大型資料處理優化"></a>2. 大型資料處理優化</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 優化大型資料匯出效能</span></span><br><span class="line">:setvar ChunkSize <span class="number">1000000</span>  <span class="comment">-- 設定每個分割檔案的資料量</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 建立暫存資料表存放分割資訊</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> #ExportChunks (</span><br><span class="line">    ChunkID <span class="type">int</span> <span class="keyword">IDENTITY</span>(<span class="number">1</span>,<span class="number">1</span>),</span><br><span class="line">    StartID <span class="type">bigint</span>,</span><br><span class="line">    EndID <span class="type">bigint</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 計算分割區間</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> #ExportChunks (StartID, EndID)</span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> ID) <span class="keyword">AS</span> StartID,</span><br><span class="line">    <span class="built_in">LEAD</span>(<span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> ID)) <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> ID) <span class="keyword">AS</span> EndID</span><br><span class="line"><span class="keyword">FROM</span> YourTable</span><br><span class="line"><span class="keyword">WHERE</span> ID <span class="operator">%</span> $(ChunkSize) <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用迴圈處理每個分割檔案</span></span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@ChunkID</span> <span class="type">int</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@MaxChunks</span> <span class="type">int</span> <span class="operator">=</span> (<span class="keyword">SELECT</span> <span class="built_in">MAX</span>(ChunkID) <span class="keyword">FROM</span> #ExportChunks)</span><br><span class="line"></span><br><span class="line">WHILE <span class="variable">@ChunkID</span> <span class="operator">&lt;=</span> <span class="variable">@MaxChunks</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 匯出分割檔案</span></span><br><span class="line">    <span class="keyword">DECLARE</span> <span class="variable">@ChunkFileName</span> nvarchar(<span class="number">500</span>) <span class="operator">=</span> <span class="string">&#x27;$(OutputPath)\Chunk_&#x27;</span> <span class="operator">+</span> </span><br><span class="line">           <span class="built_in">CAST</span>(<span class="variable">@ChunkID</span> <span class="keyword">as</span> nvarchar) <span class="operator">+</span> <span class="string">&#x27;.csv&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 這裡加入您的匯出指令</span></span><br><span class="line">    <span class="comment">-- ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@ChunkID</span> <span class="operator">=</span> <span class="variable">@ChunkID</span> <span class="operator">+</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<h3 id="3-特殊字元處理"><a href="#3-特殊字元處理" class="headerlink" title="3. 特殊字元處理"></a>3. 特殊字元處理</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 處理CSV特殊字元</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> dbo.EscapeCSV</span><br><span class="line">(</span><br><span class="line">    <span class="variable">@text</span> nvarchar(max)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">RETURNS</span> nvarchar(max)</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 處理雙引號</span></span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@text</span> <span class="operator">=</span> REPLACE(<span class="variable">@text</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;&quot;&quot;&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 處理逗號和換行符</span></span><br><span class="line">    IF <span class="variable">@text</span> <span class="keyword">LIKE</span> <span class="string">&#x27;%[,\r\n]%&#x27;</span></span><br><span class="line">        <span class="keyword">SET</span> <span class="variable">@text</span> <span class="operator">=</span> <span class="string">&#x27;&quot;&#x27;</span> <span class="operator">+</span> <span class="variable">@text</span> <span class="operator">+</span> <span class="string">&#x27;&quot;&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">RETURN</span> <span class="variable">@text</span></span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在匯出時使用</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    dbo.EscapeCSV(Column1) <span class="keyword">as</span> Column1,</span><br><span class="line">    dbo.EscapeCSV(Column2) <span class="keyword">as</span> Column2</span><br><span class="line"><span class="keyword">FROM</span> YourTable</span><br></pre></td></tr></table></figure>

<h2 id="效能優化技巧"><a href="#效能優化技巧" class="headerlink" title="效能優化技巧"></a>效能優化技巧</h2><ol>
<li><p>記憶體最佳化</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 設定最佳記憶體使用量</span></span><br><span class="line">sqlcmd <span class="operator">-</span>S ServerName <span class="operator">-</span>b <span class="operator">-</span>m <span class="number">65535</span> <span class="operator">-</span>U DBAdmin <span class="operator">-</span>P Password </span><br></pre></td></tr></table></figure></li>
<li><p>平行處理</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 啟用平行處理</span></span><br><span class="line">:setvar MAXDOP <span class="number">4</span></span><br><span class="line">GO</span><br><span class="line">sp_configure <span class="string">&#x27;max degree of parallelism&#x27;</span>, $(MAXDOP)</span><br><span class="line">GO</span><br><span class="line">RECONFIGURE <span class="keyword">WITH</span> OVERRIDE</span><br><span class="line">GO</span><br></pre></td></tr></table></figure></li>
<li><p>批次處理優化</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 設定最佳批次大小</span></span><br><span class="line">:setvar BATCHSIZE <span class="number">10000</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="實戰案例分享"><a href="#實戰案例分享" class="headerlink" title="實戰案例分享"></a>實戰案例分享</h2><h3 id="案例一：千萬筆交易資料匯出"><a href="#案例一：千萬筆交易資料匯出" class="headerlink" title="案例一：千萬筆交易資料匯出"></a>案例一：千萬筆交易資料匯出</h3><p>在某專案中，需要匯出千萬筆紀錄進行分析。使用傳統方式可能需要24小時以上，但透過以下最佳化設定，我們將時間縮短到2小時：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 優化設定</span></span><br><span class="line">:setvar MAXDOP <span class="number">8</span>          <span class="comment">-- 設定平行處理數</span></span><br><span class="line">:setvar BATCHSIZE <span class="number">50000</span>   <span class="comment">-- 設定批次大小</span></span><br><span class="line">:setvar BufferSize <span class="number">4096</span>   <span class="comment">-- 設定緩衝區大小</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 匯出腳本</span></span><br><span class="line">:<span class="keyword">on</span> error exit</span><br><span class="line"><span class="keyword">SET</span> NOCOUNT <span class="keyword">ON</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 分割處理</span></span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@StartID</span> <span class="type">bigint</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@EndID</span> <span class="type">bigint</span></span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@ChunkSize</span> <span class="type">bigint</span> <span class="operator">=</span> <span class="number">1000000</span></span><br><span class="line"></span><br><span class="line">WHILE <span class="keyword">EXISTS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="number">1</span> </span><br><span class="line">    <span class="keyword">FROM</span> Transactions </span><br><span class="line">    <span class="keyword">WHERE</span> ID <span class="operator">&gt;=</span> <span class="variable">@StartID</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@EndID</span> <span class="operator">=</span> <span class="variable">@StartID</span> <span class="operator">+</span> <span class="variable">@ChunkSize</span> <span class="operator">-</span> <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 匯出當前區間資料</span></span><br><span class="line">    <span class="keyword">EXEC</span> sp_executesql N<span class="string">&#x27;</span></span><br><span class="line"><span class="string">    bcp &quot;</span></span><br><span class="line"><span class="string">    SELECT *</span></span><br><span class="line"><span class="string">    FROM Transactions</span></span><br><span class="line"><span class="string">    WHERE ID BETWEEN @StartID AND @EndID</span></span><br><span class="line"><span class="string">    ORDER BY ID</span></span><br><span class="line"><span class="string">    &quot; queryout &quot;D:\Export\Chunk_$(StartID).csv&quot; -c -t&quot;,&quot; -T</span></span><br><span class="line"><span class="string">    &#x27;</span>, N<span class="string">&#x27;@StartID bigint, @EndID bigint&#x27;</span>,</span><br><span class="line">    <span class="variable">@StartID</span>, <span class="variable">@EndID</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@StartID</span> <span class="operator">=</span> <span class="variable">@EndID</span> <span class="operator">+</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<h2 id="BCP-實戰技巧"><a href="#BCP-實戰技巧" class="headerlink" title="BCP 實戰技巧"></a>BCP 實戰技巧</h2><h3 id="1-基本語法"><a href="#1-基本語法" class="headerlink" title="1. 基本語法"></a>1. 基本語法</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- BCP基本匯出語法</span></span><br><span class="line">bcp &quot;SELECT * FROM DatabaseName.dbo.TableName&quot; </span><br><span class="line">queryout &quot;D:\Export\output.csv&quot; </span><br><span class="line"><span class="operator">-</span>c                              <span class="comment">-- 字元格式</span></span><br><span class="line"><span class="operator">-</span>t&quot;,&quot;                           <span class="comment">-- 分隔符號</span></span><br><span class="line"><span class="operator">-</span>S ServerName                   <span class="comment">-- 伺服器名稱</span></span><br><span class="line"><span class="operator">-</span>T                             <span class="comment">-- Windows驗證</span></span><br><span class="line"><span class="operator">-</span>U Username                     <span class="comment">-- SQL驗證使用者名稱</span></span><br><span class="line"><span class="operator">-</span>P Password                     <span class="comment">-- SQL驗證密碼</span></span><br></pre></td></tr></table></figure>

<h3 id="2-效能優化設定"><a href="#2-效能優化設定" class="headerlink" title="2. 效能優化設定"></a>2. 效能優化設定</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 最佳化參數設定</span></span><br><span class="line">bcp &quot;SELECT * FROM YourTable&quot; </span><br><span class="line">queryout &quot;output.csv&quot; </span><br><span class="line"><span class="operator">-</span>b <span class="number">10000</span>                        <span class="comment">-- 批次大小</span></span><br><span class="line"><span class="operator">-</span>a <span class="number">16384</span>                        <span class="comment">-- 封包大小</span></span><br><span class="line"><span class="operator">-</span>O                             <span class="comment">-- 保持身份值</span></span><br><span class="line"><span class="operator">-</span>h &quot;TABLOCK&quot;                    <span class="comment">-- 資料表鎖定提示</span></span><br></pre></td></tr></table></figure>

<h3 id="3-大型資料處理"><a href="#3-大型資料處理" class="headerlink" title="3. 大型資料處理"></a>3. 大型資料處理</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 處理大型資料的腳本</span></span><br><span class="line"><span class="variable">@echo</span> off</span><br><span class="line">setlocal enabledelayedexpansion</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 設定變數</span></span><br><span class="line"><span class="keyword">set</span> SERVER<span class="operator">=</span>YourServer</span><br><span class="line"><span class="keyword">set</span> DATABASE<span class="operator">=</span>YourDB</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">TABLE</span><span class="operator">=</span>YourTable</span><br><span class="line"><span class="keyword">set</span> EXPORTPATH<span class="operator">=</span>D:\Export</span><br><span class="line"><span class="keyword">set</span> BATCHSIZE<span class="operator">=</span><span class="number">1000000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 分割處理大型資料</span></span><br><span class="line"><span class="keyword">for</span> <span class="operator">/</span>L <span class="operator">%</span><span class="operator">%</span>i <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">1</span>,<span class="number">10</span>) do (</span><br><span class="line">    <span class="keyword">set</span> <span class="operator">/</span>a <span class="keyword">START</span><span class="operator">=</span>((<span class="operator">%</span><span class="operator">%</span>i<span class="number">-1</span>)<span class="operator">*</span><span class="operator">%</span>BATCHSIZE<span class="operator">%</span>)<span class="operator">+</span><span class="number">1</span></span><br><span class="line">    <span class="keyword">set</span> <span class="operator">/</span>a <span class="keyword">END</span><span class="operator">=</span><span class="operator">%</span><span class="operator">%</span>i<span class="operator">*</span><span class="operator">%</span>BATCHSIZE<span class="operator">%</span></span><br><span class="line">    </span><br><span class="line">    bcp &quot;SELECT * FROM %DATABASE%.dbo.%TABLE% </span><br><span class="line">         WHERE ID BETWEEN !START! AND !END!</span><br><span class="line">         ORDER BY ID&quot; </span><br><span class="line">    queryout &quot;%EXPORTPATH%\Part_%%i.csv&quot; </span><br><span class="line">    <span class="operator">-</span>c <span class="operator">-</span>t&quot;,&quot; <span class="operator">-</span>S <span class="operator">%</span>SERVER<span class="operator">%</span> <span class="operator">-</span>T</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="SSIS-實戰技巧"><a href="#SSIS-實戰技巧" class="headerlink" title="SSIS 實戰技巧"></a>SSIS 實戰技巧</h2><h3 id="1-基本元件設定"><a href="#1-基本元件設定" class="headerlink" title="1. 基本元件設定"></a>1. 基本元件設定</h3><p>在SSIS中建立CSV匯出流程：</p>
<ol>
<li><p>資料流程工作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 來源查詢優化</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> YourTable <span class="keyword">WITH</span> (NOLOCK)    <span class="comment">-- 降低鎖定影響</span></span><br><span class="line">OPTION (MAXDOP <span class="number">4</span>)               <span class="comment">-- 設定平行處理</span></span><br></pre></td></tr></table></figure></li>
<li><p>轉換元件設定</p>
<ul>
<li>資料轉換：設定適當的緩衝區大小</li>
<li>排序：依需求設定索引鍵</li>
<li>條件分割：處理特殊資料</li>
</ul>
</li>
<li><p>目的地元件</p>
<ul>
<li>選擇「一般檔案目的地」</li>
<li>設定適當的編碼格式</li>
<li>設定錯誤處理機制</li>
</ul>
</li>
</ol>
<h3 id="2-效能優化技巧"><a href="#2-效能優化技巧" class="headerlink" title="2. 效能優化技巧"></a>2. 效能優化技巧</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SSIS專案屬性設定</span></span><br><span class="line"><span class="comment">-- 1. 緩衝區設定</span></span><br><span class="line">BufferTempStoragePath <span class="operator">=</span> &quot;D:\SSIS\Temp&quot;    <span class="comment">-- 設定暫存路徑</span></span><br><span class="line">DefaultBufferMaxRows <span class="operator">=</span> <span class="number">10000</span>               <span class="comment">-- 設定緩衝區大小</span></span><br><span class="line">DefaultBufferSize <span class="operator">=</span> <span class="number">10485760</span>               <span class="comment">-- 設定緩衝記憶體大小</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 引擎設定</span></span><br><span class="line">MaxConcurrentExecutables <span class="operator">=</span> <span class="number">4</span>               <span class="comment">-- 設定平行處理數</span></span><br></pre></td></tr></table></figure>

<h3 id="3-自動化部署"><a href="#3-自動化部署" class="headerlink" title="3. 自動化部署"></a>3. 自動化部署</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PowerShell部署腳本</span></span><br><span class="line"><span class="variable">$SSISNamespace</span> = <span class="string">&quot;Microsoft.SqlServer.Management.IntegrationServices&quot;</span></span><br><span class="line"><span class="variable">$Server</span> = <span class="built_in">New-Object</span> Microsoft.SqlServer.Management.Smo.Server(<span class="variable">$ServerName</span>)</span><br><span class="line"><span class="variable">$Catalog</span> = <span class="built_in">New-Object</span> <span class="string">&quot;<span class="variable">$SSISNamespace</span>.IntegrationServices&quot;</span> <span class="variable">$Server</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署專案</span></span><br><span class="line"><span class="variable">$Project</span> = <span class="variable">$Folder</span>.DeployProject(</span><br><span class="line">    <span class="variable">$ProjectFilePath</span>,</span><br><span class="line">    <span class="variable">$ProjectName</span>,</span><br><span class="line">    <span class="variable">$ProjectDescription</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="實戰案例分享-1"><a href="#實戰案例分享-1" class="headerlink" title="實戰案例分享"></a>實戰案例分享</h2><h3 id="案例一：客戶資料匯出"><a href="#案例一：客戶資料匯出" class="headerlink" title="案例一：客戶資料匯出"></a>案例一：客戶資料匯出</h3><p>情境：需要每日匯出500萬筆客戶紀錄</p>
<p>解決方案：</p>
<ol>
<li>使用BCP進行快速匯出<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 分割匯出腳本</span></span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@StartDate</span> datetime <span class="operator">=</span> <span class="string">&#x27;2024-01-01&#x27;</span></span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@EndDate</span> datetime <span class="operator">=</span> <span class="string">&#x27;2024-01-02&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 建立暫存資料表存放分割區間</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> #DateRanges (</span><br><span class="line">    RangeID <span class="type">int</span> <span class="keyword">IDENTITY</span>(<span class="number">1</span>,<span class="number">1</span>),</span><br><span class="line">    StartTime datetime,</span><br><span class="line">    EndTime datetime</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 產生15分鐘區間</span></span><br><span class="line">WHILE <span class="variable">@StartDate</span> <span class="operator">&lt;</span> <span class="variable">@EndDate</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">INSERT INTO</span> #DateRanges (StartTime, EndTime)</span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">        <span class="variable">@StartDate</span>,</span><br><span class="line">        DATEADD(<span class="keyword">minute</span>, <span class="number">15</span>, <span class="variable">@StartDate</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@StartDate</span> <span class="operator">=</span> DATEADD(<span class="keyword">minute</span>, <span class="number">15</span>, <span class="variable">@StartDate</span>)</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 平行處理匯出</span></span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@RangeID</span> <span class="type">int</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@MaxRangeID</span> <span class="type">int</span> <span class="operator">=</span> (<span class="keyword">SELECT</span> <span class="built_in">MAX</span>(RangeID) <span class="keyword">FROM</span> #DateRanges)</span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@ThreadCount</span> <span class="type">int</span> <span class="operator">=</span> <span class="number">4</span>                                    <span class="comment">-- 設定平行處理數</span></span><br><span class="line"></span><br><span class="line">WHILE <span class="variable">@RangeID</span> <span class="operator">&lt;=</span> <span class="variable">@MaxRangeID</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 檢查執行中的處理程序數</span></span><br><span class="line">    WHILE (<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> sys.dm_exec_requests </span><br><span class="line">           <span class="keyword">WHERE</span> command <span class="operator">=</span> <span class="string">&#x27;BCP&#x27;</span> <span class="keyword">AND</span> wait_type <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="string">&#x27;SLEEP_TASK&#x27;</span>)) <span class="operator">&gt;=</span> <span class="variable">@ThreadCount</span></span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        WAITFOR DELAY <span class="string">&#x27;00:00:01&#x27;</span></span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 啟動新的BCP處理程序</span></span><br><span class="line">    <span class="keyword">DECLARE</span> <span class="variable">@BCPCommand</span> nvarchar(<span class="number">4000</span>)</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="variable">@BCPCommand</span> <span class="operator">=</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">    bcp &quot;</span></span><br><span class="line"><span class="string">    SELECT * </span></span><br><span class="line"><span class="string">    FROM CallRecords </span></span><br><span class="line"><span class="string">    WHERE CallTime BETWEEN &#x27;&#x27;&#x27;</span> <span class="operator">+</span> </span><br><span class="line">    <span class="keyword">CONVERT</span>(<span class="type">varchar</span>, StartTime, <span class="number">121</span>) <span class="operator">+</span> <span class="string">&#x27;&#x27;&#x27; AND &#x27;&#x27;&#x27;</span> <span class="operator">+</span></span><br><span class="line">    <span class="keyword">CONVERT</span>(<span class="type">varchar</span>, EndTime, <span class="number">121</span>) <span class="operator">+</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    &quot; queryout &quot;D:\Export\CallRecords_&#x27;</span> <span class="operator">+</span> </span><br><span class="line">    <span class="built_in">CAST</span>(RangeID <span class="keyword">as</span> <span class="type">varchar</span>) <span class="operator">+</span> <span class="string">&#x27;.csv&quot; -c -t&quot;,&quot; -S $(ServerName) -T</span></span><br><span class="line"><span class="string">    &#x27;</span></span><br><span class="line">    <span class="keyword">FROM</span> #DateRanges</span><br><span class="line">    <span class="keyword">WHERE</span> RangeID <span class="operator">=</span> <span class="variable">@RangeID</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 執行BCP命令</span></span><br><span class="line">    <span class="keyword">EXEC</span> master..xp_cmdshell <span class="variable">@BCPCommand</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@RangeID</span> <span class="operator">=</span> <span class="variable">@RangeID</span> <span class="operator">+</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>效能優化重點：</p>
<ol>
<li>使用時間區間分割資料</li>
<li>設定適當的平行處理數</li>
<li>監控系統資源使用情況</li>
<li>錯誤處理機制</li>
</ol>
<p>實際效能：</p>
<ul>
<li>原本單執行緒需要4小時</li>
<li>優化後只需40分鐘</li>
<li>CPU使用率維持在70%左右</li>
<li>記憶體使用穩定</li>
</ul>
<h3 id="案例二：交易資料匯出"><a href="#案例二：交易資料匯出" class="headerlink" title="案例二：交易資料匯出"></a>案例二：交易資料匯出</h3><p>情境：券商需要每日收盤後30分鐘內完成百萬筆交易資料的匯出並進行格式轉換</p>
<p>解決方案：結合BCP和SSIS的優點</p>
<ol>
<li><p>使用BCP快速匯出原始資料</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 交易資料快速匯出</span></span><br><span class="line">bcp &quot;</span><br><span class="line">SELECT t.*, </span><br><span class="line">       a.AccountName,</span><br><span class="line">       s.StockName,</span><br><span class="line">       s.MarketType</span><br><span class="line">FROM Transactions t</span><br><span class="line">JOIN Accounts a ON t.AccountID = a.AccountID</span><br><span class="line">JOIN Stocks s ON t.StockID = s.StockID</span><br><span class="line">WHERE t.TransDate = CAST(GETDATE() AS date)</span><br><span class="line">&quot; queryout &quot;D:\Export\RawData.csv&quot; <span class="operator">-</span>c <span class="operator">-</span>t&quot;,&quot; <span class="operator">-</span>S $(ServerName) <span class="operator">-</span>T</span><br></pre></td></tr></table></figure></li>
<li><p>使用SSIS進行資料轉換</p>
</li>
</ol>
<ul>
<li>建立資料流程任務</li>
<li>設定CSV來源元件</li>
<li>加入資料轉換元件：<ul>
<li>特殊字元處理</li>
<li>金額格式轉換</li>
<li>編碼轉換</li>
<li>異常資料過濾</li>
</ul>
</li>
<li>設定匯出格式</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SSIS指令碼任務 - 資料轉換</span></span><br><span class="line">public void Main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span> 設定來源連接</span><br><span class="line">    string sourceFile <span class="operator">=</span> @&quot;D:\Export\RawData.csv&quot;;</span><br><span class="line">    </span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span> 設定緩衝區大小</span><br><span class="line">    BufferSize <span class="operator">=</span> <span class="number">10485760</span>;              <span class="comment">-- 10MB緩衝區</span></span><br><span class="line">    DefaultBufferMaxRows <span class="operator">=</span> <span class="number">10000</span>;        <span class="comment">-- 每批次處理筆數</span></span><br><span class="line">    </span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span> 設定錯誤處理</span><br><span class="line">    try</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="operator">/</span><span class="operator">/</span> 執行資料轉換</span><br><span class="line">        foreach (<span class="type">row</span> <span class="keyword">in</span> Source)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="operator">/</span><span class="operator">/</span> 處理特殊字元</span><br><span class="line">            row.AccountName <span class="operator">=</span> HandleSpecialChars(row.AccountName);</span><br><span class="line">            </span><br><span class="line">            <span class="operator">/</span><span class="operator">/</span> 轉換金額格式</span><br><span class="line">            row.Amount <span class="operator">=</span> FormatCurrency(row.Amount);</span><br><span class="line">            </span><br><span class="line">            <span class="operator">/</span><span class="operator">/</span> 寫入目標檔案</span><br><span class="line">            WriteToTarget(<span class="type">row</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="operator">/</span><span class="operator">/</span> 記錄錯誤</span><br><span class="line">        LogError(ex);</span><br><span class="line">        throw;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>自動化排程設定<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PowerShell自動化腳本</span></span><br><span class="line"><span class="variable">$dtStart</span> = <span class="built_in">Get-Date</span> <span class="string">&quot;15:00&quot;</span>              <span class="comment"># 設定開始時間</span></span><br><span class="line"><span class="variable">$dtEnd</span> = <span class="built_in">Get-Date</span> <span class="string">&quot;15:30&quot;</span>                <span class="comment"># 設定結束時間</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 監控資料匯出狀態</span></span><br><span class="line"><span class="keyword">while</span> ((<span class="built_in">Get-Date</span>) <span class="operator">-lt</span> <span class="variable">$dtEnd</span>) &#123;</span><br><span class="line">    <span class="comment"># 檢查匯出進度</span></span><br><span class="line">    <span class="variable">$progress</span> = <span class="built_in">Get-ExportProgress</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$progress</span>.Status <span class="operator">-eq</span> <span class="string">&quot;Completed&quot;</span>) &#123;</span><br><span class="line">        <span class="comment"># 開始SSIS轉換</span></span><br><span class="line">        <span class="built_in">Start-SSISPackage</span> <span class="literal">-Path</span> <span class="string">&quot;D:\SSIS\DataTransform.dtsx&quot;</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">Start-Sleep</span> <span class="literal">-Seconds</span> <span class="number">30</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>實際效能：</p>
<ul>
<li>BCP匯出：5分鐘</li>
<li>SSIS轉換：15分鐘</li>
<li>總耗時：20分鐘</li>
<li>成功率：99.9%</li>
</ul>
<h2 id="工具選擇建議"><a href="#工具選擇建議" class="headerlink" title="工具選擇建議"></a>工具選擇建議</h2><p>根據情境選擇合適的工具：</p>
<ol>
<li><p>單純資料匯出</p>
<ul>
<li>資料量 &lt; 100萬筆：SQLCMD</li>
<li>資料量 &gt; 100萬筆：BCP</li>
</ul>
</li>
<li><p>需要資料轉換</p>
<ul>
<li>簡單轉換：SQLCMD</li>
<li>複雜轉換：SSIS</li>
</ul>
</li>
<li><p>自動化需求</p>
<ul>
<li>單一任務：BCP + 排程</li>
<li>複雜流程：SSIS</li>
</ul>
</li>
<li><p>整合應用</p>
<ul>
<li>BCP + SSIS：大量資料配合複雜轉換</li>
<li>SQLCMD + BCP：彈性控制配合快速匯出</li>
<li>三者整合：完整ETL解決方案</li>
</ul>
</li>
</ol>
<h2 id="效能優化重點"><a href="#效能優化重點" class="headerlink" title="效能優化重點"></a>效能優化重點</h2><ol>
<li>系統層級<ul>
<li>CPU平行處理設定</li>
<li>記憶體分配</li>
<li>磁碟I/O最佳化</li>
</ul>
</li>
<li>應用層級<ul>
<li>批次處理大小</li>
<li>緩衝區設定</li>
<li>交易控制</li>
</ul>
</li>
<li>網路層級<ul>
<li>封包大小設定</li>
<li>網路延遲處理</li>
<li>連線池設定</li>
</ul>
</li>
</ol>
<h2 id="常見問題解決方案"><a href="#常見問題解決方案" class="headerlink" title="常見問題解決方案"></a>常見問題解決方案</h2><ol>
<li><p>編碼問題</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 設定正確的編碼格式</span></span><br><span class="line">bcp ... <span class="operator">-</span>C <span class="number">65001</span>                         </span><br><span class="line"><span class="comment">-- 使用UTF-8編碼</span></span><br></pre></td></tr></table></figure></li>
<li><p>特殊字元處理</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 建立特殊字元處理函數</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> dbo.HandleSpecialChars</span><br><span class="line">(</span><br><span class="line">    <span class="variable">@text</span> nvarchar(max)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">RETURNS</span> nvarchar(max)</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@text</span> <span class="operator">=</span> REPLACE(<span class="variable">@text</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;&quot;&quot;&#x27;</span>)    </span><br><span class="line">    <span class="comment">-- 處理雙引號</span></span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@text</span> <span class="operator">=</span> REPLACE(<span class="variable">@text</span>, <span class="type">CHAR</span>(<span class="number">13</span>), <span class="string">&#x27;&#x27;</span>)  </span><br><span class="line">    <span class="comment">-- 處理換行符</span></span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@text</span> <span class="operator">=</span> REPLACE(<span class="variable">@text</span>, <span class="type">CHAR</span>(<span class="number">10</span>), <span class="string">&#x27;&#x27;</span>)  </span><br><span class="line">    <span class="comment">-- 處理換行符</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">RETURN</span> <span class="variable">@text</span></span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure></li>
<li><p>效能監控</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 建立效能監控查詢</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    r.session_id,</span><br><span class="line">    r.start_time,</span><br><span class="line">    r.status,</span><br><span class="line">    r.command,</span><br><span class="line">    r.cpu_time,</span><br><span class="line">    r.total_elapsed_time,</span><br><span class="line">    r.reads,</span><br><span class="line">    r.writes,</span><br><span class="line">    r.logical_reads</span><br><span class="line"><span class="keyword">FROM</span> sys.dm_exec_requests r</span><br><span class="line"><span class="keyword">WHERE</span> r.command <span class="keyword">IN</span> (<span class="string">&#x27;BCP&#x27;</span>, <span class="string">&#x27;BULK INSERT&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>透過本文介紹的實戰技巧，你現在應該能夠：</p>
<ul>
<li>根據情境選擇最適合的工具</li>
<li>優化匯出效能達到最佳狀態</li>
<li>處理各種匯出相關問題</li>
<li>建立完整的自動化解決方案</li>
</ul>
<p>要記住：沒有一個工具適合所有情境，關鍵是要根據實際需求選擇合適的工具組合，並且持續優化調整！</p>
<h2 id="參考資源"><a href="#參考資源" class="headerlink" title="參考資源"></a>參考資源</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/sql/">SQL Server官方文件</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/sql/integration-services/best-practices">SSIS最佳實踐指南</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/sql/tools/bcp-utility">BCP命令列參考</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/sql/relational-databases/performance/performance-center-for-sql-server-database-engine-and-azure-sql-database">SQL Server效能調校指南</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">SQL Server 資料庫管理必學秘技：快速查詢物件修改時間</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2024-12-16 18:15:05" itemprop="dateCreated datePublished" datetime="2024-12-16T18:15:05+08:00">2024-12-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-12-19 11:45:22" itemprop="dateModified" datetime="2024-12-19T11:45:22+08:00">2024-12-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%B3%87%E6%96%99%E5%BA%AB/" itemprop="url" rel="index"><span itemprop="name">資料庫</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>1.2k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>1 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在進行資料庫開發與維護時，經常需要知道資料表、檢視表或預存程序最後的修改時間。這些資訊對於：</p>
<ul>
<li>追蹤系統變更</li>
<li>問題排除</li>
<li>效能調校</li>
<li>版本控制<br>都非常重要。本文將介紹幾個實用的SQL查詢技巧，讓你輕鬆掌握資料庫物件的時間資訊。</li>
</ul>
<h1 id="查詢資料表與檢視表的修改時間"><a href="#查詢資料表與檢視表的修改時間" class="headerlink" title="查詢資料表與檢視表的修改時間"></a>查詢資料表與檢視表的修改時間</h1><p>以下是查詢資料表與檢視表修改時間的SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> [name]           <span class="comment">-- 物件名稱</span></span><br><span class="line">      ,create_date     <span class="comment">-- 建立時間</span></span><br><span class="line">      ,modify_date     <span class="comment">-- 修改時間</span></span><br><span class="line">      ,type_desc       <span class="comment">-- 物件類型</span></span><br><span class="line"><span class="keyword">FROM</span> sys.all_objects </span><br><span class="line"><span class="keyword">WHERE</span> type_desc <span class="operator">=</span> <span class="string">&#x27;USER_TABLE&#x27;</span>    <span class="comment">-- 使用者資料表</span></span><br><span class="line">   <span class="keyword">OR</span> type_desc <span class="operator">=</span> <span class="string">&#x27;VIEW&#x27;</span>          <span class="comment">-- 檢視表</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> modify_date <span class="keyword">DESC</span>         <span class="comment">-- 依修改時間排序</span></span><br></pre></td></tr></table></figure>

<h2 id="查詢說明"><a href="#查詢說明" class="headerlink" title="查詢說明"></a>查詢說明</h2><ul>
<li><code>sys.all_objects</code>: SQL Server的系統檢視表，儲存所有資料庫物件的資訊</li>
<li><code>type_desc</code>: 物件類型描述<ul>
<li>&#39;USER_TABLE&#39;: 使用者建立的資料表</li>
<li>&#39;VIEW&#39;: 檢視表</li>
</ul>
</li>
<li><code>ORDER BY modify_date DESC</code>: 依修改時間降冪排序，最新的排在最前面</li>
</ul>
<h1 id="查詢預存程序的修改時間"><a href="#查詢預存程序的修改時間" class="headerlink" title="查詢預存程序的修改時間"></a>查詢預存程序的修改時間</h1><p>如果要查詢預存程序的修改時間，可以使用以下查詢：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> [name]           <span class="comment">-- 預存程序名稱</span></span><br><span class="line">      ,create_date     <span class="comment">-- 建立時間</span></span><br><span class="line">      ,modify_date     <span class="comment">-- 修改時間</span></span><br><span class="line"><span class="keyword">FROM</span> sys.all_objects </span><br><span class="line"><span class="keyword">WHERE</span> type_desc <span class="operator">=</span> <span class="string">&#x27;SQL_STORED_PROCEDURE&#x27;</span>    <span class="comment">-- 限定查詢預存程序</span></span><br><span class="line">  <span class="keyword">AND</span> <span class="built_in">SUBSTRING</span>([name], <span class="number">1</span>, <span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="string">&#x27;sp_&#x27;</span>, <span class="string">&#x27;dt_&#x27;</span>, <span class="string">&#x27;xp_&#x27;</span>)  <span class="comment">-- 排除系統預存程序</span></span><br></pre></td></tr></table></figure>

<h2 id="查詢說明-1"><a href="#查詢說明-1" class="headerlink" title="查詢說明"></a>查詢說明</h2><ul>
<li><code>type_desc = &#39;SQL_STORED_PROCEDURE&#39;</code>: 只查詢SQL預存程序</li>
<li><code>SUBSTRING([name], 1, 3) NOT IN (&#39;sp_&#39;, &#39;dt_&#39;, &#39;xp_&#39;)</code>: <ul>
<li>排除系統內建的預存程序</li>
<li>這些預存程序通常以sp_、dt_或xp_開頭</li>
<li>過濾後只顯示使用者建立的預存程序</li>
</ul>
</li>
</ul>
<h1 id="實際應用範例"><a href="#實際應用範例" class="headerlink" title="實際應用範例"></a>實際應用範例</h1><p>這些查詢在以下情況特別有用：</p>
<ol>
<li><p>系統維護</p>
<ul>
<li>追蹤最近被修改的物件</li>
<li>確認系統更新是否成功部署</li>
</ul>
</li>
<li><p>問題排查</p>
<ul>
<li>當系統發生異常時</li>
<li>可以快速檢查是否有物件被意外修改</li>
</ul>
</li>
<li><p>效能調校</p>
<ul>
<li>追蹤統計資料更新時間</li>
<li>檢查索引重建時間</li>
</ul>
</li>
<li><p>版本控制</p>
<ul>
<li>確認程式碼部署狀態</li>
<li>驗證物件是否為最新版本</li>
</ul>
</li>
</ol>
<h1 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h1><ol>
<li><p>執行權限</p>
<ul>
<li>需要有適當的資料庫權限才能查詢這些系統檢視表</li>
<li>建議使用具有db_owner或更高權限的帳號</li>
</ul>
</li>
<li><p>效能考量</p>
<ul>
<li>這些查詢通常執行很快</li>
<li>但在大型資料庫中，建議加上適當的WHERE條件限制範圍</li>
</ul>
</li>
<li><p>時間準確性</p>
<ul>
<li>modify_date會在物件定義變更時更新</li>
<li>純資料異動不會影響此時間</li>
</ul>
</li>
</ol>
<h1 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h1><p>掌握這些查詢技巧，可以讓你的資料庫管理工作事半功倍。建議將這些查詢儲存為程式碼片段，需要時可以快速使用。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">SQL Server管理員必學：SQLCMD實戰指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2024-12-15 18:52:15" itemprop="dateCreated datePublished" datetime="2024-12-15T18:52:15+08:00">2024-12-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-12-19 11:45:02" itemprop="dateModified" datetime="2024-12-19T11:45:02+08:00">2024-12-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%B3%87%E6%96%99%E5%BA%AB%E7%AE%A1%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">資料庫管理</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>3.1k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>3 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在管理大型SQL Server資料庫時,你是否遇過以下痛點？</p>
<ul>
<li>資料匯入匯出緩慢到讓人抓狂</li>
<li>維護作業需要人工執行,常常加班到半夜</li>
<li>大型資料庫備份還原總是出問題</li>
<li>跨伺服器操作複雜又容易出錯</li>
</ul>
<p>別擔心！本篇完整剖析SQLCMD的所有實戰技巧,讓你輕鬆應對各種資料庫維運挑戰。無論你是資深DBA還是新手工程師,都能從中學到實用的技巧！</p>
<svg viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg">
  <text x="400" y="40" text-anchor="middle" font-size="24" fill="#333">SQLCMD 功能與效能概觀</text>
  <circle cx="400" cy="200" r="60" fill="#4A90E2"/>
  <text x="400" y="205" text-anchor="middle" font-size="16" fill="white">SQLCMD</text>
  <g>
    <circle cx="200" cy="100" r="50" fill="#81C784"/>
    <text x="200" y="95" text-anchor="middle" font-size="14" fill="white">資料匯入匯出</text>
    <text x="200" y="115" text-anchor="middle" font-size="12" fill="white">批次處理優化</text>
    <line x1="340" y1="170" x2="240" y2="120" stroke="#666" stroke-width="2"/>
    <circle cx="600" cy="100" r="50" fill="#81C784"/>
    <text x="600" y="95" text-anchor="middle" font-size="14" fill="white">執行SQL指令</text>
    <text x="600" y="115" text-anchor="middle" font-size="12" fill="white">效能監控</text>
    <line x1="460" y1="170" x2="560" y2="120" stroke="#666" stroke-width="2"/>
    <circle cx="200" cy="300" r="50" fill="#81C784"/>
    <text x="200" y="295" text-anchor="middle" font-size="14" fill="white">資料庫備份</text>
    <text x="200" y="315" text-anchor="middle" font-size="12" fill="white">壓縮優化</text>
    <line x1="340" y1="230" x2="240" y2="280" stroke="#666" stroke-width="2"/>
    <circle cx="600" cy="300" r="50" fill="#81C784"/>
    <text x="600" y="295" text-anchor="middle" font-size="14" fill="white">自動化排程</text>
    <text x="600" y="315" text-anchor="middle" font-size="12" fill="white">錯誤處理</text>
    <line x1="460" y1="230" x2="560" y2="280" stroke="#666" stroke-width="2"/>
  </g>
  <g transform="translate(100,400)">
    <text x="300" y="20" text-anchor="middle" font-size="16" fill="#333">大型資料庫匯入效能比較</text>
    <line x1="50" y1="150" x2="550" y2="150" stroke="#666" stroke-width="2"/>
    <line x1="50" y1="150" x2="50" y2="30" stroke="#666" stroke-width="2"/>
    <rect x="100" y="70" width="40" height="80" fill="#4A90E2" opacity="0.8"/>
    <rect x="250" y="100" width="40" height="50" fill="#4A90E2" opacity="0.8"/>
    <rect x="400" y="40" width="40" height="110" fill="#4A90E2" opacity="0.8"/>
    <text x="120" y="170" text-anchor="middle" font-size="12">一般匯入</text>
    <text x="270" y="170" text-anchor="middle" font-size="12">批次處理</text>
    <text x="420" y="170" text-anchor="middle" font-size="12">最佳化設定</text>
  </g>
</svg>

<h2 id="實戰經驗分享"><a href="#實戰經驗分享" class="headerlink" title="實戰經驗分享"></a>實戰經驗分享</h2><h3 id="案例一：10TB-大型資料庫的快速匯入"><a href="#案例一：10TB-大型資料庫的快速匯入" class="headerlink" title="案例一：10TB 大型資料庫的快速匯入"></a>案例一：10TB 大型資料庫的快速匯入</h3><p>在某電力公司的專案中,我們需要匯入一個10TB的資料庫。使用傳統方式可能需要數天時間,但透過以下SQLCMD優化技巧,我們將時間縮短到12小時：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 設定最佳化參數</span></span><br><span class="line">sqlcmd <span class="operator">-</span>S ServerName <span class="operator">-</span>U DBAdmin <span class="operator">-</span>P Password <span class="operator">-</span>d TargetDB <span class="operator">-</span>r </span><br><span class="line"><span class="operator">-</span>b                              <span class="comment">-- 遇錯誤終止批次作業</span></span><br><span class="line"><span class="operator">-</span>h<span class="number">-1</span>                            <span class="comment">-- 移除頁首</span></span><br><span class="line"><span class="operator">-</span>k                              <span class="comment">-- 保留格式化字元</span></span><br><span class="line"><span class="operator">-</span>t <span class="number">600</span>                          <span class="comment">-- 設定查詢逾時600秒</span></span><br><span class="line"><span class="operator">-</span>i &quot;D:\import_script.sql&quot;       <span class="comment">-- 指定匯入腳本</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- import_script.sql 內容</span></span><br><span class="line">:setvar BATCHSIZE <span class="number">10000</span>         <span class="comment">-- 設定批次大小</span></span><br><span class="line">:setvar MAXDOP <span class="number">4</span>                <span class="comment">-- 設定平行處理數</span></span><br><span class="line"></span><br><span class="line">USE [TargetDB]</span><br><span class="line">GO</span><br><span class="line"><span class="keyword">SET</span> NOCOUNT <span class="keyword">ON</span></span><br><span class="line">GO</span><br><span class="line"><span class="keyword">BEGIN</span> TRANSACTION</span><br><span class="line">    <span class="comment">-- 在此加入您的資料匯入指令</span></span><br><span class="line">    <span class="comment">-- 建議每10000筆做一次COMMIT</span></span><br><span class="line"><span class="keyword">COMMIT</span></span><br><span class="line">GO</span><br></pre></td></tr></table></figure>

<p>關鍵優化點：</p>
<ol>
<li>適當的批次大小設定</li>
<li>平行處理數調整</li>
<li>記憶體使用最佳化</li>
<li>交易記錄管理</li>
</ol>
<h3 id="案例二：自動化備份策略"><a href="#案例二：自動化備份策略" class="headerlink" title="案例二：自動化備份策略"></a>案例二：自動化備份策略</h3><p>以下是一個實際運作中的自動化備份方案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 建立排程備份腳本</span></span><br><span class="line"><span class="comment">-- backup_script.sql</span></span><br><span class="line">:<span class="keyword">on</span> error exit</span><br><span class="line">:setvar LogPath &quot;D:\Logs&quot;</span><br><span class="line">:setvar BackupPath &quot;D:\Backups&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 錯誤處理與記錄</span></span><br><span class="line"><span class="keyword">BEGIN</span> TRY</span><br><span class="line">    <span class="keyword">DECLARE</span> <span class="variable">@StartTime</span> datetime <span class="operator">=</span> GETDATE()</span><br><span class="line">    <span class="keyword">DECLARE</span> <span class="variable">@BackupFile</span> nvarchar(<span class="number">500</span>) <span class="operator">=</span> <span class="string">&#x27;$(BackupPath)\&#x27;</span> <span class="operator">+</span> </span><br><span class="line">           DB_NAME() <span class="operator">+</span> <span class="string">&#x27;_&#x27;</span> <span class="operator">+</span> </span><br><span class="line">           FORMAT(GETDATE(), <span class="string">&#x27;yyyyMMdd_HHmmss&#x27;</span>) <span class="operator">+</span> <span class="string">&#x27;.bak&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 執行完整備份</span></span><br><span class="line">    BACKUP DATABASE [$(DatabaseName)]</span><br><span class="line">    <span class="keyword">TO</span> DISK <span class="operator">=</span> <span class="variable">@BackupFile</span></span><br><span class="line">    <span class="keyword">WITH</span> COMPRESSION,                 <span class="comment">-- 啟用壓縮</span></span><br><span class="line">         CHECKSUM,                    <span class="comment">-- 檢查備份資料完整性</span></span><br><span class="line">         STATS <span class="operator">=</span> <span class="number">10</span>                   <span class="comment">-- 顯示進度</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 記錄成功訊息</span></span><br><span class="line">    <span class="keyword">DECLARE</span> <span class="variable">@EndTime</span> datetime <span class="operator">=</span> GETDATE()</span><br><span class="line">    <span class="keyword">DECLARE</span> <span class="variable">@Duration</span> <span class="type">int</span> <span class="operator">=</span> DATEDIFF(<span class="keyword">MINUTE</span>, <span class="variable">@StartTime</span>, <span class="variable">@EndTime</span>)</span><br><span class="line">    </span><br><span class="line">    PRINT <span class="string">&#x27;備份完成：&#x27;</span></span><br><span class="line">    PRINT <span class="string">&#x27;開始時間: &#x27;</span> <span class="operator">+</span> <span class="keyword">CONVERT</span>(<span class="type">varchar</span>, <span class="variable">@StartTime</span>, <span class="number">120</span>)</span><br><span class="line">    PRINT <span class="string">&#x27;結束時間: &#x27;</span> <span class="operator">+</span> <span class="keyword">CONVERT</span>(<span class="type">varchar</span>, <span class="variable">@EndTime</span>, <span class="number">120</span>)</span><br><span class="line">    PRINT <span class="string">&#x27;執行時間: &#x27;</span> <span class="operator">+</span> <span class="built_in">CAST</span>(<span class="variable">@Duration</span> <span class="keyword">as</span> <span class="type">varchar</span>) <span class="operator">+</span> <span class="string">&#x27; 分鐘&#x27;</span></span><br><span class="line"><span class="keyword">END</span> TRY</span><br><span class="line"><span class="keyword">BEGIN</span> CATCH</span><br><span class="line">    <span class="comment">-- 錯誤處理</span></span><br><span class="line">    <span class="keyword">DECLARE</span> <span class="variable">@ErrorMessage</span> nvarchar(<span class="number">4000</span>) <span class="operator">=</span> ERROR_MESSAGE()</span><br><span class="line">    <span class="keyword">DECLARE</span> <span class="variable">@ErrorSeverity</span> <span class="type">int</span> <span class="operator">=</span> ERROR_SEVERITY()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 寫入錯誤記錄</span></span><br><span class="line">    PRINT <span class="string">&#x27;備份失敗：&#x27;</span> <span class="operator">+</span> <span class="variable">@ErrorMessage</span></span><br><span class="line">    RAISERROR(<span class="variable">@ErrorMessage</span>, <span class="variable">@ErrorSeverity</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">END</span> CATCH</span><br></pre></td></tr></table></figure>

<h2 id="進階效能優化技巧"><a href="#進階效能優化技巧" class="headerlink" title="進階效能優化技巧"></a>進階效能優化技巧</h2><h3 id="1-記憶體最佳化"><a href="#1-記憶體最佳化" class="headerlink" title="1. 記憶體最佳化"></a>1. 記憶體最佳化</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 設定最佳記憶體使用量</span></span><br><span class="line">sqlcmd <span class="operator">-</span>S ServerName <span class="operator">-</span>b <span class="operator">-</span>m <span class="number">65535</span> <span class="operator">-</span>U DBAdmin <span class="operator">-</span>P Password </span><br></pre></td></tr></table></figure>

<p>記憶體參數說明：</p>
<ul>
<li><code>-m</code> 設定最大記憶體使用量</li>
<li>建議值：可用實體記憶體的 75%</li>
<li>需考慮同時執行的其他處理程序</li>
</ul>
<h3 id="2-平行處理優化"><a href="#2-平行處理優化" class="headerlink" title="2. 平行處理優化"></a>2. 平行處理優化</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 設定平行處理</span></span><br><span class="line">:setvar MAXDOP <span class="number">4</span>              <span class="comment">-- 設定平行處理數</span></span><br><span class="line">GO</span><br><span class="line">sp_configure <span class="string">&#x27;max degree of parallelism&#x27;</span>, $(MAXDOP)</span><br><span class="line">GO</span><br><span class="line">RECONFIGURE <span class="keyword">WITH</span> OVERRIDE</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>

<p>平行處理建議：</p>
<ul>
<li>CPU核心數 ≤ 4：使用全部核心</li>
<li>4 &lt; CPU核心數 ≤ 8：使用核心數的75%</li>
<li>CPU核心數 &gt; 8：使用8個核心</li>
</ul>
<h3 id="3-分割檔案匯入策略"><a href="#3-分割檔案匯入策略" class="headerlink" title="3. 分割檔案匯入策略"></a>3. 分割檔案匯入策略</h3><p>大型檔案建議分割處理：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 分割檔案匯入腳本</span></span><br><span class="line">:<span class="keyword">on</span> error exit</span><br><span class="line">:setvar ChunkSize <span class="number">1000000</span>    <span class="comment">-- 每個分割檔案的資料筆數</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 讀取分割檔案</span></span><br><span class="line">WHILE <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> ##TempFileList <span class="keyword">WHERE</span> Processed <span class="operator">=</span> <span class="number">0</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 處理單一分割檔案</span></span><br><span class="line">    :r &quot;$(CurrentChunkFile)&quot;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 更新處理狀態</span></span><br><span class="line">    <span class="keyword">UPDATE</span> ##TempFileList </span><br><span class="line">    <span class="keyword">SET</span> Processed <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">WHERE</span> FileName <span class="operator">=</span> <span class="string">&#x27;$(CurrentChunkFile)&#x27;</span></span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<h2 id="安全性強化設定"><a href="#安全性強化設定" class="headerlink" title="安全性強化設定"></a>安全性強化設定</h2><h3 id="1-加密傳輸設定"><a href="#1-加密傳輸設定" class="headerlink" title="1. 加密傳輸設定"></a>1. 加密傳輸設定</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 啟用加密傳輸</span></span><br><span class="line">sqlcmd <span class="operator">-</span>S ServerName <span class="operator">-</span>U DBAdmin <span class="operator">-</span>P Password <span class="operator">-</span>N                <span class="comment">-- 強制加密</span></span><br></pre></td></tr></table></figure>

<h3 id="2-稽核記錄設定"><a href="#2-稽核記錄設定" class="headerlink" title="2. 稽核記錄設定"></a>2. 稽核記錄設定</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 啟用稽核記錄</span></span><br><span class="line"><span class="keyword">CREATE</span> SERVER AUDIT SQLCMDExecAudit</span><br><span class="line"><span class="keyword">TO</span> FILE (FILEPATH <span class="operator">=</span> <span class="string">&#x27;D:\Audit\&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 設定稽核規格</span></span><br><span class="line"><span class="keyword">CREATE</span> SERVER AUDIT SPECIFICATION SQLCMDExecSpec</span><br><span class="line"><span class="keyword">FOR</span> SERVER AUDIT SQLCMDExecAudit</span><br><span class="line"><span class="keyword">ADD</span> (FAILED_LOGIN_GROUP),</span><br><span class="line"><span class="keyword">ADD</span> (SUCCESSFUL_LOGIN_GROUP),</span><br><span class="line"><span class="keyword">ADD</span> (DATABASE_CHANGE_GROUP)</span><br><span class="line"><span class="keyword">WITH</span> (STATE <span class="operator">=</span> <span class="keyword">ON</span>)</span><br></pre></td></tr></table></figure>

<h2 id="常見問題診斷與解決"><a href="#常見問題診斷與解決" class="headerlink" title="常見問題診斷與解決"></a>常見問題診斷與解決</h2><ol>
<li><p>連線逾時</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 增加連線逾時設定</span></span><br><span class="line">sqlcmd <span class="operator">-</span>S ServerName <span class="operator">-</span>U DBAdmin <span class="operator">-</span>P Password <span class="operator">-</span>t <span class="number">600</span>           <span class="comment">-- 設定600秒逾時</span></span><br></pre></td></tr></table></figure></li>
<li><p>記憶體不足</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 設定最大記憶體使用量</span></span><br><span class="line">sqlcmd <span class="operator">-</span>S ServerName <span class="operator">-</span>U DBAdmin <span class="operator">-</span>P Password <span class="operator">-</span>m <span class="number">65535</span></span><br></pre></td></tr></table></figure></li>
<li><p>權限問題</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 檢查與設定必要權限</span></span><br><span class="line"><span class="keyword">GRANT</span> CONTROL SERVER <span class="keyword">TO</span> [DBAdmin]                            <span class="comment">-- 設定伺服器層級權限</span></span><br><span class="line"><span class="keyword">GRANT</span> CONTROL <span class="keyword">ON</span> DATABASE::[TargetDB] <span class="keyword">TO</span> [DBAdmin]          <span class="comment">-- 設定資料庫層級權限</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>透過本文介紹的SQLCMD進階技巧,你現在應該能夠：</p>
<ul>
<li>大幅提升資料匯入匯出效能</li>
<li>建立穩定的自動化維護機制</li>
<li>處理各種大型資料庫維運挑戰</li>
<li>優化執行效能</li>
<li>確保作業安全性</li>
</ul>
<p>善用這些技巧,讓你的資料庫維運工作更輕鬆、更有效率！</p>
<h2 id="參考資源"><a href="#參考資源" class="headerlink" title="參考資源"></a>參考資源</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/sql/">Microsoft SQL Server 官方文件</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/sql/relational-databases/performance/performance-center-for-sql-server-database-engine-and-azure-sql-database">SQL Server 效能調校指南</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/sql/relational-databases/security/security-center-for-sql-server-database-engine-and-azure-sql-database">SQL Server 安全性最佳實務</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">SQL Server管理員必學：SQLCMD完整應用指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2024-12-14 18:28:35" itemprop="dateCreated datePublished" datetime="2024-12-14T18:28:35+08:00">2024-12-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-12-19 11:44:38" itemprop="dateModified" datetime="2024-12-19T11:44:38+08:00">2024-12-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%B3%87%E6%96%99%E5%BA%AB%E7%AE%A1%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">資料庫管理</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>1.8k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>2 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在管理大型SQL Server資料庫時,SQLCMD是一個不可或缺的命令列工具。無論是執行日常維護工作、資料匯入匯出,還是建立自動化作業,SQLCMD都能幫助我們更有效率地完成這些任務。本文將詳細介紹SQLCMD的各種應用方式,幫助你掌握這個強大的工具。</p>
<svg viewBox="0 0 800 400" xmlns="http://www.w3.org/2000/svg">
  <text x="400" y="40" text-anchor="middle" font-size="24" fill="#333">SQLCMD 功能概觀</text>
  <circle cx="400" cy="200" r="60" fill="#4A90E2"/>
  <text x="400" y="205" text-anchor="middle" font-size="16" fill="white">SQLCMD</text>
  <g>
    <circle cx="200" cy="100" r="50" fill="#81C784"/>
    <text x="200" y="105" text-anchor="middle" font-size="14" fill="white">資料匯入匯出</text>
    <line x1="340" y1="170" x2="240" y2="120" stroke="#666" stroke-width="2"/>
    <circle cx="600" cy="100" r="50" fill="#81C784"/>
    <text x="600" y="105" text-anchor="middle" font-size="14" fill="white">執行SQL指令</text>
    <line x1="460" y1="170" x2="560" y2="120" stroke="#666" stroke-width="2"/>
    <circle cx="200" cy="300" r="50" fill="#81C784"/>
    <text x="200" y="305" text-anchor="middle" font-size="14" fill="white">資料庫備份</text>
    <line x1="340" y1="230" x2="240" y2="280" stroke="#666" stroke-width="2"/>
    <circle cx="600" cy="300" r="50" fill="#81C784"/>
    <text x="600" y="305" text-anchor="middle" font-size="14" fill="white">自動化排程</text>
    <line x1="460" y1="230" x2="560" y2="280" stroke="#666" stroke-width="2"/>
  </g>
</svg>

<h2 id="SQLCMD基本語法"><a href="#SQLCMD基本語法" class="headerlink" title="SQLCMD基本語法"></a>SQLCMD基本語法</h2><p>SQLCMD的基本語法結構如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sqlcmd </span><br><span class="line"><span class="operator">-</span>S <span class="operator">&lt;</span>伺服器名稱<span class="operator">&gt;</span>          <span class="comment">-- 指定SQL Server執行個體</span></span><br><span class="line"><span class="operator">-</span>U <span class="operator">&lt;</span>使用者名稱<span class="operator">&gt;</span>          <span class="comment">-- 指定登入帳號</span></span><br><span class="line"><span class="operator">-</span>P <span class="operator">&lt;</span>密碼<span class="operator">&gt;</span>                <span class="comment">-- 指定密碼</span></span><br><span class="line"><span class="operator">-</span>d <span class="operator">&lt;</span>資料庫名稱<span class="operator">&gt;</span>          <span class="comment">-- 指定要使用的資料庫</span></span><br><span class="line"><span class="operator">-</span>i <span class="operator">&lt;</span>輸入檔案<span class="operator">&gt;</span>            <span class="comment">-- 指定要執行的SQL指令檔</span></span><br><span class="line"><span class="operator">-</span>o <span class="operator">&lt;</span>輸出檔案<span class="operator">&gt;</span>            <span class="comment">-- 指定輸出結果的檔案</span></span><br><span class="line"><span class="operator">-</span>r                       <span class="comment">-- 將錯誤訊息輸出到stderr</span></span><br></pre></td></tr></table></figure>

<h2 id="主要應用場景"><a href="#主要應用場景" class="headerlink" title="主要應用場景"></a>主要應用場景</h2><h3 id="1-資料匯入匯出"><a href="#1-資料匯入匯出" class="headerlink" title="1. 資料匯入匯出"></a>1. 資料匯入匯出</h3><p>大型資料庫的匯入是SQLCMD最常見的應用之一。以下是一個完整的匯入範例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 匯入資料庫備份</span></span><br><span class="line">sqlcmd <span class="operator">-</span>S <span class="number">192.168</span><span class="number">.0</span><span class="number">.3</span> <span class="operator">-</span>U DBAdmin <span class="operator">-</span>P MyPassword <span class="operator">-</span>d TargetDB <span class="operator">-</span>r <span class="operator">-</span>i D:\backup.sql</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 匯出查詢結果</span></span><br><span class="line">sqlcmd <span class="operator">-</span>S ServerName <span class="operator">-</span>U DBAdmin <span class="operator">-</span>P MyPassword <span class="operator">-</span>d SourceDB <span class="operator">-</span>Q &quot;SELECT * FROM Users&quot; <span class="operator">-</span>o &quot;D:\export.txt&quot;</span><br></pre></td></tr></table></figure>

<h3 id="2-執行SQL指令檔"><a href="#2-執行SQL指令檔" class="headerlink" title="2. 執行SQL指令檔"></a>2. 執行SQL指令檔</h3><p>SQLCMD可以執行預先準備好的SQL指令檔：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 執行單一SQL檔案</span></span><br><span class="line">sqlcmd <span class="operator">-</span>S ServerName <span class="operator">-</span>U DBAdmin <span class="operator">-</span>P MyPassword <span class="operator">-</span>i &quot;D:\scripts\maintenance.sql&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 執行多個SQL檔案並記錄結果</span></span><br><span class="line">sqlcmd <span class="operator">-</span>S ServerName <span class="operator">-</span>U DBAdmin <span class="operator">-</span>P MyPassword <span class="operator">-</span>i &quot;D:\script1.sql&quot; <span class="operator">-</span>i &quot;D:\script2.sql&quot; <span class="operator">-</span>o &quot;D:\log.txt&quot;</span><br></pre></td></tr></table></figure>

<h3 id="3-資料庫備份"><a href="#3-資料庫備份" class="headerlink" title="3. 資料庫備份"></a>3. 資料庫備份</h3><p>透過SQLCMD進行資料庫備份：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 完整備份</span></span><br><span class="line">sqlcmd <span class="operator">-</span>S ServerName <span class="operator">-</span>U DBAdmin <span class="operator">-</span>P MyPassword <span class="operator">-</span>Q &quot;BACKUP DATABASE MyDB TO DISK=&#x27;D:\Backups\MyDB.bak&#x27;&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 差異備份</span></span><br><span class="line">sqlcmd <span class="operator">-</span>S ServerName <span class="operator">-</span>U DBAdmin <span class="operator">-</span>P MyPassword <span class="operator">-</span>Q &quot;BACKUP DATABASE MyDB TO DISK=&#x27;D:\Backups\MyDB_Diff.bak&#x27; WITH DIFFERENTIAL&quot;</span><br></pre></td></tr></table></figure>

<h3 id="4-自動化作業排程"><a href="#4-自動化作業排程" class="headerlink" title="4. 自動化作業排程"></a>4. 自動化作業排程</h3><p>結合Windows排程器使用SQLCMD：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 建立批次檔案(.bat)</span></span><br><span class="line"><span class="variable">@echo</span> off</span><br><span class="line">sqlcmd <span class="operator">-</span>S ServerName <span class="operator">-</span>U DBAdmin <span class="operator">-</span>P MyPassword <span class="operator">-</span>d MyDB <span class="operator">-</span>i &quot;D:\DailyMaintenance.sql&quot;</span><br></pre></td></tr></table></figure>

<h2 id="進階技巧"><a href="#進階技巧" class="headerlink" title="進階技巧"></a>進階技巧</h2><h3 id="變數使用"><a href="#變數使用" class="headerlink" title="變數使用"></a>變數使用</h3><p>SQLCMD支援使用變數,讓指令更具彈性：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 使用變數</span></span><br><span class="line">sqlcmd <span class="operator">-</span>S $(Server) <span class="operator">-</span>U $(<span class="keyword">User</span>) <span class="operator">-</span>P $(Password) <span class="operator">-</span>v DB<span class="operator">=</span>&quot;MyDatabase&quot; <span class="operator">-</span>Q &quot;SELECT * FROM $(DB).dbo.Users&quot;</span><br></pre></td></tr></table></figure>

<h3 id="錯誤處理"><a href="#錯誤處理" class="headerlink" title="錯誤處理"></a>錯誤處理</h3><p>加入錯誤處理機制：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 設定錯誤處理</span></span><br><span class="line">:<span class="keyword">on</span> error exit</span><br><span class="line">:setvar ErrorLevel <span class="number">0</span></span><br><span class="line"><span class="keyword">BEGIN</span> TRY</span><br><span class="line">    <span class="comment">-- 你的SQL指令</span></span><br><span class="line"><span class="keyword">END</span> TRY</span><br><span class="line"><span class="keyword">BEGIN</span> CATCH</span><br><span class="line">    <span class="keyword">SELECT</span> ERROR_MESSAGE() <span class="keyword">AS</span> ErrorMessage</span><br><span class="line">    :setvar ErrorLevel <span class="number">1</span></span><br><span class="line"><span class="keyword">END</span> CATCH</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>

<h2 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h2><ol>
<li>密碼安全性：避免在指令中直接寫入密碼,建議使用環境變數或設定檔</li>
<li>效能考量：大型檔案匯入時,建議使用批次處理</li>
<li>錯誤記錄：務必加入適當的錯誤處理與記錄機制</li>
<li>權限控制：確保SQLCMD執行帳號擁有適當的權限</li>
</ol>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>SQLCMD是一個功能強大的命令列工具,透過本文的介紹,相信你已經對它的各種應用有了深入的了解。善用SQLCMD不只能提升工作效率,更能建立更穩定的資料庫維護機制。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">SQL Server管理技巧：批量更新資料的神奇小法術</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2024-12-13 18:53:00" itemprop="dateCreated datePublished" datetime="2024-12-13T18:53:00+08:00">2024-12-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-12-19 11:44:04" itemprop="dateModified" datetime="2024-12-19T11:44:04+08:00">2024-12-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%B3%87%E6%96%99%E5%BA%AB/" itemprop="url" rel="index"><span itemprop="name">資料庫</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>1.7k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>2 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在管理資料庫時，我們經常會遇到需要在多個資料表中更新相同欄位的情況。例如：修改某個代碼、更新狀態值等。如果要手動找出所有包含該欄位的資料表並逐一更新，不只費時還容易出錯。今天就來分享一個實用的 SQL 技巧，教你如何快速找出並更新特定欄位！</p>
<h1 id="使用情境"><a href="#使用情境" class="headerlink" title="使用情境"></a>使用情境</h1><p>假設我們需要將所有資料表中的 <code>MaintainClassID</code> 欄位從 4851204 更新為 4851206。在大型資料庫中，這個欄位可能分散在多個資料表中。如何一次找出所有包含此欄位的資料表呢？</p>
<h1 id="解決方案"><a href="#解決方案" class="headerlink" title="解決方案"></a>解決方案</h1><p>我們可以利用 SQL Server 的 <code>INFORMATION_SCHEMA</code> 視圖來查詢資料庫結構，並產生所需的更新語句。讓我們一步步來看：</p>
<h2 id="步驟一：找出所有包含特定欄位的資料表"><a href="#步驟一：找出所有包含特定欄位的資料表" class="headerlink" title="步驟一：找出所有包含特定欄位的資料表"></a>步驟一：找出所有包含特定欄位的資料表</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 找到所有有該欄位的資料表</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span></span><br><span class="line">    t.TABLE_SCHEMA, <span class="comment">-- 資料表的架構名稱</span></span><br><span class="line">    t.TABLE_NAME   <span class="comment">-- 資料表名稱</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    INFORMATION_SCHEMA.COLUMNS c</span><br><span class="line">    <span class="keyword">INNER</span> <span class="keyword">JOIN</span></span><br><span class="line">    INFORMATION_SCHEMA.TABLES t </span><br><span class="line">        <span class="keyword">ON</span> c.TABLE_NAME <span class="operator">=</span> t.TABLE_NAME </span><br><span class="line">        <span class="keyword">AND</span> c.TABLE_SCHEMA <span class="operator">=</span> t.TABLE_SCHEMA</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    c.COLUMN_NAME <span class="operator">=</span> <span class="string">&#x27;MaintainClassID&#x27;</span> <span class="comment">-- 要查找的欄位名稱</span></span><br><span class="line">    <span class="keyword">AND</span> t.TABLE_TYPE <span class="operator">=</span> <span class="string">&#x27;BASE TABLE&#x27;</span>;  <span class="comment">-- 確保僅查找資料表，不包含視圖</span></span><br></pre></td></tr></table></figure>

<h3 id="程式碼解析："><a href="#程式碼解析：" class="headerlink" title="程式碼解析："></a>程式碼解析：</h3><ol>
<li><code>INFORMATION_SCHEMA.COLUMNS</code>：此視圖包含所有欄位的資訊</li>
<li><code>INFORMATION_SCHEMA.TABLES</code>：此視圖包含所有資料表的資訊</li>
<li><code>INNER JOIN</code>：合併兩個視圖的資料，確保欄位和資料表資訊相符</li>
<li><code>WHERE</code> 條件：<ul>
<li>指定要查找的欄位名稱</li>
<li><code>TABLE_TYPE = &#39;BASE TABLE&#39;</code> 過濾掉視圖，只保留實體資料表</li>
</ul>
</li>
</ol>
<h2 id="步驟二：產生更新語句"><a href="#步驟二：產生更新語句" class="headerlink" title="步驟二：產生更新語句"></a>步驟二：產生更新語句</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 產生更新語句</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="string">&#x27;UPDATE [&#x27;</span> <span class="operator">+</span> t.TABLE_SCHEMA <span class="operator">+</span> <span class="string">&#x27;].[&#x27;</span> <span class="operator">+</span> t.TABLE_NAME <span class="operator">+</span> </span><br><span class="line">    <span class="string">&#x27;] SET MaintainClassID = 4851206 WHERE MaintainClassID = 4851204;&#x27;</span></span><br><span class="line">    <span class="keyword">AS</span> UpdateStatement</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    INFORMATION_SCHEMA.COLUMNS c</span><br><span class="line">    <span class="keyword">INNER</span> <span class="keyword">JOIN</span></span><br><span class="line">    INFORMATION_SCHEMA.TABLES t </span><br><span class="line">        <span class="keyword">ON</span> c.TABLE_NAME <span class="operator">=</span> t.TABLE_NAME </span><br><span class="line">        <span class="keyword">AND</span> c.TABLE_SCHEMA <span class="operator">=</span> t.TABLE_SCHEMA</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    c.COLUMN_NAME <span class="operator">=</span> <span class="string">&#x27;MaintainClassID&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> t.TABLE_TYPE <span class="operator">=</span> <span class="string">&#x27;BASE TABLE&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> t.TABLE_NAME <span class="keyword">IN</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> TABLE_NAME</span><br><span class="line">        <span class="keyword">FROM</span> INFORMATION_SCHEMA.COLUMNS</span><br><span class="line">        <span class="keyword">WHERE</span> COLUMN_NAME <span class="operator">=</span> <span class="string">&#x27;MaintainClassID&#x27;</span></span><br><span class="line">    );</span><br></pre></td></tr></table></figure>

<h3 id="程式碼解析：-1"><a href="#程式碼解析：-1" class="headerlink" title="程式碼解析："></a>程式碼解析：</h3><ol>
<li>使用字串串接（<code>+</code>）來組合完整的 UPDATE 語句</li>
<li>加入方括號 <code>[]</code> 來處理可能包含特殊字元的架構名稱和資料表名稱</li>
<li>子查詢確保只更新有指定欄位的資料表</li>
</ol>
<h1 id="使用注意事項"><a href="#使用注意事項" class="headerlink" title="使用注意事項"></a>使用注意事項</h1><ol>
<li>執行更新前請先備份資料庫</li>
<li>建議先用 SELECT 語句測試確認影響的資料範圍</li>
<li>大量資料更新時要注意交易記錄檔的大小</li>
<li>考慮在非尖峰時段執行更新作業</li>
</ol>
<h1 id="實用擴展"><a href="#實用擴展" class="headerlink" title="實用擴展"></a>實用擴展</h1><p>這個技巧不只適用於更新，還可以用於：</p>
<ul>
<li>查找重複欄位名稱</li>
<li>檢查欄位定義一致性</li>
<li>產生資料庫文件</li>
<li>自動化資料庫維護工作</li>
</ul>
<h1 id="總結"><a href="#總結" class="headerlink" title="總結"></a>總結</h1><p>透過 <code>INFORMATION_SCHEMA</code> 視圖，我們可以輕鬆地管理和維護資料庫。這個技巧不僅節省時間，還能降低人為錯誤的風險。下次遇到需要大量更新資料的情況，就可以運用這個方法了！</p>
<h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sql/relational-databases/system-information-schema-views/system-information-schema-views-transact-sql">Microsoft SQL Server Documentation - INFORMATION_SCHEMA Views</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sql/ssms/sql-server-management-studio-ssms">SQL Server Management Studio 使用指南</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">【SQL Server密技】一次精通SELECT INTO批次建表，效能優化的絕佳解決方案！</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2024-12-12 18:16:00" itemprop="dateCreated datePublished" datetime="2024-12-12T18:16:00+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-12-19 11:44:16" itemprop="dateModified" datetime="2024-12-19T11:44:16+08:00">2024-12-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%B3%87%E6%96%99%E5%BA%AB/" itemprop="url" rel="index"><span itemprop="name">資料庫</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>2.1k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>2 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在處理大型資料庫時，有時候我們需要將一個大型資料表的資料分割成多個較小的資料表，以提升查詢效能或方便資料管理。本文將介紹如何使用SQL Server的SELECT INTO搭配批次處理來實現這個目標。</p>
<h1 id="SELECT-INTO-的神奇魔力"><a href="#SELECT-INTO-的神奇魔力" class="headerlink" title="SELECT INTO 的神奇魔力"></a>SELECT INTO 的神奇魔力</h1><p>SELECT INTO 是SQL Server提供的一個強大功能，它可以：</p>
<ol>
<li>根據查詢結果直接建立新的資料表</li>
<li>自動複製資料表結構</li>
<li>自動將資料寫入新表</li>
</ol>
<svg viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg">
  <rect width="800" height="500" fill="#f8f9fa"/>
  <rect x="350" y="30" width="100" height="60" rx="5" fill="#2196F3"/>
  <text x="400" y="65" text-anchor="middle" fill="white">來源資料表</text>
  <rect x="200" y="150" width="400" height="80" rx="5" fill="#FF9800"/>
  <text x="400" y="190" text-anchor="middle" fill="white">批次處理邏輯</text>
  <text x="400" y="210" text-anchor="middle" fill="white">每批500筆資料</text>
  <rect x="50" y="300" width="100" height="60" rx="5" fill="#4CAF50"/>
  <text x="100" y="335" text-anchor="middle" fill="white">資料表1</text>
  <rect x="200" y="300" width="100" height="60" rx="5" fill="#4CAF50"/>
  <text x="250" y="335" text-anchor="middle" fill="white">資料表2</text>
  <rect x="350" y="300" width="100" height="60" rx="5" fill="#4CAF50"/>
  <text x="400" y="335" text-anchor="middle" fill="white">資料表3</text>
  <rect x="500" y="300" width="100" height="60" rx="5" fill="#4CAF50"/>
  <text x="550" y="335" text-anchor="middle" fill="white">資料表4</text>
  <rect x="650" y="300" width="100" height="60" rx="5" fill="#4CAF50"/>
  <text x="700" y="335" text-anchor="middle" fill="white">資料表...</text>
  <path d="M400 90 L400 150" stroke="#333" stroke-width="2" marker-end="url(#arrow)"/>
  <path d="M400 230 L100 300" stroke="#333" stroke-width="2" marker-end="url(#arrow)"/>
  <path d="M400 230 L250 300" stroke="#333" stroke-width="2" marker-end="url(#arrow)"/>
  <path d="M400 230 L400 300" stroke="#333" stroke-width="2" marker-end="url(#arrow)"/>
  <path d="M400 230 L550 300" stroke="#333" stroke-width="2" marker-end="url(#arrow)"/>
  <path d="M400 230 L700 300" stroke="#333" stroke-width="2" marker-end="url(#arrow)"/>
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
      <path d="M0,0 L10,5 L0,10" fill="none" stroke="#333"/>
    </marker>
  </defs>
  <text x="450" y="120" text-anchor="start" fill="#666">讀取原始資料</text>
  <text x="450" y="270" text-anchor="start" fill="#666">依據ROW_NUMBER()分批建立新資料表</text>
</svg>

<h1 id="程式碼詳解"><a href="#程式碼詳解" class="headerlink" title="程式碼詳解"></a>程式碼詳解</h1><p>讓我們來看看完整的程式碼：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 宣告必要的變數</span></span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@StartRow</span> <span class="type">INT</span>,          <span class="comment">-- 目前處理批次的起始列號</span></span><br><span class="line">        <span class="variable">@EndRow</span> <span class="type">INT</span>,            <span class="comment">-- 目前處理批次的結束列號</span></span><br><span class="line">        <span class="variable">@BatchSize</span> <span class="type">INT</span>,         <span class="comment">-- 每批次處理的資料筆數</span></span><br><span class="line">        <span class="variable">@BatchNumber</span> <span class="type">INT</span>,       <span class="comment">-- 批次編號</span></span><br><span class="line">        <span class="variable">@TablePrefix</span> NVARCHAR(<span class="number">255</span>)  <span class="comment">-- 新建資料表的名稱前綴</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 設定初始值</span></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@StartRow</span> <span class="operator">=</span> <span class="number">1</span>              <span class="comment">-- 從第一筆資料開始</span></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@BatchSize</span> <span class="operator">=</span> <span class="number">500</span>           <span class="comment">-- 每個新資料表存放500筆資料</span></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@BatchNumber</span> <span class="operator">=</span> <span class="number">1</span>           <span class="comment">-- 批次編號從1開始</span></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@TablePrefix</span> <span class="operator">=</span> <span class="string">&#x27;UserInfo_Batch_&#x27;</span>  <span class="comment">-- 新資料表的名稱前綴</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用WHILE迴圈進行批次處理</span></span><br><span class="line">WHILE <span class="variable">@StartRow</span> <span class="operator">&lt;=</span> (<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> UserInfo)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 計算本批次的結束列號</span></span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@EndRow</span> <span class="operator">=</span> <span class="variable">@StartRow</span> <span class="operator">+</span> <span class="variable">@BatchSize</span> <span class="operator">-</span> <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 組合動態SQL：建立新的資料表</span></span><br><span class="line">    <span class="keyword">DECLARE</span> <span class="variable">@SQL</span> NVARCHAR(MAX)</span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@SQL</span> <span class="operator">=</span> <span class="string">&#x27;SELECT * INTO &#x27;</span> <span class="operator">+</span> <span class="variable">@TablePrefix</span> <span class="operator">+</span> </span><br><span class="line">               <span class="built_in">CAST</span>(<span class="variable">@BatchNumber</span> <span class="keyword">AS</span> NVARCHAR(<span class="number">10</span>)) <span class="operator">+</span> </span><br><span class="line">               <span class="string">&#x27; FROM (SELECT *, ROW_NUMBER() OVER (ORDER BY id) as RowNum &#x27;</span> <span class="operator">+</span></span><br><span class="line">               <span class="string">&#x27;FROM UserInfo) as SourceData &#x27;</span> <span class="operator">+</span></span><br><span class="line">               <span class="string">&#x27;WHERE SourceData.RowNum BETWEEN &#x27;</span> <span class="operator">+</span> </span><br><span class="line">               <span class="built_in">CAST</span>(<span class="variable">@StartRow</span> <span class="keyword">AS</span> NVARCHAR(<span class="number">10</span>)) <span class="operator">+</span> <span class="string">&#x27; AND &#x27;</span> <span class="operator">+</span> </span><br><span class="line">               <span class="built_in">CAST</span>(<span class="variable">@EndRow</span> <span class="keyword">AS</span> NVARCHAR(<span class="number">10</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 執行動態SQL：這會建立一個新的資料表並插入資料</span></span><br><span class="line">    <span class="keyword">EXEC</span> (<span class="variable">@SQL</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 更新下一批次的起始位置和批次編號</span></span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@StartRow</span> <span class="operator">=</span> <span class="variable">@EndRow</span> <span class="operator">+</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@BatchNumber</span> <span class="operator">=</span> <span class="variable">@BatchNumber</span> <span class="operator">+</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h1 id="重點解析"><a href="#重點解析" class="headerlink" title="重點解析"></a>重點解析</h1><h2 id="1-SELECT-INTO-的運作原理"><a href="#1-SELECT-INTO-的運作原理" class="headerlink" title="1. SELECT INTO 的運作原理"></a>1. SELECT INTO 的運作原理</h2><p>當我們執行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">INTO</span> 新資料表 <span class="keyword">FROM</span> 來源資料表</span><br></pre></td></tr></table></figure>
<p>SQL Server會：</p>
<ul>
<li>建立一個新的資料表</li>
<li>複製來源資料表的結構</li>
<li>將符合條件的資料寫入新表</li>
</ul>
<h2 id="2-批次處理的控制"><a href="#2-批次處理的控制" class="headerlink" title="2. 批次處理的控制"></a>2. 批次處理的控制</h2><ul>
<li>使用ROW_NUMBER()給每一列編號</li>
<li>利用BETWEEN來控制每批次的資料範圍</li>
<li>每批次500筆資料，避免資源過度消耗</li>
</ul>
<h2 id="3-動態SQL的組合"><a href="#3-動態SQL的組合" class="headerlink" title="3. 動態SQL的組合"></a>3. 動態SQL的組合</h2><p>程式動態產生建表指令，這讓我們能夠：</p>
<ul>
<li>動態指定新資料表名稱</li>
<li>靈活控制每個批次的資料範圍</li>
<li>方便擴充其他條件</li>
</ul>
<h1 id="執行結果說明"><a href="#執行結果說明" class="headerlink" title="執行結果說明"></a>執行結果說明</h1><p>執行此程式後，會產生多個資料表：</p>
<ul>
<li>Data_1（第1-500筆資料）</li>
<li>Data_2（第501-1000筆資料）</li>
<li>Data_3（第1001-1500筆資料）<br>...以此類推</li>
</ul>
<h1 id="實用技巧"><a href="#實用技巧" class="headerlink" title="實用技巧"></a>實用技巧</h1><ol>
<li><p><strong>命名策略</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 建議使用有意義的命名方式</span></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@SQL</span> <span class="operator">=</span> <span class="string">&#x27;SELECT * INTO UserInfo_Batch_&#x27;</span> <span class="operator">+</span> </span><br><span class="line">           <span class="built_in">CAST</span>(<span class="variable">@FileNumber</span> <span class="keyword">AS</span> NVARCHAR(<span class="number">10</span>)) <span class="operator">+</span> </span><br><span class="line">           <span class="string">&#x27; FROM ...&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>加入錯誤處理</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span> TRY</span><br><span class="line">    <span class="keyword">EXEC</span> (<span class="variable">@SQL</span>)</span><br><span class="line"><span class="keyword">END</span> TRY</span><br><span class="line"><span class="keyword">BEGIN</span> CATCH</span><br><span class="line">    <span class="comment">-- 處理錯誤</span></span><br><span class="line">    <span class="keyword">SELECT</span> ERROR_MESSAGE()</span><br><span class="line"><span class="keyword">END</span> CATCH</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="效能優化建議"><a href="#效能優化建議" class="headerlink" title="效能優化建議"></a>效能優化建議</h1><ol>
<li>在批次處理之前先建立適當的索引</li>
<li>根據系統資源調整批次大小</li>
<li>考慮在非尖峰時段執行</li>
<li>監控資料庫效能指標</li>
</ol>
<h1 id="應用場景"><a href="#應用場景" class="headerlink" title="應用場景"></a>應用場景</h1><ol>
<li>大型資料表分割</li>
<li>資料庫維護</li>
<li>效能優化</li>
<li>資料歸檔</li>
</ol>
<h1 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h1><ol>
<li><p><strong>檢查空間</strong></p>
<ul>
<li>確認資料庫有足夠空間存放新建立的資料表</li>
<li>考慮日誌檔案的成長</li>
</ul>
</li>
<li><p><strong>命名衝突</strong></p>
<ul>
<li>執行前檢查是否已存在相同名稱的資料表</li>
<li>建立命名規則避免衝突</li>
</ul>
</li>
<li><p><strong>權限設定</strong></p>
<ul>
<li>確認執行帳號具有建立資料表的權限</li>
<li>設定適當的資料表存取權限</li>
</ul>
</li>
</ol>
<h1 id="疑難排解"><a href="#疑難排解" class="headerlink" title="疑難排解"></a>疑難排解</h1><p>如果遇到以下問題：</p>
<ol>
<li><p><strong>執行逾時</strong></p>
<ul>
<li>調整批次大小</li>
<li>檢查資料庫設定</li>
</ul>
</li>
<li><p><strong>空間不足</strong></p>
<ul>
<li>清理不需要的資料</li>
<li>擴充資料庫空間</li>
</ul>
</li>
<li><p><strong>權限錯誤</strong></p>
<ul>
<li>檢查帳號權限</li>
<li>聯絡資料庫管理員</li>
</ul>
</li>
</ol>
<h1 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h1><p>透過SELECT INTO的批次處理機制，我們可以有效地將大型資料表分割成多個較小的資料表。這個方法不只解決了效能問題，還提供了更靈活的資料管理方式。建議在實務應用時，根據實際需求調整批次大小和命名規則。</p>
<h1 id="參考資源"><a href="#參考資源" class="headerlink" title="參考資源"></a>參考資源</h1><ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sql/t-sql/queries/select-into-clause-transact-sql">SQL Server官方文件-SELECT INTO</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sql/relational-databases/performance/performance-center-for-sql-server-database-engine-and-azure-sql-database">SQL Server效能優化指南</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">在本機免費運行 AI 大模型的開源神器 Ollama</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>
      

      <time title="創建時間：2024-12-11 18:16:34 / 修改時間：15:47:06" itemprop="dateCreated datePublished" datetime="2024-12-11T18:16:34+08:00">2024-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/AI%E6%87%89%E7%94%A8/" itemprop="url" rel="index"><span itemprop="name">AI應用</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>1.4k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>1 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>隨著 AI 技術的快速發展,大型語言模型(LLM)的應用越來越廣泛。然而,要在本機運行這些模型往往需要複雜的環境設定與昂貴的硬體設備。今天要介紹的 Ollama 就是一個能讓你輕鬆在本機運行各種開源 AI 模型的神器!</p>
<h2 id="Ollama-是什麼"><a href="#Ollama-是什麼" class="headerlink" title="Ollama 是什麼?"></a>Ollama 是什麼?</h2><p>Ollama 是一個開源的 LLM 運行工具,它的主要特色包括:</p>
<ul>
<li>簡單易用的安裝流程</li>
<li>支援多種開源模型</li>
<li>優秀的效能最佳化</li>
<li>完整的 API 支援</li>
<li>活躍的社群支援</li>
</ul>
<h1 id="安裝教學"><a href="#安裝教學" class="headerlink" title="安裝教學"></a>安裝教學</h1><h2 id="系統需求"><a href="#系統需求" class="headerlink" title="系統需求"></a>系統需求</h2><ul>
<li>作業系統: Windows/macOS/Linux</li>
<li>RAM: 建議至少 8GB</li>
<li>硬碟空間: 依照模型大小,建議預留 10GB 以上</li>
</ul>
<h2 id="安裝步驟"><a href="#安裝步驟" class="headerlink" title="安裝步驟"></a>安裝步驟</h2><h3 id="Windows-安裝"><a href="#Windows-安裝" class="headerlink" title="Windows 安裝"></a>Windows 安裝</h3><ol>
<li>從 <a target="_blank" rel="noopener" href="https://ollama.ai/">Ollama 官網</a> 下載 Windows 安裝檔</li>
<li>執行安裝檔,依照指示完成安裝</li>
<li>開啟命令提示字元確認安裝成功:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ollama --version</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="macOS-安裝"><a href="#macOS-安裝" class="headerlink" title="macOS 安裝"></a>macOS 安裝</h3><p>使用 Homebrew 安裝:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install ollama</span><br></pre></td></tr></table></figure>

<h3 id="Linux-安裝"><a href="#Linux-安裝" class="headerlink" title="Linux 安裝"></a>Linux 安裝</h3><p>使用官方腳本安裝:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://ollama.ai/install.sh | sh</span><br></pre></td></tr></table></figure>

<h1 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h1><h2 id="下載模型"><a href="#下載模型" class="headerlink" title="下載模型"></a>下載模型</h2><p>Ollama 支援多種開源模型,以下是常用的指令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下載 Llama 2 模型</span></span><br><span class="line">ollama pull llama2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下載輕量版模型</span></span><br><span class="line">ollama pull llama2-uncensored</span><br></pre></td></tr></table></figure>

<h2 id="開始對話"><a href="#開始對話" class="headerlink" title="開始對話"></a>開始對話</h2><p>執行以下指令開始與模型對話:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ollama run llama2</span><br></pre></td></tr></table></figure>

<h2 id="常用指令範例"><a href="#常用指令範例" class="headerlink" title="常用指令範例"></a>常用指令範例</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出已安裝的模型</span></span><br><span class="line">ollama list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刪除模型</span></span><br><span class="line">ollama <span class="built_in">rm</span> llama2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 匯出模型</span></span><br><span class="line">ollama <span class="built_in">export</span> llama2 &gt; llama2.tar</span><br></pre></td></tr></table></figure>

<h1 id="進階應用"><a href="#進階應用" class="headerlink" title="進階應用"></a>進階應用</h1><h2 id="使用-API"><a href="#使用-API" class="headerlink" title="使用 API"></a>使用 API</h2><p>Ollama 提供了完整的 REST API,讓你能輕鬆整合到自己的應用中:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python 範例</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chat_with_model</span>(<span class="params">prompt</span>):</span><br><span class="line">    url = <span class="string">&#x27;http://localhost:11434/api/generate&#x27;</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&#x27;model&#x27;</span>: <span class="string">&#x27;llama2&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;prompt&#x27;</span>: prompt</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    response = requests.post(url, json=data)</span><br><span class="line">    <span class="keyword">return</span> response.json()[<span class="string">&#x27;response&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用範例</span></span><br><span class="line">result = chat_with_model(<span class="string">&quot;解釋什麼是人工智慧&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure>

<h2 id="自訂模型設定"><a href="#自訂模型設定" class="headerlink" title="自訂模型設定"></a>自訂模型設定</h2><p>你可以透過建立模型設定檔來自訂模型行為:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># modelfile</span></span><br><span class="line"><span class="string">FROM</span> <span class="string">llama2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 設定系統提示</span></span><br><span class="line"><span class="string">SYSTEM</span> <span class="string">&quot;你是一個熱心助人的 AI 助手&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 設定參數</span></span><br><span class="line"><span class="string">PARAMETER</span> <span class="string">temperature</span> <span class="number">0.7</span></span><br><span class="line"><span class="string">PARAMETER</span> <span class="string">top_p</span> <span class="number">0.9</span></span><br></pre></td></tr></table></figure>

<h1 id="常見問題與解決方案"><a href="#常見問題與解決方案" class="headerlink" title="常見問題與解決方案"></a>常見問題與解決方案</h1><ol>
<li>記憶體不足</li>
</ol>
<ul>
<li>解決方案: 使用較小的模型或增加虛擬記憶體</li>
</ul>
<ol start="2">
<li>模型下載失敗</li>
</ol>
<ul>
<li>解決方案: 檢查網路連線或使用代理伺服器</li>
</ul>
<ol start="3">
<li>API 連線問題</li>
</ol>
<ul>
<li>解決方案: 確認 Ollama 服務是否正常運行</li>
</ul>
<h1 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h1><p>Ollama 讓在本機運行 AI 大模型變得前所未有的簡單。無論是研究、學習還是開發,都能透過 Ollama 輕鬆體驗 AI 技術的魅力。希望這篇教學能幫助你開始探索 AI 的世界!</p>
<h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://ollama.ai/">Ollama 官方</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ollama/ollama">Ollama GitHub</a></li>
<li><a target="_blank" rel="noopener" href="https://python.langchain.com/docs/integrations/llms/ollama">LangChain 整合教學</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">解決 C 槽爆炸危機！把 Ollama 模型檔案搬到 D 槽</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>
      

      <time title="創建時間：2024-12-11 12:00:00 / 修改時間：16:21:26" itemprop="dateCreated datePublished" datetime="2024-12-11T12:00:00+08:00">2024-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/AI%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">AI工具</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>647</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>1 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="為什麼要移動-Ollama-模型？"><a href="#為什麼要移動-Ollama-模型？" class="headerlink" title="為什麼要移動 Ollama 模型？"></a>為什麼要移動 Ollama 模型？</h2><p>Ollama 是一個強大的本地端 AI 模型執行工具，但預設將所有模型檔案都存放在 C 槽，隨著下載的模型越來越多，很容易造成系統碟空間不足。本教學將帶你一步步將模型檔案移動到 D 槽，讓你的 C 槽重獲新生！</p>
<h2 id="移動前的準備工作"><a href="#移動前的準備工作" class="headerlink" title="移動前的準備工作"></a>移動前的準備工作</h2><ol>
<li>確認 D 槽有足夠空間</li>
<li>先關閉所有正在運行的 Ollama 程序</li>
<li>備份重要的模型設定（建議）</li>
</ol>
<h2 id="詳細移動步驟"><a href="#詳細移動步驟" class="headerlink" title="詳細移動步驟"></a>詳細移動步驟</h2><h3 id="步驟一：建立新的存放位置"><a href="#步驟一：建立新的存放位置" class="headerlink" title="步驟一：建立新的存放位置"></a>步驟一：建立新的存放位置</h3><ol>
<li>在 D 槽建立新的資料夾：<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D:</span></span><br><span class="line"><span class="function"><span class="title">mkdir</span> <span class="title">D</span>:\<span class="title">Ollama</span></span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="步驟二：移動現有模型"><a href="#步驟二：移動現有模型" class="headerlink" title="步驟二：移動現有模型"></a>步驟二：移動現有模型</h3><ol>
<li><p>打開檔案總管，預設模型位置在：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\[使用者名稱]\.ollama</span><br></pre></td></tr></table></figure></li>
<li><p>將 <code>.ollama</code> 資料夾內的所有檔案複製到 D:\Ollama</p>
</li>
</ol>
<h3 id="步驟三：設定環境變數"><a href="#步驟三：設定環境變數" class="headerlink" title="步驟三：設定環境變數"></a>步驟三：設定環境變數</h3><ol>
<li>按下 Windows + R</li>
<li>輸入 <code>sysdm.cpl</code> 開啟系統內容</li>
<li>切換到「進階」頁籤</li>
<li>點選「環境變數」</li>
<li>在「系統變數」區域中新增：<ul>
<li>變數名稱：<code>OLLAMA_MODELS</code></li>
<li>變數值：<code>D:\Ollama</code></li>
</ul>
</li>
</ol>
<h3 id="步驟四：驗證設定"><a href="#步驟四：驗證設定" class="headerlink" title="步驟四：驗證設定"></a>步驟四：驗證設定</h3><ol>
<li>重新啟動 Ollama</li>
<li>執行以下指令確認模型可以正常使用：<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ollama list</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="常見問題解答"><a href="#常見問題解答" class="headerlink" title="常見問題解答"></a>常見問題解答</h2><h3 id="Q1：移動後模型無法使用怎麼辦？"><a href="#Q1：移動後模型無法使用怎麼辦？" class="headerlink" title="Q1：移動後模型無法使用怎麼辦？"></a>Q1：移動後模型無法使用怎麼辦？</h3><p>確認環境變數是否正確設定，並重新啟動電腦試試看。</p>
<h3 id="Q2：要如何確認移動成功？"><a href="#Q2：要如何確認移動成功？" class="headerlink" title="Q2：要如何確認移動成功？"></a>Q2：要如何確認移動成功？</h3><p>檢查 D:\Ollama 資料夾的大小，應該要和原本 C 槽的 .ollama 資料夾大小相近。</p>
<h3 id="Q3：移動過程中可以取消嗎？"><a href="#Q3：移動過程中可以取消嗎？" class="headerlink" title="Q3：移動過程中可以取消嗎？"></a>Q3：移動過程中可以取消嗎？</h3><p>建議一次完成所有步驟，中途取消可能會造成模型檔案不完整。</p>
<h2 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h2><ul>
<li>移動過程中請勿關機或重新啟動電腦</li>
<li>確保有足夠的磁碟空間</li>
<li>建議在移動前先備份重要的模型檔案</li>
</ul>
<h2 id="參考資源"><a href="#參考資源" class="headerlink" title="參考資源"></a>參考資源</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/ollama/ollama">Ollama 官方文件</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ollama/ollama/blob/main/docs/configuration.md">Ollama 環境變數設定說明</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一頁" aria-label="上一頁" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" title="下一頁" aria-label="下一頁" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">null </a>
  </div>
  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">kyosora</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="總字數">303k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="所需總閱讀時間">4:35</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="訪客總數">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="總瀏覽次數">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 強力驅動
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="回到頂端">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/yourname" class="github-corner" title="在 GitHub 上關注我" aria-label="在 GitHub 上關注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":null,"repo":null,"client_id":null,"client_secret":null,"admin_user":null,"distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"0fbab7edd0d4dab4bf31d3d31408c245"}</script>
<script src="/js/third-party/comments/gitalk.js" defer></script>
<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"kyosora/kyosora.github.io","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js" defer></script>

</body>
</html>
