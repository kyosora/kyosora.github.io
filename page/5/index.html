<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous" defer></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"kyosora.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.25.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":null},"fold":{"enable":true,"height":500},"language":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜尋...","empty":"我們無法找到任何有關 ${query} 的搜索結果","hits_time":"找到 ${hits} 個搜索結果（用時 ${time} 毫秒）","hits":"找到 ${hits} 個搜索結果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="個人技術筆記和學習心得分享">
<meta property="og:type" content="website">
<meta property="og:title" content="kyosora 虛空筆記">
<meta property="og:url" content="https://kyosora.github.io/page/5/">
<meta property="og:site_name" content="kyosora 虛空筆記">
<meta property="og:description" content="個人技術筆記和學習心得分享">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="kyosora">
<meta property="article:tag" content="網路安全, 系統管理, 程式設計, 技術筆記">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://kyosora.github.io/page/5/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-TW","comments":"","permalink":"","path":"page/5/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>kyosora 虛空筆記</title>
  





  <script class="next-config" data-name="matomo" type="application/json">{"enable":true,"server_url":null,"site_id":null}</script>
  <script src="/js/third-party/analytics/matomo.js" defer></script>

  <script async defer data-website-id="" src=""></script>

  <script defer data-domain="" src=""></script>

  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/comments.js" defer></script><script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="/js/bookmark.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/algoliasearch/5.36.0/lite/builds/browser.umd.js" integrity="sha256-o49zoHLDPBm9WLg6AiliAVi3axCRTqe3ltTxLvhzAVg=" crossorigin="anonymous" defer></script><script src="/js/third-party/search/algolia-search.js" defer></script>
<script class="next-config" data-name="chatra" type="application/json">{"enable":true,"async":true,"id":null}</script>
<script src="/js/third-party/chat/chatra.js" defer></script>
<script async src="https://call.chatra.io/chatra.js"></script>

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.3.1/pdfobject.min.js","integrity":"sha256-jI72I8ZLVflVOisZIOaLvRew3tyvzeu6aZXFm7P7dEo="},"url":"/lib/pdf/web/viewer"}</script>
  <script src="/js/third-party/tags/pdf.js" defer></script>

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.10.1/mermaid.min.js","integrity":"sha256-BmQmdWDS8X2OTbrwELWK366LV6escyWhHHe0XCTU/Hk="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>

  <script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/wavedrom.min.js","integrity":"sha256-INLAoJc6quTNfiMWkGZniYO2cxE8mHpddnLow1m6RFs="}}</script>
  <script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script>
  <script src="/js/third-party/tags/wavedrom.js" defer></script>


  <script src="/js/third-party/pace.js" defer></script>

  <script src="/js/third-party/addtoany.js" defer></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/12.2.1/firebase-app-compat.js" integrity="sha256-d21UgtIcA6c6qwr8nWk6lxs/KrpbWhknQN7qBjWA2Kk=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/12.2.1/firebase-firestore-compat.js" integrity="sha256-leHatffkFuVGIg7ABaA5BDsqsEUtktL4tftb3OdQfg0=" crossorigin="anonymous" defer></script>
  <script class="next-config" data-name="firestore" type="application/json">{"enable":true,"collection":"articles","apiKey":null,"projectId":null}</script>
  <script src="/js/third-party/statistics/firestore.js" defer></script>



  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js" defer></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/3.0.1/quicklink.umd.js" integrity="sha256-44BednzIpUeQJcY8qtLyarFu0UCCTbgmWOvaoehiFQQ=" crossorigin="anonymous" defer></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":false,"home":false,"archive":false,"delay":true,"timeout":3000,"priority":true,"url":"https://kyosora.github.io/page/5/"}</script>
  <script src="/js/third-party/quicklink.js" defer></script>

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">kyosora 虛空筆記</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">技術探索與學習分享</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜尋" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜尋..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fab fa-algolia fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">kyosora</p>
  <div class="site-description" itemprop="description">個人技術筆記和學習心得分享</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">110</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">分類</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">155</span>
        <span class="site-state-item-name">標籤</span>
      </div>
  </nav>
</div>
  <div class="sidebar-button animated">
    <button><i class="fa fa-comment"></i>
      聊天
    </button>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">IIS環境下使用C#操作LibreOffice進行檔案轉換</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2024-11-02 18:57:14" itemprop="dateCreated datePublished" datetime="2024-11-02T18:57:14+08:00">2024-11-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-11-27 14:41:34" itemprop="dateModified" datetime="2024-11-27T14:41:34+08:00">2024-11-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A8%8B%E5%BC%8F%E6%95%99%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">程式教學</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>5.9k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>5 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="在-IIS-環境下使用-C-操作-LibreOffice-進行檔案轉換"><a href="#在-IIS-環境下使用-C-操作-LibreOffice-進行檔案轉換" class="headerlink" title="在 IIS 環境下使用 C# 操作 LibreOffice 進行檔案轉換"></a>在 IIS 環境下使用 C# 操作 LibreOffice 進行檔案轉換</h1><h2 id="問題背景"><a href="#問題背景" class="headerlink" title="問題背景"></a>問題背景</h2><p>在 Web 應用程式中，我們經常需要提供檔案格式轉換的功能。本文將詳細說明如何在 IIS 環境下，使用 C# 程式碼呼叫 LibreOffice 進行檔案格式轉換（例如：Excel 轉 ODS），並完整解決執行過程中可能遇到的權限問題。</p>
<h2 id="環境需求"><a href="#環境需求" class="headerlink" title="環境需求"></a>環境需求</h2><ol>
<li>Windows Server 環境</li>
<li>IIS 網頁伺服器</li>
<li>LibreOffice 套件</li>
<li>.NET Framework 開發環境</li>
</ol>
<h2 id="可能遇到的問題"><a href="#可能遇到的問題" class="headerlink" title="可能遇到的問題"></a>可能遇到的問題</h2><ol>
<li>使用一般使用者帳號無法執行轉換</li>
<li>IIS ApplicationPool 權限不足</li>
<li>檔案轉換過程沒有回應</li>
<li>程式執行但找不到輸出檔案</li>
<li>權限不足導致程式無法執行</li>
</ol>
<h2 id="完整解決方案"><a href="#完整解決方案" class="headerlink" title="完整解決方案"></a>完整解決方案</h2><h3 id="1-IIS-應用程式集區設定"><a href="#1-IIS-應用程式集區設定" class="headerlink" title="1. IIS 應用程式集區設定"></a>1. IIS 應用程式集區設定</h3><p>首先確認 IIS 應用程式集區的設定：</p>
<ol>
<li>開啟 IIS 管理員</li>
<li>找到您的應用程式集區（例如：DefaultAppPool）</li>
<li>右鍵 → 進階設定</li>
<li>設定以下項目：<ul>
<li>載入使用者設定檔 = True</li>
<li>識別 = ApplicationPoolIdentity</li>
</ul>
</li>
</ol>
<h3 id="2-Windows-使用者權限指派"><a href="#2-Windows-使用者權限指派" class="headerlink" title="2. Windows 使用者權限指派"></a>2. Windows 使用者權限指派</h3><p>設定執行檔案轉換的使用者權限：</p>
<ol>
<li><p>開啟「本機安全性原則」</p>
<ul>
<li>按 Windows + R</li>
<li>輸入 secpol.msc</li>
<li>按確定</li>
</ul>
</li>
<li><p>在左側樹狀目錄中依序展開</p>
<ul>
<li>安全性設定</li>
<li>本機原則</li>
<li>使用者權限指派</li>
</ul>
</li>
<li><p>設定下列權限（對於您要使用的帳號，例如 IIS APPPOOL\DefaultAppPool 或特定使用者帳號）</p>
<ul>
<li><p>找到「以批次工作登入」（Log on as a batch job）</p>
<ul>
<li>按右鍵 → 內容</li>
<li>點選「新增使用者或群組」</li>
<li>加入使用者帳號</li>
</ul>
</li>
<li><p>找到「以服務方式登入」（Log on as a service）</p>
<ul>
<li>按右鍵 → 內容</li>
<li>點選「新增使用者或群組」</li>
<li>加入使用者帳號</li>
</ul>
</li>
<li><p>找到「允許本機登入」（Allow log on locally）</p>
<ul>
<li>按右鍵 → 內容</li>
<li>點選「新增使用者或群組」</li>
<li>加入使用者帳號</li>
</ul>
</li>
</ul>
</li>
<li><p>如果使用 IIS APPPOOL\DefaultAppPool</p>
<ul>
<li>上述三個權限都要加入 IIS APPPOOL\DefaultAppPool</li>
<li>特別注意「以批次工作登入」這個權限一定要加入</li>
</ul>
</li>
</ol>
<h3 id="3-資料夾權限設定"><a href="#3-資料夾權限設定" class="headerlink" title="3. 資料夾權限設定"></a>3. 資料夾權限設定</h3><p>為執行帳號設定適當的資料夾權限：</p>
<ol>
<li>在以下資料夾按右鍵 → 內容 → 安全性 → 編輯</li>
<li>點選「新增」，輸入您使用的帳號（例如：IIS APPPOOL\DefaultAppPool）</li>
<li>給予以下權限：<ul>
<li>讀取權限</li>
<li>寫入權限</li>
<li>執行權限</li>
</ul>
</li>
</ol>
<p>需要設定的資料夾：</p>
<ul>
<li>LibreOffice 安裝目錄（通常是 C:\Program Files\LibreOffice）</li>
<li>轉換檔案的來源資料夾</li>
<li>轉換檔案的目標資料夾</li>
<li>暫存資料夾（例如：D:\temp）</li>
</ul>
<h3 id="4-程式碼實作"><a href="#4-程式碼實作" class="headerlink" title="4. 程式碼實作"></a>4. 程式碼實作</h3><p>以下是完整的程式碼實作，包含詳細的錯誤處理和記錄：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel;</span><br><span class="line"><span class="keyword">using</span> System.Security;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ImpersonateUser</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Windows API 常數定義</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> LOGON32_LOGON_INTERACTIVE = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> LOGON32_PROVIDER_DEFAULT = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> LOGON32_LOGON_BATCH = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">DllImport(<span class="string">&quot;advapi32.dll&quot;</span>, SetLastError = true)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">bool</span> <span class="title">LogonUser</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">string</span> lpszUsername,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">string</span> lpszDomain,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">string</span> lpszPassword,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">int</span> dwLogonType,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">int</span> dwLogonProvider,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">out</span> IntPtr phToken</span>)</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">DllImport(<span class="string">&quot;advapi32.dll&quot;</span>, SetLastError = true)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">bool</span> <span class="title">ImpersonateLoggedOnUser</span>(<span class="params">IntPtr hToken</span>)</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">DllImport(<span class="string">&quot;advapi32.dll&quot;</span>, SetLastError = true)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">bool</span> <span class="title">RevertToSelf</span>()</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">DllImport(<span class="string">&quot;kernel32.dll&quot;</span>, SetLastError = true)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">bool</span> <span class="title">CloseHandle</span>(<span class="params">IntPtr hObject</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ConvertFile</span>(<span class="params"><span class="built_in">string</span> sourcePath, <span class="built_in">string</span> destPath, <span class="built_in">string</span> Format</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> sofficePath = <span class="string">@&quot;C:\Program Files\LibreOffice\program\soffice.exe&quot;</span>;</span><br><span class="line">        Process process = <span class="literal">null</span>;</span><br><span class="line">        IntPtr tokenHandle = IntPtr.Zero;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            XLogFile.WriteLog(<span class="string">$&quot;原始執行身份: <span class="subst">&#123;System.Security.Principal.WindowsIdentity.GetCurrent().Name&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 取得使用者認證</span></span><br><span class="line">            <span class="built_in">string</span> userName = ConfigurationManager.AppSettings[<span class="string">&quot;SystemAccount&quot;</span>].ToString();</span><br><span class="line">            <span class="built_in">string</span> password = ConfigurationManager.AppSettings[<span class="string">&quot;SystemPassword&quot;</span>].ToString();</span><br><span class="line">            <span class="built_in">string</span> domain = <span class="string">&quot;.&quot;</span>; <span class="comment">// 本機帳號使用 &quot;.&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 嘗試登入並取得權杖</span></span><br><span class="line">            <span class="built_in">bool</span> loginSuccess = LogonUser(</span><br><span class="line">                userName,</span><br><span class="line">                domain,</span><br><span class="line">                password,</span><br><span class="line">                LOGON32_LOGON_INTERACTIVE,</span><br><span class="line">                LOGON32_PROVIDER_DEFAULT,</span><br><span class="line">                <span class="keyword">out</span> tokenHandle);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!loginSuccess)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> error = Marshal.GetLastWin32Error();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Win32Exception(error, <span class="string">$&quot;LogonUser 失敗. 錯誤碼: <span class="subst">&#123;error&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 模擬使用者</span></span><br><span class="line">            <span class="keyword">if</span> (!ImpersonateLoggedOnUser(tokenHandle))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> error = Marshal.GetLastWin32Error();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Win32Exception(error, <span class="string">&quot;ImpersonateLoggedOnUser 失敗&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XLogFile.WriteLog(<span class="string">$&quot;切換後執行身份: <span class="subst">&#123;System.Security.Principal.WindowsIdentity.GetCurrent().Name&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 設定程序啟動資訊</span></span><br><span class="line">            ProcessStartInfo startInfo = <span class="keyword">new</span> ProcessStartInfo();</span><br><span class="line">            startInfo.FileName = sofficePath;</span><br><span class="line">            startInfo.Arguments = <span class="string">$&quot;--headless --convert-to \&quot;<span class="subst">&#123;Format&#125;</span>\&quot; \&quot;<span class="subst">&#123;sourcePath&#125;</span>\&quot; --outdir \&quot;<span class="subst">&#123;Path.GetDirectoryName(destPath)&#125;</span>\&quot;&quot;</span>;</span><br><span class="line">            startInfo.UseShellExecute = <span class="literal">false</span>;</span><br><span class="line">            startInfo.RedirectStandardOutput = <span class="literal">true</span>;</span><br><span class="line">            startInfo.RedirectStandardError = <span class="literal">true</span>;</span><br><span class="line">            startInfo.CreateNoWindow = <span class="literal">true</span>;</span><br><span class="line">            startInfo.WorkingDirectory = Path.GetDirectoryName(sourcePath);</span><br><span class="line"></span><br><span class="line">            XLogFile.WriteLog(<span class="string">$&quot;完整命令: <span class="subst">&#123;startInfo.FileName&#125;</span> <span class="subst">&#123;startInfo.Arguments&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 執行程序</span></span><br><span class="line">            process = <span class="keyword">new</span> Process();</span><br><span class="line">            process.StartInfo = startInfo;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 處理輸出</span></span><br><span class="line">            process.OutputDataReceived += (sender, e) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(e.Data))</span><br><span class="line">                    XLogFile.WriteLog(<span class="string">$&quot;程序輸出: <span class="subst">&#123;e.Data&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;;</span><br><span class="line">            process.ErrorDataReceived += (sender, e) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(e.Data))</span><br><span class="line">                    XLogFile.WriteLog(<span class="string">$&quot;程序錯誤: <span class="subst">&#123;e.Data&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            process.Start();</span><br><span class="line">            process.BeginOutputReadLine();</span><br><span class="line">            process.BeginErrorReadLine();</span><br><span class="line">            process.WaitForExit();</span><br><span class="line"></span><br><span class="line">            XLogFile.WriteLog(<span class="string">$&quot;程序結束代碼: <span class="subst">&#123;process.ExitCode&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 檢查輸出檔案</span></span><br><span class="line">            <span class="built_in">string</span> expectedOutputFile = Path.Combine(</span><br><span class="line">                Path.GetDirectoryName(destPath),</span><br><span class="line">                Path.GetFileNameWithoutExtension(sourcePath) + <span class="string">&quot;.&quot;</span> + Format);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (File.Exists(expectedOutputFile))</span><br><span class="line">            &#123;</span><br><span class="line">                XLogFile.WriteLog(<span class="string">&quot;檔案轉換成功&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                XLogFile.WriteLog(<span class="string">&quot;警告：找不到輸出檔案&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            XLogFile.WriteLog(<span class="string">$&quot;轉換過程發生錯誤: <span class="subst">&#123;ex.ToString()&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 清理資源</span></span><br><span class="line">            <span class="keyword">if</span> (process != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                process.Close();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 恢復原始身份</span></span><br><span class="line">            RevertToSelf();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 關閉權杖</span></span><br><span class="line">            <span class="keyword">if</span> (tokenHandle != IntPtr.Zero)</span><br><span class="line">            &#123;</span><br><span class="line">                CloseHandle(tokenHandle);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-Web-config-設定"><a href="#5-Web-config-設定" class="headerlink" title="5. Web.config 設定"></a>5. Web.config 設定</h3><p>在 Web.config 中加入使用者帳號設定：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appSettings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">add</span> <span class="attr">key</span>=<span class="string">&quot;SystemAccount&quot;</span> <span class="attr">value</span>=<span class="string">&quot;您的使用者帳號&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">add</span> <span class="attr">key</span>=<span class="string">&quot;SystemPassword&quot;</span> <span class="attr">value</span>=<span class="string">&quot;您的密碼&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appSettings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-使用方式"><a href="#6-使用方式" class="headerlink" title="6. 使用方式"></a>6. 使用方式</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 呼叫範例</span></span><br><span class="line">ImpersonateUser.ConvertFile(</span><br><span class="line">    <span class="string">@&quot;D:\Source\test.xlsx&quot;</span>,           <span class="comment">// 來源檔案路徑</span></span><br><span class="line">    <span class="string">@&quot;D:\Destination\test.ods&quot;</span>,       <span class="comment">// 目標檔案路徑</span></span><br><span class="line">    <span class="string">&quot;ods&quot;</span>                             <span class="comment">// 轉換格式</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h2 id="完整檢查清單"><a href="#完整檢查清單" class="headerlink" title="完整檢查清單"></a>完整檢查清單</h2><p>設定完成後，使用以下清單檢查是否已完成所有必要設定：</p>
<ol>
<li><p>IIS 設定</p>
<ul>
<li><input disabled="" type="checkbox"> 應用程式集區載入使用者設定檔設為 True</li>
<li><input disabled="" type="checkbox"> 應用程式集區識別設定正確</li>
</ul>
</li>
<li><p>資料夾權限</p>
<ul>
<li><input disabled="" type="checkbox"> LibreOffice 安裝目錄權限</li>
<li><input disabled="" type="checkbox"> 來源資料夾權限</li>
<li><input disabled="" type="checkbox"> 目標資料夾權限</li>
<li><input disabled="" type="checkbox"> 暫存資料夾權限</li>
</ul>
</li>
<li><p>使用者權限指派</p>
<ul>
<li><input disabled="" type="checkbox"> 以批次工作登入</li>
<li><input disabled="" type="checkbox"> 以服務方式登入</li>
<li><input disabled="" type="checkbox"> 允許本機登入</li>
</ul>
</li>
<li><p>Web.config 設定</p>
<ul>
<li><input disabled="" type="checkbox"> SystemAccount 設定正確</li>
<li><input disabled="" type="checkbox"> SystemPassword 設定正確</li>
</ul>
</li>
</ol>
<h2 id="常見問題排除"><a href="#常見問題排除" class="headerlink" title="常見問題排除"></a>常見問題排除</h2><ol>
<li><p>程式沒有回應</p>
<ul>
<li>檢查 IIS 應用程式集區的識別設定</li>
<li>確認資料夾權限設定</li>
<li>查看事件檢視器中的錯誤記錄</li>
</ul>
</li>
<li><p>找不到輸出檔案</p>
<ul>
<li>確認目標資料夾的寫入權限</li>
<li>檢查 LibreOffice 是否正確安裝</li>
<li>查看記錄檔中的錯誤訊息</li>
</ul>
</li>
<li><p>權限不足</p>
<ul>
<li>確認已設定正確的資料夾權限</li>
<li>檢查使用者帳號是否有足夠權限</li>
<li>確認 Web.config 中的帳號設定正確</li>
</ul>
</li>
<li><p>設定完權限後仍無法執行</p>
<ul>
<li>重新啟動 IIS</li>
<li>重新啟動應用程式集區</li>
<li>必要時重新啟動伺服器</li>
</ul>
</li>
</ol>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>要在 IIS 環境下成功使用 LibreOffice 進行檔案轉換，關鍵在於：</p>
<ol>
<li>正確設定 IIS 應用程式集區</li>
<li>設定完整的 Windows 使用者權限</li>
<li>設定適當的資料夾權限</li>
<li>實作完整的錯誤處理機制</li>
<li>記錄詳細的執行過程</li>
</ol>
<p>只要依照上述步驟仔細設定，就能順利完成檔案轉換的功能。如果遇到問題，也可以透過記錄檔快速找出問題所在。</p>
<p>希望這篇文章能幫助遇到類似問題的開發者，快速建立起可靠的檔案轉換機制！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">SQL Server 空間查詢操作指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2024-11-01 17:57:14" itemprop="dateCreated datePublished" datetime="2024-11-01T17:57:14+08:00">2024-11-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-11-27 14:41:16" itemprop="dateModified" datetime="2024-11-27T14:41:16+08:00">2024-11-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A8%8B%E5%BC%8F%E6%95%99%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">程式教學</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>5.1k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>5 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="SQL-Server-空間查詢操作指南"><a href="#SQL-Server-空間查詢操作指南" class="headerlink" title="SQL Server 空間查詢操作指南"></a>SQL Server 空間查詢操作指南</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在處理地理資訊系統(GIS)時，SQL Server 提供了一系列強大的空間查詢工具。本文將詳細介紹這些工具的使用方法，幫助您更有效地處理空間資料。</p>
<h2 id="一、基本空間關係判斷"><a href="#一、基本空間關係判斷" class="headerlink" title="一、基本空間關係判斷"></a>一、基本空間關係判斷</h2><h3 id="1-包含關係"><a href="#1-包含關係" class="headerlink" title="1. 包含關係"></a>1. 包含關係</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- A.STContains(B)：判斷 A 是否包含 B</span></span><br><span class="line"><span class="comment">-- 最常用於判斷點位是否在某個範圍內</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> Points </span><br><span class="line"><span class="keyword">WHERE</span> <span class="variable">@polygon</span>.STContains(point_geometry) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- A.STWithin(B)：判斷 A 是否在 B 內</span></span><br><span class="line"><span class="comment">-- 與 STContains 相反，從點位角度判斷</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> Points </span><br><span class="line"><span class="keyword">WHERE</span> point_geometry.STWithin(<span class="variable">@polygon</span>) <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="2-相交關係"><a href="#2-相交關係" class="headerlink" title="2. 相交關係"></a>2. 相交關係</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- A.STIntersects(B)：判斷 A 和 B 是否相交</span></span><br><span class="line"><span class="comment">-- 適合判斷兩個範圍是否有重疊</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> Zones</span><br><span class="line"><span class="keyword">WHERE</span> zone1_geometry.STIntersects(zone2_geometry) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- A.STTouches(B)：判斷 A 和 B 是否僅在邊界相交</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> Zones</span><br><span class="line"><span class="keyword">WHERE</span> zone1_geometry.STTouches(zone2_geometry) <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="3-其他空間關係"><a href="#3-其他空間關係" class="headerlink" title="3. 其他空間關係"></a>3. 其他空間關係</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- A.STEquals(B)：判斷 A 和 B 是否完全相同</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> Geometry_Table</span><br><span class="line"><span class="keyword">WHERE</span> geometry1.STEquals(geometry2) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- A.STOverlaps(B)：判斷 A 和 B 是否部分重疊</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> Zones</span><br><span class="line"><span class="keyword">WHERE</span> zone1_geometry.STOverlaps(zone2_geometry) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- A.STDisjoint(B)：判斷 A 和 B 是否完全不相交</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> Zones</span><br><span class="line"><span class="keyword">WHERE</span> zone1_geometry.STDisjoint(zone2_geometry) <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="二、距離相關方法"><a href="#二、距離相關方法" class="headerlink" title="二、距離相關方法"></a>二、距離相關方法</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 計算兩個空間物件間的距離</span></span><br><span class="line">.STDistance(geometry)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 建立指定距離的緩衝區</span></span><br><span class="line">.STBuffer(distance)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 實際應用範例：找出距離特定點位 500 公尺內的所有點</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Points</span><br><span class="line"><span class="keyword">WHERE</span> point_geometry.STDistance(<span class="variable">@centerPoint</span>) <span class="operator">&lt;=</span> <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 建立緩衝區後進行查詢</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Points</span><br><span class="line"><span class="keyword">WHERE</span> <span class="variable">@polygon</span>.STBuffer(<span class="number">100</span>).STContains(point_geometry) <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="三、幾何運算方法"><a href="#三、幾何運算方法" class="headerlink" title="三、幾何運算方法"></a>三、幾何運算方法</h2><h3 id="1-差集運算-Difference"><a href="#1-差集運算-Difference" class="headerlink" title="1. 差集運算 (Difference)"></a>1. 差集運算 (Difference)</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- A.STDifference(B)：從 A 中減去與 B 重疊的部分</span></span><br><span class="line"><span class="keyword">SELECT</span> @規劃範圍.STDifference(@禁制區) <span class="keyword">as</span> 實際可用範圍</span><br></pre></td></tr></table></figure>

<h3 id="2-聯集運算-Union"><a href="#2-聯集運算-Union" class="headerlink" title="2. 聯集運算 (Union)"></a>2. 聯集運算 (Union)</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- A.STUnion(B)：合併 A 和 B 的範圍</span></span><br><span class="line"><span class="keyword">SELECT</span> @範圍<span class="number">1.</span>STUnion(@範圍<span class="number">2</span>) <span class="keyword">as</span> 合併範圍</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 多筆資料的聯集</span></span><br><span class="line"><span class="keyword">SELECT</span> geometry::UnionAggregate(geometry欄位) <span class="keyword">as</span> 總範圍</span><br><span class="line"><span class="keyword">FROM</span> 範圍表</span><br></pre></td></tr></table></figure>

<h3 id="3-交集運算-Intersection"><a href="#3-交集運算-Intersection" class="headerlink" title="3. 交集運算 (Intersection)"></a>3. 交集運算 (Intersection)</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- A.STIntersection(B)：取得 A 和 B 重疊的部分</span></span><br><span class="line"><span class="keyword">SELECT</span> @範圍<span class="number">1.</span>STIntersection(@範圍<span class="number">2</span>) <span class="keyword">as</span> 重疊區域</span><br></pre></td></tr></table></figure>

<h3 id="4-對稱差集-Symmetric-Difference"><a href="#4-對稱差集-Symmetric-Difference" class="headerlink" title="4. 對稱差集 (Symmetric Difference)"></a>4. 對稱差集 (Symmetric Difference)</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- A.STSymDifference(B)：取得兩個範圍不重疊的部分</span></span><br><span class="line"><span class="keyword">SELECT</span> @範圍<span class="number">1.</span>STSymDifference(@範圍<span class="number">2</span>) <span class="keyword">as</span> 不重疊區域</span><br></pre></td></tr></table></figure>

<h2 id="四、資料格式轉換"><a href="#四、資料格式轉換" class="headerlink" title="四、資料格式轉換"></a>四、資料格式轉換</h2><h3 id="1-文字轉空間資料"><a href="#1-文字轉空間資料" class="headerlink" title="1. 文字轉空間資料"></a>1. 文字轉空間資料</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 從WKT文字轉geometry</span></span><br><span class="line">geometry::STGeomFromText(<span class="string">&#x27;POINT(X Y)&#x27;</span>, SRID)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 專門轉換點位的方法</span></span><br><span class="line">geometry::STPointFromText(<span class="string">&#x27;POINT(X Y)&#x27;</span>, SRID)</span><br></pre></td></tr></table></figure>

<h3 id="2-空間資料轉文字"><a href="#2-空間資料轉文字" class="headerlink" title="2. 空間資料轉文字"></a>2. 空間資料轉文字</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 轉為WKT格式文字</span></span><br><span class="line">.STAsText()</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 轉為字串</span></span><br><span class="line">.ToString()</span><br></pre></td></tr></table></figure>

<h2 id="五、實際應用範例"><a href="#五、實際應用範例" class="headerlink" title="五、實際應用範例"></a>五、實際應用範例</h2><h3 id="1-基本範圍查詢"><a href="#1-基本範圍查詢" class="headerlink" title="1. 基本範圍查詢"></a>1. 基本範圍查詢</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 範例一：找出特定區域內的所有點位</span></span><br><span class="line"><span class="keyword">SELECT</span> p.<span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Points p</span><br><span class="line"><span class="keyword">WHERE</span> @特定區域.STContains(p.geometry) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 範例二：找出同時在A區域和B區域的點位</span></span><br><span class="line"><span class="keyword">SELECT</span> p.<span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Points p</span><br><span class="line"><span class="keyword">WHERE</span> @區域A.STContains(p.geometry) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">AND</span> @區域B.STContains(p.geometry) <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="2-複合條件查詢"><a href="#2-複合條件查詢" class="headerlink" title="2. 複合條件查詢"></a>2. 複合條件查詢</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 範例一：找出在特定區域內且符合特定條件的點位</span></span><br><span class="line"><span class="keyword">SELECT</span> p.<span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Points p</span><br><span class="line"><span class="keyword">JOIN</span> Zones z <span class="keyword">ON</span> z.geometry.STContains(p.geometry) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">WHERE</span> </span><br><span class="line">    z.ZoneName <span class="operator">=</span> <span class="string">&#x27;特定區域&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> p.Type <span class="operator">=</span> <span class="string">&#x27;住宅&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> p.Status <span class="operator">=</span> <span class="string">&#x27;使用中&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 範例二：找出在多個區域內的點位並標示區域名稱</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    p.<span class="operator">*</span>,</span><br><span class="line">    STRING_AGG(z.ZoneName, <span class="string">&#x27;,&#x27;</span>) <span class="keyword">as</span> 所在區域</span><br><span class="line"><span class="keyword">FROM</span> Points p</span><br><span class="line"><span class="keyword">JOIN</span> Zones z <span class="keyword">ON</span> z.geometry.STContains(p.geometry) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> p.Id, p.geometry, p.Name  <span class="comment">-- 需要列出所有要顯示的欄位</span></span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">&gt;</span> <span class="number">1</span>  <span class="comment">-- 只顯示位於多個區域的點位</span></span><br></pre></td></tr></table></figure>

<h3 id="3-距離相關查詢"><a href="#3-距離相關查詢" class="headerlink" title="3. 距離相關查詢"></a>3. 距離相關查詢</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 範例一：找出距離特定點位500公尺內的所有點</span></span><br><span class="line"><span class="keyword">DECLARE</span> @中心點 geometry <span class="operator">=</span> geometry::STPointFromText(<span class="string">&#x27;POINT(330000 2730000)&#x27;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    p.<span class="operator">*</span>,</span><br><span class="line">    p.geometry.STDistance(@中心點) <span class="keyword">as</span> 距離</span><br><span class="line"><span class="keyword">FROM</span> Points p</span><br><span class="line"><span class="keyword">WHERE</span> p.geometry.STDistance(@中心點) <span class="operator">&lt;=</span> <span class="number">500</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> 距離</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 範例二：找出兩個點位間最短距離的路徑</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    p1.Id <span class="keyword">as</span> 起點ID,</span><br><span class="line">    p2.Id <span class="keyword">as</span> 終點ID,</span><br><span class="line">    p1.geometry.STDistance(p2.geometry) <span class="keyword">as</span> 距離</span><br><span class="line"><span class="keyword">FROM</span> Points p1</span><br><span class="line"><span class="keyword">CROSS</span> <span class="keyword">JOIN</span> Points p2</span><br><span class="line"><span class="keyword">WHERE</span> p1.Id <span class="operator">&lt;</span> p2.Id  <span class="comment">-- 避免重複組合</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> 距離</span><br></pre></td></tr></table></figure>

<h3 id="4-範圍運算案例"><a href="#4-範圍運算案例" class="headerlink" title="4. 範圍運算案例"></a>4. 範圍運算案例</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 範例一：計算多個區域的聯集範圍</span></span><br><span class="line"><span class="keyword">WITH</span> 合併範圍 <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> geometry::UnionAggregate(geometry) <span class="keyword">as</span> 總範圍</span><br><span class="line">    <span class="keyword">FROM</span> Zones</span><br><span class="line">    <span class="keyword">WHERE</span> ZoneType <span class="operator">=</span> <span class="string">&#x27;服務區&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    總範圍,</span><br><span class="line">    總範圍.STArea() <span class="keyword">as</span> 總面積</span><br><span class="line"><span class="keyword">FROM</span> 合併範圍</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 範例二：找出兩個區域的重疊部分</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    @區域A.STIntersection(@區域B) <span class="keyword">as</span> 重疊區域,</span><br><span class="line">    @區域A.STIntersection(@區域B).STArea() <span class="keyword">as</span> 重疊面積</span><br></pre></td></tr></table></figure>

<h3 id="5-複雜範圍處理"><a href="#5-複雜範圍處理" class="headerlink" title="5. 複雜範圍處理"></a>5. 複雜範圍處理</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 範例一：從規劃範圍中扣除多個禁制區</span></span><br><span class="line"><span class="keyword">WITH</span> 禁制區 <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> geometry::UnionAggregate(geometry) <span class="keyword">as</span> 總禁制區</span><br><span class="line">    <span class="keyword">FROM</span> Zones</span><br><span class="line">    <span class="keyword">WHERE</span> ZoneType <span class="operator">=</span> <span class="string">&#x27;禁制區&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    @規劃範圍.STDifference(總禁制區) <span class="keyword">as</span> 可用範圍,</span><br><span class="line">    @規劃範圍.STDifference(總禁制區).STArea() <span class="keyword">as</span> 可用面積</span><br><span class="line"><span class="keyword">FROM</span> 禁制區</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 範例二：建立緩衝區並找出在緩衝區內的點位</span></span><br><span class="line"><span class="keyword">SELECT</span> p.<span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Points p</span><br><span class="line"><span class="keyword">CROSS</span> APPLY (</span><br><span class="line">    <span class="keyword">SELECT</span> geometry::UnionAggregate(geometry.STBuffer(<span class="number">100</span>)) <span class="keyword">as</span> 緩衝區</span><br><span class="line">    <span class="keyword">FROM</span> ServicePoints</span><br><span class="line">    <span class="keyword">WHERE</span> Type <span class="operator">=</span> <span class="string">&#x27;服務站&#x27;</span></span><br><span class="line">) buffer</span><br><span class="line"><span class="keyword">WHERE</span> buffer.緩衝區.STContains(p.geometry) <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="6-統計分析案例"><a href="#6-統計分析案例" class="headerlink" title="6. 統計分析案例"></a>6. 統計分析案例</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 範例一：計算各區域內的點位數量</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    z.ZoneName,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">as</span> 點位數量,</span><br><span class="line">    z.geometry.STArea() <span class="keyword">as</span> 區域面積,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">*</span> <span class="number">1.0</span> <span class="operator">/</span> z.geometry.STArea() <span class="keyword">as</span> 點位密度</span><br><span class="line"><span class="keyword">FROM</span> Zones z</span><br><span class="line"><span class="keyword">JOIN</span> Points p <span class="keyword">ON</span> z.geometry.STContains(p.geometry) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> z.ZoneId, z.ZoneName, z.geometry</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 範例二：計算點位的分佈情況</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    p1.Id <span class="keyword">as</span> 中心點ID,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">as</span> 周圍點位數量,</span><br><span class="line">    <span class="built_in">AVG</span>(p1.geometry.STDistance(p2.geometry)) <span class="keyword">as</span> 平均距離,</span><br><span class="line">    <span class="built_in">MIN</span>(p1.geometry.STDistance(p2.geometry)) <span class="keyword">as</span> 最短距離,</span><br><span class="line">    <span class="built_in">MAX</span>(p1.geometry.STDistance(p2.geometry)) <span class="keyword">as</span> 最長距離</span><br><span class="line"><span class="keyword">FROM</span> Points p1</span><br><span class="line"><span class="keyword">JOIN</span> Points p2 <span class="keyword">ON</span> p1.Id <span class="operator">!=</span> p2.Id</span><br><span class="line"><span class="keyword">WHERE</span> p1.geometry.STDistance(p2.geometry) <span class="operator">&lt;=</span> <span class="number">1000</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> p1.Id</span><br></pre></td></tr></table></figure>

<h3 id="7-資料驗證案例"><a href="#7-資料驗證案例" class="headerlink" title="7. 資料驗證案例"></a>7. 資料驗證案例</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 範例一：檢查點位是否在合法範圍內</span></span><br><span class="line"><span class="keyword">SELECT</span> p.<span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Points p</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> LegalZones z <span class="keyword">ON</span> z.geometry.STContains(p.geometry) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">WHERE</span> z.Id <span class="keyword">IS</span> <span class="keyword">NULL</span>  <span class="comment">-- 找出不在任何合法區域內的點位</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 範例二：檢查兩個點位是否過於接近</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    p1.Id <span class="keyword">as</span> 點位<span class="number">1</span>,</span><br><span class="line">    p2.Id <span class="keyword">as</span> 點位<span class="number">2</span>,</span><br><span class="line">    p1.geometry.STDistance(p2.geometry) <span class="keyword">as</span> 距離</span><br><span class="line"><span class="keyword">FROM</span> Points p1</span><br><span class="line"><span class="keyword">JOIN</span> Points p2 <span class="keyword">ON</span> p1.Id <span class="operator">&lt;</span> p2.Id</span><br><span class="line"><span class="keyword">WHERE</span> p1.geometry.STDistance(p2.geometry) <span class="operator">&lt;</span> <span class="number">10</span>  <span class="comment">-- 距離小於10公尺</span></span><br></pre></td></tr></table></figure>

<h3 id="8-空間索引最佳化案例"><a href="#8-空間索引最佳化案例" class="headerlink" title="8. 空間索引最佳化案例"></a>8. 空間索引最佳化案例</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 範例一：使用空間索引的查詢寫法</span></span><br><span class="line"><span class="keyword">SELECT</span> p.<span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> Points p <span class="keyword">WITH</span>(INDEX(空間索引名稱))</span><br><span class="line"><span class="keyword">WHERE</span> </span><br><span class="line">    p.geometry.STIntersects(@查詢範圍) <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">AND</span> p.Type <span class="operator">=</span> <span class="string">&#x27;特定類型&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 範例二：建立空間索引</span></span><br><span class="line"><span class="keyword">CREATE</span> SPATIAL INDEX [空間索引名稱]</span><br><span class="line"><span class="keyword">ON</span> Points(geometry)</span><br><span class="line"><span class="keyword">USING</span> GEOMETRY_GRID</span><br><span class="line"><span class="keyword">WITH</span> (</span><br><span class="line">    BOUNDING_BOX <span class="operator">=</span> (xmin<span class="operator">=</span><span class="number">320000</span>, ymin<span class="operator">=</span><span class="number">2720000</span>, xmax<span class="operator">=</span><span class="number">340000</span>, ymax<span class="operator">=</span><span class="number">2750000</span>),</span><br><span class="line">    GRIDS <span class="operator">=</span> (LEVEL_1 <span class="operator">=</span> MEDIUM, LEVEL_2 <span class="operator">=</span> MEDIUM, LEVEL_3 <span class="operator">=</span> MEDIUM, LEVEL_4 <span class="operator">=</span> MEDIUM),</span><br><span class="line">    CELLS_PER_OBJECT <span class="operator">=</span> <span class="number">16</span>,</span><br><span class="line">    PAD_INDEX <span class="operator">=</span> OFF,</span><br><span class="line">    STATISTICS_NORECOMPUTE <span class="operator">=</span> OFF,</span><br><span class="line">    SORT_IN_TEMPDB <span class="operator">=</span> OFF,</span><br><span class="line">    DROP_EXISTING <span class="operator">=</span> OFF,</span><br><span class="line">    ONLINE <span class="operator">=</span> OFF,</span><br><span class="line">    ALLOW_ROW_LOCKS <span class="operator">=</span> <span class="keyword">ON</span>,</span><br><span class="line">    ALLOW_PAGE_LOCKS <span class="operator">=</span> <span class="keyword">ON</span></span><br><span class="line">) <span class="keyword">ON</span> [<span class="keyword">PRIMARY</span>]</span><br></pre></td></tr></table></figure>

<h2 id="六、效能最佳化建議"><a href="#六、效能最佳化建議" class="headerlink" title="六、效能最佳化建議"></a>六、效能最佳化建議</h2><ol>
<li> 建立適當的空間索引</li>
<li> 優先過濾非空間條件</li>
<li> 避免在大量資料上進行複雜的空間運算</li>
<li> 適當使用 CTE 或子查詢來優化查詢結構</li>
<li> 確保所有幾何物件使用相同的空間參考系統(SRID)</li>
</ol>
<h2 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h2><p>空間查詢方法提供了強大的工具來處理地理資訊數據。透過適當的使用這些方法，我們可以有效地進行空間分析、範圍規劃等作業。在實務應用中，記得考慮效能影響，並選擇最適合的方法來達成目標。</p>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ul>
<li>  <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/sql/relational-databases/spatial/spatial-data-types-overview">Microsoft SQL Server 官方檔案</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">資料庫連線池爆掉救火秘笈！如何優雅地處理 SQL Server 連線危機</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2024-10-27 14:30:00" itemprop="dateCreated datePublished" datetime="2024-10-27T14:30:00+08:00">2024-10-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-11-27 15:55:40" itemprop="dateModified" datetime="2024-11-27T15:55:40+08:00">2024-11-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BE%8C%E7%AB%AF%E9%96%8B%E7%99%BC/" itemprop="url" rel="index"><span itemprop="name">後端開發</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BE%8C%E7%AB%AF%E9%96%8B%E7%99%BC/%E8%B3%87%E6%96%99%E5%BA%AB%E5%84%AA%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">資料庫優化</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>2.6k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>2 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>身為後端工程師，你是否遇過這樣的情況：</p>
<ul>
<li>系統突然變得超級慢</li>
<li>網頁一直轉圈圈</li>
<li>收到「已超過連線逾時的設定」錯誤訊息</li>
</ul>
<p>如果有，恭喜你！你可能遇到了資料庫連線池爆掉的問題。今天就來分享一個真實案例，看看如何從診斷到解決這個棘手的問題。</p>
<h2 id="問題診斷"><a href="#問題診斷" class="headerlink" title="問題診斷"></a>問題診斷</h2><p>當你遇到以下錯誤訊息時，很可能是連線池出問題了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.InvalidOperationException: &#x27;已超過連線逾時的設定。在取得集區連線之前超過逾時等待的時間，可能的原因為所有的共用連線已在使用中，並已達共用集區大小的最大值。&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="快速診斷方法"><a href="#快速診斷方法" class="headerlink" title="快速診斷方法"></a>快速診斷方法</h3><p>首先，我們可以使用以下 SQL 指令來查看目前的連線狀況：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    DB_NAME(dbid) <span class="keyword">as</span> DatabaseName,</span><br><span class="line">    <span class="built_in">COUNT</span>(dbid) <span class="keyword">as</span> NumberOfConnections,</span><br><span class="line">    loginame <span class="keyword">as</span> LoginName,</span><br><span class="line">    status,</span><br><span class="line">    hostname <span class="keyword">as</span> HostName,</span><br><span class="line">    program_name <span class="keyword">as</span> ProgramName</span><br><span class="line"><span class="keyword">FROM</span> sys.sysprocesses</span><br><span class="line"><span class="keyword">WHERE</span> dbid <span class="operator">&gt;</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> dbid, loginame, status, hostname, program_name;</span><br></pre></td></tr></table></figure>

<h2 id="緊急處理方案"><a href="#緊急處理方案" class="headerlink" title="緊急處理方案"></a>緊急處理方案</h2><p>發現問題後，可以使用以下步驟處理：</p>
<ol>
<li><strong>檢視問題連線</strong><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1. 首先查看當前的連接詳情</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    spid <span class="keyword">as</span> <span class="string">&#x27;處理序 ID&#x27;</span>,</span><br><span class="line">    db_name(dbid) <span class="keyword">as</span> <span class="string">&#x27;數據庫&#x27;</span>,</span><br><span class="line">    loginame <span class="keyword">as</span> <span class="string">&#x27;登入名稱&#x27;</span>,</span><br><span class="line">    hostname <span class="keyword">as</span> <span class="string">&#x27;主機名&#x27;</span>,</span><br><span class="line">    program_name <span class="keyword">as</span> <span class="string">&#x27;程式名稱&#x27;</span>,</span><br><span class="line">    login_time <span class="keyword">as</span> <span class="string">&#x27;登入時間&#x27;</span>,</span><br><span class="line">    last_batch <span class="keyword">as</span> <span class="string">&#x27;最後執行時間&#x27;</span>,</span><br><span class="line">    status <span class="keyword">as</span> <span class="string">&#x27;狀態&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span> sys.sysprocesses </span><br><span class="line"><span class="keyword">WHERE</span> dbid <span class="operator">=</span> DB_ID(<span class="string">&#x27;資料庫名稱&#x27;</span>)  <span class="comment">-- 替換成你的數據庫名</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> login_time <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 查看具體在執行什麼 SQL</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    spid,</span><br><span class="line">    blocked <span class="keyword">as</span> <span class="string">&#x27;被阻塞源&#x27;</span>,</span><br><span class="line">    hostname <span class="keyword">as</span> <span class="string">&#x27;主機名&#x27;</span>,</span><br><span class="line">    program_name <span class="keyword">as</span> <span class="string">&#x27;程式名稱&#x27;</span>,</span><br><span class="line">    cmd <span class="keyword">as</span> <span class="string">&#x27;指令&#x27;</span>,</span><br><span class="line">    cpu <span class="keyword">as</span> <span class="string">&#x27;CPU時間&#x27;</span>,</span><br><span class="line">    physical_io <span class="keyword">as</span> <span class="string">&#x27;實體IO&#x27;</span>,</span><br><span class="line">    last_batch <span class="keyword">as</span> <span class="string">&#x27;最後執行時間&#x27;</span>,</span><br><span class="line">    [text] <span class="keyword">as</span> <span class="string">&#x27;SQL內容&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span> sys.sysprocesses sp</span><br><span class="line"><span class="keyword">CROSS</span> APPLY sys.dm_exec_sql_text(sql_handle)</span><br><span class="line"><span class="keyword">WHERE</span> dbid <span class="operator">=</span> DB_ID(<span class="string">&#x27;資料庫名稱&#x27;</span>)  <span class="comment">-- 替換成你的數據庫名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 殺掉特定連接 (請小心使用)</span></span><br><span class="line"><span class="comment">-- KILL 52;  -- 替換成你要關閉的 SPID</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4. 如果確定要關閉所有用戶連接，可以使用動態 SQL (需要特別小心)</span></span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@kill</span> <span class="type">varchar</span>(<span class="number">8000</span>) <span class="operator">=</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@kill</span> <span class="operator">=</span> <span class="variable">@kill</span> <span class="operator">+</span> <span class="string">&#x27;KILL &#x27;</span> <span class="operator">+</span> <span class="keyword">CONVERT</span>(<span class="type">varchar</span>(<span class="number">5</span>), spid) <span class="operator">+</span> <span class="string">&#x27;;&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span> sys.sysprocesses </span><br><span class="line"><span class="keyword">WHERE</span> dbid <span class="operator">=</span> DB_ID(<span class="string">&#x27;資料庫名稱&#x27;</span>)  <span class="comment">-- 替換成你的數據庫名</span></span><br><span class="line"><span class="keyword">AND</span> spid <span class="operator">&gt;</span> <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 執行前先確認要關閉的連接</span></span><br><span class="line">PRINT <span class="variable">@kill</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 如果確認無誤，則可以執行（請小心使用）</span></span><br><span class="line"><span class="comment">-- EXEC(@kill);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 5. 如果要切換數據庫到單一用戶模式</span></span><br><span class="line"><span class="comment">-- 這會強制斷開所有現有連接</span></span><br><span class="line"><span class="keyword">ALTER</span> DATABASE 資料庫名稱</span><br><span class="line"><span class="keyword">SET</span> SINGLE_USER </span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">ROLLBACK</span> IMMEDIATE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 完成後切換回多用戶模式</span></span><br><span class="line"><span class="comment">-- ALTER DATABASE 資料庫名稱 SET MULTI_USER;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="代碼優化建議"><a href="#代碼優化建議" class="headerlink" title="代碼優化建議"></a>代碼優化建議</h2><p>這次發生的問題最後定位問題發現是很久以前前人寫的VB程式碼資料庫連接沒有正確的釋放導致的，為了避免類似問題再次發生，對程式碼進行以下優化：</p>
<ol>
<li><p><strong>使用 Using 區塊確保資源釋放</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Using connection As New SqlConnection(connectionString)</span><br><span class="line">    &#x27; 資料庫操作</span><br><span class="line">End Using</span><br></pre></td></tr></table></figure></li>
<li><p><strong>避免全域宣告資料庫連線</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x27; 不建議</span><br><span class="line">Dim conn As New SqlConnection  &#x27;全域變數</span><br><span class="line"></span><br><span class="line">&#x27; 建議</span><br><span class="line">Private Function GetData() As DataTable</span><br><span class="line">    Using conn As New SqlConnection(connectionString)</span><br><span class="line">        &#x27; 程式碼</span><br><span class="line">    End Using</span><br><span class="line">End Function</span><br></pre></td></tr></table></figure></li>
<li><p><strong>設定適當的連線池參數</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">connectionStrings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;MyConnection&quot;</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">connectionString</span>=<span class="string">&quot;Server=myserver;Database=mydb;</span></span></span><br><span class="line"><span class="string"><span class="tag">         Max Pool Size=100;Min Pool Size=5;</span></span></span><br><span class="line"><span class="string"><span class="tag">         Connection Timeout=30;&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">providerName</span>=<span class="string">&quot;System.Data.SqlClient&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">connectionStrings</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="預防措施"><a href="#預防措施" class="headerlink" title="預防措施"></a>預防措施</h2><ol>
<li><p><strong>定期監控連線數</strong></p>
<ul>
<li>設置警示機制</li>
<li>監控連線成長趨勢</li>
</ul>
</li>
<li><p><strong>程式碼審查重點</strong></p>
<ul>
<li>確認所有資料庫連線都有正確釋放</li>
<li>避免無限期保持連線</li>
</ul>
</li>
<li><p><strong>效能調校建議</strong></p>
<ul>
<li>適當設定 Max Pool Size</li>
<li>配置合理的 Connection Timeout</li>
<li>實作重試機制</li>
</ul>
</li>
</ol>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>資料庫連線池問題雖然棘手，但只要掌握正確的診斷和處理方法，就能夠優雅地解決。預防永遠勝於治療，建議定期檢查程式碼和監控系統狀態，及早發現潛在問題。</p>
<h2 id="參考資源"><a href="#參考資源" class="headerlink" title="參考資源"></a>參考資源</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sql/connect/ado-net/sql-server-connection-pooling">Microsoft Docs - SQL Server 連線集區</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/connection-pooling">ASP.NET Connection Pooling</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">如何快速查詢資料庫檢視表(View)的欄位資訊</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2024-10-23 11:19:17" itemprop="dateCreated datePublished" datetime="2024-10-23T11:19:17+08:00">2024-10-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-11-27 14:42:14" itemprop="dateModified" datetime="2024-11-27T14:42:14+08:00">2024-11-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A8%8B%E5%BC%8F%E6%95%99%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">程式教學</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>1.8k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>2 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="如何快速查詢資料庫檢視表-View-的欄位資訊"><a href="#如何快速查詢資料庫檢視表-View-的欄位資訊" class="headerlink" title="如何快速查詢資料庫檢視表(View)的欄位資訊"></a>如何快速查詢資料庫檢視表(View)的欄位資訊</h1><p>今天遇到長官要求提供所需的資料訊息，因為要求的資料欄位是由多個資料表組合而成時，要一個一個去查看原始資料表相當費時。本文將介紹如何使用 SQL 指令快速查詢檢視表的欄位資訊。</p>
<h2 id="為什麼需要這個查詢？"><a href="#為什麼需要這個查詢？" class="headerlink" title="為什麼需要這個查詢？"></a>為什麼需要這個查詢？</h2><ul>
<li>快速了解檢視表的結構</li>
<li>檢查欄位的資料類型和限制</li>
<li>節省查看原始資料表的時間</li>
<li>方便進行資料庫文件製作</li>
</ul>
<h2 id="各資料庫系統的查詢方式"><a href="#各資料庫系統的查詢方式" class="headerlink" title="各資料庫系統的查詢方式"></a>各資料庫系統的查詢方式</h2><h3 id="Microsoft-SQL-Server"><a href="#Microsoft-SQL-Server" class="headerlink" title="Microsoft SQL Server"></a>Microsoft SQL Server</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    c.name <span class="keyword">AS</span> ColumnName,</span><br><span class="line">    t.name <span class="keyword">AS</span> DataType,</span><br><span class="line">    c.max_length <span class="keyword">AS</span> MaxLength,</span><br><span class="line">    c.precision <span class="keyword">AS</span> NumericPrecision,</span><br><span class="line">    c.scale <span class="keyword">AS</span> NumericScale,</span><br><span class="line">    c.is_nullable <span class="keyword">AS</span> IsNullable,</span><br><span class="line">    ISNULL(dc.definition, <span class="string">&#x27;&#x27;</span>) <span class="keyword">AS</span> DefaultValue</span><br><span class="line"><span class="keyword">FROM</span> sys.views v</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> sys.columns c <span class="keyword">ON</span> v.object_id <span class="operator">=</span> c.object_id</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> sys.types t <span class="keyword">ON</span> c.user_type_id <span class="operator">=</span> t.user_type_id</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> sys.default_constraints dc <span class="keyword">ON</span> c.default_object_id <span class="operator">=</span> dc.object_id</span><br><span class="line"><span class="keyword">WHERE</span> v.name <span class="operator">=</span> <span class="string">&#x27;檢視表名稱&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> c.column_id;</span><br></pre></td></tr></table></figure>

<h3 id="MySQL-MariaDB"><a href="#MySQL-MariaDB" class="headerlink" title="MySQL/MariaDB"></a>MySQL/MariaDB</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    COLUMN_NAME,</span><br><span class="line">    DATA_TYPE,</span><br><span class="line">    CHARACTER_MAXIMUM_LENGTH,</span><br><span class="line">    NUMERIC_PRECISION,</span><br><span class="line">    NUMERIC_SCALE,</span><br><span class="line">    IS_NULLABLE,</span><br><span class="line">    COLUMN_DEFAULT</span><br><span class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.COLUMNS</span><br><span class="line"><span class="keyword">WHERE</span> TABLE_SCHEMA <span class="operator">=</span> <span class="string">&#x27;資料庫名稱&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> TABLE_NAME <span class="operator">=</span> <span class="string">&#x27;檢視表名稱&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Oracle"><a href="#Oracle" class="headerlink" title="Oracle"></a>Oracle</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    COLUMN_NAME,</span><br><span class="line">    DATA_TYPE,</span><br><span class="line">    DATA_LENGTH,</span><br><span class="line">    DATA_PRECISION,</span><br><span class="line">    DATA_SCALE,</span><br><span class="line">    NULLABLE,</span><br><span class="line">    DATA_DEFAULT</span><br><span class="line"><span class="keyword">FROM</span> ALL_TAB_COLUMNS</span><br><span class="line"><span class="keyword">WHERE</span> TABLE_NAME <span class="operator">=</span> <span class="string">&#x27;檢視表名稱&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> COLUMN_ID;</span><br></pre></td></tr></table></figure>

<h3 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    a.attname <span class="keyword">AS</span> column_name,</span><br><span class="line">    pg_catalog.format_type(a.atttypid, a.atttypmod) <span class="keyword">AS</span> data_type,</span><br><span class="line">    a.attnotnull <span class="keyword">AS</span> is_not_null,</span><br><span class="line">    pg_catalog.pg_get_expr(d.adbin, d.adrelid) <span class="keyword">AS</span> default_value</span><br><span class="line"><span class="keyword">FROM</span> pg_catalog.pg_attribute a</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> pg_catalog.pg_attrdef d <span class="keyword">ON</span> (a.attrelid, a.attnum) <span class="operator">=</span> (d.adrelid, d.adnum)</span><br><span class="line"><span class="keyword">WHERE</span> a.attrelid <span class="operator">=</span> <span class="string">&#x27;檢視表名稱&#x27;</span>::regclass</span><br><span class="line"><span class="keyword">AND</span> a.attnum <span class="operator">&gt;</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">AND</span> <span class="keyword">NOT</span> a.attisdropped</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> a.attnum;</span><br></pre></td></tr></table></figure>

<h2 id="查詢結果說明"><a href="#查詢結果說明" class="headerlink" title="查詢結果說明"></a>查詢結果說明</h2><p>執行上述查詢後，你會得到以下資訊：</p>
<ol>
<li><strong>欄位名稱</strong>（Column Name）：該欄位的名稱</li>
<li><strong>資料型態</strong>（Data Type）：如 varchar、int、decimal 等</li>
<li><strong>最大長度</strong>（Max Length）：文字類型的最大長度</li>
<li><strong>數值精確度</strong>（Numeric Precision）：數值類型的精確度</li>
<li><strong>小數位數</strong>（Numeric Scale）：數值類型的小數位數</li>
<li><strong>是否可為空值</strong>（Is Nullable）：該欄位是否允許 NULL</li>
<li><strong>預設值</strong>（Default Value）：欄位的預設值</li>
</ol>
<h2 id="使用技巧"><a href="#使用技巧" class="headerlink" title="使用技巧"></a>使用技巧</h2><ol>
<li>請根據你使用的資料庫系統選擇對應的查詢語法</li>
<li>將查詢中的「檢視表名稱」替換為你要查詢的檢視表名稱</li>
<li>若使用 MySQL/MariaDB，記得也要替換「資料庫名稱」</li>
<li>查詢結果可以匯出成 Excel 方便記錄</li>
</ol>
<h2 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h2><p>這個查詢方式可以讓我們快速了解檢視表的結構，特別適合處理複雜的檢視表或需要製作資料庫文件時使用。善用這些系統表格查詢，可以大幅提升資料庫管理的效率。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">SQL Server 備份檔案異常增長的排查指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2024-10-22 10:11:50" itemprop="dateCreated datePublished" datetime="2024-10-22T10:11:50+08:00">2024-10-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-11-27 14:39:56" itemprop="dateModified" datetime="2024-11-27T14:39:56+08:00">2024-11-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A8%8B%E5%BC%8F%E6%95%99%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">程式教學</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>2.1k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>2 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="SQL-Server-備份檔案異常增長的排查指南"><a href="#SQL-Server-備份檔案異常增長的排查指南" class="headerlink" title="SQL Server 備份檔案異常增長的排查指南"></a>SQL Server 備份檔案異常增長的排查指南</h1><p>在管理 SQL Server 資料庫時，有時會遇到備份檔案大小突然增加的情況。即使資料表中的資料量沒有明顯增長，備份檔案卻莫名變大了好幾 GB，這時該如何進行排查呢？本文將介紹幾個常見的原因和解決方案。</p>
<h2 id="常見原因分析"><a href="#常見原因分析" class="headerlink" title="常見原因分析"></a>常見原因分析</h2><h3 id="1-交易記錄檔（Transaction-Log）過大"><a href="#1-交易記錄檔（Transaction-Log）過大" class="headerlink" title="1. 交易記錄檔（Transaction Log）過大"></a>1. 交易記錄檔（Transaction Log）過大</h3><p>交易記錄檔是記錄資料庫所有異動的檔案，如果沒有定期做記錄檔備份或截斷，可能會導致檔案持續成長。</p>
<p><strong>診斷方式：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DBCC SQLPERF(LOGSPACE);</span><br></pre></td></tr></table></figure>
<p>這個指令可以顯示所有資料庫的記錄檔使用狀況。</p>
<h3 id="2-索引碎片化"><a href="#2-索引碎片化" class="headerlink" title="2. 索引碎片化"></a>2. 索引碎片化</h3><p>頻繁的資料異動可能造成索引碎片化，進而影響備份檔案大小。</p>
<p><strong>診斷方式：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> OBJECT_NAME(ind.OBJECT_ID) <span class="keyword">AS</span> TableName, </span><br><span class="line">       ind.name <span class="keyword">AS</span> IndexName, </span><br><span class="line">       indexstats.avg_fragmentation_in_percent</span><br><span class="line"><span class="keyword">FROM</span> sys.dm_db_index_physical_stats(DB_ID(), <span class="keyword">NULL</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span>) indexstats</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> sys.indexes ind </span><br><span class="line"><span class="keyword">ON</span> ind.object_id <span class="operator">=</span> indexstats.object_id </span><br><span class="line"><span class="keyword">AND</span> ind.index_id <span class="operator">=</span> indexstats.index_id</span><br><span class="line"><span class="keyword">WHERE</span> indexstats.avg_fragmentation_in_percent <span class="operator">&gt;</span> <span class="number">30</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> indexstats.avg_fragmentation_in_percent <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure>
<p>此查詢可以找出碎片率超過 30% 的索引。</p>
<h3 id="3-快照隔離層級的版本存儲"><a href="#3-快照隔離層級的版本存儲" class="headerlink" title="3. 快照隔離層級的版本存儲"></a>3. 快照隔離層級的版本存儲</h3><p>如果啟用了 RCSI（Read Committed Snapshot Isolation）或快照隔離，系統會在 tempdb 中保留資料版本，可能導致備份檔案變大。</p>
<h3 id="4-備份壓縮設定"><a href="#4-備份壓縮設定" class="headerlink" title="4. 備份壓縮設定"></a>4. 備份壓縮設定</h3><p>檢查備份是否有啟用壓縮功能。未壓縮的備份檔案會比壓縮後的檔案大上許多。</p>
<h3 id="5-大型物件（LOB）資料異動"><a href="#5-大型物件（LOB）資料異動" class="headerlink" title="5. 大型物件（LOB）資料異動"></a>5. 大型物件（LOB）資料異動</h3><p>異動大型物件資料（如文字、圖片等）時，即使只修改一小部分，在備份時可能也會包含整個物件。</p>
<h2 id="診斷與解決步驟"><a href="#診斷與解決步驟" class="headerlink" title="診斷與解決步驟"></a>診斷與解決步驟</h2><h3 id="Step-1-檢查資料庫完整性"><a href="#Step-1-檢查資料庫完整性" class="headerlink" title="Step 1: 檢查資料庫完整性"></a>Step 1: 檢查資料庫完整性</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DBCC CHECKDB(<span class="string">&#x27;您的資料庫名稱&#x27;</span>) <span class="keyword">WITH</span> NO_INFOMSGS;</span><br></pre></td></tr></table></figure>

<h3 id="Step-2-檢查資料庫實際使用空間"><a href="#Step-2-檢查資料庫實際使用空間" class="headerlink" title="Step 2: 檢查資料庫實際使用空間"></a>Step 2: 檢查資料庫實際使用空間</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXEC</span> sp_spaceused;</span><br></pre></td></tr></table></figure>

<h3 id="Step-3-重建索引並收縮資料庫"><a href="#Step-3-重建索引並收縮資料庫" class="headerlink" title="Step 3: 重建索引並收縮資料庫"></a>Step 3: 重建索引並收縮資料庫</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 重建所有索引</span></span><br><span class="line"><span class="keyword">EXEC</span> sp_MSforeachtable <span class="variable">@command1</span><span class="operator">=</span>&quot;print &#x27;?&#x27; DBCC DBREINDEX (&#x27;?&#x27;, &#x27; &#x27;, 80)&quot;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 收縮資料庫</span></span><br><span class="line">DBCC SHRINKDATABASE (N<span class="string">&#x27;您的資料庫名稱&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Step-4-檢查各資料表的大小與記錄數"><a href="#Step-4-檢查各資料表的大小與記錄數" class="headerlink" title="Step 4: 檢查各資料表的大小與記錄數"></a>Step 4: 檢查各資料表的大小與記錄數</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    t.NAME <span class="keyword">AS</span> TableName,</span><br><span class="line">    s.Name <span class="keyword">AS</span> SchemaName,</span><br><span class="line">    p.rows <span class="keyword">AS</span> RowCounts,</span><br><span class="line">    <span class="built_in">SUM</span>(a.total_pages) <span class="operator">*</span> <span class="number">8</span> <span class="keyword">AS</span> TotalSpaceKB, </span><br><span class="line">    <span class="built_in">SUM</span>(a.used_pages) <span class="operator">*</span> <span class="number">8</span> <span class="keyword">AS</span> UsedSpaceKB, </span><br><span class="line">    (<span class="built_in">SUM</span>(a.total_pages) <span class="operator">-</span> <span class="built_in">SUM</span>(a.used_pages)) <span class="operator">*</span> <span class="number">8</span> <span class="keyword">AS</span> UnusedSpaceKB</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    sys.tables t</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span>      </span><br><span class="line">    sys.indexes i <span class="keyword">ON</span> t.OBJECT_ID <span class="operator">=</span> i.object_id</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> </span><br><span class="line">    sys.partitions p <span class="keyword">ON</span> i.object_id <span class="operator">=</span> p.OBJECT_ID <span class="keyword">AND</span> i.index_id <span class="operator">=</span> p.index_id</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> </span><br><span class="line">    sys.allocation_units a <span class="keyword">ON</span> p.partition_id <span class="operator">=</span> a.container_id</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> </span><br><span class="line">    sys.schemas s <span class="keyword">ON</span> t.schema_id <span class="operator">=</span> s.schema_id</span><br><span class="line"><span class="keyword">WHERE</span> </span><br><span class="line">    t.NAME <span class="keyword">NOT</span> <span class="keyword">LIKE</span> <span class="string">&#x27;dt%&#x27;</span> </span><br><span class="line">    <span class="keyword">AND</span> t.is_ms_shipped <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">AND</span> i.OBJECT_ID <span class="operator">&gt;</span> <span class="number">255</span> </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">    t.Name, s.Name, p.Rows</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> </span><br><span class="line">    TotalSpaceKB <span class="keyword">DESC</span>, t.Name</span><br></pre></td></tr></table></figure>

<h2 id="預防措施"><a href="#預防措施" class="headerlink" title="預防措施"></a>預防措施</h2><ol>
<li><p><strong>定期維護索引</strong></p>
<ul>
<li>定期重建或重組碎片率高的索引</li>
<li>檢查不常使用的索引，考慮是否需要保留</li>
</ul>
</li>
<li><p><strong>適當的備份策略</strong></p>
<ul>
<li>規劃完整備份的頻率</li>
<li>實施交易記錄備份機制</li>
<li>適時清理過期的備份檔案</li>
</ul>
</li>
<li><p><strong>監控資料庫成長</strong></p>
<ul>
<li>定期檢查資料庫和記錄檔的大小</li>
<li>設置警示機制，當檔案超過預期大小時通知管理員</li>
</ul>
</li>
<li><p><strong>最佳化資料庫設定</strong></p>
<ul>
<li>適當配置自動成長設定</li>
<li>根據需求調整復原模式</li>
<li>考慮是否需要啟用壓縮功能</li>
</ul>
</li>
</ol>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>遇到 SQL Server 備份檔案異常增長的情況時，不要驚慌。依照本文提供的步驟逐一檢查，通常都能找出問題的根源。建議將這些檢查步驟納入日常維護程序中，可以及早發現並解決潛在的問題。</p>
<p>記住，預防勝於治療，建立良好的資料庫維護習慣，可以避免許多效能和空間的問題。如果執行這些步驟後仍無法解決問題，建議尋求專業的資料庫管理人員協助，進行更深入的診斷。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">實作零信任架構的 .NET Core Web API 教學</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2024-10-19 14:30:24" itemprop="dateCreated datePublished" datetime="2024-10-19T14:30:24+08:00">2024-10-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-11-27 14:50:20" itemprop="dateModified" datetime="2024-11-27T14:50:20+08:00">2024-11-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A8%8B%E5%BC%8F%E6%95%99%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">程式教學</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>15k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>13 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="實作零信任架構的-NET-Core-Web-API-教學"><a href="#實作零信任架構的-NET-Core-Web-API-教學" class="headerlink" title="實作零信任架構的 .NET Core Web API 教學"></a>實作零信任架構的 .NET Core Web API 教學</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在現代應用程式開發中，安全性是一個不能忽視的重要議題。零信任（Zero Trust）安全模型提供了一個「永不信任，始終驗證」的架構方針，特別適合用於建構安全的 Web API。本文將詳細說明如何在 .NET Core Web API 中實作零信任架構。</p>
<h2 id="零信任架構核心概念"><a href="#零信任架構核心概念" class="headerlink" title="零信任架構核心概念"></a>零信任架構核心概念</h2><p>零信任架構建立在以下幾個核心原則上：</p>
<ol>
<li>永遠驗證 - 對每個請求都進行身分驗證</li>
<li>最小權限 - 只給予必要的存取權限</li>
<li>假設破壞 - 假設網路環境已被入侵</li>
<li>全程加密 - 所有通訊都需要加密</li>
<li>持續監控 - 記錄與分析所有活動</li>
</ol>
<h2 id="專案設定"><a href="#專案設定" class="headerlink" title="專案設定"></a>專案設定</h2><p>首先建立一個新的 .NET Core Web API 專案：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dotnet new webapi -n ZeroTrustApi</span><br><span class="line"><span class="built_in">cd</span> ZeroTrustApi</span><br></pre></td></tr></table></figure>

<h3 id="安裝必要的-NuGet-套件："><a href="#安裝必要的-NuGet-套件：" class="headerlink" title="安裝必要的 NuGet 套件："></a>安裝必要的 NuGet 套件：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer</span><br><span class="line">dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore</span><br><span class="line">dotnet add package Microsoft.EntityFrameworkCore.SqlServer</span><br><span class="line">dotnet add package AspNetCoreRateLimit</span><br></pre></td></tr></table></figure>

<h2 id="API檔案與安全測試"><a href="#API檔案與安全測試" class="headerlink" title="API檔案與安全測試"></a>API檔案與安全測試</h2><h3 id="1-Swagger-檔案設定"><a href="#1-Swagger-檔案設定" class="headerlink" title="1. Swagger 檔案設定"></a>1. Swagger 檔案設定</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddEndpointsApiExplorer();</span><br><span class="line">builder.Services.AddSwaggerGen(c =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    c.SwaggerDoc(<span class="string">&quot;v1&quot;</span>, <span class="keyword">new</span> OpenApiInfo </span><br><span class="line">    &#123; </span><br><span class="line">        Title = <span class="string">&quot;Zero Trust API&quot;</span>, </span><br><span class="line">        Version = <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">        Description = <span class="string">&quot;實作零信任架構的 Web API&quot;</span>,</span><br><span class="line">        Contact = <span class="keyword">new</span> OpenApiContact</span><br><span class="line">        &#123;</span><br><span class="line">            Name = <span class="string">&quot;Your Name&quot;</span>,</span><br><span class="line">            Email = <span class="string">&quot;your.email@domain.com&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// JWT 驗證設定</span></span><br><span class="line">    c.AddSecurityDefinition(<span class="string">&quot;Bearer&quot;</span>, <span class="keyword">new</span> OpenApiSecurityScheme</span><br><span class="line">    &#123;</span><br><span class="line">        Type = SecuritySchemeType.Http,</span><br><span class="line">        Scheme = <span class="string">&quot;bearer&quot;</span>,</span><br><span class="line">        BearerFormat = <span class="string">&quot;JWT&quot;</span>,</span><br><span class="line">        Description = <span class="string">&quot;請在下方輸入 JWT Token&quot;</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    c.AddSecurityRequirement(<span class="keyword">new</span> OpenApiSecurityRequirement</span><br><span class="line">    &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">new</span> OpenApiSecurityScheme</span><br><span class="line">            &#123;</span><br><span class="line">                Reference = <span class="keyword">new</span> OpenApiReference </span><br><span class="line">                &#123; </span><br><span class="line">                    Type = ReferenceType.SecurityScheme,</span><br><span class="line">                    Id = <span class="string">&quot;Bearer&quot;</span> </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            Array.Empty&lt;<span class="built_in">string</span>&gt;()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="2-單元測試設定"><a href="#2-單元測試設定" class="headerlink" title="2. 單元測試設定"></a>2. 單元測試設定</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SecureControllerTests.cs</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SecureControllerTests</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> SecureController _controller;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> Mock&lt;ILogger&lt;SecureController&gt;&gt; _loggerMock;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecureControllerTests</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _loggerMock = <span class="keyword">new</span> Mock&lt;ILogger&lt;SecureController&gt;&gt;();</span><br><span class="line">        _controller = <span class="keyword">new</span> SecureController(_loggerMock.Object);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 模擬使用者身份</span></span><br><span class="line">        <span class="keyword">var</span> claims = <span class="keyword">new</span>[]</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">new</span> Claim(ClaimTypes.Name, <span class="string">&quot;testuser&quot;</span>),</span><br><span class="line">            <span class="keyword">new</span> Claim(ClaimTypes.Role, <span class="string">&quot;Admin&quot;</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">var</span> identity = <span class="keyword">new</span> ClaimsIdentity(claims, <span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> claimsPrincipal = <span class="keyword">new</span> ClaimsPrincipal(identity);</span><br><span class="line">        </span><br><span class="line">        _controller.ControllerContext = <span class="keyword">new</span> ControllerContext</span><br><span class="line">        &#123;</span><br><span class="line">            HttpContext = <span class="keyword">new</span> DefaultHttpContext </span><br><span class="line">            &#123; </span><br><span class="line">                User = claimsPrincipal </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Fact</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Get_AuthenticatedUser_ReturnsOkResult</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Arrange</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Act</span></span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">await</span> _controller.Get();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Assert</span></span><br><span class="line">        Assert.IsType&lt;OkObjectResult&gt;(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="實作身分驗證"><a href="#實作身分驗證" class="headerlink" title="實作身分驗證"></a>實作身分驗證</h2><h3 id="1-JWT-認證設定"><a href="#1-JWT-認證設定" class="headerlink" title="1. JWT 認證設定"></a>1. JWT 認證設定</h3><p>在 <code>Program.cs</code> 中加入 JWT 認證：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(<span class="keyword">args</span>);</span><br><span class="line"></span><br><span class="line">builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)</span><br><span class="line">    .AddJwtBearer(options =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        options.TokenValidationParameters = <span class="keyword">new</span> TokenValidationParameters</span><br><span class="line">        &#123;</span><br><span class="line">            ValidateIssuer = <span class="literal">true</span>,</span><br><span class="line">            ValidateAudience = <span class="literal">true</span>,</span><br><span class="line">            ValidateLifetime = <span class="literal">true</span>,</span><br><span class="line">            ValidateIssuerSigningKey = <span class="literal">true</span>,</span><br><span class="line">            ValidIssuer = builder.Configuration[<span class="string">&quot;Jwt:Issuer&quot;</span>],</span><br><span class="line">            ValidAudience = builder.Configuration[<span class="string">&quot;Jwt:Audience&quot;</span>],</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Token 存活時間設定</span></span><br><span class="line">            ClockSkew = TimeSpan.Zero,  <span class="comment">// 避免時間偏差</span></span><br><span class="line">            RequireExpirationTime = <span class="literal">true</span>,</span><br><span class="line">            ValidateLifetime = <span class="literal">true</span>,</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Token 加密金鑰設定</span></span><br><span class="line">            IssuerSigningKey = <span class="keyword">new</span> SymmetricSecurityKey(</span><br><span class="line">                Encoding.UTF8.GetBytes(builder.Configuration[<span class="string">&quot;Jwt:Key&quot;</span>])),</span><br><span class="line">            TokenDecryptionKey = <span class="keyword">new</span> SymmetricSecurityKey(</span><br><span class="line">                Encoding.UTF8.GetBytes(builder.Configuration[<span class="string">&quot;Jwt:EncryptionKey&quot;</span>]))</span><br><span class="line">        &#125;;</span><br><span class="line">               <span class="comment">// Token 過期事件處理</span></span><br><span class="line">        options.Events = <span class="keyword">new</span> JwtBearerEvents</span><br><span class="line">        &#123;</span><br><span class="line">            OnAuthenticationFailed = context =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (context.Exception.GetType() == <span class="keyword">typeof</span>(SecurityTokenExpiredException))</span><br><span class="line">                &#123;</span><br><span class="line">                    context.Response.Headers.Add(<span class="string">&quot;Token-Expired&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> Task.CompletedTask;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;; </span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="2-使用者身分模型"><a href="#2-使用者身分模型" class="headerlink" title="2. 使用者身分模型"></a>2. 使用者身分模型</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ApplicationUser</span> : <span class="title">IdentityUser</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> FirstName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> LastName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> DateTime LastLoginTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-資料庫上下文"><a href="#3-資料庫上下文" class="headerlink" title="3. 資料庫上下文"></a>3. 資料庫上下文</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ApplicationDbContext</span> : <span class="title">IdentityDbContext</span>&lt;<span class="title">ApplicationUser</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApplicationDbContext</span>(<span class="params">DbContextOptions&lt;ApplicationDbContext&gt; options</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">options</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="API-存取控制"><a href="#API-存取控制" class="headerlink" title="API 存取控制"></a>API 存取控制</h2><h3 id="1-實作請求限流"><a href="#1-實作請求限流" class="headerlink" title="1. 實作請求限流"></a>1. 實作請求限流</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.Configure&lt;IpRateLimitOptions&gt;(builder.Configuration.GetSection(<span class="string">&quot;IpRateLimit&quot;</span>));</span><br><span class="line">builder.Services.AddSingleton&lt;IIpPolicyStore, MemoryCacheIpPolicyStore&gt;();</span><br><span class="line">builder.Services.AddSingleton&lt;IRateLimitCounterStore, MemoryCacheRateLimitCounterStore&gt;();</span><br></pre></td></tr></table></figure>

<h3 id="2-自訂授權政策"><a href="#2-自訂授權政策" class="headerlink" title="2. 自訂授權政策"></a>2. 自訂授權政策</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddAuthorization(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    options.AddPolicy(<span class="string">&quot;RequireAdminRole&quot;</span>, policy =&gt; </span><br><span class="line">        policy.RequireRole(<span class="string">&quot;Admin&quot;</span>));</span><br><span class="line">        </span><br><span class="line">    options.AddPolicy(<span class="string">&quot;RequireApiAccess&quot;</span>, policy =&gt;</span><br><span class="line">        policy.RequireClaim(<span class="string">&quot;scope&quot;</span>, <span class="string">&quot;api_access&quot;</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="API-端點安全性"><a href="#API-端點安全性" class="headerlink" title="API 端點安全性"></a>API 端點安全性</h2><h3 id="1-安全的控制器範例"><a href="#1-安全的控制器範例" class="headerlink" title="1. 安全的控制器範例"></a>1. 安全的控制器範例</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">ApiController</span>]</span><br><span class="line">[<span class="meta">Route(<span class="string">&quot;api/[controller]&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">Authorize</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SecureController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;SecureController&gt; _logger;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecureController</span>(<span class="params">ILogger&lt;SecureController&gt; logger</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HttpGet</span>]</span><br><span class="line">    [<span class="meta">ProducesResponseType(StatusCodes.Status200OK)</span>]</span><br><span class="line">    [<span class="meta">ProducesResponseType(StatusCodes.Status401Unauthorized)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">Get</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 記錄存取</span></span><br><span class="line">            _logger.LogInformation(</span><br><span class="line">                <span class="string">&quot;Access attempt by user &#123;User&#125; at &#123;Time&#125;&quot;</span>, </span><br><span class="line">                User.Identity.Name, </span><br><span class="line">                DateTime.UtcNow);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 驗證請求的其他屬性</span></span><br><span class="line">            <span class="keyword">if</span> (!ValidateRequest())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> Unauthorized();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 回傳資料</span></span><br><span class="line">            <span class="keyword">return</span> Ok(<span class="keyword">new</span> &#123; message = <span class="string">&quot;Secure data&quot;</span> &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogError(ex, <span class="string">&quot;Error occurred while processing request&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> StatusCode(<span class="number">500</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">ValidateRequest</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 實作額外的請求驗證邏輯</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-全域錯誤處理中介軟體"><a href="#2-全域錯誤處理中介軟體" class="headerlink" title="2. 全域錯誤處理中介軟體"></a>2. 全域錯誤處理中介軟體</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SecurityHeadersMiddleware</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> RequestDelegate _next;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecurityHeadersMiddleware</span>(<span class="params">RequestDelegate next</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _next = next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">InvokeAsync</span>(<span class="params">HttpContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 加入安全標頭</span></span><br><span class="line">        context.Response.Headers.Add(<span class="string">&quot;X-Frame-Options&quot;</span>, <span class="string">&quot;DENY&quot;</span>);</span><br><span class="line">        context.Response.Headers.Add(<span class="string">&quot;X-Content-Type-Options&quot;</span>, <span class="string">&quot;nosniff&quot;</span>);</span><br><span class="line">        context.Response.Headers.Add(<span class="string">&quot;X-XSS-Protection&quot;</span>, <span class="string">&quot;1; mode=block&quot;</span>);</span><br><span class="line">        context.Response.Headers.Add(<span class="string">&quot;Referrer-Policy&quot;</span>, <span class="string">&quot;strict-origin-when-cross-origin&quot;</span>);</span><br><span class="line">        context.Response.Headers.Add(<span class="string">&quot;Content-Security-Policy&quot;</span>, </span><br><span class="line">            <span class="string">&quot;default-src &#x27;self&#x27;; script-src &#x27;self&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> _next(context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="加密與安全通訊"><a href="#加密與安全通訊" class="headerlink" title="加密與安全通訊"></a>加密與安全通訊</h2><h3 id="1-HTTPS-設定"><a href="#1-HTTPS-設定" class="headerlink" title="1. HTTPS 設定"></a>1. HTTPS 設定</h3><p>在 <code>Program.cs</code> 中加入：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line">app.UseHttpsRedirection();</span><br><span class="line">app.UseHsts();</span><br></pre></td></tr></table></figure>

<h3 id="2-敏感資料加密服務"><a href="#2-敏感資料加密服務" class="headerlink" title="2. 敏感資料加密服務"></a>2. 敏感資料加密服務</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IEncryptionService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">Encrypt</span>(<span class="params"><span class="built_in">string</span> plainText</span>)</span>;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">Decrypt</span>(<span class="params"><span class="built_in">string</span> cipherText</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意: 在生產環境中，應該為每次加密操作產生新的 IV</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EncryptionService</span> : <span class="title">IEncryptionService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="built_in">string</span> _key;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="built_in">string</span> _iv;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EncryptionService</span>(<span class="params">IConfiguration configuration</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _key = configuration[<span class="string">&quot;Encryption:Key&quot;</span>];</span><br><span class="line">        _iv = configuration[<span class="string">&quot;Encryption:IV&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Encrypt</span>(<span class="params"><span class="built_in">string</span> plainText</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> (Aes aes = Aes.Create())</span><br><span class="line">        &#123;</span><br><span class="line">            aes.Key = Encoding.UTF8.GetBytes(_key);</span><br><span class="line">            aes.IV = Encoding.UTF8.GetBytes(_iv);</span><br><span class="line"></span><br><span class="line">            ICryptoTransform encryptor = aes.CreateEncryptor(aes.Key, aes.IV);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">using</span> (MemoryStream msEncrypt = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">using</span> (CryptoStream csEncrypt = <span class="keyword">new</span> CryptoStream(</span><br><span class="line">                    msEncrypt, encryptor, CryptoStreamMode.Write))</span><br><span class="line">                <span class="keyword">using</span> (StreamWriter swEncrypt = <span class="keyword">new</span> StreamWriter(csEncrypt))</span><br><span class="line">                &#123;</span><br><span class="line">                    swEncrypt.Write(plainText);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> Convert.ToBase64String(msEncrypt.ToArray());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Decrypt</span>(<span class="params"><span class="built_in">string</span> cipherText</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 實作解密邏輯</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">string</span>.Empty;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="日誌記錄與監控"><a href="#日誌記錄與監控" class="headerlink" title="日誌記錄與監控"></a>日誌記錄與監控</h2><h3 id="1-設定結構化日誌"><a href="#1-設定結構化日誌" class="headerlink" title="1. 設定結構化日誌"></a>1. 設定結構化日誌</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">builder.Logging.ClearProviders();</span><br><span class="line">builder.Logging.AddConsole();</span><br><span class="line">builder.Logging.AddDebug();</span><br><span class="line">builder.Logging.AddEventLog();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加入 Serilog</span></span><br><span class="line">builder.Logging.AddSerilog(<span class="keyword">new</span> LoggerConfiguration()</span><br><span class="line">    .WriteTo.File(<span class="string">&quot;logs/api-.txt&quot;</span>, rollingInterval: RollingInterval.Day)</span><br><span class="line">    .CreateLogger());</span><br></pre></td></tr></table></figure>

<h3 id="2-稽核日誌中介軟體"><a href="#2-稽核日誌中介軟體" class="headerlink" title="2. 稽核日誌中介軟體"></a>2. 稽核日誌中介軟體</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AuditLoggingMiddleware</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> RequestDelegate _next;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger _logger;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AuditLoggingMiddleware</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        RequestDelegate next,</span></span></span><br><span class="line"><span class="params"><span class="function">        ILogger&lt;AuditLoggingMiddleware&gt; logger</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _next = next;</span><br><span class="line">        _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">InvokeAsync</span>(<span class="params">HttpContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> auditLog = <span class="keyword">new</span></span><br><span class="line">        &#123;</span><br><span class="line">            Timestamp = DateTime.UtcNow,</span><br><span class="line">            RequestPath = context.Request.Path,</span><br><span class="line">            RequestMethod = context.Request.Method,</span><br><span class="line">            UserAgent = context.Request.Headers[<span class="string">&quot;User-Agent&quot;</span>].ToString(),</span><br><span class="line">            UserIp = context.Connection.RemoteIpAddress?.ToString(),</span><br><span class="line">            UserId = context.User.Identity?.Name</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        _logger.LogInformation(</span><br><span class="line">            <span class="string">&quot;API Request: &#123;@AuditLog&#125;&quot;</span>, auditLog);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> _next(context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="跨域資源共用-CORS-設定"><a href="#跨域資源共用-CORS-設定" class="headerlink" title="跨域資源共用(CORS)設定"></a>跨域資源共用(CORS)設定</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddCors(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    options.AddPolicy(<span class="string">&quot;SecurePolicy&quot;</span>, policy =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        policy</span><br><span class="line">            .WithOrigins(</span><br><span class="line">                <span class="comment">// 設定允許的來源網域</span></span><br><span class="line">                <span class="string">&quot;https://yourdomain.com&quot;</span>,</span><br><span class="line">                <span class="string">&quot;https://api.yourdomain.com&quot;</span></span><br><span class="line">            )</span><br><span class="line">            .WithMethods(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>, <span class="string">&quot;PUT&quot;</span>, <span class="string">&quot;DELETE&quot;</span>)  <span class="comment">// 允許的 HTTP 方法</span></span><br><span class="line">            .WithHeaders(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>)  <span class="comment">// 允許的標頭</span></span><br><span class="line">            .AllowCredentials()  <span class="comment">// 允許認證資訊</span></span><br><span class="line">            .SetPreflightMaxAge(TimeSpan.FromMinutes(<span class="number">10</span>));  <span class="comment">// 預檢請求快取時間</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 Program.cs 中啟用 CORS</span></span><br><span class="line">app.UseCors(<span class="string">&quot;SecurePolicy&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="健康檢查設定"><a href="#健康檢查設定" class="headerlink" title="健康檢查設定"></a>健康檢查設定</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 註冊健康檢查服務</span></span><br><span class="line"><span class="comment">// DiskSpaceHealthCheck 和 CustomHealthCheck 僅為示範用途</span></span><br><span class="line"><span class="comment">// 實際使用時應根據專案需求實作完整的檢查邏輯</span></span><br><span class="line">builder.Services.AddHealthChecks()</span><br><span class="line">    .AddDbContextCheck&lt;ApplicationDbContext&gt;()  <span class="comment">// 檢查資料庫連線</span></span><br><span class="line">    .AddUrlGroup(<span class="keyword">new</span> Uri(<span class="string">&quot;https://dependent-service.com/health&quot;</span>))  <span class="comment">// 檢查相依服務</span></span><br><span class="line">    .AddCheck(<span class="string">&quot;DiskSpace&quot;</span>, <span class="keyword">new</span> DiskSpaceHealthCheck(<span class="number">1024</span>))  <span class="comment">// 自訂檢查</span></span><br><span class="line">    .AddCheck&lt;CustomHealthCheck&gt;(<span class="string">&quot;Custom&quot;</span>);  <span class="comment">// 自訂健康檢查邏輯</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 自訂健康檢查邏輯</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomHealthCheck</span> : <span class="title">IHealthCheck</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task&lt;HealthCheckResult&gt; <span class="title">CheckHealthAsync</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        HealthCheckContext context, </span></span></span><br><span class="line"><span class="params"><span class="function">        CancellationToken cancellationToken = <span class="literal">default</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 執行健康檢查邏輯</span></span><br><span class="line">            <span class="keyword">return</span> Task.FromResult(HealthCheckResult.Healthy());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Task.FromResult(</span><br><span class="line">                HealthCheckResult.Unhealthy(ex.Message));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 Program.cs 中設定健康檢查端點</span></span><br><span class="line">app.MapHealthChecks(<span class="string">&quot;/health&quot;</span>, <span class="keyword">new</span> HealthCheckOptions</span><br><span class="line">&#123;</span><br><span class="line">    ResponseWriter = UIResponseWriter.WriteHealthCheckUIResponse</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="容器化與部署"><a href="#容器化與部署" class="headerlink" title="容器化與部署"></a>容器化與部署</h2><h3 id="1-Docker-設定"><a href="#1-Docker-設定" class="headerlink" title="1. Docker 設定"></a>1. Docker 設定</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> mcr.microsoft.com/dotnet/aspnet:<span class="number">7.0</span> AS base</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">443</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> mcr.microsoft.com/dotnet/sdk:<span class="number">7.0</span> AS build</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /src</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> [<span class="string">&quot;ZeroTrustApi.csproj&quot;</span>, <span class="string">&quot;./&quot;</span>]</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> dotnet restore <span class="string">&quot;ZeroTrustApi.csproj&quot;</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> dotnet build <span class="string">&quot;ZeroTrustApi.csproj&quot;</span> -c Release -o /app/build</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> build AS publish</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> dotnet publish <span class="string">&quot;ZeroTrustApi.csproj&quot;</span> -c Release -o /app/publish</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> base AS final</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=publish /app/publish .</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;dotnet&quot;</span>, <span class="string">&quot;ZeroTrustApi.dll&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="2-CI-CD-Pipeline-GitHub-Actions"><a href="#2-CI-CD-Pipeline-GitHub-Actions" class="headerlink" title="2. CI/CD Pipeline (GitHub Actions)"></a>2. CI/CD Pipeline (GitHub Actions)</h3><h1 id="這是基本範例，實際使用時應該根據部署環境需求調整設定"><a href="#這是基本範例，實際使用時應該根據部署環境需求調整設定" class="headerlink" title="這是基本範例，實際使用時應該根據部署環境需求調整設定"></a>這是基本範例，實際使用時應該根據部署環境需求調整設定</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">.NET</span> <span class="string">Core</span> <span class="string">CI/CD</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span> [ <span class="string">main</span> ]</span><br><span class="line">  <span class="attr">pull_request:</span></span><br><span class="line">    <span class="attr">branches:</span> [ <span class="string">main</span> ]</span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build-and-test:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setup</span> <span class="string">.NET</span> <span class="string">Core</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">actions/setup-dotnet@v1</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">dotnet-version:</span> <span class="string">&#x27;7.0.x&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restore</span> <span class="string">dependencies</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">dotnet</span> <span class="string">restore</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">dotnet</span> <span class="string">build</span> <span class="string">--configuration</span> <span class="string">Release</span> <span class="string">--no-restore</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Test</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">dotnet</span> <span class="string">test</span> <span class="string">--no-restore</span> <span class="string">--verbosity</span> <span class="string">normal</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Publish</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">dotnet</span> <span class="string">publish</span> <span class="string">-c</span> <span class="string">Release</span> <span class="string">-o</span> <span class="string">published</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">push</span> <span class="string">Docker</span> <span class="string">image</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">docker/build-push-action@v2</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">        <span class="attr">push:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">yourdockerrepo/zerotrust-api:latest</span></span><br></pre></td></tr></table></figure>


<h2 id="APM-與監控"><a href="#APM-與監控" class="headerlink" title="APM 與監控"></a>APM 與監控</h2><h3 id="1-Application-Insights-設定"><a href="#1-Application-Insights-設定" class="headerlink" title="1. Application Insights 設定"></a>1. Application Insights 設定</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 Program.cs 中加入</span></span><br><span class="line">builder.Services.AddApplicationInsightsTelemetry(options =&gt; </span><br><span class="line">&#123;</span><br><span class="line">    options.ConnectionString = builder.Configuration[<span class="string">&quot;ApplicationInsights:ConnectionString&quot;</span>];</span><br><span class="line">    options.EnableAdaptiveSampling = <span class="literal">false</span>;  <span class="comment">// 在開發環境建議關閉</span></span><br><span class="line">    options.EnableDebugLogger = <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自訂遙測</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomTelemetryInitializer</span> : <span class="title">ITelemetryInitializer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Initialize</span>(<span class="params">ITelemetry telemetry</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        telemetry.Context.Cloud.RoleName = <span class="string">&quot;ZeroTrustApi&quot;</span>;</span><br><span class="line">        telemetry.Context.Cloud.RoleInstance = Environment.MachineName;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (telemetry <span class="keyword">is</span> RequestTelemetry request)</span><br><span class="line">        &#123;</span><br><span class="line">            request.Properties[<span class="string">&quot;CustomProperty&quot;</span>] = <span class="string">&quot;CustomValue&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-效能監控"><a href="#2-效能監控" class="headerlink" title="2. 效能監控"></a>2. 效能監控</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PerformanceMonitoringMiddleware</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> RequestDelegate _next;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger _logger;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> TelemetryClient _telemetryClient;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PerformanceMonitoringMiddleware</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        RequestDelegate next,</span></span></span><br><span class="line"><span class="params"><span class="function">        ILogger&lt;PerformanceMonitoringMiddleware&gt; logger,</span></span></span><br><span class="line"><span class="params"><span class="function">        TelemetryClient telemetryClient</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _next = next;</span><br><span class="line">        _logger = logger;</span><br><span class="line">        _telemetryClient = telemetryClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">InvokeAsync</span>(<span class="params">HttpContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> sw = Stopwatch.StartNew();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> _next(context);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        &#123;</span><br><span class="line">            sw.Stop();</span><br><span class="line">            <span class="keyword">var</span> elapsed = sw.ElapsedMilliseconds;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 記錄執行時間</span></span><br><span class="line">            _telemetryClient.TrackMetric(</span><br><span class="line">                <span class="string">&quot;RequestDuration&quot;</span>,</span><br><span class="line">                elapsed,</span><br><span class="line">                <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    &#123;<span class="string">&quot;Path&quot;</span>, context.Request.Path&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;Method&quot;</span>, context.Request.Method&#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果執行時間超過閾值，記錄警告</span></span><br><span class="line">            <span class="keyword">if</span> (elapsed &gt; <span class="number">1000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogWarning(</span><br><span class="line">                    <span class="string">&quot;Long running request: &#123;Path&#125; took &#123;Elapsed&#125;ms&quot;</span>,</span><br><span class="line">                    context.Request.Path,</span><br><span class="line">                    elapsed);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="最佳實踐建議"><a href="#最佳實踐建議" class="headerlink" title="最佳實踐建議"></a>最佳實踐建議</h2><ol>
<li><p><strong>定期更新套件</strong>：</p>
<ul>
<li>使用 <code>dotnet list package --vulnerable</code> 檢查漏洞</li>
<li>設定自動化更新提醒</li>
</ul>
</li>
<li><p><strong>設定檔管理</strong>：</p>
<ul>
<li>使用 Azure Key Vault 或其他安全的祕密管理服務</li>
<li>不要在程式碼中硬編碼任何祕密</li>
</ul>
</li>
<li><p><strong>API 版本控制</strong>：</p>
<ul>
<li>實作 API 版本管理</li>
<li>提供版本降級機制</li>
</ul>
</li>
<li><p><strong>效能與安全性平衡</strong>：</p>
<ul>
<li>實作快取機制</li>
<li>使用適當的請求限流設定</li>
</ul>
</li>
<li><p><strong>持續監控</strong>：</p>
<ul>
<li>設定警報機制</li>
<li>定期審查日誌</li>
<li>進行安全性掃描</li>
</ul>
</li>
<li><p><strong>災難復原計畫</strong>：</p>
<ul>
<li>  定期備份資料庫和設定檔</li>
<li>  建立自動化還原程序</li>
<li>  設定異地備援機制</li>
<li>  進行定期的災難復原演練</li>
</ul>
</li>
<li><p> <strong>API 限流設定範例</strong>：</p>
</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.Configure&lt;IpRateLimitOptions&gt;(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    options.GeneralRules = <span class="keyword">new</span> List&lt;RateLimitRule&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">new</span> RateLimitRule</span><br><span class="line">        &#123;</span><br><span class="line">            Endpoint = <span class="string">&quot;*&quot;</span>,  <span class="comment">// 適用所有端點</span></span><br><span class="line">            Period = <span class="string">&quot;1m&quot;</span>,   <span class="comment">// 時間區間</span></span><br><span class="line">            Limit = <span class="number">30</span>       <span class="comment">// 請求數限制</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">new</span> RateLimitRule</span><br><span class="line">        &#123;</span><br><span class="line">            Endpoint = <span class="string">&quot;*&quot;</span>,</span><br><span class="line">            Period = <span class="string">&quot;1h&quot;</span>,</span><br><span class="line">            Limit = <span class="number">500</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ol start="8">
<li> <strong>密碼雜湊設定</strong>：</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.Configure&lt;IdentityOptions&gt;(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    options.Password.RequireDigit = <span class="literal">true</span>;</span><br><span class="line">    options.Password.RequiredLength = <span class="number">8</span>;</span><br><span class="line">    options.Password.RequireNonAlphanumeric = <span class="literal">true</span>;</span><br><span class="line">    options.Password.RequireUppercase = <span class="literal">true</span>;</span><br><span class="line">    options.Password.RequireLowercase = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 密碼雜湊設定</span></span><br><span class="line">    options.Password.HasherOptions = <span class="keyword">new</span> PasswordHasherOptions</span><br><span class="line">    &#123;</span><br><span class="line">        IterationCount = <span class="number">100000</span>  <span class="comment">// PBKDF2 迭代次數</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>實作零信任架構需要全面性的考量，從身分驗證、授權、加密到監控都需要謹慎規劃。本文提供的範例程式碼和建議可作為建置安全 API 的起點，但記住安全是一個持續進行的過程，需要定期檢視和更新。</p>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ref>
* [ASP.NET Core 安全性文件](https://docs.microsoft.com/zh-tw/aspnet/core/security/)
* [OWASP Top 10 API Security Risks](https://owasp.org/www-project-api-security/)
* [Microsoft Identity Platform](https://docs.microsoft.com/zh-tw/azure/active-directory/develop/)
* [ASP.NET Core 應用程式監控](https://docs.microsoft.com/zh-tw/azure/azure-monitor/app/asp-net-core) 
* [Docker 容器化最佳實踐](https://docs.docker.com/develop/develop-images/dockerfile\_best-practices/) 
* [.NET Core 中的密碼雜湊](https://docs.microsoft.com/zh-tw/aspnet/core/security/data-protection/consumer-apis/password-hashing)
</ref>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">HTMX：網頁開發的優雅回歸</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2024-10-17 16:13:15" itemprop="dateCreated datePublished" datetime="2024-10-17T16:13:15+08:00">2024-10-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-11-27 14:54:54" itemprop="dateModified" datetime="2024-11-27T14:54:54+08:00">2024-11-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A8%8B%E5%BC%8F%E6%95%99%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">程式教學</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>1k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>1 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="HTMX：網頁開發的優雅回歸"><a href="#HTMX：網頁開發的優雅回歸" class="headerlink" title="HTMX：網頁開發的優雅回歸"></a>HTMX：網頁開發的優雅回歸</h1><p>在這幾年的網頁開發生態中，我們看到一個有趣的現象：HTMX 這類強調後端渲染的技術框架逐漸受到歡迎。這個趨勢某種程度上打破了過去「前後端分離」的主流思維，值得我們深入探討。</p>
<h2 id="前後端分離時代的挑戰"><a href="#前後端分離時代的挑戰" class="headerlink" title="前後端分離時代的挑戰"></a>前後端分離時代的挑戰</h2><p>過去幾年，前後端分離的開發模式一直是主流。這種架構確實帶來許多好處：</p>
<ul>
<li>前端團隊可以專注在使用者體驗</li>
<li>後端專注在商業邏輯與資料處理</li>
<li>API 可以服務多種客戶端</li>
<li>更容易做到水平擴展</li>
</ul>
<p>但隨著時間推移，開發者也逐漸體會到這種架構的一些痛點：</p>
<ul>
<li>需要維護兩個獨立的程式碼庫</li>
<li>狀態管理變得複雜</li>
<li>開發門檻提高</li>
<li>建置與部署流程變得繁瑣</li>
<li>效能優化需要更多心力</li>
</ul>
<h2 id="HTMX：簡單而強大"><a href="#HTMX：簡單而強大" class="headerlink" title="HTMX：簡單而強大"></a>HTMX：簡單而強大</h2><p>HTMX 提供了一個更簡單的解決方案。它讓我們能夠直接在 HTML 中使用屬性來處理互動，而不需要寫大量的 JavaScript 程式碼。</p>
<h3 id="基本語法示例："><a href="#基本語法示例：" class="headerlink" title="基本語法示例："></a>基本語法示例：</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">hx-post</span>=<span class="string">&quot;/submit&quot;</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">hx-target</span>=<span class="string">&quot;#result&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">hx-swap</span>=<span class="string">&quot;outerHTML&quot;</span>&gt;</span></span><br><span class="line">  送出</span><br><span class="line"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>這段程式碼就能處理 AJAX 請求、更新 DOM，還有動態內容載入，簡單明瞭。</p>
<h3 id="HTMX-的主要優勢："><a href="#HTMX-的主要優勢：" class="headerlink" title="HTMX 的主要優勢："></a>HTMX 的主要優勢：</h3><ol>
<li><p><strong>開發效率</strong></p>
<ul>
<li>減少重複的程式碼</li>
<li>更快的開發週期</li>
<li>較低的維護成本</li>
</ul>
</li>
<li><p><strong>效能表現</strong></p>
<ul>
<li>較小的前端資源大小</li>
<li>更快的初始載入時間</li>
<li>較低的記憶體使用量</li>
</ul>
</li>
<li><p><strong>學習曲線</strong></p>
<ul>
<li>容易上手</li>
<li>熟悉 HTML 的開發者可以快速適應</li>
<li>不需要學習複雜的前端框架</li>
</ul>
</li>
</ol>
<h2 id="為什麼現在開始流行？"><a href="#為什麼現在開始流行？" class="headerlink" title="為什麼現在開始流行？"></a>為什麼現在開始流行？</h2><p>這個轉變反映了幾個重要的趨勢：</p>
<ol>
<li><p><strong>複雜度疲勞</strong></p>
<ul>
<li>開發者開始尋找更簡單的解決方案</li>
<li>不是每個專案都需要完整的 SPA 架構</li>
<li>對於較小型的專案，全端分離可能是過度設計</li>
</ul>
</li>
<li><p><strong>效能意識</strong></p>
<ul>
<li>使用者對網站效能的要求提高</li>
<li>行動裝置用戶增加，對載入速度更敏感</li>
<li>搜尋引擎對效能的重視</li>
</ul>
</li>
<li><p><strong>實用主義的回歸</strong></p>
<ul>
<li>開發者開始重視實際需求而非追求潮流</li>
<li>尋找最適合專案的技術，而非最新的技術</li>
<li>重視開發效率與維護性</li>
</ul>
</li>
</ol>
<h2 id="適合的使用場景"><a href="#適合的使用場景" class="headerlink" title="適合的使用場景"></a>適合的使用場景</h2><p>HTMX 特別適合：</p>
<ul>
<li>內部管理系統</li>
<li>資料導向的應用程式</li>
<li>需要快速開發的專案</li>
<li>較小型的網站</li>
<li>需要 SEO 優化的網站</li>
</ul>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>HTMX 的興起並不意味著前後端分離架構就此沒落，而是提供了另一種選擇。對於許多專案來說，這可能是一個更務實的解決方案。重點在於選擇適合專案需求的技術，而不是盲目追隨趨勢。</p>
<p>在評估是否採用 HTMX 時，建議考慮：</p>
<ul>
<li>專案的規模與複雜度</li>
<li>團隊的技術能力</li>
<li>開發時程</li>
<li>效能需求</li>
<li>維護成本</li>
</ul>
<p>最後，這個技術趨勢提醒我們：有時候，更簡單的解決方案可能才是更好的選擇。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">Visual Studio ReSharper 擴充套件完整介紹</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2024-10-02 18:59:10" itemprop="dateCreated datePublished" datetime="2024-10-02T18:59:10+08:00">2024-10-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-11-27 14:40:34" itemprop="dateModified" datetime="2024-11-27T14:40:34+08:00">2024-11-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%96%8B%E7%99%BC%E7%9B%B8%E9%97%9C/" itemprop="url" rel="index"><span itemprop="name">開發相關</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>1.2k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>1 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Visual-Studio-ReSharper-擴充套件完整介紹"><a href="#Visual-Studio-ReSharper-擴充套件完整介紹" class="headerlink" title="Visual Studio ReSharper 擴充套件完整介紹"></a>Visual Studio ReSharper 擴充套件完整介紹</h1><p>在 Visual Studio 的眾多擴充套件中，ReSharper 可說是最受歡迎的生產力工具之一。本文將詳細介紹 ReSharper 的主要功能，讓你的開發效率更上一層樓！</p>
<h2 id="什麼是-ReSharper？"><a href="#什麼是-ReSharper？" class="headerlink" title="什麼是 ReSharper？"></a>什麼是 ReSharper？</h2><p>ReSharper 是由 JetBrains 公司開發的 Visual Studio 擴充套件，專門用於提升 .NET 開發人員的生產力。它提供了強大的程式碼分析、重構工具和智慧提示功能。</p>
<h2 id="主要功能介紹"><a href="#主要功能介紹" class="headerlink" title="主要功能介紹"></a>主要功能介紹</h2><h3 id="1-即時程式碼分析"><a href="#1-即時程式碼分析" class="headerlink" title="1. 即時程式碼分析"></a>1. 即時程式碼分析</h3><ul>
<li>自動偵測潛在問題和效能瓶頸</li>
<li>提供最佳實踐建議</li>
<li>突顯未使用的程式碼和多餘的參照</li>
<li>即時檢查命名規則符合性</li>
</ul>
<h3 id="2-強大的重構工具"><a href="#2-強大的重構工具" class="headerlink" title="2. 強大的重構工具"></a>2. 強大的重構工具</h3><ul>
<li>變數重命名（支援跨檔案）</li>
<li>方法提取與內嵌</li>
<li>介面提取</li>
<li>程式碼移動與重組</li>
<li>自動產生建構函式、屬性等樣板程式碼</li>
</ul>
<h3 id="3-導覽增強"><a href="#3-導覽增強" class="headerlink" title="3. 導覽增強"></a>3. 導覽增強</h3><ul>
<li>快速搜尋任何內容（Alt+`)</li>
<li>跳至宣告/實作</li>
<li>找出所有參照</li>
<li>檔案結構視圖</li>
<li>繼承階層檢視</li>
</ul>
<h3 id="4-程式碼產生與樣板"><a href="#4-程式碼產生與樣板" class="headerlink" title="4. 程式碼產生與樣板"></a>4. 程式碼產生與樣板</h3><ul>
<li>自動完成常用程式碼片段</li>
<li>客製化程式碼樣板</li>
<li>單元測試產生器</li>
<li>建構函式參數包裝器</li>
</ul>
<h3 id="5-語言支援"><a href="#5-語言支援" class="headerlink" title="5. 語言支援"></a>5. 語言支援</h3><ul>
<li>C#</li>
<li>VB.NET</li>
<li>TypeScript/JavaScript</li>
<li>HTML/CSS</li>
<li>XAML</li>
<li>ASP.NET</li>
<li>ASP.NET Core</li>
</ul>
<h2 id="實用快速鍵"><a href="#實用快速鍵" class="headerlink" title="實用快速鍵"></a>實用快速鍵</h2><p>以下是一些最常用的快速鍵：</p>
<table>
<thead>
<tr>
<th>功能</th>
<th>快速鍵</th>
</tr>
</thead>
<tbody><tr>
<td>快速修正建議</td>
<td>Alt+Enter</td>
</tr>
<tr>
<td>重構選單</td>
<td>Ctrl+Shift+R</td>
</tr>
<tr>
<td>快速搜尋</td>
<td>Alt+`</td>
</tr>
<tr>
<td>前往任何內容</td>
<td>Ctrl+T</td>
</tr>
<tr>
<td>尋找用法</td>
<td>Alt+F7</td>
</tr>
</tbody></table>
<h2 id="安裝方式"><a href="#安裝方式" class="headerlink" title="安裝方式"></a>安裝方式</h2><ol>
<li>開啟 Visual Studio</li>
<li>點選「工具」&gt;「擴充功能和更新」</li>
<li>搜尋 &quot;ReSharper&quot;</li>
<li>點選下載並安裝</li>
<li>重新啟動 Visual Studio</li>
</ol>
<h2 id="授權選擇"><a href="#授權選擇" class="headerlink" title="授權選擇"></a>授權選擇</h2><p>ReSharper 提供多種授權方案：</p>
<ol>
<li><p><strong>個人授權</strong></p>
<ul>
<li>適合個人開發者</li>
<li>可在多台電腦上使用</li>
<li>提供月付或年付選項</li>
</ul>
</li>
<li><p><strong>商業授權</strong></p>
<ul>
<li>適合公司團隊使用</li>
<li>提供團隊版本控管</li>
<li>包含技術支援服務</li>
</ul>
</li>
<li><p><strong>試用版</strong></p>
<ul>
<li>提供 30 天免費試用</li>
<li>功能完全開放</li>
<li>無須信用卡資訊</li>
</ul>
</li>
</ol>
<h2 id="效能考量"><a href="#效能考量" class="headerlink" title="效能考量"></a>效能考量</h2><p>雖然 ReSharper 功能強大，但也需要注意一些使用上的考量：</p>
<ol>
<li><p><strong>記憶體使用</strong></p>
<ul>
<li>ReSharper 會佔用較多系統資源</li>
<li>建議電腦配備至少 16GB RAM</li>
<li>大型專案可能需要更多資源</li>
</ul>
</li>
<li><p><strong>解決方案大小</strong></p>
<ul>
<li>專案越大，初次載入時間越長</li>
<li>建議使用 SSD 以提升效能</li>
<li>可考慮只載入需要的專案</li>
</ul>
</li>
</ol>
<h2 id="使用技巧"><a href="#使用技巧" class="headerlink" title="使用技巧"></a>使用技巧</h2><ol>
<li><p><strong>善用 Solution-Wide Analysis</strong></p>
<ul>
<li>可即時檢查整個方案的問題</li>
<li>適合在 code review 前執行</li>
<li>可找出跨專案的相依性問題</li>
</ul>
</li>
<li><p><strong>客製化程式碼樣式</strong></p>
<ul>
<li>設定符合團隊的編碼規範</li>
<li>統一格式化規則</li>
<li>自動執行程式碼清理</li>
</ul>
</li>
<li><p><strong>整合版本控制</strong></p>
<ul>
<li>支援 Git 操作整合</li>
<li>顯示程式碼變更記錄</li>
<li>衝突解決輔助</li>
</ul>
</li>
</ol>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>ReSharper 是一個功能非常完整的開發工具，雖然需要付費使用，但其提供的生產力提升絕對值得投資。對於經常使用 Visual Studio 進行 .NET 開發的開發者來說，ReSharper 幾乎是必備的工具之一。</p>
<p>透過本文的介紹，相信讀者們已經對 ReSharper 有了基本的認識。建議可以先使用試用版本體驗看看，若覺得適合再購買授權。記得善用快速鍵和自動化功能，讓開發工作更加順暢！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">SQL優化：處理百萬級資料表的結構修改</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2024-09-27 09:51:14" itemprop="dateCreated datePublished" datetime="2024-09-27T09:51:14+08:00">2024-09-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-11-27 14:39:06" itemprop="dateModified" datetime="2024-11-27T14:39:06+08:00">2024-11-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A8%8B%E5%BC%8F%E6%95%99%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">程式教學</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>5k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>5 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="SQL優化：處理千萬級資料表的結構修改"><a href="#SQL優化：處理千萬級資料表的結構修改" class="headerlink" title="SQL優化：處理千萬級資料表的結構修改"></a>SQL優化：處理千萬級資料表的結構修改</h1><p>在資料庫管理中，當我們面對龐大的資料表時，進行結構修改常常會遇到效能問題。本文將探討如何處理一個資料量達到千萬級別的資料表，並在不造成系統超時的情況下完成結構修改。</p>
<h2 id="問題背景"><a href="#問題背景" class="headerlink" title="問題背景"></a>問題背景</h2><p>當資料表的記錄數量達到千萬級別時，直接執行 <code>ALTER TABLE</code> 指令可能會導致操作超時，影響系統的正常運作。這是因為 MySQL 在執行 <code>ALTER TABLE</code> 時，會鎖定整個資料表，導致其他查詢無法進行，同時也會消耗大量系統資源。</p>
<h2 id="解決方案"><a href="#解決方案" class="headerlink" title="解決方案"></a>解決方案</h2><p>為了解決這個問題，我們可以採用一種漸進式的方法來修改資料表結構。這個方法主要包含以下步驟：</p>
<ol>
<li>建立一個具有新結構的空資料表</li>
<li>複製原始資料到新資料表</li>
<li>重命名資料表</li>
<li>清理舊資料表</li>
</ol>
<p>讓我們來看看具體的 SQL 實現：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 步驟 1：建立新的資料表結構</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> new_table <span class="keyword">LIKE</span> original_table;</span><br><span class="line"><span class="keyword">ALTER TABLE</span> new_table <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> new_column <span class="type">INT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 步驟 2：分批複製資料</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> new_table </span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span>, <span class="keyword">NULL</span> </span><br><span class="line"><span class="keyword">FROM</span> original_table </span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">&gt;</span> <span class="variable">@last_id</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id </span><br><span class="line">LIMIT <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 步驟 3：重命名資料表</span></span><br><span class="line">RENAME <span class="keyword">TABLE</span> original_table <span class="keyword">TO</span> old_table, new_table <span class="keyword">TO</span> original_table;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 步驟 4：刪除舊的資料表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> old_table;</span><br></pre></td></tr></table></figure>

<h2 id="詳細解說"><a href="#詳細解說" class="headerlink" title="詳細解說"></a>詳細解說</h2><h3 id="步驟-1：建立新的資料表結構"><a href="#步驟-1：建立新的資料表結構" class="headerlink" title="步驟 1：建立新的資料表結構"></a>步驟 1：建立新的資料表結構</h3><p>首先，我們建立一個與原始資料表結構相同的新資料表，然後加入我們想要的新欄位。這樣可以確保新資料表的結構與原始資料表一致，同時包含了我們需要的修改。</p>
<h3 id="步驟-2：分批複製資料"><a href="#步驟-2：分批複製資料" class="headerlink" title="步驟 2：分批複製資料"></a>步驟 2：分批複製資料</h3><p>這是整個過程中最關鍵的步驟。我們使用一個迴圈（這裡沒有顯示迴圈結構），每次複製一小部分資料到新的資料表中。<code>@last_id</code> 是一個變數，用來記錄上一次複製的最後一筆資料的 ID。每次迴圈都會更新這個變數，確保下一次複製時能夠接著上次的進度繼續。</p>
<p><code>LIMIT 10000</code> 限制了每次複製的記錄數量，這個數字可以根據系統的效能和需求進行調整。較小的數值會增加迴圈次數但減少每次操作的負擔，較大的數值則相反。</p>
<h3 id="步驟-3：重命名資料表"><a href="#步驟-3：重命名資料表" class="headerlink" title="步驟 3：重命名資料表"></a>步驟 3：重命名資料表</h3><p>當所有資料都複製完成後，我們使用 <code>RENAME TABLE</code> 指令來交換新舊資料表的名稱。這個操作幾乎是瞬時完成的，不會對系統造成太大負擔。</p>
<h3 id="步驟-4：刪除舊的資料表"><a href="#步驟-4：刪除舊的資料表" class="headerlink" title="步驟 4：刪除舊的資料表"></a>步驟 4：刪除舊的資料表</h3><p>最後，我們可以安全地刪除舊的資料表，釋放儲存空間。</p>
<h2 id="優點"><a href="#優點" class="headerlink" title="優點"></a>優點</h2><ol>
<li>減少系統負擔：通過分批處理，避免了一次性操作大量數據造成的系統負擔。</li>
<li>不影響正常業務：在複製過程中，原始資料表仍然可以正常使用，不會影響日常操作。</li>
<li>安全性高：如果在過程中出現問題，可以隨時中斷操作，不會影響原有數據。</li>
<li>彈性大：可以根據系統負載調整每次處理的數據量，找到最佳平衡點。</li>
</ol>
<h2 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h2><ol>
<li>在執行這個過程時，需要確保有足夠的磁碟空間來存儲額外的資料表。</li>
<li>整個過程可能需要較長時間，建議在系統負載較低的時候進行。</li>
<li>在複製過程中，如果原始資料表有新的寫入操作，可能需要額外的機制來同步這些新數據。</li>
</ol>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>通過這種方法，我們成功地在不影響系統正常運作的情況下，完成了對大型資料表的結構修改。這種技巧不僅適用於新增欄位，也可以應用在其他類型的結構修改上。在處理大型資料庫時，採用這種漸進式的方法可以大大提高操作的安全性和效率。</p>
<h2 id="SQL實戰實現"><a href="#SQL實戰實現" class="headerlink" title="SQL實戰實現"></a>SQL實戰實現</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 步驟 1: 刪除現有的新表格（如果存在）</span></span><br><span class="line">IF OBJECT_ID(<span class="string">&#x27;WaterLevelGaugeHistory_New&#x27;</span>, <span class="string">&#x27;U&#x27;</span>) <span class="keyword">IS</span> <span class="keyword">NOT NULL</span></span><br><span class="line">    <span class="keyword">DROP</span> <span class="keyword">TABLE</span> WaterLevelGaugeHistory_New;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 步驟 2: 重新創建新表格，記得將 ID 設置為 IDENTITY</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> WaterLevelGaugeHistory_New (</span><br><span class="line">    ID <span class="type">int</span> <span class="keyword">IDENTITY</span>(<span class="number">1</span>,<span class="number">1</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    stt_no nvarchar(<span class="number">50</span>) <span class="keyword">NULL</span>,</span><br><span class="line">    dev_id nvarchar(<span class="number">50</span>) <span class="keyword">NULL</span>,</span><br><span class="line">    measure_time datetime <span class="keyword">NULL</span>,</span><br><span class="line">    upload_time nvarchar(<span class="number">50</span>) <span class="keyword">NULL</span>,</span><br><span class="line">    val <span class="type">decimal</span>(<span class="number">10</span>, <span class="number">3</span>) <span class="keyword">NULL</span>,</span><br><span class="line">    Voltage <span class="type">decimal</span>(<span class="number">10</span>, <span class="number">3</span>) <span class="keyword">NULL</span>,</span><br><span class="line">    Power nvarchar(<span class="number">10</span>) <span class="keyword">NULL</span>,</span><br><span class="line">    DataLogPeriod nvarchar(<span class="number">50</span>) <span class="keyword">NULL</span>,</span><br><span class="line">    Status <span class="type">int</span> <span class="keyword">NULL</span>,</span><br><span class="line">    flood_season <span class="type">int</span> <span class="keyword">NULL</span>,</span><br><span class="line">    cstatus nvarchar(<span class="number">2</span>) <span class="keyword">NULL</span>,</span><br><span class="line">    nodata bit <span class="keyword">NULL</span>,</span><br><span class="line">    StationClass <span class="type">int</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> PK_WaterLevelGaugeHistory_New <span class="keyword">PRIMARY KEY</span> CLUSTERED (ID)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 步驟 3: 創建一個用於跟蹤進度的臨時表格</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> #ProcessedRows (</span><br><span class="line">    BatchID <span class="type">INT</span> <span class="keyword">IDENTITY</span>(<span class="number">1</span>,<span class="number">1</span>) <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    LastProcessedID <span class="type">INT</span>,</span><br><span class="line">    RowsProcessed <span class="type">INT</span>,</span><br><span class="line">    ProcessedTime DATETIME <span class="keyword">DEFAULT</span> GETDATE()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 步驟 4: 分批複製數據</span></span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@BatchSize</span> <span class="type">INT</span> <span class="operator">=</span> <span class="number">50000</span>; <span class="comment">-- 減小批次大小</span></span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@LastProcessedID</span> <span class="type">INT</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@RowsAffected</span> <span class="type">INT</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@TotalRowsProcessed</span> <span class="type">INT</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@TotalRowsOld</span> <span class="type">INT</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@TotalRowsNew</span> <span class="type">INT</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@StartTime</span> DATETIME <span class="operator">=</span> GETDATE();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 獲取原表的總行數</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@TotalRowsOld</span> <span class="operator">=</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> WaterLevelGaugeHistory;</span><br><span class="line"></span><br><span class="line">WHILE <span class="variable">@LastProcessedID</span> <span class="keyword">IS</span> <span class="keyword">NOT NULL</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">BEGIN</span> TRY</span><br><span class="line">        <span class="keyword">BEGIN</span> TRANSACTION;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">-- 插入一批數據到新表格</span></span><br><span class="line">        <span class="keyword">INSERT INTO</span> WaterLevelGaugeHistory_New (</span><br><span class="line">            stt_no, dev_id, measure_time, upload_time, val, Voltage, Power, </span><br><span class="line">            DataLogPeriod, Status, flood_season, cstatus, nodata, StationClass</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">SELECT</span> TOP (<span class="variable">@BatchSize</span>)</span><br><span class="line">            stt_no, dev_id, measure_time, upload_time, val, Voltage, Power, </span><br><span class="line">            DataLogPeriod, Status, <span class="number">0</span> <span class="keyword">AS</span> flood_season, cstatus, nodata, StationClass</span><br><span class="line">        <span class="keyword">FROM</span> WaterLevelGaugeHistory</span><br><span class="line">        <span class="keyword">WHERE</span> ID <span class="operator">&gt;</span> <span class="variable">@LastProcessedID</span></span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> ID;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">SET</span> <span class="variable">@RowsAffected</span> <span class="operator">=</span> @<span class="variable">@ROWCOUNT</span>;</span><br><span class="line">        <span class="keyword">SET</span> <span class="variable">@TotalRowsProcessed</span> <span class="operator">=</span> <span class="variable">@TotalRowsProcessed</span> <span class="operator">+</span> <span class="variable">@RowsAffected</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- 更新最後處理的 ID</span></span><br><span class="line">        IF <span class="variable">@RowsAffected</span> <span class="operator">&gt;</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">BEGIN</span></span><br><span class="line">            <span class="keyword">SELECT</span> <span class="variable">@LastProcessedID</span> <span class="operator">=</span> <span class="built_in">MAX</span>(ID)</span><br><span class="line">            <span class="keyword">FROM</span> WaterLevelGaugeHistory</span><br><span class="line">            <span class="keyword">WHERE</span> ID <span class="operator">&gt;</span> <span class="variable">@LastProcessedID</span> <span class="keyword">AND</span> ID <span class="operator">&lt;=</span> <span class="variable">@LastProcessedID</span> <span class="operator">+</span> <span class="variable">@BatchSize</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">-- 記錄進度</span></span><br><span class="line">            <span class="keyword">INSERT INTO</span> #ProcessedRows (LastProcessedID, RowsProcessed)</span><br><span class="line">            <span class="keyword">VALUES</span> (<span class="variable">@LastProcessedID</span>, <span class="variable">@RowsAffected</span>);</span><br><span class="line">        <span class="keyword">END</span></span><br><span class="line">        <span class="keyword">ELSE</span></span><br><span class="line">        <span class="keyword">BEGIN</span></span><br><span class="line">            <span class="keyword">SET</span> <span class="variable">@LastProcessedID</span> <span class="operator">=</span> <span class="keyword">NULL</span>; <span class="comment">-- 結束循環</span></span><br><span class="line">        <span class="keyword">END</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">COMMIT</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- 輸出進度</span></span><br><span class="line">        PRINT <span class="string">&#x27;Processed &#x27;</span> <span class="operator">+</span> <span class="built_in">CAST</span>(<span class="variable">@RowsAffected</span> <span class="keyword">AS</span> NVARCHAR(<span class="number">10</span>)) <span class="operator">+</span> <span class="string">&#x27; rows. Last ID: &#x27;</span> <span class="operator">+</span> ISNULL(<span class="built_in">CAST</span>(<span class="variable">@LastProcessedID</span> <span class="keyword">AS</span> NVARCHAR(<span class="number">20</span>)), <span class="string">&#x27;NULL&#x27;</span>) <span class="operator">+</span> </span><br><span class="line">              <span class="string">&#x27;. Total Processed: &#x27;</span> <span class="operator">+</span> <span class="built_in">CAST</span>(<span class="variable">@TotalRowsProcessed</span> <span class="keyword">AS</span> NVARCHAR(<span class="number">20</span>)) <span class="operator">+</span> </span><br><span class="line">              <span class="string">&#x27;. Elapsed Time: &#x27;</span> <span class="operator">+</span> <span class="built_in">CAST</span>(DATEDIFF(<span class="keyword">SECOND</span>, <span class="variable">@StartTime</span>, GETDATE()) <span class="keyword">AS</span> NVARCHAR(<span class="number">10</span>)) <span class="operator">+</span> <span class="string">&#x27; seconds&#x27;</span>;</span><br><span class="line"></span><br><span class="line">         <span class="comment">-- 可選：新增一個小的延遲以減少資源使用</span></span><br><span class="line">        WAITFOR DELAY <span class="string">&#x27;00:00:00.1&#x27;</span>;</span><br><span class="line">    <span class="keyword">END</span> TRY</span><br><span class="line">    <span class="keyword">BEGIN</span> CATCH</span><br><span class="line">        IF @<span class="variable">@TRANCOUNT</span> <span class="operator">&gt;</span> <span class="number">0</span></span><br><span class="line">            <span class="keyword">ROLLBACK</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line">        PRINT <span class="string">&#x27;Error occurred: &#x27;</span> <span class="operator">+</span> ERROR_MESSAGE();</span><br><span class="line">        PRINT <span class="string">&#x27;Error Line: &#x27;</span> <span class="operator">+</span> <span class="built_in">CAST</span>(ERROR_LINE() <span class="keyword">AS</span> NVARCHAR(<span class="number">10</span>));</span><br><span class="line">        PRINT <span class="string">&#x27;Last processed ID: &#x27;</span> <span class="operator">+</span> ISNULL(<span class="built_in">CAST</span>(<span class="variable">@LastProcessedID</span> <span class="keyword">AS</span> NVARCHAR(<span class="number">20</span>)), <span class="string">&#x27;NULL&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- 繼續下一個批次，而不是退出循環</span></span><br><span class="line">        <span class="keyword">SET</span> <span class="variable">@LastProcessedID</span> <span class="operator">=</span> ISNULL(<span class="variable">@LastProcessedID</span> <span class="operator">+</span> <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">END</span> CATCH</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 步驟 5: 驗證數據驗證數據</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@TotalRowsNew</span> <span class="operator">=</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> WaterLevelGaugeHistory_New;</span><br><span class="line"></span><br><span class="line">IF <span class="variable">@TotalRowsOld</span> <span class="operator">=</span> <span class="variable">@TotalRowsNew</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 步驟 6: 重新命名表格</span></span><br><span class="line">    <span class="keyword">EXEC</span> sp_rename <span class="string">&#x27;WaterLevelGaugeHistory&#x27;</span>, <span class="string">&#x27;WaterLevelGaugeHistory_Old&#x27;</span>;</span><br><span class="line">    <span class="keyword">EXEC</span> sp_rename <span class="string">&#x27;WaterLevelGaugeHistory_New&#x27;</span>, <span class="string">&#x27;WaterLevelGaugeHistory&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 步驟 7: 刪除舊表格（可選，取決於您的需求）</span></span><br><span class="line">    <span class="comment">-- DROP TABLE WaterLevelGaugeHistory_Old</span></span><br><span class="line">    </span><br><span class="line">    PRINT <span class="string">&#x27;表格更新成功完成。&#x27;</span>;</span><br><span class="line">    PRINT <span class="string">&#x27;總行數: &#x27;</span> <span class="operator">+</span> <span class="built_in">CAST</span>(<span class="variable">@TotalRowsNew</span> <span class="keyword">AS</span> NVARCHAR(<span class="number">20</span>));</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"><span class="keyword">ELSE</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    PRINT <span class="string">&#x27;數據驗證失敗，請檢查並重試。&#x27;</span>;</span><br><span class="line">    PRINT <span class="string">&#x27;原表行數: &#x27;</span> <span class="operator">+</span> <span class="built_in">CAST</span>(<span class="variable">@TotalRowsOld</span> <span class="keyword">AS</span> NVARCHAR(<span class="number">20</span>));</span><br><span class="line">    PRINT <span class="string">&#x27;新表行數: &#x27;</span> <span class="operator">+</span> <span class="built_in">CAST</span>(<span class="variable">@TotalRowsNew</span> <span class="keyword">AS</span> NVARCHAR(<span class="number">20</span>));</span><br><span class="line">    PRINT <span class="string">&#x27;處理的行數: &#x27;</span> <span class="operator">+</span> <span class="built_in">CAST</span>(<span class="variable">@TotalRowsProcessed</span> <span class="keyword">AS</span> NVARCHAR(<span class="number">20</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 輸出進度詳情，幫助診斷問題</span></span><br><span class="line">    <span class="keyword">SELECT</span> TOP <span class="number">100</span> <span class="operator">*</span> <span class="keyword">FROM</span> #ProcessedRows <span class="keyword">ORDER</span> <span class="keyword">BY</span> BatchID <span class="keyword">DESC</span>;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 清理</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> #ProcessedRows;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/posts/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | kyosora 虛空筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/undefined/" class="post-title-link" itemprop="url">使用 Python 和 FFmpeg 打造簡易視頻轉換器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2024-09-26 17:56:07" itemprop="dateCreated datePublished" datetime="2024-09-26T17:56:07+08:00">2024-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2024-11-27 14:15:10" itemprop="dateModified" datetime="2024-11-27T14:15:10+08:00">2024-11-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A8%8B%E5%BC%8F%E9%96%8B%E7%99%BC/" itemprop="url" rel="index"><span itemprop="name">程式開發</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="閱讀次數">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">閱讀次數：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>2.3k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>2 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="使用-Python-和-FFmpeg-打造簡易視頻轉換器"><a href="#使用-Python-和-FFmpeg-打造簡易視頻轉換器" class="headerlink" title="使用 Python 和 FFmpeg 打造簡易視頻轉換器"></a>使用 Python 和 FFmpeg 打造簡易視頻轉換器</h1><p>今天我要跟各位分享一個有趣的小專案 - 使用 Python 和 FFmpeg 製作的簡易視頻轉換器。這個應用程式不僅實用，還能讓我們學習到如何結合 Python 的圖形使用者介面（GUI）與強大的視頻處理工具。</p>
<h2 id="專案概述"><a href="#專案概述" class="headerlink" title="專案概述"></a>專案概述</h2><p><img src="20240926060101745.png"><br>這個視頻轉換器具有以下特點：</p>
<ol>
<li>簡潔的圖形使用者介面</li>
<li>可以選擇輸入檔案和指定輸出檔案</li>
<li>使用 FFmpeg 進行視頻轉換</li>
<li>顯示轉換狀態和錯誤訊息</li>
</ol>
<h2 id="使用的技術"><a href="#使用的技術" class="headerlink" title="使用的技術"></a>使用的技術</h2><ul>
<li>Python：程式的主要語言</li>
<li>tkinter：Python 的標準 GUI 函式庫</li>
<li>ffmpeg-python：FFmpeg 的 Python 綁定，用於視頻處理</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 導入必要的模組</span></span><br><span class="line"><span class="keyword">import</span> ffmpeg  <span class="comment"># 用於處理視頻轉換</span></span><br><span class="line"><span class="keyword">import</span> tkinter <span class="keyword">as</span> tk  <span class="comment"># 用於創建圖形使用者介面 (GUI)</span></span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> filedialog, messagebox  <span class="comment"># 用於檔案選擇和顯示訊息框</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定義選擇檔案的函數</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_file</span>():</span><br><span class="line">    <span class="comment"># 開啟檔案選擇對話框</span></span><br><span class="line">    filename = filedialog.askopenfilename()</span><br><span class="line">    <span class="comment"># 清除輸入框的現有內容</span></span><br><span class="line">    input_entry.delete(<span class="number">0</span>, tk.END)</span><br><span class="line">    <span class="comment"># 將選擇的檔案路徑插入輸入框</span></span><br><span class="line">    input_entry.insert(<span class="number">0</span>, filename)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定義視頻轉換的函數</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert_video</span>():</span><br><span class="line">    <span class="comment"># 獲取輸入和輸出檔案路徑</span></span><br><span class="line">    input_file = input_entry.get()</span><br><span class="line">    output_file = output_entry.get()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 讀取輸入檔案</span></span><br><span class="line">        stream = ffmpeg.<span class="built_in">input</span>(input_file)</span><br><span class="line">        <span class="comment"># 設置輸出參數（這裡使用預設參數）</span></span><br><span class="line">        stream = ffmpeg.output(stream, output_file)</span><br><span class="line">        <span class="comment"># 執行 FFmpeg 指令</span></span><br><span class="line">        ffmpeg.run(stream)</span><br><span class="line">        <span class="comment"># 更新狀態標籤，顯示成功訊息</span></span><br><span class="line">        status_label.config(text=<span class="string">&quot;轉換成功!&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> ffmpeg.Error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 如果發生錯誤，更新狀態標籤顯示錯誤訊息</span></span><br><span class="line">        status_label.config(text=<span class="string">&quot;轉換失敗。錯誤: &quot;</span> + <span class="built_in">str</span>(e))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 創建主視窗</span></span><br><span class="line">root = tk.Tk()</span><br><span class="line">root.title(<span class="string">&quot;視頻轉換器 (使用 ffmpeg-python)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 創建和放置控制項</span></span><br><span class="line"><span class="comment"># 輸入檔案部分</span></span><br><span class="line">tk.Label(root, text=<span class="string">&quot;輸入檔案:&quot;</span>).grid(row=<span class="number">0</span>, column=<span class="number">0</span>, sticky=<span class="string">&quot;e&quot;</span>)</span><br><span class="line">input_entry = tk.Entry(root, width=<span class="number">50</span>)</span><br><span class="line">input_entry.grid(row=<span class="number">0</span>, column=<span class="number">1</span>)</span><br><span class="line">tk.Button(root, text=<span class="string">&quot;瀏覽&quot;</span>, command=select_file).grid(row=<span class="number">0</span>, column=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 輸出檔案部分</span></span><br><span class="line">tk.Label(root, text=<span class="string">&quot;輸出檔案:&quot;</span>).grid(row=<span class="number">1</span>, column=<span class="number">0</span>, sticky=<span class="string">&quot;e&quot;</span>)</span><br><span class="line">output_entry = tk.Entry(root, width=<span class="number">50</span>)</span><br><span class="line">output_entry.grid(row=<span class="number">1</span>, column=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 轉換按鈕</span></span><br><span class="line">convert_button = tk.Button(root, text=<span class="string">&quot;轉換&quot;</span>, command=convert_video)</span><br><span class="line">convert_button.grid(row=<span class="number">2</span>, column=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 狀態標籤</span></span><br><span class="line">status_label = tk.Label(root, text=<span class="string">&quot;&quot;</span>)</span><br><span class="line">status_label.grid(row=<span class="number">3</span>, column=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 啟動主循環</span></span><br><span class="line">root.mainloop()</span><br></pre></td></tr></table></figure>
<h2 id="程式碼解析"><a href="#程式碼解析" class="headerlink" title="程式碼解析"></a>程式碼解析</h2><p>讓我們來看看這個應用程式的主要組成部分：</p>
<ol>
<li>導入必要模組：<br>我們導入了 ffmpeg、tkinter 以及 filedialog 和 messagebox。這些模組分別用於視頻處理、創建 GUI 和處理檔案選擇。</li>
<li>檔案選擇功能：<br>select_file() 函數使用 filedialog.askopenfilename() 來開啟檔案選擇對話框，讓使用者可以輕鬆選擇要轉換的視頻檔案。</li>
<li>視頻轉換功能：<br>convert_video() 函數是這個應用程式的核心。它使用 ffmpeg-python 來讀取輸入檔案、設定輸出參數並執行轉換。如果轉換成功，會顯示成功訊息；如果失敗，則顯示錯誤訊息。</li>
<li>創建 GUI：<br>我們使用 tkinter 創建了一個簡單的視窗，包含輸入檔案和輸出檔案的輸入框、瀏覽按鈕、轉換按鈕和狀態標籤。</li>
</ol>
<h2 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h2><ol>
<li>啟動應用程式後，你會看到一個簡單的視窗。</li>
<li>點擊「瀏覽」按鈕選擇要轉換的視頻檔案。</li>
<li>在「輸出檔案」欄位中輸入想要的輸出檔案名稱（記得加上副檔名）。</li>
<li>點擊「轉換」按鈕開始轉換過程。</li>
<li>轉換完成後，狀態標籤會顯示成功或失敗的訊息。</li>
</ol>
<h2 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h2><p>請確保你的系統上已安裝 FFmpeg。<br>這個程式使用了 FFmpeg 的預設參數進行轉換。如果你需要更多自訂選項，可以修改 convert_video() 函數中的 ffmpeg.output() 部分。</p>
<h2 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h2><p>這個簡單的視頻轉換器展示了如何將強大的命令列工具（FFmpeg）與用戶友善的圖形介面結合。雖然這只是一個基礎版本，但你可以根據自己的需求進行擴展，例如增加更多的轉換選項、支援批次處理等。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一頁" aria-label="上一頁" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" title="下一頁" aria-label="下一頁" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">null </a>
  </div>
  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">kyosora</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="總字數">303k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="所需總閱讀時間">4:35</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="訪客總數">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="總瀏覽次數">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 強力驅動
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="回到頂端">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/yourname" class="github-corner" title="在 GitHub 上關注我" aria-label="在 GitHub 上關注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":null,"repo":null,"client_id":null,"client_secret":null,"admin_user":null,"distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"5691cbcd1f6129dc3262ebee63fa0cff"}</script>
<script src="/js/third-party/comments/gitalk.js" defer></script>
<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"kyosora/kyosora.github.io","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js" defer></script>

</body>
</html>
