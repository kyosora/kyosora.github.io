<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"kyosora.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="個人技術筆記和學習心得分享">
<meta property="og:type" content="website">
<meta property="og:title" content="kyosora 虛空筆記">
<meta property="og:url" content="https://kyosora.github.io/page/6/index.html">
<meta property="og:site_name" content="kyosora 虛空筆記">
<meta property="og:description" content="個人技術筆記和學習心得分享">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="kyosora">
<meta property="article:tag" content="網路安全, 系統管理, 程式設計, 技術筆記">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://kyosora.github.io/page/6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-TW'
  };
</script>

  <title>kyosora 虛空筆記</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">kyosora 虛空筆記</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">技術探索與學習分享</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/08/20/SQL-%E6%9F%A5%E8%A9%A2%E5%84%AA%E5%8C%96%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6%EF%BC%9A%E6%8F%90%E5%8D%87%E6%B0%B4%E4%BD%8D%E7%9B%A3%E6%B8%AC%E7%B3%BB%E7%B5%B1%E6%80%A7%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/20/SQL-%E6%9F%A5%E8%A9%A2%E5%84%AA%E5%8C%96%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6%EF%BC%9A%E6%8F%90%E5%8D%87%E6%B0%B4%E4%BD%8D%E7%9B%A3%E6%B8%AC%E7%B3%BB%E7%B5%B1%E6%80%A7%E8%83%BD/" class="post-title-link" itemprop="url">SQL 查詢優化案例研究：提升水位監測系統性能</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-08-20 15:38:16" itemprop="dateCreated datePublished" datetime="2024-08-20T15:38:16+08:00">2024-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-11-27 14:34:28" itemprop="dateModified" datetime="2024-11-27T14:34:28+08:00">2024-11-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%A8%8B%E5%BC%8F%E6%95%99%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">程式教學</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="SQL-查詢優化案例研究：提升水位監測系統性能"><a href="#SQL-查詢優化案例研究：提升水位監測系統性能" class="headerlink" title="SQL 查詢優化案例研究：提升水位監測系統性能"></a>SQL 查詢優化案例研究：提升水位監測系統性能</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>我們的水位監測系統面臨著一個重要的挑戰：主要的數據查詢速度緩慢，造成了「執行逾時到期。在作業完成之前超過逾時等待的時間，或是伺服器未回應。」的問題，導致系統一直發送LINE通知錯誤。這個案例研究詳細介紹了我們如何通過優化 SQL 查詢來顯著提升系統性能。</p>
<h2 id="初始情況"><a href="#初始情況" class="headerlink" title="初始情況"></a>初始情況</h2><h3 id="系統概況"><a href="#系統概況" class="headerlink" title="系統概況"></a>系統概況</h3><ul>
<li>目前總共有 120 個監測站點（stt_no）</li>
<li>每 10 分鐘向 WaterLevelGaugeHistory 表匯入一次數據</li>
<li>需要查詢每個站點最近 24 小時的最新數據</li>
</ul>
<h3 id="原始查詢"><a href="#原始查詢" class="headerlink" title="原始查詢"></a>原始查詢</h3><p>初始查詢涉及多個表的聯接和子查詢，執行時間約為 1 分鐘以上。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> 
    WL<span class="token punctuation">.</span><span class="token punctuation">[</span>ID<span class="token punctuation">]</span><span class="token punctuation">,</span> WL<span class="token punctuation">.</span><span class="token punctuation">[</span>stt_name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">/* 其他欄位 ... */</span>
    WLH<span class="token punctuation">.</span><span class="token punctuation">[</span>measure_time<span class="token punctuation">]</span><span class="token punctuation">,</span> WLH<span class="token punctuation">.</span><span class="token punctuation">[</span>val<span class="token punctuation">]</span><span class="token punctuation">,</span> WLH<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token keyword">Status</span><span class="token punctuation">]</span><span class="token punctuation">,</span> WLH<span class="token punctuation">.</span>cstatus<span class="token punctuation">,</span> WLH<span class="token punctuation">.</span><span class="token punctuation">[</span>Epower<span class="token punctuation">]</span><span class="token punctuation">,</span> WLH<span class="token punctuation">.</span>nodata
<span class="token keyword">FROM</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>WaterLevelGauge<span class="token punctuation">]</span> WL
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>WaterLevelGauge_detailed_View<span class="token punctuation">]</span> WLD 
    <span class="token keyword">ON</span> WL<span class="token punctuation">.</span><span class="token punctuation">[</span>stt_name<span class="token punctuation">]</span> <span class="token operator">=</span> WLD<span class="token punctuation">.</span><span class="token punctuation">[</span>MonitoringStationNumber<span class="token punctuation">]</span>
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token punctuation">[</span>ID<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>stt_no<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>dev_id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>measure_time<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>val<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">Status</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>cstatus<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>nodata<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>power<span class="token punctuation">]</span> <span class="token keyword">AS</span> Epower<span class="token punctuation">,</span> 
    ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> <span class="token punctuation">[</span>stt_no<span class="token punctuation">]</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">[</span>measure_time<span class="token punctuation">]</span> <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> row_num 
    <span class="token keyword">FROM</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>WaterLevelGaugeHistory<span class="token punctuation">]</span> 
    <span class="token keyword">WHERE</span> <span class="token punctuation">[</span>dev_id<span class="token punctuation">]</span> <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span> WLH <span class="token keyword">ON</span> WL<span class="token punctuation">.</span><span class="token punctuation">[</span>stt_no<span class="token punctuation">]</span> <span class="token operator">=</span> WLH<span class="token punctuation">.</span><span class="token punctuation">[</span>stt_no<span class="token punctuation">]</span> <span class="token operator">AND</span> WLH<span class="token punctuation">.</span>row_num <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">WHERE</span> WL<span class="token punctuation">.</span><span class="token punctuation">[</span>memo2<span class="token punctuation">]</span> <span class="token operator">&lt;></span> <span class="token string">'停用'</span> <span class="token operator">OR</span> WL<span class="token punctuation">.</span><span class="token punctuation">[</span>memo2<span class="token punctuation">]</span> <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="優化過程"><a href="#優化過程" class="headerlink" title="優化過程"></a>優化過程</h2><h3 id="步驟-1：分析查詢瓶頸"><a href="#步驟-1：分析查詢瓶頸" class="headerlink" title="步驟 1：分析查詢瓶頸"></a>步驟 1：分析查詢瓶頸</h3><p>我們發現 WaterLevelGaugeHistory 表的大量數據是造成查詢緩慢的主要原因，觀察的時候已經資料量已經來到了五百萬筆以上。</p>
<h3 id="步驟-2：重構子查詢"><a href="#步驟-2：重構子查詢" class="headerlink" title="步驟 2：重構子查詢"></a>步驟 2：重構子查詢</h3><p>我們重新設計了子查詢，以更高效地過濾和排序數據：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
    <span class="token punctuation">[</span>ID<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>stt_no<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>dev_id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>measure_time<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>val<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">Status</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
    <span class="token punctuation">[</span>cstatus<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>nodata<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>power<span class="token punctuation">]</span> <span class="token keyword">AS</span> Epower
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> 
        <span class="token punctuation">[</span>ID<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>stt_no<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>dev_id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>measure_time<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>val<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">Status</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        <span class="token punctuation">[</span>cstatus<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>nodata<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>power<span class="token punctuation">]</span><span class="token punctuation">,</span>
        ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> <span class="token punctuation">[</span>stt_no<span class="token punctuation">]</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">[</span>measure_time<span class="token punctuation">]</span> <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> row_num
    <span class="token keyword">FROM</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>WaterLevelGaugeHistory<span class="token punctuation">]</span>
    <span class="token keyword">WHERE</span> <span class="token punctuation">[</span>dev_id<span class="token punctuation">]</span> <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
        <span class="token operator">AND</span> <span class="token punctuation">[</span>measure_time<span class="token punctuation">]</span> <span class="token operator">>=</span> DATEADD<span class="token punctuation">(</span><span class="token keyword">HOUR</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">24</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">-- 只查詢最近24小時的數據</span>
<span class="token punctuation">)</span> ranked
<span class="token keyword">WHERE</span> row_num <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="步驟-3：添加時間過濾"><a href="#步驟-3：添加時間過濾" class="headerlink" title="步驟 3：添加時間過濾"></a>步驟 3：添加時間過濾</h3><p>我們添加了時間過濾條件，只查詢最近 24 小時的數據，這大大減少了需要處理的數據量。</p>
<h3 id="步驟-4：索引優化"><a href="#步驟-4：索引優化" class="headerlink" title="步驟 4：索引優化"></a>步驟 4：索引優化</h3><p>我們創建了一個針對性的索引來支持查詢：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 在 WaterLevelGaugeHistory 表上創建優化的複合索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">NONCLUSTERED</span> <span class="token keyword">INDEX</span> IX_WaterLevelGaugeHistory_stt_no_measure_time
<span class="token keyword">ON</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>WaterLevelGaugeHistory<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>stt_no<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>measure_time<span class="token punctuation">]</span> <span class="token keyword">DESC</span><span class="token punctuation">)</span>
INCLUDE <span class="token punctuation">(</span><span class="token punctuation">[</span>val<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">Status</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>cstatus<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">WITH</span> <span class="token punctuation">(</span>SORT_IN_TEMPDB <span class="token operator">=</span> <span class="token keyword">ON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 在 WaterLevelGauge 表上創建索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">NONCLUSTERED</span> <span class="token keyword">INDEX</span> IX_WaterLevelGauge_stt_name
<span class="token keyword">ON</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>WaterLevelGauge<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>stt_name<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">WITH</span> <span class="token punctuation">(</span>SORT_IN_TEMPDB <span class="token operator">=</span> <span class="token keyword">ON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 更新統計資訊</span>
<span class="token keyword">UPDATE</span> <span class="token keyword">STATISTICS</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>WaterLevelGaugeHistory<span class="token punctuation">]</span> 
<span class="token keyword">WITH</span> FULLSCAN<span class="token punctuation">;</span>

<span class="token keyword">UPDATE</span> <span class="token keyword">STATISTICS</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>WaterLevelGauge<span class="token punctuation">]</span> 
<span class="token keyword">WITH</span> FULLSCAN<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這個索引包含了所有需要的列，支持索引覆蓋查詢，進一步提高了性能。</p>
<h2 id="優化結果"><a href="#優化結果" class="headerlink" title="優化結果"></a>優化結果</h2><p>經過優化後，我們取得了令人矚目的成果：</p>
<ul>
<li><strong>原始查詢時間</strong>：約 1 分鐘</li>
<li><strong>優化後查詢時間</strong>：約 1 秒</li>
<li><strong>性能提升</strong>：超過 98%</li>
</ul>
<p>這種程度的性能改進遠遠超出了我們最初的預期，幾乎達到了即時響應的水平。</p>
<h2 id="深入分析顯著提升的原因"><a href="#深入分析顯著提升的原因" class="headerlink" title="深入分析顯著提升的原因"></a>深入分析顯著提升的原因</h2><ol>
<li><p><strong>精確的數據過濾</strong>：通過限制查詢範圍到最近 24 小時，我們大幅減少了需要處理的數據量。考慮到我們的系統每 10 分鐘更新一次數據，這意味著每個站點最多只需處理 144 條記錄（24小時 * 6次/小時）。</p>
</li>
<li><p><strong>高效的索引利用</strong>：我們創建的複合索引（stt_no, measure_time, dev_id）完美匹配了查詢模式。這使得 SQL Server 能夠快速定位到每個站點的最新記錄，而無需掃描大量數據。</p>
</li>
<li><p><strong>子查詢優化</strong>：重構後的子查詢使用了 ROW_NUMBER() 函數，配合 PARTITION BY 和高效索引，使得 SQL Server 能夠極快地識別每個站點的最新記錄。</p>
</li>
<li><p><strong>索引覆蓋</strong>：通過在索引中包含所有需要的列，我們實現了索引覆蓋查詢。這意味著 SQL Server 可以直接從索引中檢索所有所需的數據，而無需訪問實際的表數據頁，大大減少了 I/O 操作。</p>
</li>
<li><p><strong>數據分布的優勢</strong>：由於我們只有 120 個監測站點，並且每個站點的數據都很規律（每 10 分鐘一條），這種數據分布特性非常有利於查詢優化和索引使用。</p>
</li>
<li><p><strong>減少了複雜的連接操作</strong>：優化後的查詢減少了對 WaterLevelGauge 和 WaterLevelGauge_detailed_View 的連接操作，這些操作在原始查詢中可能造成了額外的性能開銷。</p>
</li>
</ol>
<h2 id="學到的經驗"><a href="#學到的經驗" class="headerlink" title="學到的經驗"></a>學到的經驗</h2><ol>
<li><p><strong>了解數據特性的重要性</strong>：知道有 120 個站點和 10 分鐘的更新頻率，幫助我們做出更精確的優化決策。</p>
</li>
<li><p><strong>時間過濾的效果</strong>：通過只查詢最近 24 小時的數據，大幅減少了需要處理的數據量。</p>
</li>
<li><p><strong>索引設計的重要性</strong>：精心設計的索引可以顯著提升查詢性能。</p>
</li>
<li><p><strong>子查詢優化</strong>：重構子查詢可以更高效地過濾和排序數據。</p>
</li>
<li><p><strong>持續監控和維護的必要性</strong>：建議定期更新統計信息和重建索引，以維持優化效果。</p>
</li>
<li><p><strong>數據特性的重要性</strong>：了解數據的更新頻率、分布特性和查詢模式，對於實現極致的查詢優化至關重要。</p>
</li>
<li><p><strong>不要低估優化的潛力</strong>：有時，經過精心設計的優化可以帶來遠超預期的性能提升。</p>
</li>
<li><p><strong>測試和驗證的重要性</strong>：實際測試結果可能會與理論預期有很大差異，強調了在真實環境中進行全面測試的重要性。</p>
</li>
</ol>
<h2 id="後續建議"><a href="#後續建議" class="headerlink" title="後續建議"></a>後續建議</h2><ol>
<li><p><strong>實施數據保留策略</strong>：考慮只保留最近幾個月的詳細數據，將老數據歸檔或匯總。</p>
</li>
<li><p><strong>定期維護</strong>：設置定期任務來更新統計信息和重建索引。</p>
</li>
<li><p><strong>監控查詢性能</strong>：使用 SQL Server 的查詢存儲持續監控查詢性能，及時發現潛在問題。</p>
</li>
<li><p><strong>考慮進階技術</strong>：如果數據量繼續增長，可能需要考慮分區表或內存優化表等技術。</p>
</li>
<li><p><strong>性能基準測試</strong>：定期進行性能基準測試，以確保優化效果長期保持。</p>
</li>
<li><p><strong>擴展優化範圍</strong>：將類似的優化策略應用到系統中的其他查詢，可能會帶來整體性能的顯著提升。</p>
</li>
<li><p><strong>用戶體驗改進</strong>：利用查詢速度的顯著提升，考慮改進用戶界面，提供更多實時或近實時的數據展示功能。</p>
</li>
</ol>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>這個案例研究展示了深入理解數據特性、精心設計查詢和索引如何帶來變革性的性能提升。將查詢時間從 1 分鐘減少到 1 秒不僅提高了系統效率，還為用戶體驗和未來功能擴展開闢了新的可能性。這種程度的優化證明，即使是看似複雜的性能問題，通過系統的分析和優化，也能夠取得驚人的改進。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/08/19/WebSocket%E6%95%99%E7%A8%8B%EF%BC%9A%E6%A7%8B%E5%BB%BA%E5%AF%A6%E6%99%82%E8%81%8A%E5%A4%A9%E6%87%89%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/19/WebSocket%E6%95%99%E7%A8%8B%EF%BC%9A%E6%A7%8B%E5%BB%BA%E5%AF%A6%E6%99%82%E8%81%8A%E5%A4%A9%E6%87%89%E7%94%A8/" class="post-title-link" itemprop="url">WebSocket教程：構建實時聊天應用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-08-19 18:15:52" itemprop="dateCreated datePublished" datetime="2024-08-19T18:15:52+08:00">2024-08-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-11-27 14:33:36" itemprop="dateModified" datetime="2024-11-27T14:33:36+08:00">2024-11-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%A8%8B%E5%BC%8F%E6%95%99%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">程式教學</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="WebSocket教程：構建實時聊天應用"><a href="#WebSocket教程：構建實時聊天應用" class="headerlink" title="WebSocket教程：構建實時聊天應用"></a>WebSocket教程：構建實時聊天應用</h1><h2 id="目錄"><a href="#目錄" class="headerlink" title="目錄"></a>目錄</h2><ol>
<li>介紹</li>
<li>WebSocket基礎</li>
<li>項目設置</li>
<li>後端實現</li>
<li>前端實現</li>
<li>運行和測試</li>
<li>進階主題</li>
<li>結論</li>
</ol>
<h2 id="1-介紹"><a href="#1-介紹" class="headerlink" title="1. 介紹"></a>1. 介紹</h2><p>在當今的web應用中,實時通信已經成為一個常見需求。無論是聊天應用、協作工具還是實時遊戲,都需要服務器和客戶端之間快速、雙向的通信。WebSocket技術為此提供了完美的解決方案。</p>
<p>在本教程中，我們將深入探討WebSocket技術，並通過構建一個簡單的實時聊天應用來學習如何使用它。我們將使用Python作為後端，JavaScript作為前端。</p>
<h2 id="2-WebSocket基礎"><a href="#2-WebSocket基礎" class="headerlink" title="2. WebSocket基礎"></a>2. WebSocket基礎</h2><p>WebSocket是一種網絡通信協議，提供全雙工通信通道，運行在單個TCP連接上。與傳統的HTTP請求-響應模型不同，WebSocket允許服務器主動向客戶端推送數據。</p>
<p>主要特點：</p>
<ul>
<li>雙向通信</li>
<li>實時數據傳輸</li>
<li>較低的延遲</li>
<li>效率高（相比輪詢）</li>
</ul>
<h2 id="3-項目設置"><a href="#3-項目設置" class="headerlink" title="3. 項目設置"></a>3. 項目設置</h2><h3 id="後端設置"><a href="#後端設置" class="headerlink" title="後端設置"></a>後端設置</h3><ol>
<li>確保已安裝Python (3.7+)</li>
<li>安裝WebSocket庫：<pre class="line-numbers language-none"><code class="language-none">pip install websockets<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<h3 id="前端設置"><a href="#前端設置" class="headerlink" title="前端設置"></a>前端設置</h3><p>只需一個簡單的HTML文件和一些JavaScript代碼。</p>
<h2 id="4-後端實現"><a href="#4-後端實現" class="headerlink" title="4. 後端實現"></a>4. 後端實現</h2><p>創建一個名為<code>server.py</code>的文件：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> websockets
<span class="token keyword">import</span> logging

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>

connected <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">chat</span><span class="token punctuation">(</span>websocket<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    client_id <span class="token operator">=</span> <span class="token builtin">id</span><span class="token punctuation">(</span>websocket<span class="token punctuation">)</span>
    connected<span class="token punctuation">.</span>add<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"新客戶端連接: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>client_id<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">for</span> message <span class="token keyword">in</span> websocket<span class="token punctuation">:</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"收到來自 </span><span class="token interpolation"><span class="token punctuation">&#123;</span>client_id<span class="token punctuation">&#125;</span></span><span class="token string"> 的消息: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>message<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> conn <span class="token keyword">in</span> connected<span class="token punctuation">:</span>
                <span class="token keyword">if</span> conn <span class="token operator">!=</span> websocket<span class="token punctuation">:</span>
                    <span class="token keyword">await</span> conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"用戶 </span><span class="token interpolation"><span class="token punctuation">&#123;</span>client_id<span class="token punctuation">&#125;</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>message<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"消息已發送給客戶端 </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">id</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        connected<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"客戶端斷開連接: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>client_id<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

start_server <span class="token operator">=</span> websockets<span class="token punctuation">.</span>serve<span class="token punctuation">(</span>chat<span class="token punctuation">,</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">8765</span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>start_server<span class="token punctuation">)</span>
asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_forever<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>代碼解釋：</p>
<ul>
<li>我們使用<code>asyncio</code>和<code>websockets</code>庫來創建一個異步WebSocket服務器。</li>
<li><code>connected</code>集合用於存儲所有連接的客戶端。</li>
<li><code>chat</code>函數處理每個WebSocket連接。</li>
<li>當收到消息時，我們將其廣播給所有其他連接的客戶端。</li>
<li>我們使用日志來跟蹤連接、斷開連接和消息傳輸。</li>
</ul>
<h2 id="5-前端實現"><a href="#5-前端實現" class="headerlink" title="5. 前端實現"></a>5. 前端實現</h2><p>創建一個名為<code>index.html</code>的文件：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>WebSocket聊天<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">
        <span class="token selector">#messages</span> <span class="token punctuation">&#123;</span> <span class="token property">height</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span> <span class="token property">overflow-y</span><span class="token punctuation">:</span> scroll<span class="token punctuation">;</span> <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #ccc<span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token selector">.status</span> <span class="token punctuation">&#123;</span> <span class="token property">color</span><span class="token punctuation">:</span> #888<span class="token punctuation">;</span> <span class="token property">font-style</span><span class="token punctuation">:</span> italic<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token selector">.error</span> <span class="token punctuation">&#123;</span> <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>WebSocket聊天<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>messages<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>messageInput<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>輸入消息...<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>發送<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
        <span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://localhost:8765'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> messagesDiv <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'messages'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> messageInput <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'messageInput'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        socket<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">addMessage</span><span class="token punctuation">(</span><span class="token string">'已連接到服務器'</span><span class="token punctuation">,</span> <span class="token string">'status'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        socket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">addMessage</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        socket<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">addMessage</span><span class="token punctuation">(</span><span class="token string">'與服務器斷開連接'</span><span class="token punctuation">,</span> <span class="token string">'status'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        socket<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">addMessage</span><span class="token punctuation">(</span><span class="token string">'WebSocket錯誤: '</span> <span class="token operator">+</span> error<span class="token punctuation">.</span>message<span class="token punctuation">,</span> <span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token keyword">function</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">const</span> message <span class="token operator">=</span> messageInput<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">addMessage</span><span class="token punctuation">(</span><span class="token string">'你: '</span> <span class="token operator">+</span> message<span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                messageInput<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">function</span> <span class="token function">addMessage</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">const</span> messageElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageElement<span class="token punctuation">.</span>textContent <span class="token operator">=</span> message<span class="token punctuation">;</span>
            messageElement<span class="token punctuation">.</span>className <span class="token operator">=</span> type<span class="token punctuation">;</span>
            messagesDiv<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>messageElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
            messagesDiv<span class="token punctuation">.</span>scrollTop <span class="token operator">=</span> messagesDiv<span class="token punctuation">.</span>scrollHeight<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>代碼解釋：</p>
<ul>
<li>我們創建一個WebSocket連接到我們的服務器。</li>
<li><code>onopen</code>, <code>onmessage</code>, <code>onclose</code>, 和 <code>onerror</code>事件處理程序用於管理WebSocket的生命周期。</li>
<li><code>sendMessage</code>函數用於發送消息到服務器。</li>
<li><code>addMessage</code>函數用於在UI中顯示消息。</li>
</ul>
<h2 id="6-運行和測試"><a href="#6-運行和測試" class="headerlink" title="6. 運行和測試"></a>6. 運行和測試</h2><ol>
<li>啟動服務器：<pre class="line-numbers language-none"><code class="language-none">python server.py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li>在瀏覽器中打開<code>index.html</code>文件。</li>
<li>打開多個瀏覽器窗口或標簽頁來模擬多個用戶。</li>
<li>開始聊天並觀察實時通信！</li>
</ol>
<h2 id="7-進階主題"><a href="#7-進階主題" class="headerlink" title="7. 進階主題"></a>7. 進階主題</h2><ul>
<li>安全性：在生產環境中,考慮使用WSS (WebSocket Secure)。</li>
<li>身份驗證：實現用戶身份驗證系統。</li>
<li>錯誤處理：增強錯誤處理和重連機制。</li>
<li>消息格式：使用JSON等結構化格式傳輸覆雜數據。</li>
<li>擴展性：考慮如何擴展應用以支持更多用戶。</li>
</ul>
<h2 id="8-結論"><a href="#8-結論" class="headerlink" title="8. 結論"></a>8. 結論</h2><p>通過本教程，我們學習了WebSocket的基礎知識，並成功構建了一個簡單的實時聊天應用。WebSocket為實時web應用開發提供了強大的工具，使得創建響應迅速、交互性強的應用成為可能。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/08/08/%E4%BD%BF%E7%94%A8-SQL-Server-Resource-Governor-%E9%99%90%E5%88%B6%E7%89%B9%E5%AE%9A%E8%B3%87%E6%96%99%E5%BA%AB%E7%9A%84%E8%B3%87%E6%BA%90%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/08/%E4%BD%BF%E7%94%A8-SQL-Server-Resource-Governor-%E9%99%90%E5%88%B6%E7%89%B9%E5%AE%9A%E8%B3%87%E6%96%99%E5%BA%AB%E7%9A%84%E8%B3%87%E6%BA%90%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">使用 SQL Server Resource Governor 限制特定資料庫的資源使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-08-08 09:36:04" itemprop="dateCreated datePublished" datetime="2024-08-08T09:36:04+08:00">2024-08-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-11-27 14:44:22" itemprop="dateModified" datetime="2024-11-27T14:44:22+08:00">2024-11-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%B3%87%E6%96%99%E5%BA%AB/" itemprop="url" rel="index"><span itemprop="name">資料庫</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="使用-SQL-Server-Resource-Governor-限制特定資料庫的資源使用"><a href="#使用-SQL-Server-Resource-Governor-限制特定資料庫的資源使用" class="headerlink" title="使用 SQL Server Resource Governor 限制特定資料庫的資源使用"></a>使用 SQL Server Resource Governor 限制特定資料庫的資源使用</h1><h2 id="1-簡介"><a href="#1-簡介" class="headerlink" title="1. 簡介"></a>1. 簡介</h2><p>某次在正式環境使用者抱怨網頁速度太慢，會卡好幾分鐘，於是開始排查問題，發現自己連接SSMS的搜尋也是一樣卡，不太對勁，結果最後發現了是其他專案資料庫排程執行時過度消耗資源，導致其他專案的效能受到影響，最好的解決方案是應該切其他主機，不過沒有其他資源只能想想其他方法。本文將介紹如何使用 SQL Server 的 Resource Governor 功能來解決這個問題，有效地限制特定資料庫的資源使用。</p>
<h2 id="2-Resource-Governor-簡介"><a href="#2-Resource-Governor-簡介" class="headerlink" title="2. Resource Governor 簡介"></a>2. Resource Governor 簡介</h2><p>Resource Governor 是 SQL Server 提供的一個強大工具，用於管理 SQL Server 實例中的工作負載和資源消耗。它允許我們為不同的工作負載設置資源使用限制，確保關鍵任務能夠獲得所需的資源。</p>
<p>相比其他方法（如設置 MAXDOP），Resource Governor 提供了更細緻和動態的控制，能夠根據多種條件（如資料庫名稱、登入帳號等）來分配資源。</p>
<h2 id="3-設定-Resource-Governor-的步驟"><a href="#3-設定-Resource-Governor-的步驟" class="headerlink" title="3. 設定 Resource Governor 的步驟"></a>3. 設定 Resource Governor 的步驟</h2><h3 id="3-1-建立資源池-Resource-Pool"><a href="#3-1-建立資源池-Resource-Pool" class="headerlink" title="3.1 建立資源池 (Resource Pool)"></a>3.1 建立資源池 (Resource Pool)</h3><p>資源池定義了可用的資源限制。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> RESOURCE POOL PoolAdhocDB
<span class="token keyword">WITH</span> <span class="token punctuation">(</span>MAX_CPU_PERCENT <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span> 
      MAX_MEMORY_PERCENT <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="3-2-建立工作負載群組-Workload-Group"><a href="#3-2-建立工作負載群組-Workload-Group" class="headerlink" title="3.2 建立工作負載群組 (Workload Group)"></a>3.2 建立工作負載群組 (Workload Group)</h3><p>工作負載群組關聯到特定的資源池。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> WORKLOAD <span class="token keyword">GROUP</span> GroupAdhocDB
<span class="token keyword">USING</span> PoolAdhocDB<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="3-3-建立分類函數-Classifier-Function"><a href="#3-3-建立分類函數-Classifier-Function" class="headerlink" title="3.3 建立分類函數 (Classifier Function)"></a>3.3 建立分類函數 (Classifier Function)</h3><p>分類函數決定將請求分配到哪個工作負載群組。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> master<span class="token punctuation">;</span>
GO

<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> dbo<span class="token punctuation">.</span>fn_WorkloadClassifier<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> sysname 
<span class="token keyword">WITH</span> SCHEMABINDING
<span class="token keyword">AS</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">RETURN</span> <span class="token keyword">CASE</span> 
               <span class="token keyword">WHEN</span> DB_NAME<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'AdhocDatabase'</span> <span class="token keyword">THEN</span> <span class="token string">'GroupAdhocDB'</span>
               <span class="token keyword">ELSE</span> <span class="token string">'default'</span>
           <span class="token keyword">END</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
GO<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-4-啟用-Resource-Governor-設定"><a href="#3-4-啟用-Resource-Governor-設定" class="headerlink" title="3.4 啟用 Resource Governor 設定"></a>3.4 啟用 Resource Governor 設定</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> RESOURCE GOVERNOR <span class="token keyword">WITH</span> <span class="token punctuation">(</span>CLASSIFIER_FUNCTION <span class="token operator">=</span> dbo<span class="token punctuation">.</span>fn_WorkloadClassifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> RESOURCE GOVERNOR <span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="4-驗證設定"><a href="#4-驗證設定" class="headerlink" title="4. 驗證設定"></a>4. 驗證設定</h2><p>執行以下查詢來檢查 Resource Governor 的組態：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>resource_governor_configuration<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>resource_governor_resource_pools<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>resource_governor_workload_groups<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="5-注意事項"><a href="#5-注意事項" class="headerlink" title="5. 注意事項"></a>5. 注意事項</h2><ul>
<li>確保在 master 資料庫中創建分類函數</li>
<li>確保有足夠的權限（通常需要 CONTROL SERVER 權限）</li>
<li>根據實際情況調整資源池的限制參數</li>
</ul>
<h2 id="6-可能遇到的問題與解決方案"><a href="#6-可能遇到的問題與解決方案" class="headerlink" title="6. 可能遇到的問題與解決方案"></a>6. 可能遇到的問題與解決方案</h2><ol>
<li>分類函數找不到的錯誤<ul>
<li>解決方案：確保函數名稱正確，且存在於 master 資料庫中</li>
</ul>
</li>
<li>權限不足的問題<ul>
<li>解決方案：確保執行組態的帳號具有足夠的權限</li>
</ul>
</li>
</ol>
<h2 id="7-優化建議"><a href="#7-優化建議" class="headerlink" title="7. 優化建議"></a>7. 優化建議</h2><ul>
<li>定期監控資源使用情況，可以使用 Dynamic Management Views (DMVs) 來追蹤資源使用</li>
<li>根據監控結果調整資源池設定，確保資源分配合理</li>
</ul>
<h2 id="8-總結"><a href="#8-總結" class="headerlink" title="8. 總結"></a>8. 總結</h2><p>Resource Governor 為我們提供了一個強大的工具，用於管理 SQL Server 的資源分配。通過合理組態，我們可以：</p>
<ul>
<li>防止單一資料庫過度消耗資源</li>
<li>確保關鍵業務的效能</li>
<li>提高整體資料庫伺服器的穩定性和可預測性</li>
</ul>
<p>在複雜的多租戶或多應用環境中，Resource Governor 的使用尤為重要，它能夠幫助 DBA 更好地平衡各種工作負載的需求。</p>
<h2 id="9-延伸閱讀"><a href="#9-延伸閱讀" class="headerlink" title="9. 延伸閱讀"></a>9. 延伸閱讀</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sql/relational-databases/resource-governor/resource-governor">SQL Server 官方文檔：Resource Governor</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sql/relational-databases/performance/monitor-resource-usage-system-statistical-functions">使用 Extended Events 監控 Resource Governor</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sql/relational-databases/performance/performance-center-for-sql-server-database-engine-and-azure-sql-database">其他 SQL Server 效能優化技巧</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/08/06/%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90-%E4%BD%BF%E7%94%A8Python%E6%A7%8B%E5%BB%BA%E5%85%A8%E9%9D%A2%E7%9A%84%E5%B8%82%E5%A0%B4%E9%A2%A8%E9%9A%AA%E7%9B%A3%E6%B8%AC%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/06/%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90-%E4%BD%BF%E7%94%A8Python%E6%A7%8B%E5%BB%BA%E5%85%A8%E9%9D%A2%E7%9A%84%E5%B8%82%E5%A0%B4%E9%A2%A8%E9%9A%AA%E7%9B%A3%E6%B8%AC%E5%B7%A5%E5%85%B7/" class="post-title-link" itemprop="url">深入解析:使用Python構建全面的市場風險監測工具</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-08-06 13:58:22" itemprop="dateCreated datePublished" datetime="2024-08-06T13:58:22+08:00">2024-08-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-11-27 14:43:08" itemprop="dateModified" datetime="2024-11-27T14:43:08+08:00">2024-11-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%A8%8B%E5%BC%8F%E9%96%8B%E7%99%BC/" itemprop="url" rel="index"><span itemprop="name">程式開發</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kyosora/VolatilityVigil">專案網址</a></li>
</ul>
<h1 id="深入解析-使用Python構建全面的市場風險監測工具"><a href="#深入解析-使用Python構建全面的市場風險監測工具" class="headerlink" title="深入解析:使用Python構建全面的市場風險監測工具"></a>深入解析:使用Python構建全面的市場風險監測工具</h1><p>七月的時候因為許多的利空事件極短時間內發生，結果全球股災，來的速度太快結果都被套牢了，所以想著開發一個使用Python市場風險監測工具，該工具能夠分析多個市場指標，計算風險評分，並提供直觀的視覺化結果。</p>
<h2 id="1-程式概述"><a href="#1-程式概述" class="headerlink" title="1. 程式概述"></a>1. 程式概述</h2><p>這個Python程式主要實現以下功能:</p>
<ul>
<li>從Yahoo Finance獲取多個市場的歷史數據</li>
<li>計算各市場的波動性和異常情況</li>
<li>基於波動性和異常情況評估市場風險</li>
<li>使用機器學習方法對市場狀態進行聚類</li>
<li>生成多種視覺化圖表以直觀展示分析結果</li>
</ul>
<p>程式使用了多個Python庫，包括pandas用於數據處理，sklearn用於機器學習算法，yfinance用於獲取市場數據，以及matplotlib和seaborn用於數據可視化。</p>
<h2 id="2-核心功能詳解"><a href="#2-核心功能詳解" class="headerlink" title="2. 核心功能詳解"></a>2. 核心功能詳解</h2><h3 id="2-1-數據獲取"><a href="#2-1-數據獲取" class="headerlink" title="2.1 數據獲取"></a>2.1 數據獲取</h3><p>程式使用<code>yfinance</code>庫從Yahoo Finance獲取過去90天的市場數據:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_date_range</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    end_date <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>date<span class="token punctuation">(</span><span class="token punctuation">)</span>
    start_date <span class="token operator">=</span> end_date <span class="token operator">-</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">90</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> start_date， end_date

market_data <span class="token operator">=</span> yf<span class="token punctuation">.</span>download<span class="token punctuation">(</span>symbols， start<span class="token operator">=</span>start_date， end<span class="token operator">=</span>end_date<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'Close'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這裡的<code>symbols</code>列表包含了多個市場指標，涵蓋美國、歐洲、亞洲的主要股市指數，以及商品期貨和外匯市場。</p>
<h3 id="2-2-風險評估"><a href="#2-2-風險評估" class="headerlink" title="2.2 風險評估"></a>2.2 風險評估</h3><p>風險評估主要基於兩個因素:波動性和異常情況。</p>
<p>波動性計算:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">calculate_volatility</span><span class="token punctuation">(</span>data， window<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> data<span class="token punctuation">.</span>pct_change<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token number">252</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>異常檢測使用PCA(主成分分析)方法:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">detect_anomalies</span><span class="token punctuation">(</span>data， threshold<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ... (代碼省略)</span>
    pca <span class="token operator">=</span> PCA<span class="token punctuation">(</span>n_components<span class="token operator">=</span><span class="token number">0.95</span><span class="token punctuation">)</span>
    pca_result <span class="token operator">=</span> pca<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>normalized_data<span class="token punctuation">)</span>
    reconstruction <span class="token operator">=</span> pca<span class="token punctuation">.</span>inverse_transform<span class="token punctuation">(</span>pca_result<span class="token punctuation">)</span>
    mse <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>np<span class="token punctuation">.</span>power<span class="token punctuation">(</span>normalized_data <span class="token operator">-</span> reconstruction， <span class="token number">2</span><span class="token punctuation">)</span>， axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>mse <span class="token operator">></span> threshold <span class="token operator">*</span> np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>mse<span class="token punctuation">)</span>， index<span class="token operator">=</span>data<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>風險評分的計算綜合考慮了波動性和異常情況:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">calculate_risk_score</span><span class="token punctuation">(</span>market_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    volatility <span class="token operator">=</span> calculate_volatility<span class="token punctuation">(</span>market_data<span class="token punctuation">)</span>
    anomalies <span class="token operator">=</span> detect_anomalies<span class="token punctuation">(</span>market_data<span class="token punctuation">)</span>
    
    risk_score <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>index<span class="token operator">=</span>common_index<span class="token punctuation">)</span>
    <span class="token keyword">for</span> column <span class="token keyword">in</span> market_data<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
        vol_threshold <span class="token operator">=</span> volatility<span class="token punctuation">[</span>column<span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> volatility<span class="token punctuation">[</span>column<span class="token punctuation">]</span><span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token punctuation">)</span>
        risk_score<span class="token punctuation">[</span>column<span class="token punctuation">]</span> <span class="token operator">=</span> anomalies<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>volatility<span class="token punctuation">[</span>column<span class="token punctuation">]</span> <span class="token operator">></span> vol_threshold<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> risk_score<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-3-市場狀態聚類"><a href="#2-3-市場狀態聚類" class="headerlink" title="2.3 市場狀態聚類"></a>2.3 市場狀態聚類</h3><p>程式使用K-means算法對市場狀態進行聚類:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">cluster_market_states</span><span class="token punctuation">(</span>data， n_clusters<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    kmeans <span class="token operator">=</span> KMeans<span class="token punctuation">(</span>n_clusters<span class="token operator">=</span>n_clusters， n_init<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>kmeans<span class="token punctuation">.</span>fit_predict<span class="token punctuation">(</span>data_filled<span class="token punctuation">)</span>， index<span class="token operator">=</span>data<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>這有助於識別市場的不同運行狀態，為投資決策提供額外的參考。</p>
<h2 id="3-視覺化"><a href="#3-視覺化" class="headerlink" title="3. 視覺化"></a>3. 視覺化</h2><p>程式提供了多種視覺化方法，幫助更直觀地理解分析結果:</p>
<ol>
<li>風險評分熱力圖</li>
<li>市場趨勢圖</li>
<li>市場相關性矩陣</li>
<li>總體風險評分分佈圖</li>
</ol>
<p>這些視覺化功能使用matplotlib和seaborn庫實現，例如:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">visualize_risk_scores</span><span class="token punctuation">(</span>risk_score<span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span>， <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sns<span class="token punctuation">.</span>heatmap<span class="token punctuation">(</span>risk_score<span class="token punctuation">.</span>T， cmap<span class="token operator">=</span><span class="token string">'YlOrRd'</span>， cbar_kws<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'label'</span><span class="token punctuation">:</span> <span class="token string">'風險評分'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'各市場風險評分熱力圖'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'日期'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'市場'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-結果解釋"><a href="#4-結果解釋" class="headerlink" title="4. 結果解釋"></a>4. 結果解釋</h2><p>程式不僅提供數值結果，還包含了詳細的結果解釋功能:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">explain_risk_score</span><span class="token punctuation">(</span>risk_score<span class="token punctuation">)</span><span class="token punctuation">:</span>
    explanations <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">"低風險：市場表現正常，波動性低於平均水平。"</span>，
        <span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">"中等風險：市場出現一些異常波動或波動性略高於平均水平。需要密切關注。"</span>，
        <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">"高風險：市場出現顯著異常或波動性大幅高於平均水平。建議採取風險管理措施。"</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment"># ... (代碼省略)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這個功能將數值結果轉化為易於理解的文字描述，並針對高風險市場提供特別警示。</p>
<h2 id="5-使用注意事項"><a href="#5-使用注意事項" class="headerlink" title="5. 使用注意事項"></a>5. 使用注意事項</h2><ol>
<li>資料時效性:程式會檢查最新數據的日期，如果距離當前日期超過5天，會發出警告。</li>
<li>缺失數據處理:程式會報告並處理缺失數據，使用前向填充和後向填充方法。</li>
<li>市場休市:用戶需要注意解釋結果時考慮市場休市等因素。</li>
</ol>
<h2 id="6-結論"><a href="#6-結論" class="headerlink" title="6. 結論"></a>6. 結論</h2><p>這個Python程式提供了一個全面的市場風險監測解決方案。它不僅能夠及時評估多個市場的風險狀況，還提供了直觀的視覺化結果和詳細的解釋。這對於投資者、風險管理人員和市場分析師來說都是一個非常有價值的工具。</p>
<p>然而，需要注意的是，任何模型都有其局限性。這個工具應該作為決策的輔助，而不是唯一依據。使用者仍需結合其他分析方法和專業判斷來做出投資決策。</p>
<p>未來，這個工具還可以進一步擴展，例如風險預警系統、納入更多的市場指標，引入更復雜的機器學習模型，或者開發成為一個實時監測系統。隨著金融市場的不斷演變，持續優化和更新這樣的風險監測工具將變得越來越重要。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/07/14/%E7%82%BA%E4%BB%80%E9%BA%BC%E4%BD%A0%E6%87%89%E8%A9%B2%E4%BD%BF%E7%94%A8Docker%EF%BC%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/07/14/%E7%82%BA%E4%BB%80%E9%BA%BC%E4%BD%A0%E6%87%89%E8%A9%B2%E4%BD%BF%E7%94%A8Docker%EF%BC%9F/" class="post-title-link" itemprop="url">為什麼你應該使用Docker？</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-07-14 17:50:09" itemprop="dateCreated datePublished" datetime="2024-07-14T17:50:09+08:00">2024-07-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-11-27 14:46:42" itemprop="dateModified" datetime="2024-11-27T14:46:42+08:00">2024-11-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%96%8B%E7%99%BC%E7%9B%B8%E9%97%9C/" itemprop="url" rel="index"><span itemprop="name">開發相關</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="為什麼你應該使用Docker？"><a href="#為什麼你應該使用Docker？" class="headerlink" title="為什麼你應該使用Docker？"></a>為什麼你應該使用Docker？</h1><p>在現代軟體開發和部署領域中,Docker已經成為一個不可或缺的工具。無論你是開發人員、系統管理員,還是 DevOps 工程師,了解並使用Docker都能為你的工作帶來諸多好處。本文將深入探討為什麼你應該開始使用Docker,以及它能為你的專案和工作流程帶來哪些優勢。</p>
<h2 id="1-一致的開發環境"><a href="#1-一致的開發環境" class="headerlink" title="1. 一致的開發環境"></a>1. 一致的開發環境</h2><p>Docker 最顯著的優勢之一就是能夠創建一致的開發環境。通過使用Docker,你可以確保所有開發人員都在相同的環境中工作,無論他們使用的是什麼操作系統。</p>
<ul>
<li><strong>消除「在我的機器上可以運行」的問題:</strong> Docker容器封裝了應用程式及其所有依賴,確保它在任何地方都能以相同的方式運行。</li>
<li><strong>簡化新成員入職:</strong> 新加入的團隊成員可以快速設置開發環境,無需花費大量時間進行配置。</li>
<li><strong>版本控制環境:</strong> 你可以輕鬆管理不同版本的開發環境,便於在不同專案間切換。</li>
</ul>
<h2 id="2-提高部署效率"><a href="#2-提高部署效率" class="headerlink" title="2. 提高部署效率"></a>2. 提高部署效率</h2><p>Docker 極大地簡化了應用程式的部署流程,使得從開發到生產環境的遷移變得更加順暢。</p>
<ul>
<li><strong>快速部署:</strong> Docker 映像檔可以在幾秒鐘內啟動,大大縮短了部署時間。</li>
<li><strong>可移植性:</strong> Docker 容器可以在任何支援 Docker 的系統上運行,無需擔心底層基礎設施的差異。</li>
<li><strong>擴展性:</strong> 使用 Docker Swarm 或 Kubernetes 等工具,你可以輕鬆實現應用程式的水平擴展。</li>
</ul>
<h2 id="3-資源效率"><a href="#3-資源效率" class="headerlink" title="3. 資源效率"></a>3. 資源效率</h2><p>相較於傳統的虛擬機,Docker容器更加輕量級,能夠更有效地利用系統資源。</p>
<ul>
<li><strong>共享作業系統核心:</strong> 多個容器可以共享同一個作業系統核心,減少了額外的開銷。</li>
<li><strong>快速啟動:</strong> 容器可以在幾毫秒內啟動,遠快於傳統虛擬機。</li>
<li><strong>高密度部署:</strong> 在同一台主機上可以運行更多的容器,提高了硬體利用率。</li>
</ul>
<h2 id="4-隔離性和安全性"><a href="#4-隔離性和安全性" class="headerlink" title="4. 隔離性和安全性"></a>4. 隔離性和安全性</h2><p>Docker 提供了一個隔離的環境來運行應用程式,增強了系統的整體安全性。</p>
<ul>
<li><strong>應用程式隔離:</strong> 每個容器都在自己的沙箱中運行,減少了應用程式之間相互影響的風險。</li>
<li><strong>資源限制:</strong> 可以為每個容器設置資源使用限制,防止單個容器消耗過多資源。</li>
<li><strong>版本控制:</strong> 容易追蹤和管理不同版本的應用程式,便於回滾和版本管理。</li>
</ul>
<h2 id="5-簡化微服務架構的實現"><a href="#5-簡化微服務架構的實現" class="headerlink" title="5. 簡化微服務架構的實現"></a>5. 簡化微服務架構的實現</h2><p>對於採用微服務架構的專案,Docker 提供了理想的容器化解決方案。</p>
<ul>
<li><strong>服務獨立性:</strong> 每個微服務可以獨立部署在自己的容器中,便於管理和擴展。</li>
<li><strong>快速迭代:</strong> 可以單獨更新和部署特定的微服務,而不影響整個系統。</li>
<li><strong>技術多樣性:</strong> 不同的微服務可以使用不同的技術棧,每個都封裝在自己的容器中。</li>
</ul>
<h2 id="6-便於持續集成和持續部署-CI-CD"><a href="#6-便於持續集成和持續部署-CI-CD" class="headerlink" title="6. 便於持續集成和持續部署 (CI/CD)"></a>6. 便於持續集成和持續部署 (CI/CD)</h2><p>Docker 與現代 CI/CD 工具完美集成,簡化了自動化測試和部署流程。</p>
<ul>
<li><strong>一致的測試環境:</strong> 確保測試總是在與生產環境相同的條件下進行。</li>
<li><strong>快速構建和部署:</strong> 容器化應用程式可以快速構建、測試和部署。</li>
<li><strong>容易回滾:</strong> 如果新版本出現問題,可以迅速回滾到之前的穩定版本。</li>
</ul>
<h2 id="7-支援雲端遷移和混合雲"><a href="#7-支援雲端遷移和混合雲" class="headerlink" title="7. 支援雲端遷移和混合雲"></a>7. 支援雲端遷移和混合雲</h2><p>Docker 使得在不同雲端平台之間遷移應用程式變得更加容易。</p>
<ul>
<li><strong>雲端無關性:</strong> Docker 容器可以在任何支援 Docker 的雲端平台上運行。</li>
<li><strong>混合雲支援:</strong> 可以輕鬆在私有雲和公有雲之間遷移應用程式。</li>
<li><strong>多雲戰略:</strong> 便於實施多雲戰略,避免對單一雲端提供商的依賴。</li>
</ul>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>Docker 已經徹底改變了我們開發、測試和部署應用程式的方式。它不僅提高了效率和一致性,還為現代軟體開發中的許多挑戰提供了解決方案。無論是簡化開發環境、提高部署效率,還是支援微服務架構和 CI/CD 流程,Docker 都展現出了巨大的優勢。</p>
<p>對於任何希望提高生產力、增強應用程式可移植性和擴展性的團隊來說,學習和採用Docker都是一個明智之選。隨著容器技術的不斷發展,Docker 無疑將繼續在軟體開發和部署領域扮演重要角色。現在正是開始使用Docker的最佳時機,讓它成為你技術工具箱中的一個強大工具吧!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/06/27/%E5%BE%9ENewtonsoft.Json%E9%81%B7%E7%A7%BB%E5%88%B0System.Text.Json%E7%9A%84%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/27/%E5%BE%9ENewtonsoft.Json%E9%81%B7%E7%A7%BB%E5%88%B0System.Text.Json%E7%9A%84%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/" class="post-title-link" itemprop="url">從Newtonsoft.Json遷移到System.Text.Json的經驗分享</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-06-27 18:43:20" itemprop="dateCreated datePublished" datetime="2024-06-27T18:43:20+08:00">2024-06-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-12-10 09:57:30" itemprop="dateModified" datetime="2024-12-10T09:57:30+08:00">2024-12-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%A8%8B%E5%BC%8F%E6%95%99%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">程式教學</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="從Newtonsoft-Json遷移到System-Text-Json的經驗分享"><a href="#從Newtonsoft-Json遷移到System-Text-Json的經驗分享" class="headerlink" title="從Newtonsoft.Json遷移到System.Text.Json的經驗分享"></a>從Newtonsoft.Json遷移到System.Text.Json的經驗分享</h1><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>在.NET Core的發展過程中，微軟推出了System.Text.Json作為內建的JSON處理庫，以替代長期以來廣泛使用的Newtonsoft.Json (也稱為Json.NET)。本文將分享我在從Newtonsoft.Json遷移到System.Text.Json過程中的經驗，特別是一些可能遇到的”坑”以及解決方案。</p>
<h2 id="為什麼要遷移"><a href="#為什麼要遷移" class="headerlink" title="為什麼要遷移?"></a>為什麼要遷移?</h2><ul>
<li>System.Text.Json的優勢<ul>
<li>更好的性能</li>
<li>與.NET Core的深度整合</li>
<li>減少外部依賴</li>
</ul>
</li>
</ul>
<h2 id="主要差異"><a href="#主要差異" class="headerlink" title="主要差異"></a>主要差異</h2><ol>
<li>命名策略</li>
<li>日期時間處理</li>
<li>類型處理和多態性</li>
<li>循環引用</li>
</ol>
<h2 id="遇到的問題-JSON輸出變成小駝峰命名"><a href="#遇到的問題-JSON輸出變成小駝峰命名" class="headerlink" title="遇到的問題:JSON輸出變成小駝峰命名"></a>遇到的問題:JSON輸出變成小駝峰命名</h2><h3 id="問題描述"><a href="#問題描述" class="headerlink" title="問題描述"></a>問題描述</h3><p>在遷移過程中，我驚訝地發現原本使用Pascal命名法(大駝峰)的JSON輸出突然變成了Camel命名法(小駝峰)。這是因為System.Text.Json和Newtonsoft.Json在默認命名策略上的差異。</p>
<h3 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h3><ul>
<li>Newtonsoft.Json默認保持屬性名稱不變</li>
<li>System.Text.Json默認使用Camel命名法</li>
</ul>
<h3 id="解決方案"><a href="#解決方案" class="headerlink" title="解決方案"></a>解決方案</h3><p>要解決這個問題，我們可以在配置System.Text.Json序列化選項時指定命名策略:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>Json</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>Serialization</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonSerializerOptions</span>
<span class="token punctuation">&#123;</span>
    PropertyNamingPolicy <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// 使用此設置保持原始屬性名稱</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// 使用選項進行序列化</span>
<span class="token class-name"><span class="token keyword">string</span></span> json <span class="token operator">=</span> JsonSerializer<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span>myObject<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="其他常見問題及解決方案"><a href="#其他常見問題及解決方案" class="headerlink" title="其他常見問題及解決方案"></a>其他常見問題及解決方案</h2><h3 id="1-日期時間格式"><a href="#1-日期時間格式" class="headerlink" title="1. 日期時間格式"></a>1. 日期時間格式</h3><p>System.Text.Json默認使用ISO 8601格式，而Newtonsoft.Json允許更多自定義。</p>
<p>解決方案:使用自定義的JsonConverter</p>
<h3 id="2-處理null值"><a href="#2-處理null值" class="headerlink" title="2. 處理null值"></a>2. 處理null值</h3><p>System.Text.Json默認不序列化null值，而Newtonsoft.Json會。</p>
<p>解決方案:設置<code>JsonSerializerOptions.DefaultIgnoreCondition</code></p>
<h3 id="3-類型處理和多態性"><a href="#3-類型處理和多態性" class="headerlink" title="3. 類型處理和多態性"></a>3. 類型處理和多態性</h3><p>System.Text.Json在處理複雜類型和多態性時不如Newtonsoft.Json靈活。</p>
<p>解決方案:使用自定義JsonConverter或考慮保留Newtonsoft.Json用於複雜場景</p>
<h2 id="遷移步驟"><a href="#遷移步驟" class="headerlink" title="遷移步驟"></a>遷移步驟</h2><ol>
<li>評估當前使用情況</li>
<li>更新包引用</li>
<li>修改序列化和反序列化代碼</li>
<li>處理命名策略</li>
<li>調整日期時間處理</li>
<li>處理自定義轉換器</li>
<li>測試和驗證</li>
</ol>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>從Newtonsoft.Json遷移到System.Text.Json雖然可能遇到一些挑戰，但通過適當的配置和調整，大多數問題都可以得到解決。遷移帶來的性能提升和與.NET Core的更好集成是值得的。然而，對於一些特別複雜的場景，可能需要考慮混合使用兩個庫或暫時保留Newtonsoft.Json。</p>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/standard/serialization/system-text-json-migrate-from-newtonsoft-how-to">Microsoft Docs: How to migrate from Newtonsoft.Json to System.Text.Json</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dotnet/runtime/tree/main/src/libraries/System.Text.Json">System.Text.Json GitHub Repository</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/06/26/System.Text.Json-%E8%88%87-Newtonsoft.Json-%E7%9A%84%E6%B7%B1%E5%85%A5%E6%AF%94%E8%BC%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/26/System.Text.Json-%E8%88%87-Newtonsoft.Json-%E7%9A%84%E6%B7%B1%E5%85%A5%E6%AF%94%E8%BC%83/" class="post-title-link" itemprop="url">System.Text.Json 與 Newtonsoft.Json 的深入比較</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-06-26 18:51:01" itemprop="dateCreated datePublished" datetime="2024-06-26T18:51:01+08:00">2024-06-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-11-27 14:39:42" itemprop="dateModified" datetime="2024-11-27T14:39:42+08:00">2024-11-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%A8%8B%E5%BC%8F%E6%95%99%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">程式教學</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="System-Text-Json-與-Newtonsoft-Json-的深入比較"><a href="#System-Text-Json-與-Newtonsoft-Json-的深入比較" class="headerlink" title="System.Text.Json 與 Newtonsoft.Json 的深入比較"></a>System.Text.Json 與 Newtonsoft.Json 的深入比較</h1><p>上一篇文章提到，從Newtonsoft.Json遷移到System.Text.Json的經驗分享，這一篇講講兩個之間的比較，在.NET開發生態系統中，JSON序列化是一個常見的需求。本文將深入比較兩個主要的JSON序列化工具：較新的System.Text.Json和經典的Newtonsoft.Json（也稱為Json.NET）。</p>
<h2 id="歷史背景"><a href="#歷史背景" class="headerlink" title="歷史背景"></a>歷史背景</h2><h3 id="Newtonsoft-Json"><a href="#Newtonsoft-Json" class="headerlink" title="Newtonsoft.Json"></a>Newtonsoft.Json</h3><ul>
<li>2007年發布</li>
<li>長期作為.NET生態系統的標準JSON處理工具</li>
<li>在.NET Framework時期被廣泛使用</li>
<li>直到.NET Core 2.x都是預設的JSON序列化器</li>
</ul>
<h3 id="System-Text-Json"><a href="#System-Text-Json" class="headerlink" title="System.Text.Json"></a>System.Text.Json</h3><ul>
<li>隨著.NET Core 3.0（2019年）推出</li>
<li>由微軟開發，作為.NET Core的一部分</li>
<li>設計目標是提供更好的效能和更低的資源使用</li>
</ul>
<h2 id="效能比較"><a href="#效能比較" class="headerlink" title="效能比較"></a>效能比較</h2><h3 id="System-Text-Json-優勢"><a href="#System-Text-Json-優勢" class="headerlink" title="System.Text.Json 優勢"></a>System.Text.Json 優勢</h3><ul>
<li>序列化和反序列化速度更快</li>
<li>更低的記憶體使用量</li>
<li>減少垃圾回收的頻率</li>
<li>特別適合處理大型JSON數據</li>
<li>非同步處理的效能更好</li>
</ul>
<h3 id="實際數據（以處理1MB-JSON檔案為例）"><a href="#實際數據（以處理1MB-JSON檔案為例）" class="headerlink" title="實際數據（以處理1MB JSON檔案為例）"></a>實際數據（以處理1MB JSON檔案為例）</h3><pre class="line-numbers language-none"><code class="language-none">序列化速度：
- System.Text.Json: ~45ms
- Newtonsoft.Json: ~65ms

記憶體使用：
- System.Text.Json: ~30MB
- Newtonsoft.Json: ~45MB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="功能比較"><a href="#功能比較" class="headerlink" title="功能比較"></a>功能比較</h2><h3 id="Newtonsoft-Json-優勢"><a href="#Newtonsoft-Json-優勢" class="headerlink" title="Newtonsoft.Json 優勢"></a>Newtonsoft.Json 優勢</h3><ol>
<li><p>功能完整性</p>
<ul>
<li>支援更多的序列化選項</li>
<li>提供更豐富的自訂設定</li>
<li>更好的動態型別支援</li>
<li>完整的LINQ to JSON支援</li>
</ul>
</li>
<li><p>彈性</p>
<ul>
<li>更多的特性（Attributes）選項</li>
<li>更容易處理複雜的JSON結構</li>
<li>更好的日期格式處理</li>
<li>支援更多的資料型別轉換</li>
</ul>
</li>
<li><p>成熟度</p>
<ul>
<li>大量的社群支援</li>
<li>豐富的文件和範例</li>
<li>經過長期實戰測試</li>
</ul>
</li>
</ol>
<h3 id="System-Text-Json-優勢-1"><a href="#System-Text-Json-優勢-1" class="headerlink" title="System.Text.Json 優勢"></a>System.Text.Json 優勢</h3><ol>
<li><p>安全性</p>
<ul>
<li>預設的安全設定更嚴格</li>
<li>內建防止JSON反序列化攻擊的機制</li>
<li>限制JSON物件的巢狀深度</li>
</ul>
</li>
<li><p>現代化設計</p>
<ul>
<li>支援新的.NET功能</li>
<li>更好的跨平台支援</li>
<li>原生支援非同步操作</li>
</ul>
</li>
</ol>
<h2 id="程式碼比較"><a href="#程式碼比較" class="headerlink" title="程式碼比較"></a>程式碼比較</h2><h3 id="基本序列化"><a href="#基本序列化" class="headerlink" title="基本序列化"></a>基本序列化</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// System.Text.Json</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>Json</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> json <span class="token operator">=</span> JsonSerializer<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span>myObject<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Newtonsoft.Json</span>
<span class="token keyword">using</span> <span class="token namespace">Newtonsoft<span class="token punctuation">.</span>Json</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> json <span class="token operator">=</span> JsonConvert<span class="token punctuation">.</span><span class="token function">SerializeObject</span><span class="token punctuation">(</span>myObject<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="自訂命名規則"><a href="#自訂命名規則" class="headerlink" title="自訂命名規則"></a>自訂命名規則</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// System.Text.Json</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>Json</span><span class="token punctuation">;</span>

options<span class="token punctuation">.</span>PropertyNamingPolicy <span class="token operator">=</span> JsonNamingPolicy<span class="token punctuation">.</span>CamelCase<span class="token punctuation">;</span>

<span class="token comment">// Newtonsoft.Json</span>
<span class="token keyword">using</span> <span class="token namespace">Newtonsoft<span class="token punctuation">.</span>Json</span><span class="token punctuation">;</span>

settings<span class="token punctuation">.</span>ContractResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CamelCasePropertyNamesContractResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="使用建議"><a href="#使用建議" class="headerlink" title="使用建議"></a>使用建議</h2><h3 id="適合使用System-Text-Json的情況"><a href="#適合使用System-Text-Json的情況" class="headerlink" title="適合使用System.Text.Json的情況"></a>適合使用System.Text.Json的情況</h3><ol>
<li>新專案開發</li>
<li>需要較高效能</li>
<li>主要處理簡單的JSON結構</li>
<li>使用.NET Core/.NET 5+的新專案</li>
<li>需要較低資源使用</li>
</ol>
<h3 id="適合使用Newtonsoft-Json的情況"><a href="#適合使用Newtonsoft-Json的情況" class="headerlink" title="適合使用Newtonsoft.Json的情況"></a>適合使用Newtonsoft.Json的情況</h3><ol>
<li>維護現有專案</li>
<li>需要特定的JSON處理功能</li>
<li>處理複雜的JSON結構</li>
<li>需要大量自訂序列化邏輯</li>
<li>團隊較熟悉Newtonsoft.Json</li>
</ol>
<h2 id="實際應用範例"><a href="#實際應用範例" class="headerlink" title="實際應用範例"></a>實際應用範例</h2><h3 id="處理動態物件"><a href="#處理動態物件" class="headerlink" title="處理動態物件"></a>處理動態物件</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// System.Text.Json</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>Nodes</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> jsonNode <span class="token operator">=</span> JsonNode<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> <span class="token keyword">value</span> <span class="token operator">=</span> jsonNode<span class="token punctuation">[</span><span class="token string">"property"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetValue</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Newtonsoft.Json</span>
<span class="token keyword">using</span> <span class="token namespace">Newtonsoft<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> jObject <span class="token operator">=</span> JObject<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> <span class="token keyword">value</span> <span class="token operator">=</span> jObject<span class="token punctuation">[</span><span class="token string">"property"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Value</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="自訂型別轉換"><a href="#自訂型別轉換" class="headerlink" title="自訂型別轉換"></a>自訂型別轉換</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// System.Text.Json</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomConverter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">JsonConverter<span class="token punctuation">&lt;</span>CustomType<span class="token punctuation">></span></span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">CustomType</span> <span class="token function">Read</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">Utf8JsonReader</span> reader<span class="token punctuation">,</span>
        <span class="token class-name">Type</span> typeToConvert<span class="token punctuation">,</span>
        <span class="token class-name">JsonSerializerOptions</span> options<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 實作讀取邏輯</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Write</span><span class="token punctuation">(</span><span class="token class-name">Utf8JsonWriter</span> writer<span class="token punctuation">,</span>
        <span class="token class-name">CustomType</span> <span class="token keyword">value</span><span class="token punctuation">,</span>
        <span class="token class-name">JsonSerializerOptions</span> options<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 實作寫入邏輯</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Newtonsoft.Json</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomConverter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">JsonConverter</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">ReadJson</span><span class="token punctuation">(</span><span class="token class-name">JsonReader</span> reader<span class="token punctuation">,</span>
        <span class="token class-name">Type</span> objectType<span class="token punctuation">,</span>
        <span class="token class-name"><span class="token keyword">object</span></span> existingValue<span class="token punctuation">,</span>
        <span class="token class-name">JsonSerializer</span> serializer<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 實作讀取邏輯</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WriteJson</span><span class="token punctuation">(</span><span class="token class-name">JsonWriter</span> writer<span class="token punctuation">,</span>
        <span class="token class-name"><span class="token keyword">object</span></span> <span class="token keyword">value</span><span class="token punctuation">,</span>
        <span class="token class-name">JsonSerializer</span> serializer<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 實作寫入邏輯</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>選擇使用哪個JSON序列化器，主要取決於您的專案需求：</p>
<ol>
<li><p>如果您正在開發新專案，且不需要特殊的JSON處理功能，System.Text.Json是個好選擇。它提供更好的效能和更低的資源使用。</p>
</li>
<li><p>如果您的專案需要處理複雜的JSON結構，或需要特定的JSON處理功能，Newtonsoft.Json可能是更好的選擇。它提供更多的功能和更大的彈性。</p>
</li>
<li><p>對於現有的專案，如果已經使用Newtonsoft.Json且運作正常，沒有必要立即轉換到System.Text.Json。轉換成本可能超過效能提升帶來的效益。</p>
</li>
</ol>
<p>最重要的是，兩個函式庫都是優秀的工具，選擇應該基於您的具體需求，而不是簡單地追求最新技術。在做決定時，應考慮：</p>
<ul>
<li>專案的效能需求</li>
<li>團隊的經驗和熟悉度</li>
<li>專案的複雜度</li>
<li>維護成本</li>
<li>與其他套件的相容性</li>
</ul>
<p>選擇合適的工具，才能讓開發更有效率，專案更好維護。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/06/26/%E9%98%B2%E9%A7%AD%E5%AE%A2%E5%BF%85%E5%AD%B8%EF%BC%81%E4%B8%80%E6%AC%A1%E6%90%9E%E6%87%82%20IIS%20HSTS%20%E8%A8%AD%E5%AE%9A%EF%BC%8C%E5%91%8A%E5%88%A5%20HTTPS%20%E9%99%8D%E7%B4%9A%E6%94%BB%E6%93%8A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/26/%E9%98%B2%E9%A7%AD%E5%AE%A2%E5%BF%85%E5%AD%B8%EF%BC%81%E4%B8%80%E6%AC%A1%E6%90%9E%E6%87%82%20IIS%20HSTS%20%E8%A8%AD%E5%AE%9A%EF%BC%8C%E5%91%8A%E5%88%A5%20HTTPS%20%E9%99%8D%E7%B4%9A%E6%94%BB%E6%93%8A/" class="post-title-link" itemprop="url">防駭客必學！一次搞懂 IIS HSTS 設定，告別 HTTPS 降級攻擊</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-06-26 11:18:46" itemprop="dateCreated datePublished" datetime="2024-06-26T11:18:46+08:00">2024-06-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-12-13 16:10:36" itemprop="dateModified" datetime="2024-12-13T16:10:36+08:00">2024-12-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%B3%87%E8%A8%8A%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">資訊安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="防駭客必學！一次搞懂-IIS-HSTS-設定，告別-HTTPS-降級攻擊"><a href="#防駭客必學！一次搞懂-IIS-HSTS-設定，告別-HTTPS-降級攻擊" class="headerlink" title="防駭客必學！一次搞懂 IIS HSTS 設定，告別 HTTPS 降級攻擊"></a>防駭客必學！一次搞懂 IIS HSTS 設定，告別 HTTPS 降級攻擊</h1><p>你的網站已經設定 HTTPS 了嗎？但是否知道光設定 HTTPS 還不夠安全？今天要和大家分享一個超重要的網站安全防護機制：HTTP Strict Transport Security (HSTS)，讓你的網站安全性更上一層樓！</p>
<h2 id="問題發現：弱點掃描警告"><a href="#問題發現：弱點掃描警告" class="headerlink" title="問題發現：弱點掃描警告"></a>問題發現：弱點掃描警告</h2><p>最近在進行專案的弱點掃描時，發現了一個低風險的問題：</p>
<p><img src="20240828112228876.png" alt="弱點掃描結果"></p>
<p>弱點說明提到：應用程式未設定 HTTP Strict Transport Security (HSTS) 標頭。這可能讓攻擊者有機會進行 HTTPS 降級攻擊，竊取敏感資訊。</p>
<h2 id="什麼是-HSTS？為什麼這麼重要？"><a href="#什麼是-HSTS？為什麼這麼重要？" class="headerlink" title="什麼是 HSTS？為什麼這麼重要？"></a>什麼是 HSTS？為什麼這麼重要？</h2><p>HSTS 全名是 HTTP Strict Transport Security，是一種由網際網路工程任務組（IETF）發布的網路安全政策。它的主要功能是：</p>
<ol>
<li>強制瀏覽器使用 HTTPS 與網站進行通訊</li>
<li>有效防禦 SSL 剝離攻擊</li>
<li>保護使用者的敏感資訊</li>
<li>避免憑證警告被忽略</li>
</ol>
<h3 id="HSTS-運作原理"><a href="#HSTS-運作原理" class="headerlink" title="HSTS 運作原理"></a>HSTS 運作原理</h3><p>讓我們看看 HSTS 是如何運作的：</p>
<ol>
<li>使用者第一次存取網站</li>
<li>伺服器在回應中加入 HSTS 標頭</li>
<li>瀏覽器記住這個安全設定</li>
<li>之後瀏覽器會自動將 HTTP 請求轉為 HTTPS</li>
<li>有效防止中間人攻擊</li>
</ol>
<h2 id="HSTS-的兩種設定方式"><a href="#HSTS-的兩種設定方式" class="headerlink" title="HSTS 的兩種設定方式"></a>HSTS 的兩種設定方式</h2><p>在 IIS 中，有兩種方式可以設定 HSTS：</p>
<h3 id="1-使用-CustomHeaders（簡單但不夠完善）"><a href="#1-使用-CustomHeaders（簡單但不夠完善）" class="headerlink" title="1. 使用 CustomHeaders（簡單但不夠完善）"></a>1. 使用 CustomHeaders（簡單但不夠完善）</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>system.webServer</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>httpProtocol</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>customHeaders</span><span class="token punctuation">></span></span>
            <span class="token comment">&lt;!-- 設定 HSTS 標頭，max-age 單位為秒（此處設定一年） --></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>add</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Strict-Transport-Security<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>max-age=31536000<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>customHeaders</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>httpProtocol</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>system.webServer</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-使用-URL-Rewrite（建議使用）"><a href="#2-使用-URL-Rewrite（建議使用）" class="headerlink" title="2. 使用 URL Rewrite（建議使用）"></a>2. 使用 URL Rewrite（建議使用）</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>system.webServer</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rewrite</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>outboundRules</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Add HSTS Header<span class="token punctuation">"</span></span> <span class="token attr-name">enabled</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                <span class="token comment">&lt;!-- 比對所有回應 --></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span> <span class="token attr-name">serverVariable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>RESPONSE_Strict_Transport_Security<span class="token punctuation">"</span></span>
                       <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.*<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conditions</span><span class="token punctuation">></span></span>
                    <span class="token comment">&lt;!-- 只在 HTTPS 連線時添加標頭 --></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>add</span> <span class="token attr-name">input</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;HTTPS&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>on<span class="token punctuation">"</span></span> <span class="token attr-name">ignoreCase</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>conditions</span><span class="token punctuation">></span></span>
                <span class="token comment">&lt;!-- 設定 HSTS 標頭內容 --></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Rewrite<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>max-age=31536000<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>outboundRules</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rewrite</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>system.webServer</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="實務操作：在-IIS-上設定-HSTS"><a href="#實務操作：在-IIS-上設定-HSTS" class="headerlink" title="實務操作：在 IIS 上設定 HSTS"></a>實務操作：在 IIS 上設定 HSTS</h2><h3 id="步驟一：設定-HTTPS-重新導向"><a href="#步驟一：設定-HTTPS-重新導向" class="headerlink" title="步驟一：設定 HTTPS 重新導向"></a>步驟一：設定 HTTPS 重新導向</h3><ol>
<li><p>開啟 IIS 管理員</p>
</li>
<li><p>選擇你的網站，找到「URL Rewrite」模組<br><img src="20240828112904123.png" alt="IIS管理員介面"></p>
</li>
<li><p>新增輸入規則，設定如下：</p>
<ul>
<li>名稱：HTTP to HTTPS redirect</li>
<li>模式：(.*)</li>
<li>條件：{HTTPS} 選「符合模式」，填入 ^OFF$</li>
<li>動作：選「重新導向」，URL 填 https://{HTTP_HOST}/{R:1}<br><img src="20240828112957254.png" alt="重新導向設定"><br><img src="20240828113025526.png" alt="條件設定"></li>
</ul>
</li>
</ol>
<h3 id="步驟二：設定-HSTS-輸出規則"><a href="#步驟二：設定-HSTS-輸出規則" class="headerlink" title="步驟二：設定 HSTS 輸出規則"></a>步驟二：設定 HSTS 輸出規則</h3><ol>
<li>在「URL Rewrite」模組中新增輸出規則</li>
<li>設定內容：<ul>
<li>名稱：Add Strict-Transport-Security when HTTPS</li>
<li>變數名稱：RESPONSE_Strict_Transport_Security</li>
<li>模式：.*</li>
<li>條件：{HTTPS} 選「符合模式」，填入 ^ON$</li>
<li>動作：選「重寫」，值填入 max-age=31536000<br><img src="20240828113055808.png" alt="HSTS設定"><br><img src="20240828113107254.png" alt="完整設定"></li>
</ul>
</li>
</ol>
<p>記得設定完成後要重新啟動網站！</p>
<h2 id="常見問題-Q-amp-A"><a href="#常見問題-Q-amp-A" class="headerlink" title="常見問題 Q&amp;A"></a>常見問題 Q&amp;A</h2><h3 id="Q1-設定後出現重新導向次數過多怎麼辦？"><a href="#Q1-設定後出現重新導向次數過多怎麼辦？" class="headerlink" title="Q1: 設定後出現重新導向次數過多怎麼辦？"></a>Q1: 設定後出現重新導向次數過多怎麼辦？</h3><p>如果你的 SSL 憑證是在網域防火牆處理，需要修改設定：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conditions</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!-- 改用 X-Forwarded-Proto 檢查 --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>add</span> <span class="token attr-name">input</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;HTTP_X_FORWARDED_PROTO&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>conditions</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Q2-要設定多久的-max-age-比較好？"><a href="#Q2-要設定多久的-max-age-比較好？" class="headerlink" title="Q2: 要設定多久的 max-age 比較好？"></a>Q2: 要設定多久的 max-age 比較好？</h3><ul>
<li>測試環境：建議 300 秒</li>
<li>正式環境：一般設定一年（31536000 秒）</li>
</ul>
<h3 id="Q3-如何驗證設定是否成功？"><a href="#Q3-如何驗證設定是否成功？" class="headerlink" title="Q3: 如何驗證設定是否成功？"></a>Q3: 如何驗證設定是否成功？</h3><ol>
<li>使用瀏覽器開發者工具檢查回應標頭</li>
<li>使用 <a target="_blank" rel="noopener" href="https://www.ssllabs.com/ssltest/">SSL Labs</a> 測試</li>
<li>嘗試用 HTTP 連線，應該會自動轉為 HTTPS</li>
</ol>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ol>
<li><a target="_blank" rel="noopener" href="https://owasp.org/www-project-cheat-sheets/cheatsheets/HTTP_Strict_Transport_Security_Cheat_Sheet.html">OWASP HSTS 安全指南</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-TW/docs/Web/HTTP/Headers/Strict-Transport-Security">MDN Web Docs - HSTS</a></li>
</ol>
<h2 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h2><p>網站安全不容忽視！透過正確設定 HSTS，你的網站就能有效防範 HTTPS 降級攻擊。記得要先在測試環境驗證設定，確認一切正常後再部署到正式環境。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/06/25/WebSocket%E9%80%9A%E8%A8%8A%E9%81%8E%E7%A8%8B%E8%A9%B3%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/25/WebSocket%E9%80%9A%E8%A8%8A%E9%81%8E%E7%A8%8B%E8%A9%B3%E8%A7%A3/" class="post-title-link" itemprop="url">WebSocket通訊過程詳解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-06-25 17:36:24" itemprop="dateCreated datePublished" datetime="2024-06-25T17:36:24+08:00">2024-06-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-11-27 14:36:14" itemprop="dateModified" datetime="2024-11-27T14:36:14+08:00">2024-11-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%A8%8B%E5%BC%8F%E6%95%99%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">程式教學</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="WebSocket通訊過程詳解"><a href="#WebSocket通訊過程詳解" class="headerlink" title="WebSocket通訊過程詳解"></a>WebSocket通訊過程詳解</h1><p>今天要跟各位分享的是WebSocket通訊的運作過程。不論是網頁開發新手,還是想深入了解網路協定的老鳥,這篇文章都能讓你對WebSocket有更全面的認識。</p>
<h2 id="WebSocket是什麼"><a href="#WebSocket是什麼" class="headerlink" title="WebSocket是什麼?"></a>WebSocket是什麼?</h2><p>WebSocket是一種網路通訊協定,它能在瀏覽器和伺服器之間建立全雙工、雙向的通訊管道。不同於傳統的HTTP請求-回應模式,WebSocket讓瀏覽器和伺服器可以隨時互相傳送訊息,而不需要重新發起連線。</p>
<h2 id="WebSocket通訊過程"><a href="#WebSocket通訊過程" class="headerlink" title="WebSocket通訊過程"></a>WebSocket通訊過程</h2><p>讓我們一步步來看WebSocket的通訊過程:</p>
<h3 id="1-建立連線"><a href="#1-建立連線" class="headerlink" title="1. 建立連線"></a>1. 建立連線</h3><ol>
<li>客戶端(通常是瀏覽器)向伺服器發送一個HTTP請求,要求升級連線為WebSocket。</li>
<li>這個請求會包含一些特殊的標頭:<ul>
<li><code>Upgrade: websocket</code></li>
<li><code>Connection: Upgrade</code></li>
<li><code>Sec-WebSocket-Key: [一個隨機生成的金鑰]</code></li>
<li><code>Sec-WebSocket-Version: 13</code></li>
</ul>
</li>
</ol>
<h3 id="2-伺服器回應"><a href="#2-伺服器回應" class="headerlink" title="2. 伺服器回應"></a>2. 伺服器回應</h3><ol>
<li>如果伺服器支援WebSocket,它會回應一個HTTP 101狀態碼(Switching Protocols)。</li>
<li>回應中也會包含特殊標頭:<ul>
<li><code>Upgrade: websocket</code></li>
<li><code>Connection: Upgrade</code></li>
<li><code>Sec-WebSocket-Accept: [根據客戶端發送的金鑰計算出的值]</code></li>
</ul>
</li>
</ol>
<h3 id="3-連線建立完成"><a href="#3-連線建立完成" class="headerlink" title="3. 連線建立完成"></a>3. 連線建立完成</h3><p>一旦客戶端收到伺服器的正確回應,WebSocket連線就建立成功了。現在,雙方可以開始互相傳送訊息。</p>
<h3 id="4-資料傳輸"><a href="#4-資料傳輸" class="headerlink" title="4. 資料傳輸"></a>4. 資料傳輸</h3><ol>
<li>WebSocket使用幀(Frame)來傳輸資料。每個幀都有一個小型的標頭,用來描述資料的類型和長度。</li>
<li>資料可以是文字或二進制格式。</li>
<li>雙方都可以隨時發送資料,不需要等待對方的回應。</li>
</ol>
<h3 id="5-心跳機制"><a href="#5-心跳機制" class="headerlink" title="5. 心跳機制"></a>5. 心跳機制</h3><ol>
<li>為了保持連線活躍,WebSocket協定包含了一個心跳機制。</li>
<li>客戶端或伺服器可以定期發送一個小型的Ping幀。</li>
<li>接收方必須回應一個Pong幀。</li>
</ol>
<h3 id="6-關閉連線"><a href="#6-關閉連線" class="headerlink" title="6. 關閉連線"></a>6. 關閉連線</h3><ol>
<li>任何一方都可以發起關閉連線的請求。</li>
<li>發送一個帶有狀態碼的關閉幀。</li>
<li>另一方接收到關閉幀後,也會回應一個關閉幀。</li>
<li>雙方都發送和接收到關閉幀後,連線正式關閉。</li>
</ol>
<h2 id="WebSocket的優點"><a href="#WebSocket的優點" class="headerlink" title="WebSocket的優點"></a>WebSocket的優點</h2><ol>
<li><strong>即時性</strong>: 資料可以立即傳送,不需要輪詢。</li>
<li><strong>效能</strong>: 相較於反覆建立HTTP連線,WebSocket更節省資源。</li>
<li><strong>雙向通訊</strong>: 伺服器可以主動向客戶端推送資料。</li>
<li><strong>較低延遲</strong>: 一旦連線建立,資料傳輸的延遲就很低。</li>
</ol>
<h2 id="適用場景"><a href="#適用場景" class="headerlink" title="適用場景"></a>適用場景</h2><p>WebSocket特別適合需要即時更新的應用,例如:</p>
<ul>
<li>線上遊戲</li>
<li>即時聊天室</li>
<li>股票行情顯示器</li>
<li>線上協作工具</li>
</ul>
<h2 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h2><p>WebSocket為網路應用帶來了新的可能性,讓我們能夠建立更即時、互動性更強的網站和應用程式。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/06/23/%E4%BD%BF%E7%94%A8-NSSM-%E5%B0%87-EXE-%E5%8C%85%E8%A3%9D%E6%88%90-Windows-%E6%9C%8D%E5%8B%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/23/%E4%BD%BF%E7%94%A8-NSSM-%E5%B0%87-EXE-%E5%8C%85%E8%A3%9D%E6%88%90-Windows-%E6%9C%8D%E5%8B%99/" class="post-title-link" itemprop="url">使用 NSSM 將 EXE 包裝成 Windows 服務</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-06-23 10:35:36" itemprop="dateCreated datePublished" datetime="2024-06-23T10:35:36+08:00">2024-06-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-12-10 09:58:52" itemprop="dateModified" datetime="2024-12-10T09:58:52+08:00">2024-12-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BB%9F%E9%AB%94%E4%BB%8B%E7%B4%B9/" itemprop="url" rel="index"><span itemprop="name">軟體介紹</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="使用-NSSM-將-EXE-包裝成-Windows-服務"><a href="#使用-NSSM-將-EXE-包裝成-Windows-服務" class="headerlink" title="使用 NSSM 將 EXE 包裝成 Windows 服務"></a>使用 NSSM 將 EXE 包裝成 Windows 服務</h1><p>NSSM（Non-Sucking Service Manager）是一個強大的工具，可以輕鬆地將任何可執行文件（EXE）轉換為 Windows 服務。本教學將指導您完成整個過程，從安裝 NSSM 到配置和管理您的服務。</p>
<h2 id="目錄"><a href="#目錄" class="headerlink" title="目錄"></a>目錄</h2><ol>
<li>NSSM 簡介</li>
<li>下載和安裝 NSSM</li>
<li>基本使用：創建服務</li>
<li>高級配置選項</li>
<li>管理服務</li>
<li>常見問題解決</li>
<li>最佳實踐和注意事項</li>
</ol>
<h2 id="1-NSSM-簡介與SC命令的比較"><a href="#1-NSSM-簡介與SC命令的比較" class="headerlink" title="1. NSSM 簡介與SC命令的比較"></a>1. NSSM 簡介與SC命令的比較</h2><p>NSSM 是一個免費的開源工具，它允許您將幾乎任何應用程序作為 Windows 服務運行。與SC命令比較</p>
<h2 id="SC命令的優點："><a href="#SC命令的優點：" class="headerlink" title="SC命令的優點："></a>SC命令的優點：</h2><h4 id="1-Windows-內建，無需額外安裝"><a href="#1-Windows-內建，無需額外安裝" class="headerlink" title="1. Windows 內建，無需額外安裝"></a>1. Windows 內建，無需額外安裝</h4><h4 id="2-命令簡單，適合基本需求"><a href="#2-命令簡單，適合基本需求" class="headerlink" title="2. 命令簡單，適合基本需求"></a>2. 命令簡單，適合基本需求</h4><h2 id="SC命令的限制："><a href="#SC命令的限制：" class="headerlink" title="SC命令的限制："></a>SC命令的限制：</h2><h4 id="1-功能相對簡單，缺乏高級選項"><a href="#1-功能相對簡單，缺乏高級選項" class="headerlink" title="1. 功能相對簡單，缺乏高級選項"></a>1. 功能相對簡單，缺乏高級選項</h4><h4 id="2-對於複雜的啟動參數或環境設置，可能需要額外的腳本"><a href="#2-對於複雜的啟動參數或環境設置，可能需要額外的腳本" class="headerlink" title="2. 對於複雜的啟動參數或環境設置，可能需要額外的腳本"></a>2. 對於複雜的啟動參數或環境設置，可能需要額外的腳本</h4><h4 id="3-錯誤處理和日誌記錄功能有限"><a href="#3-錯誤處理和日誌記錄功能有限" class="headerlink" title="3. 錯誤處理和日誌記錄功能有限"></a>3. 錯誤處理和日誌記錄功能有限</h4><h2 id="NSSM的優點："><a href="#NSSM的優點：" class="headerlink" title="NSSM的優點："></a>NSSM的優點：</h2><h4 id="1-圖形介面：易於使用，不需要記憶複雜的命令列語法"><a href="#1-圖形介面：易於使用，不需要記憶複雜的命令列語法" class="headerlink" title="1. 圖形介面：易於使用，不需要記憶複雜的命令列語法"></a>1. 圖形介面：易於使用，不需要記憶複雜的命令列語法</h4><h4 id="2-豐富的組態選項："><a href="#2-豐富的組態選項：" class="headerlink" title="2. 豐富的組態選項："></a>2. 豐富的組態選項：</h4><h4 id="可以設置啟動目錄、環境變量"><a href="#可以設置啟動目錄、環境變量" class="headerlink" title="- 可以設置啟動目錄、環境變量"></a>- 可以設置啟動目錄、環境變量</h4><h4 id="支援複雜的啟動參數"><a href="#支援複雜的啟動參數" class="headerlink" title="- 支援複雜的啟動參數"></a>- 支援複雜的啟動參數</h4><h4 id="可以組態服務依賴關係"><a href="#可以組態服務依賴關係" class="headerlink" title="- 可以組態服務依賴關係"></a>- 可以組態服務依賴關係</h4><h4 id="3-錯誤處理：可以設置在程序崩潰時自動重啟"><a href="#3-錯誤處理：可以設置在程序崩潰時自動重啟" class="headerlink" title="3. 錯誤處理：可以設置在程序崩潰時自動重啟"></a>3. 錯誤處理：可以設置在程序崩潰時自動重啟</h4><h4 id="4-日誌功能：可以捕獲並記錄標準輸出和錯誤輸出"><a href="#4-日誌功能：可以捕獲並記錄標準輸出和錯誤輸出" class="headerlink" title="4. 日誌功能：可以捕獲並記錄標準輸出和錯誤輸出"></a>4. 日誌功能：可以捕獲並記錄標準輸出和錯誤輸出</h4><h4 id="5-關機行為控制：可以設置如何優雅地關閉服務"><a href="#5-關機行為控制：可以設置如何優雅地關閉服務" class="headerlink" title="5. 關機行為控制：可以設置如何優雅地關閉服務"></a>5. 關機行為控制：可以設置如何優雅地關閉服務</h4><h4 id="6-I-O-重新導向：可以將輸入輸出重新導向到檔案"><a href="#6-I-O-重新導向：可以將輸入輸出重新導向到檔案" class="headerlink" title="6. I/O 重新導向：可以將輸入輸出重新導向到檔案"></a>6. I/O 重新導向：可以將輸入輸出重新導向到檔案</h4><h4 id="7-支援互動式程序：某些需要用戶輸入的程序也可以作為服務運行"><a href="#7-支援互動式程序：某些需要用戶輸入的程序也可以作為服務運行" class="headerlink" title="7. 支援互動式程序：某些需要用戶輸入的程序也可以作為服務運行"></a>7. 支援互動式程序：某些需要用戶輸入的程序也可以作為服務運行</h4><h4 id="8-服務監控：提供了更好的方式來監控服務狀態"><a href="#8-服務監控：提供了更好的方式來監控服務狀態" class="headerlink" title="8. 服務監控：提供了更好的方式來監控服務狀態"></a>8. 服務監控：提供了更好的方式來監控服務狀態</h4><p>總的來說，雖然 SC 命令對於簡單的需求來說已經足夠，但 NSSM 提供了更多的靈活性和功能，特別適合那些需要更精細控制的複雜場景。如果您的程序需要特殊的啟動條件、錯誤處理或日誌記錄，NSSM 可能是更好的選擇。</p>
<h2 id="2-下載和安裝-NSSM"><a href="#2-下載和安裝-NSSM" class="headerlink" title="2. 下載和安裝 NSSM"></a>2. 下載和安裝 NSSM</h2><ol>
<li>訪問 NSSM 官方網站：<a target="_blank" rel="noopener" href="https://nssm.cc/download">https://nssm.cc/download</a></li>
<li>下載最新版本的 NSSM（選擇適合您系統的版本，32 位或 64 位）</li>
<li>解壓下載的壓縮文件</li>
<li>將 nssm.exe 放置在一個便於訪問的位置，如 <code>C:\Program Files\NSSM\</code></li>
<li>可選：將 NSSM 的路徑添加到系統的 PATH 環境變量中</li>
</ol>
<h2 id="3-基本使用：創建服務"><a href="#3-基本使用：創建服務" class="headerlink" title="3. 基本使用：創建服務"></a>3. 基本使用：創建服務</h2><p>以管理員身份打開命令提示符，然後按照以下步驟操作：</p>
<ol>
<li><p>創建新服務：</p>
<pre class="line-numbers language-none"><code class="language-none">nssm install &lt;服務名稱&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>這將打開 NSSM 的圖形界面。</p>
</li>
<li><p>在彈出的窗口中，設置以下內容：</p>
<ul>
<li>Path: 您的 EXE 文件的完整路徑</li>
<li>Startup directory: EXE 文件所在的目錄</li>
<li>Arguments: 如果需要，添加命令行參數</li>
</ul>
</li>
<li><p>點擊 “Install service” 按鈕</p>
</li>
</ol>
<p>您也可以使用命令行直接創建服務：</p>
<pre class="line-numbers language-none"><code class="language-none">nssm install &lt;服務名稱&gt; &lt;EXE 路徑&gt; [參數]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>例如：</p>
<pre class="line-numbers language-none"><code class="language-none">nssm install MyService C:\MyApp\MyProgram.exe -config C:\MyApp\config.ini<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="4-高級配置選項"><a href="#4-高級配置選項" class="headerlink" title="4. 高級配置選項"></a>4. 高級配置選項</h2><p>NSSM 提供了許多高級配置選項：</p>
<ol>
<li><p>設置服務顯示名稱和描述：</p>
<pre class="line-numbers language-none"><code class="language-none">nssm set &lt;服務名稱&gt; DisplayName &quot;My Service Display Name&quot;
nssm set &lt;服務名稱&gt; Description &quot;This is my service description&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
<li><p>配置啟動類型：</p>
<pre class="line-numbers language-none"><code class="language-none">nssm set &lt;服務名稱&gt; Start SERVICE_AUTO_START<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>設置環境變量：</p>
<pre class="line-numbers language-none"><code class="language-none">nssm set &lt;服務名稱&gt; AppEnvironment PATH&#x3D;C:\MyApp;%PATH%<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>配置錯誤處理：</p>
<pre class="line-numbers language-none"><code class="language-none">nssm set &lt;服務名稱&gt; AppExit Default Restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>設置日誌文件：</p>
<pre class="line-numbers language-none"><code class="language-none">nssm set &lt;服務名稱&gt; AppStdout C:\Logs\MyService.log
nssm set &lt;服務名稱&gt; AppStderr C:\Logs\MyService.err<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ol>
<h2 id="5-管理服務"><a href="#5-管理服務" class="headerlink" title="5. 管理服務"></a>5. 管理服務</h2><ol>
<li><p>啟動服務：</p>
<pre class="line-numbers language-none"><code class="language-none">nssm start &lt;服務名稱&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>停止服務：</p>
<pre class="line-numbers language-none"><code class="language-none">nssm stop &lt;服務名稱&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>重啟服務：</p>
<pre class="line-numbers language-none"><code class="language-none">nssm restart &lt;服務名稱&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>查看服務狀態：</p>
<pre class="line-numbers language-none"><code class="language-none">nssm status &lt;服務名稱&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>編輯現有服務：</p>
<pre class="line-numbers language-none"><code class="language-none">nssm edit &lt;服務名稱&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>刪除服務：</p>
<pre class="line-numbers language-none"><code class="language-none">nssm remove &lt;服務名稱&gt; confirm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<h2 id="6-常見問題解決"><a href="#6-常見問題解決" class="headerlink" title="6. 常見問題解決"></a>6. 常見問題解決</h2><ol>
<li><p>服務無法啟動</p>
<ul>
<li>檢查 EXE 路徑是否正確</li>
<li>確保 NSSM 和您的應用程序有足夠的權限</li>
<li>查看 Windows 事件日誌和 NSSM 日誌文件</li>
</ul>
</li>
<li><p>服務啟動後立即停止</p>
<ul>
<li>檢查您的應用程序是否設計為長時間運行</li>
<li>確保所有必要的依賴項都可用</li>
</ul>
</li>
<li><p>無法與服務通信</p>
<ul>
<li>檢查防火牆設置</li>
<li>確保服務帳戶有適當的網絡權限</li>
</ul>
</li>
</ol>
<h2 id="7-最佳實踐和注意事項"><a href="#7-最佳實踐和注意事項" class="headerlink" title="7. 最佳實踐和注意事項"></a>7. 最佳實踐和注意事項</h2><ol>
<li>始終使用管理員權限運行 NSSM 命令</li>
<li>為您的服務使用描述性的名稱</li>
<li>定期檢查服務日誌以確保正常運行</li>
<li>考慮使用服務帳戶而不是系統帳戶來運行服務</li>
<li>定期更新 NSSM 到最新版本</li>
<li>在生產環境中部署之前，在測試環境中徹底測試您的服務配置</li>
</ol>
<p>通過遵循本教學，您應該能夠成功地使用 NSSM 將您的 EXE 文件包裝成 Windows 服務，並有效地管理它。NSSM 提供了一種靈活且強大的方式來確保您的應用程序作為服務持續運行，無需用戶干預。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">kyosora</p>
  <div class="site-description" itemprop="description">個人技術筆記和學習心得分享</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">99</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">分類</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">118</span>
        <span class="site-state-item-name">標籤</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kyosora</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 強力驅動
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
