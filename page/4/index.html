<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"kyosora.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="個人技術筆記和學習心得分享">
<meta property="og:type" content="website">
<meta property="og:title" content="kyosora 虛空筆記">
<meta property="og:url" content="https://kyosora.github.io/page/4/index.html">
<meta property="og:site_name" content="kyosora 虛空筆記">
<meta property="og:description" content="個人技術筆記和學習心得分享">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="kyosora">
<meta property="article:tag" content="網路安全, 系統管理, 程式設計, 技術筆記">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://kyosora.github.io/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-TW'
  };
</script>

  <title>kyosora 虛空筆記</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">kyosora 虛空筆記</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">技術探索與學習分享</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/11/01/SQL-Server-%E7%A9%BA%E9%96%93%E6%9F%A5%E8%A9%A2%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/01/SQL-Server-%E7%A9%BA%E9%96%93%E6%9F%A5%E8%A9%A2%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">SQL Server 空間查詢操作指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-11-01 17:57:14" itemprop="dateCreated datePublished" datetime="2024-11-01T17:57:14+08:00">2024-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-11-27 14:41:16" itemprop="dateModified" datetime="2024-11-27T14:41:16+08:00">2024-11-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%A8%8B%E5%BC%8F%E6%95%99%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">程式教學</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="SQL-Server-空間查詢操作指南"><a href="#SQL-Server-空間查詢操作指南" class="headerlink" title="SQL Server 空間查詢操作指南"></a>SQL Server 空間查詢操作指南</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在處理地理資訊系統(GIS)時，SQL Server 提供了一系列強大的空間查詢工具。本文將詳細介紹這些工具的使用方法，幫助您更有效地處理空間資料。</p>
<h2 id="一、基本空間關係判斷"><a href="#一、基本空間關係判斷" class="headerlink" title="一、基本空間關係判斷"></a>一、基本空間關係判斷</h2><h3 id="1-包含關係"><a href="#1-包含關係" class="headerlink" title="1. 包含關係"></a>1. 包含關係</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- A.STContains(B)：判斷 A 是否包含 B</span>
<span class="token comment">-- 最常用於判斷點位是否在某個範圍內</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> Points 
<span class="token keyword">WHERE</span> <span class="token variable">@polygon.STContains</span><span class="token punctuation">(</span>point_geometry<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">-- A.STWithin(B)：判斷 A 是否在 B 內</span>
<span class="token comment">-- 與 STContains 相反，從點位角度判斷</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> Points 
<span class="token keyword">WHERE</span> point_geometry<span class="token punctuation">.</span>STWithin<span class="token punctuation">(</span><span class="token variable">@polygon</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-相交關係"><a href="#2-相交關係" class="headerlink" title="2. 相交關係"></a>2. 相交關係</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- A.STIntersects(B)：判斷 A 和 B 是否相交</span>
<span class="token comment">-- 適合判斷兩個範圍是否有重疊</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> Zones
<span class="token keyword">WHERE</span> zone1_geometry<span class="token punctuation">.</span>STIntersects<span class="token punctuation">(</span>zone2_geometry<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">-- A.STTouches(B)：判斷 A 和 B 是否僅在邊界相交</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> Zones
<span class="token keyword">WHERE</span> zone1_geometry<span class="token punctuation">.</span>STTouches<span class="token punctuation">(</span>zone2_geometry<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-其他空間關係"><a href="#3-其他空間關係" class="headerlink" title="3. 其他空間關係"></a>3. 其他空間關係</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- A.STEquals(B)：判斷 A 和 B 是否完全相同</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> Geometry_Table
<span class="token keyword">WHERE</span> geometry1<span class="token punctuation">.</span>STEquals<span class="token punctuation">(</span>geometry2<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">-- A.STOverlaps(B)：判斷 A 和 B 是否部分重疊</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> Zones
<span class="token keyword">WHERE</span> zone1_geometry<span class="token punctuation">.</span>STOverlaps<span class="token punctuation">(</span>zone2_geometry<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">-- A.STDisjoint(B)：判斷 A 和 B 是否完全不相交</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> Zones
<span class="token keyword">WHERE</span> zone1_geometry<span class="token punctuation">.</span>STDisjoint<span class="token punctuation">(</span>zone2_geometry<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="二、距離相關方法"><a href="#二、距離相關方法" class="headerlink" title="二、距離相關方法"></a>二、距離相關方法</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 計算兩個空間物件間的距離</span>
<span class="token punctuation">.</span>STDistance<span class="token punctuation">(</span><span class="token keyword">geometry</span><span class="token punctuation">)</span>

<span class="token comment">-- 建立指定距離的緩衝區</span>
<span class="token punctuation">.</span>STBuffer<span class="token punctuation">(</span>distance<span class="token punctuation">)</span>

<span class="token comment">-- 實際應用範例：找出距離特定點位 500 公尺內的所有點</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> Points
<span class="token keyword">WHERE</span> point_geometry<span class="token punctuation">.</span>STDistance<span class="token punctuation">(</span><span class="token variable">@centerPoint</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">500</span>

<span class="token comment">-- 建立緩衝區後進行查詢</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> Points
<span class="token keyword">WHERE</span> <span class="token variable">@polygon.STBuffer</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span>STContains<span class="token punctuation">(</span>point_geometry<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="三、幾何運算方法"><a href="#三、幾何運算方法" class="headerlink" title="三、幾何運算方法"></a>三、幾何運算方法</h2><h3 id="1-差集運算-Difference"><a href="#1-差集運算-Difference" class="headerlink" title="1. 差集運算 (Difference)"></a>1. 差集運算 (Difference)</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- A.STDifference(B)：從 A 中減去與 B 重疊的部分</span>
<span class="token keyword">SELECT</span> @規劃範圍<span class="token punctuation">.</span>STDifference<span class="token punctuation">(</span>@禁制區<span class="token punctuation">)</span> <span class="token keyword">as</span> 實際可用範圍<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="2-聯集運算-Union"><a href="#2-聯集運算-Union" class="headerlink" title="2. 聯集運算 (Union)"></a>2. 聯集運算 (Union)</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- A.STUnion(B)：合併 A 和 B 的範圍</span>
<span class="token keyword">SELECT</span> @範圍<span class="token number">1.</span>STUnion<span class="token punctuation">(</span>@範圍<span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 合併範圍

<span class="token comment">-- 多筆資料的聯集</span>
<span class="token keyword">SELECT</span> <span class="token keyword">geometry</span>::UnionAggregate<span class="token punctuation">(</span><span class="token keyword">geometry</span>欄位<span class="token punctuation">)</span> <span class="token keyword">as</span> 總範圍
<span class="token keyword">FROM</span> 範圍表<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-交集運算-Intersection"><a href="#3-交集運算-Intersection" class="headerlink" title="3. 交集運算 (Intersection)"></a>3. 交集運算 (Intersection)</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- A.STIntersection(B)：取得 A 和 B 重疊的部分</span>
<span class="token keyword">SELECT</span> @範圍<span class="token number">1.</span>STIntersection<span class="token punctuation">(</span>@範圍<span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 重疊區域<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="4-對稱差集-Symmetric-Difference"><a href="#4-對稱差集-Symmetric-Difference" class="headerlink" title="4. 對稱差集 (Symmetric Difference)"></a>4. 對稱差集 (Symmetric Difference)</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- A.STSymDifference(B)：取得兩個範圍不重疊的部分</span>
<span class="token keyword">SELECT</span> @範圍<span class="token number">1.</span>STSymDifference<span class="token punctuation">(</span>@範圍<span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 不重疊區域<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="四、資料格式轉換"><a href="#四、資料格式轉換" class="headerlink" title="四、資料格式轉換"></a>四、資料格式轉換</h2><h3 id="1-文字轉空間資料"><a href="#1-文字轉空間資料" class="headerlink" title="1. 文字轉空間資料"></a>1. 文字轉空間資料</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 從WKT文字轉geometry</span>
<span class="token keyword">geometry</span>::STGeomFromText<span class="token punctuation">(</span><span class="token string">'POINT(X Y)'</span><span class="token punctuation">,</span> SRID<span class="token punctuation">)</span>

<span class="token comment">-- 專門轉換點位的方法</span>
<span class="token keyword">geometry</span>::STPointFromText<span class="token punctuation">(</span><span class="token string">'POINT(X Y)'</span><span class="token punctuation">,</span> SRID<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-空間資料轉文字"><a href="#2-空間資料轉文字" class="headerlink" title="2. 空間資料轉文字"></a>2. 空間資料轉文字</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 轉為WKT格式文字</span>
<span class="token punctuation">.</span>STAsText<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">-- 轉為字串</span>
<span class="token punctuation">.</span>ToString<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="五、實際應用範例"><a href="#五、實際應用範例" class="headerlink" title="五、實際應用範例"></a>五、實際應用範例</h2><h3 id="1-基本範圍查詢"><a href="#1-基本範圍查詢" class="headerlink" title="1. 基本範圍查詢"></a>1. 基本範圍查詢</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 範例一：找出特定區域內的所有點位</span>
<span class="token keyword">SELECT</span> p<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span> Points p
<span class="token keyword">WHERE</span> @特定區域<span class="token punctuation">.</span>STContains<span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">-- 範例二：找出同時在A區域和B區域的點位</span>
<span class="token keyword">SELECT</span> p<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span> Points p
<span class="token keyword">WHERE</span> @區域A<span class="token punctuation">.</span>STContains<span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token operator">AND</span> @區域B<span class="token punctuation">.</span>STContains<span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-複合條件查詢"><a href="#2-複合條件查詢" class="headerlink" title="2. 複合條件查詢"></a>2. 複合條件查詢</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 範例一：找出在特定區域內且符合特定條件的點位</span>
<span class="token keyword">SELECT</span> p<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span> Points p
<span class="token keyword">JOIN</span> Zones z <span class="token keyword">ON</span> z<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">.</span>STContains<span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">WHERE</span> 
    z<span class="token punctuation">.</span>ZoneName <span class="token operator">=</span> <span class="token string">'特定區域'</span>
    <span class="token operator">AND</span> p<span class="token punctuation">.</span><span class="token keyword">Type</span> <span class="token operator">=</span> <span class="token string">'住宅'</span>
    <span class="token operator">AND</span> p<span class="token punctuation">.</span><span class="token keyword">Status</span> <span class="token operator">=</span> <span class="token string">'使用中'</span>

<span class="token comment">-- 範例二：找出在多個區域內的點位並標示區域名稱</span>
<span class="token keyword">SELECT</span> 
    p<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
    STRING_AGG<span class="token punctuation">(</span>z<span class="token punctuation">.</span>ZoneName<span class="token punctuation">,</span> <span class="token string">','</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 所在區域
<span class="token keyword">FROM</span> Points p
<span class="token keyword">JOIN</span> Zones z <span class="token keyword">ON</span> z<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">.</span>STContains<span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> p<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> p<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>Name  <span class="token comment">-- 需要列出所有要顯示的欄位</span>
<span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span>  <span class="token comment">-- 只顯示位於多個區域的點位</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-距離相關查詢"><a href="#3-距離相關查詢" class="headerlink" title="3. 距離相關查詢"></a>3. 距離相關查詢</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 範例一：找出距離特定點位500公尺內的所有點</span>
<span class="token keyword">DECLARE</span> @中心點 <span class="token keyword">geometry</span> <span class="token operator">=</span> <span class="token keyword">geometry</span>::STPointFromText<span class="token punctuation">(</span><span class="token string">'POINT(330000 2730000)'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">SELECT</span> 
    p<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
    p<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">.</span>STDistance<span class="token punctuation">(</span>@中心點<span class="token punctuation">)</span> <span class="token keyword">as</span> 距離
<span class="token keyword">FROM</span> Points p
<span class="token keyword">WHERE</span> p<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">.</span>STDistance<span class="token punctuation">(</span>@中心點<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">500</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 距離

<span class="token comment">-- 範例二：找出兩個點位間最短距離的路徑</span>
<span class="token keyword">SELECT</span> 
    p1<span class="token punctuation">.</span>Id <span class="token keyword">as</span> 起點ID<span class="token punctuation">,</span>
    p2<span class="token punctuation">.</span>Id <span class="token keyword">as</span> 終點ID<span class="token punctuation">,</span>
    p1<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">.</span>STDistance<span class="token punctuation">(</span>p2<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 距離
<span class="token keyword">FROM</span> Points p1
<span class="token keyword">CROSS</span> <span class="token keyword">JOIN</span> Points p2
<span class="token keyword">WHERE</span> p1<span class="token punctuation">.</span>Id <span class="token operator">&lt;</span> p2<span class="token punctuation">.</span>Id  <span class="token comment">-- 避免重複組合</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 距離<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-範圍運算案例"><a href="#4-範圍運算案例" class="headerlink" title="4. 範圍運算案例"></a>4. 範圍運算案例</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 範例一：計算多個區域的聯集範圍</span>
<span class="token keyword">WITH</span> 合併範圍 <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token keyword">geometry</span>::UnionAggregate<span class="token punctuation">(</span><span class="token keyword">geometry</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 總範圍
    <span class="token keyword">FROM</span> Zones
    <span class="token keyword">WHERE</span> ZoneType <span class="token operator">=</span> <span class="token string">'服務區'</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> 
    總範圍<span class="token punctuation">,</span>
    總範圍<span class="token punctuation">.</span>STArea<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 總面積
<span class="token keyword">FROM</span> 合併範圍

<span class="token comment">-- 範例二：找出兩個區域的重疊部分</span>
<span class="token keyword">SELECT</span> 
    @區域A<span class="token punctuation">.</span>STIntersection<span class="token punctuation">(</span>@區域B<span class="token punctuation">)</span> <span class="token keyword">as</span> 重疊區域<span class="token punctuation">,</span>
    @區域A<span class="token punctuation">.</span>STIntersection<span class="token punctuation">(</span>@區域B<span class="token punctuation">)</span><span class="token punctuation">.</span>STArea<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 重疊面積<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5-複雜範圍處理"><a href="#5-複雜範圍處理" class="headerlink" title="5. 複雜範圍處理"></a>5. 複雜範圍處理</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 範例一：從規劃範圍中扣除多個禁制區</span>
<span class="token keyword">WITH</span> 禁制區 <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token keyword">geometry</span>::UnionAggregate<span class="token punctuation">(</span><span class="token keyword">geometry</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 總禁制區
    <span class="token keyword">FROM</span> Zones
    <span class="token keyword">WHERE</span> ZoneType <span class="token operator">=</span> <span class="token string">'禁制區'</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> 
    @規劃範圍<span class="token punctuation">.</span>STDifference<span class="token punctuation">(</span>總禁制區<span class="token punctuation">)</span> <span class="token keyword">as</span> 可用範圍<span class="token punctuation">,</span>
    @規劃範圍<span class="token punctuation">.</span>STDifference<span class="token punctuation">(</span>總禁制區<span class="token punctuation">)</span><span class="token punctuation">.</span>STArea<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 可用面積
<span class="token keyword">FROM</span> 禁制區

<span class="token comment">-- 範例二：建立緩衝區並找出在緩衝區內的點位</span>
<span class="token keyword">SELECT</span> p<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span> Points p
<span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token keyword">geometry</span>::UnionAggregate<span class="token punctuation">(</span><span class="token keyword">geometry</span><span class="token punctuation">.</span>STBuffer<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 緩衝區
    <span class="token keyword">FROM</span> ServicePoints
    <span class="token keyword">WHERE</span> <span class="token keyword">Type</span> <span class="token operator">=</span> <span class="token string">'服務站'</span>
<span class="token punctuation">)</span> buffer
<span class="token keyword">WHERE</span> buffer<span class="token punctuation">.</span>緩衝區<span class="token punctuation">.</span>STContains<span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="6-統計分析案例"><a href="#6-統計分析案例" class="headerlink" title="6. 統計分析案例"></a>6. 統計分析案例</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 範例一：計算各區域內的點位數量</span>
<span class="token keyword">SELECT</span> 
    z<span class="token punctuation">.</span>ZoneName<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 點位數量<span class="token punctuation">,</span>
    z<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">.</span>STArea<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 區域面積<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> z<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">.</span>STArea<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 點位密度
<span class="token keyword">FROM</span> Zones z
<span class="token keyword">JOIN</span> Points p <span class="token keyword">ON</span> z<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">.</span>STContains<span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> z<span class="token punctuation">.</span>ZoneId<span class="token punctuation">,</span> z<span class="token punctuation">.</span>ZoneName<span class="token punctuation">,</span> z<span class="token punctuation">.</span><span class="token keyword">geometry</span>

<span class="token comment">-- 範例二：計算點位的分佈情況</span>
<span class="token keyword">SELECT</span> 
    p1<span class="token punctuation">.</span>Id <span class="token keyword">as</span> 中心點ID<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 周圍點位數量<span class="token punctuation">,</span>
    <span class="token function">AVG</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">.</span>STDistance<span class="token punctuation">(</span>p2<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 平均距離<span class="token punctuation">,</span>
    <span class="token function">MIN</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">.</span>STDistance<span class="token punctuation">(</span>p2<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 最短距離<span class="token punctuation">,</span>
    <span class="token function">MAX</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">.</span>STDistance<span class="token punctuation">(</span>p2<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 最長距離
<span class="token keyword">FROM</span> Points p1
<span class="token keyword">JOIN</span> Points p2 <span class="token keyword">ON</span> p1<span class="token punctuation">.</span>Id <span class="token operator">!=</span> p2<span class="token punctuation">.</span>Id
<span class="token keyword">WHERE</span> p1<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">.</span>STDistance<span class="token punctuation">(</span>p2<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1000</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> p1<span class="token punctuation">.</span>Id<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="7-資料驗證案例"><a href="#7-資料驗證案例" class="headerlink" title="7. 資料驗證案例"></a>7. 資料驗證案例</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 範例一：檢查點位是否在合法範圍內</span>
<span class="token keyword">SELECT</span> p<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span> Points p
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> LegalZones z <span class="token keyword">ON</span> z<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">.</span>STContains<span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">WHERE</span> z<span class="token punctuation">.</span>Id <span class="token operator">IS</span> <span class="token boolean">NULL</span>  <span class="token comment">-- 找出不在任何合法區域內的點位</span>

<span class="token comment">-- 範例二：檢查兩個點位是否過於接近</span>
<span class="token keyword">SELECT</span> 
    p1<span class="token punctuation">.</span>Id <span class="token keyword">as</span> 點位<span class="token number">1</span><span class="token punctuation">,</span>
    p2<span class="token punctuation">.</span>Id <span class="token keyword">as</span> 點位<span class="token number">2</span><span class="token punctuation">,</span>
    p1<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">.</span>STDistance<span class="token punctuation">(</span>p2<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 距離
<span class="token keyword">FROM</span> Points p1
<span class="token keyword">JOIN</span> Points p2 <span class="token keyword">ON</span> p1<span class="token punctuation">.</span>Id <span class="token operator">&lt;</span> p2<span class="token punctuation">.</span>Id
<span class="token keyword">WHERE</span> p1<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">.</span>STDistance<span class="token punctuation">(</span>p2<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">10</span>  <span class="token comment">-- 距離小於10公尺</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="8-空間索引最佳化案例"><a href="#8-空間索引最佳化案例" class="headerlink" title="8. 空間索引最佳化案例"></a>8. 空間索引最佳化案例</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 範例一：使用空間索引的查詢寫法</span>
<span class="token keyword">SELECT</span> p<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span> Points p <span class="token keyword">WITH</span><span class="token punctuation">(</span><span class="token keyword">INDEX</span><span class="token punctuation">(</span>空間索引名稱<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">WHERE</span> 
    p<span class="token punctuation">.</span><span class="token keyword">geometry</span><span class="token punctuation">.</span>STIntersects<span class="token punctuation">(</span>@查詢範圍<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token operator">AND</span> p<span class="token punctuation">.</span><span class="token keyword">Type</span> <span class="token operator">=</span> <span class="token string">'特定類型'</span>

<span class="token comment">-- 範例二：建立空間索引</span>
<span class="token keyword">CREATE</span> SPATIAL <span class="token keyword">INDEX</span> <span class="token punctuation">[</span>空間索引名稱<span class="token punctuation">]</span>
<span class="token keyword">ON</span> Points<span class="token punctuation">(</span><span class="token keyword">geometry</span><span class="token punctuation">)</span>
<span class="token keyword">USING</span> GEOMETRY_GRID
<span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    BOUNDING_BOX <span class="token operator">=</span> <span class="token punctuation">(</span>xmin<span class="token operator">=</span><span class="token number">320000</span><span class="token punctuation">,</span> ymin<span class="token operator">=</span><span class="token number">2720000</span><span class="token punctuation">,</span> xmax<span class="token operator">=</span><span class="token number">340000</span><span class="token punctuation">,</span> ymax<span class="token operator">=</span><span class="token number">2750000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    GRIDS <span class="token operator">=</span> <span class="token punctuation">(</span>LEVEL_1 <span class="token operator">=</span> MEDIUM<span class="token punctuation">,</span> LEVEL_2 <span class="token operator">=</span> MEDIUM<span class="token punctuation">,</span> LEVEL_3 <span class="token operator">=</span> MEDIUM<span class="token punctuation">,</span> LEVEL_4 <span class="token operator">=</span> MEDIUM<span class="token punctuation">)</span><span class="token punctuation">,</span>
    CELLS_PER_OBJECT <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span>
    PAD_INDEX <span class="token operator">=</span> <span class="token keyword">OFF</span><span class="token punctuation">,</span>
    STATISTICS_NORECOMPUTE <span class="token operator">=</span> <span class="token keyword">OFF</span><span class="token punctuation">,</span>
    SORT_IN_TEMPDB <span class="token operator">=</span> <span class="token keyword">OFF</span><span class="token punctuation">,</span>
    DROP_EXISTING <span class="token operator">=</span> <span class="token keyword">OFF</span><span class="token punctuation">,</span>
    ONLINE <span class="token operator">=</span> <span class="token keyword">OFF</span><span class="token punctuation">,</span>
    ALLOW_ROW_LOCKS <span class="token operator">=</span> <span class="token keyword">ON</span><span class="token punctuation">,</span>
    ALLOW_PAGE_LOCKS <span class="token operator">=</span> <span class="token keyword">ON</span>
<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token punctuation">[</span><span class="token keyword">PRIMARY</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="六、效能最佳化建議"><a href="#六、效能最佳化建議" class="headerlink" title="六、效能最佳化建議"></a>六、效能最佳化建議</h2><ol>
<li> 建立適當的空間索引</li>
<li> 優先過濾非空間條件</li>
<li> 避免在大量資料上進行複雜的空間運算</li>
<li> 適當使用 CTE 或子查詢來優化查詢結構</li>
<li> 確保所有幾何物件使用相同的空間參考系統(SRID)</li>
</ol>
<h2 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h2><p>空間查詢方法提供了強大的工具來處理地理資訊數據。透過適當的使用這些方法，我們可以有效地進行空間分析、範圍規劃等作業。在實務應用中，記得考慮效能影響，並選擇最適合的方法來達成目標。</p>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ul>
<li>  <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/sql/relational-databases/spatial/spatial-data-types-overview">Microsoft SQL Server 官方檔案</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/10/27/%E8%B3%87%E6%96%99%E5%BA%AB%E9%80%A3%E7%B7%9A%E6%B1%A0%E7%88%86%E6%8E%89%E6%95%91%E7%81%AB%E7%A7%98%E7%AC%88%EF%BC%81%E5%A6%82%E4%BD%95%E5%84%AA%E9%9B%85%E5%9C%B0%E8%99%95%E7%90%86-SQL-Server-%E9%80%A3%E7%B7%9A%E5%8D%B1%E6%A9%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/27/%E8%B3%87%E6%96%99%E5%BA%AB%E9%80%A3%E7%B7%9A%E6%B1%A0%E7%88%86%E6%8E%89%E6%95%91%E7%81%AB%E7%A7%98%E7%AC%88%EF%BC%81%E5%A6%82%E4%BD%95%E5%84%AA%E9%9B%85%E5%9C%B0%E8%99%95%E7%90%86-SQL-Server-%E9%80%A3%E7%B7%9A%E5%8D%B1%E6%A9%9F/" class="post-title-link" itemprop="url">資料庫連線池爆掉救火秘笈！如何優雅地處理 SQL Server 連線危機</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-10-27 14:30:00" itemprop="dateCreated datePublished" datetime="2024-10-27T14:30:00+08:00">2024-10-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-11-27 15:55:40" itemprop="dateModified" datetime="2024-11-27T15:55:40+08:00">2024-11-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%8C%E7%AB%AF%E9%96%8B%E7%99%BC/" itemprop="url" rel="index"><span itemprop="name">後端開發</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%8C%E7%AB%AF%E9%96%8B%E7%99%BC/%E8%B3%87%E6%96%99%E5%BA%AB%E5%84%AA%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">資料庫優化</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>身為後端工程師，你是否遇過這樣的情況：</p>
<ul>
<li>系統突然變得超級慢</li>
<li>網頁一直轉圈圈</li>
<li>收到「已超過連線逾時的設定」錯誤訊息</li>
</ul>
<p>如果有，恭喜你！你可能遇到了資料庫連線池爆掉的問題。今天就來分享一個真實案例，看看如何從診斷到解決這個棘手的問題。</p>
<h2 id="問題診斷"><a href="#問題診斷" class="headerlink" title="問題診斷"></a>問題診斷</h2><p>當你遇到以下錯誤訊息時，很可能是連線池出問題了：</p>
<pre class="line-numbers language-none"><code class="language-none">System.InvalidOperationException: &#39;已超過連線逾時的設定。在取得集區連線之前超過逾時等待的時間，可能的原因為所有的共用連線已在使用中，並已達共用集區大小的最大值。&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="快速診斷方法"><a href="#快速診斷方法" class="headerlink" title="快速診斷方法"></a>快速診斷方法</h3><p>首先，我們可以使用以下 SQL 指令來查看目前的連線狀況：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 
    DB_NAME<span class="token punctuation">(</span>dbid<span class="token punctuation">)</span> <span class="token keyword">as</span> DatabaseName<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span>dbid<span class="token punctuation">)</span> <span class="token keyword">as</span> NumberOfConnections<span class="token punctuation">,</span>
    loginame <span class="token keyword">as</span> LoginName<span class="token punctuation">,</span>
    <span class="token keyword">status</span><span class="token punctuation">,</span>
    hostname <span class="token keyword">as</span> HostName<span class="token punctuation">,</span>
    program_name <span class="token keyword">as</span> ProgramName
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>sysprocesses
<span class="token keyword">WHERE</span> dbid <span class="token operator">></span> <span class="token number">0</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> dbid<span class="token punctuation">,</span> loginame<span class="token punctuation">,</span> <span class="token keyword">status</span><span class="token punctuation">,</span> hostname<span class="token punctuation">,</span> program_name<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="緊急處理方案"><a href="#緊急處理方案" class="headerlink" title="緊急處理方案"></a>緊急處理方案</h2><p>發現問題後，可以使用以下步驟處理：</p>
<ol>
<li><strong>檢視問題連線</strong><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 1. 首先查看當前的連接詳情</span>
<span class="token keyword">SELECT</span> 
    spid <span class="token keyword">as</span> <span class="token string">'處理序 ID'</span><span class="token punctuation">,</span>
    db_name<span class="token punctuation">(</span>dbid<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'數據庫'</span><span class="token punctuation">,</span>
    loginame <span class="token keyword">as</span> <span class="token string">'登入名稱'</span><span class="token punctuation">,</span>
    hostname <span class="token keyword">as</span> <span class="token string">'主機名'</span><span class="token punctuation">,</span>
    program_name <span class="token keyword">as</span> <span class="token string">'程式名稱'</span><span class="token punctuation">,</span>
    login_time <span class="token keyword">as</span> <span class="token string">'登入時間'</span><span class="token punctuation">,</span>
    last_batch <span class="token keyword">as</span> <span class="token string">'最後執行時間'</span><span class="token punctuation">,</span>
    <span class="token keyword">status</span> <span class="token keyword">as</span> <span class="token string">'狀態'</span>
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>sysprocesses 
<span class="token keyword">WHERE</span> dbid <span class="token operator">=</span> DB_ID<span class="token punctuation">(</span><span class="token string">'資料庫名稱'</span><span class="token punctuation">)</span>  <span class="token comment">-- 替換成你的數據庫名</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> login_time <span class="token keyword">DESC</span><span class="token punctuation">;</span>

<span class="token comment">-- 2. 查看具體在執行什麼 SQL</span>
<span class="token keyword">SELECT</span> 
    spid<span class="token punctuation">,</span>
    blocked <span class="token keyword">as</span> <span class="token string">'被阻塞源'</span><span class="token punctuation">,</span>
    hostname <span class="token keyword">as</span> <span class="token string">'主機名'</span><span class="token punctuation">,</span>
    program_name <span class="token keyword">as</span> <span class="token string">'程式名稱'</span><span class="token punctuation">,</span>
    cmd <span class="token keyword">as</span> <span class="token string">'指令'</span><span class="token punctuation">,</span>
    cpu <span class="token keyword">as</span> <span class="token string">'CPU時間'</span><span class="token punctuation">,</span>
    physical_io <span class="token keyword">as</span> <span class="token string">'實體IO'</span><span class="token punctuation">,</span>
    last_batch <span class="token keyword">as</span> <span class="token string">'最後執行時間'</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token keyword">text</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token string">'SQL內容'</span>
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>sysprocesses sp
<span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_sql_text<span class="token punctuation">(</span>sql_handle<span class="token punctuation">)</span>
<span class="token keyword">WHERE</span> dbid <span class="token operator">=</span> DB_ID<span class="token punctuation">(</span><span class="token string">'資料庫名稱'</span><span class="token punctuation">)</span>  <span class="token comment">-- 替換成你的數據庫名</span>

<span class="token comment">-- 3. 殺掉特定連接 (請小心使用)</span>
<span class="token comment">-- KILL 52;  -- 替換成你要關閉的 SPID</span>

<span class="token comment">-- 4. 如果確定要關閉所有用戶連接，可以使用動態 SQL (需要特別小心)</span>
<span class="token keyword">DECLARE</span> <span class="token variable">@kill</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token variable">@kill</span> <span class="token operator">=</span> <span class="token variable">@kill</span> <span class="token operator">+</span> <span class="token string">'KILL '</span> <span class="token operator">+</span> <span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> spid<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">';'</span>
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>sysprocesses 
<span class="token keyword">WHERE</span> dbid <span class="token operator">=</span> DB_ID<span class="token punctuation">(</span><span class="token string">'資料庫名稱'</span><span class="token punctuation">)</span>  <span class="token comment">-- 替換成你的數據庫名</span>
<span class="token operator">AND</span> spid <span class="token operator">></span> <span class="token number">50</span><span class="token punctuation">;</span>

<span class="token comment">-- 執行前先確認要關閉的連接</span>
<span class="token keyword">PRINT</span> <span class="token variable">@kill</span><span class="token punctuation">;</span>

<span class="token comment">-- 如果確認無誤，則可以執行（請小心使用）</span>
<span class="token comment">-- EXEC(@kill);</span>

<span class="token comment">-- 5. 如果要切換數據庫到單一用戶模式</span>
<span class="token comment">-- 這會強制斷開所有現有連接</span>
<span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> 資料庫名稱
<span class="token keyword">SET</span> SINGLE_USER 
<span class="token keyword">WITH</span> <span class="token keyword">ROLLBACK</span> IMMEDIATE<span class="token punctuation">;</span>

<span class="token comment">-- 完成後切換回多用戶模式</span>
<span class="token comment">-- ALTER DATABASE 資料庫名稱 SET MULTI_USER;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h2 id="代碼優化建議"><a href="#代碼優化建議" class="headerlink" title="代碼優化建議"></a>代碼優化建議</h2><p>這次發生的問題最後定位問題發現是很久以前前人寫的VB程式碼資料庫連接沒有正確的釋放導致的，為了避免類似問題再次發生，對程式碼進行以下優化：</p>
<ol>
<li><p><strong>使用 Using 區塊確保資源釋放</strong></p>
<pre class="line-numbers language-vb.net" data-language="vb.net"><code class="language-vb.net">Using connection As New SqlConnection(connectionString)
    &#39; 資料庫操作
End Using<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
<li><p><strong>避免全域宣告資料庫連線</strong></p>
<pre class="line-numbers language-vb.net" data-language="vb.net"><code class="language-vb.net">&#39; 不建議
Dim conn As New SqlConnection  &#39;全域變數

&#39; 建議
Private Function GetData() As DataTable
    Using conn As New SqlConnection(connectionString)
        &#39; 程式碼
    End Using
End Function<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p><strong>設定適當的連線池參數</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>connectionStrings</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>add</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>MyConnection<span class="token punctuation">"</span></span> 
         <span class="token attr-name">connectionString</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Server=myserver;Database=mydb;
         Max Pool Size=100;Min Pool Size=5;
         Connection Timeout=30;<span class="token punctuation">"</span></span>
         <span class="token attr-name">providerName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>System.Data.SqlClient<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>connectionStrings</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h2 id="預防措施"><a href="#預防措施" class="headerlink" title="預防措施"></a>預防措施</h2><ol>
<li><p><strong>定期監控連線數</strong></p>
<ul>
<li>設置警示機制</li>
<li>監控連線成長趨勢</li>
</ul>
</li>
<li><p><strong>程式碼審查重點</strong></p>
<ul>
<li>確認所有資料庫連線都有正確釋放</li>
<li>避免無限期保持連線</li>
</ul>
</li>
<li><p><strong>效能調校建議</strong></p>
<ul>
<li>適當設定 Max Pool Size</li>
<li>配置合理的 Connection Timeout</li>
<li>實作重試機制</li>
</ul>
</li>
</ol>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>資料庫連線池問題雖然棘手，但只要掌握正確的診斷和處理方法，就能夠優雅地解決。預防永遠勝於治療，建議定期檢查程式碼和監控系統狀態，及早發現潛在問題。</p>
<h2 id="參考資源"><a href="#參考資源" class="headerlink" title="參考資源"></a>參考資源</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sql/connect/ado-net/sql-server-connection-pooling">Microsoft Docs - SQL Server 連線集區</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/connection-pooling">ASP.NET Connection Pooling</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/10/23/%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E6%9F%A5%E8%A9%A2%E8%B3%87%E6%96%99%E5%BA%AB%E6%AA%A2%E8%A6%96%E8%A1%A8(View)%E7%9A%84%E6%AC%84%E4%BD%8D%E8%B3%87%E8%A8%8A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/23/%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E6%9F%A5%E8%A9%A2%E8%B3%87%E6%96%99%E5%BA%AB%E6%AA%A2%E8%A6%96%E8%A1%A8(View)%E7%9A%84%E6%AC%84%E4%BD%8D%E8%B3%87%E8%A8%8A/" class="post-title-link" itemprop="url">如何快速查詢資料庫檢視表(View)的欄位資訊</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-10-23 11:19:17" itemprop="dateCreated datePublished" datetime="2024-10-23T11:19:17+08:00">2024-10-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-11-27 14:42:14" itemprop="dateModified" datetime="2024-11-27T14:42:14+08:00">2024-11-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%A8%8B%E5%BC%8F%E6%95%99%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">程式教學</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="如何快速查詢資料庫檢視表-View-的欄位資訊"><a href="#如何快速查詢資料庫檢視表-View-的欄位資訊" class="headerlink" title="如何快速查詢資料庫檢視表(View)的欄位資訊"></a>如何快速查詢資料庫檢視表(View)的欄位資訊</h1><p>今天遇到長官要求提供所需的資料訊息，因為要求的資料欄位是由多個資料表組合而成時，要一個一個去查看原始資料表相當費時。本文將介紹如何使用 SQL 指令快速查詢檢視表的欄位資訊。</p>
<h2 id="為什麼需要這個查詢？"><a href="#為什麼需要這個查詢？" class="headerlink" title="為什麼需要這個查詢？"></a>為什麼需要這個查詢？</h2><ul>
<li>快速了解檢視表的結構</li>
<li>檢查欄位的資料類型和限制</li>
<li>節省查看原始資料表的時間</li>
<li>方便進行資料庫文件製作</li>
</ul>
<h2 id="各資料庫系統的查詢方式"><a href="#各資料庫系統的查詢方式" class="headerlink" title="各資料庫系統的查詢方式"></a>各資料庫系統的查詢方式</h2><h3 id="Microsoft-SQL-Server"><a href="#Microsoft-SQL-Server" class="headerlink" title="Microsoft SQL Server"></a>Microsoft SQL Server</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 
    c<span class="token punctuation">.</span>name <span class="token keyword">AS</span> ColumnName<span class="token punctuation">,</span>
    t<span class="token punctuation">.</span>name <span class="token keyword">AS</span> DataType<span class="token punctuation">,</span>
    c<span class="token punctuation">.</span>max_length <span class="token keyword">AS</span> MaxLength<span class="token punctuation">,</span>
    c<span class="token punctuation">.</span><span class="token keyword">precision</span> <span class="token keyword">AS</span> NumericPrecision<span class="token punctuation">,</span>
    c<span class="token punctuation">.</span>scale <span class="token keyword">AS</span> NumericScale<span class="token punctuation">,</span>
    c<span class="token punctuation">.</span>is_nullable <span class="token keyword">AS</span> IsNullable<span class="token punctuation">,</span>
    ISNULL<span class="token punctuation">(</span>dc<span class="token punctuation">.</span>definition<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> DefaultValue
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>views v
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span><span class="token keyword">columns</span> c <span class="token keyword">ON</span> v<span class="token punctuation">.</span>object_id <span class="token operator">=</span> c<span class="token punctuation">.</span>object_id
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span><span class="token keyword">types</span> t <span class="token keyword">ON</span> c<span class="token punctuation">.</span>user_type_id <span class="token operator">=</span> t<span class="token punctuation">.</span>user_type_id
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>default_constraints dc <span class="token keyword">ON</span> c<span class="token punctuation">.</span>default_object_id <span class="token operator">=</span> dc<span class="token punctuation">.</span>object_id
<span class="token keyword">WHERE</span> v<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'檢視表名稱'</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> c<span class="token punctuation">.</span>column_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="MySQL-MariaDB"><a href="#MySQL-MariaDB" class="headerlink" title="MySQL/MariaDB"></a>MySQL/MariaDB</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 
    COLUMN_NAME<span class="token punctuation">,</span>
    DATA_TYPE<span class="token punctuation">,</span>
    CHARACTER_MAXIMUM_LENGTH<span class="token punctuation">,</span>
    NUMERIC_PRECISION<span class="token punctuation">,</span>
    NUMERIC_SCALE<span class="token punctuation">,</span>
    IS_NULLABLE<span class="token punctuation">,</span>
    COLUMN_DEFAULT
<span class="token keyword">FROM</span> INFORMATION_SCHEMA<span class="token punctuation">.</span><span class="token keyword">COLUMNS</span>
<span class="token keyword">WHERE</span> TABLE_SCHEMA <span class="token operator">=</span> <span class="token string">'資料庫名稱'</span>
<span class="token operator">AND</span> TABLE_NAME <span class="token operator">=</span> <span class="token string">'檢視表名稱'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Oracle"><a href="#Oracle" class="headerlink" title="Oracle"></a>Oracle</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 
    COLUMN_NAME<span class="token punctuation">,</span>
    DATA_TYPE<span class="token punctuation">,</span>
    DATA_LENGTH<span class="token punctuation">,</span>
    DATA_PRECISION<span class="token punctuation">,</span>
    DATA_SCALE<span class="token punctuation">,</span>
    NULLABLE<span class="token punctuation">,</span>
    DATA_DEFAULT
<span class="token keyword">FROM</span> ALL_TAB_COLUMNS
<span class="token keyword">WHERE</span> TABLE_NAME <span class="token operator">=</span> <span class="token string">'檢視表名稱'</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> COLUMN_ID<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 
    a<span class="token punctuation">.</span>attname <span class="token keyword">AS</span> column_name<span class="token punctuation">,</span>
    pg_catalog<span class="token punctuation">.</span>format_type<span class="token punctuation">(</span>a<span class="token punctuation">.</span>atttypid<span class="token punctuation">,</span> a<span class="token punctuation">.</span>atttypmod<span class="token punctuation">)</span> <span class="token keyword">AS</span> data_type<span class="token punctuation">,</span>
    a<span class="token punctuation">.</span>attnotnull <span class="token keyword">AS</span> is_not_null<span class="token punctuation">,</span>
    pg_catalog<span class="token punctuation">.</span>pg_get_expr<span class="token punctuation">(</span>d<span class="token punctuation">.</span>adbin<span class="token punctuation">,</span> d<span class="token punctuation">.</span>adrelid<span class="token punctuation">)</span> <span class="token keyword">AS</span> default_value
<span class="token keyword">FROM</span> pg_catalog<span class="token punctuation">.</span>pg_attribute a
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> pg_catalog<span class="token punctuation">.</span>pg_attrdef d <span class="token keyword">ON</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>attrelid<span class="token punctuation">,</span> a<span class="token punctuation">.</span>attnum<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span>adrelid<span class="token punctuation">,</span> d<span class="token punctuation">.</span>adnum<span class="token punctuation">)</span>
<span class="token keyword">WHERE</span> a<span class="token punctuation">.</span>attrelid <span class="token operator">=</span> <span class="token string">'檢視表名稱'</span>::regclass
<span class="token operator">AND</span> a<span class="token punctuation">.</span>attnum <span class="token operator">></span> <span class="token number">0</span> 
<span class="token operator">AND</span> <span class="token operator">NOT</span> a<span class="token punctuation">.</span>attisdropped
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> a<span class="token punctuation">.</span>attnum<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="查詢結果說明"><a href="#查詢結果說明" class="headerlink" title="查詢結果說明"></a>查詢結果說明</h2><p>執行上述查詢後，你會得到以下資訊：</p>
<ol>
<li><strong>欄位名稱</strong>（Column Name）：該欄位的名稱</li>
<li><strong>資料型態</strong>（Data Type）：如 varchar、int、decimal 等</li>
<li><strong>最大長度</strong>（Max Length）：文字類型的最大長度</li>
<li><strong>數值精確度</strong>（Numeric Precision）：數值類型的精確度</li>
<li><strong>小數位數</strong>（Numeric Scale）：數值類型的小數位數</li>
<li><strong>是否可為空值</strong>（Is Nullable）：該欄位是否允許 NULL</li>
<li><strong>預設值</strong>（Default Value）：欄位的預設值</li>
</ol>
<h2 id="使用技巧"><a href="#使用技巧" class="headerlink" title="使用技巧"></a>使用技巧</h2><ol>
<li>請根據你使用的資料庫系統選擇對應的查詢語法</li>
<li>將查詢中的「檢視表名稱」替換為你要查詢的檢視表名稱</li>
<li>若使用 MySQL/MariaDB，記得也要替換「資料庫名稱」</li>
<li>查詢結果可以匯出成 Excel 方便記錄</li>
</ol>
<h2 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h2><p>這個查詢方式可以讓我們快速了解檢視表的結構，特別適合處理複雜的檢視表或需要製作資料庫文件時使用。善用這些系統表格查詢，可以大幅提升資料庫管理的效率。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/10/22/SQL-Server-%E5%82%99%E4%BB%BD%E6%AA%94%E6%A1%88%E7%95%B0%E5%B8%B8%E5%A2%9E%E9%95%B7%E7%9A%84%E6%8E%92%E6%9F%A5%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/22/SQL-Server-%E5%82%99%E4%BB%BD%E6%AA%94%E6%A1%88%E7%95%B0%E5%B8%B8%E5%A2%9E%E9%95%B7%E7%9A%84%E6%8E%92%E6%9F%A5%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">SQL Server 備份檔案異常增長的排查指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-10-22 10:11:50" itemprop="dateCreated datePublished" datetime="2024-10-22T10:11:50+08:00">2024-10-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-11-27 14:39:56" itemprop="dateModified" datetime="2024-11-27T14:39:56+08:00">2024-11-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%A8%8B%E5%BC%8F%E6%95%99%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">程式教學</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="SQL-Server-備份檔案異常增長的排查指南"><a href="#SQL-Server-備份檔案異常增長的排查指南" class="headerlink" title="SQL Server 備份檔案異常增長的排查指南"></a>SQL Server 備份檔案異常增長的排查指南</h1><p>在管理 SQL Server 資料庫時，有時會遇到備份檔案大小突然增加的情況。即使資料表中的資料量沒有明顯增長，備份檔案卻莫名變大了好幾 GB，這時該如何進行排查呢？本文將介紹幾個常見的原因和解決方案。</p>
<h2 id="常見原因分析"><a href="#常見原因分析" class="headerlink" title="常見原因分析"></a>常見原因分析</h2><h3 id="1-交易記錄檔（Transaction-Log）過大"><a href="#1-交易記錄檔（Transaction-Log）過大" class="headerlink" title="1. 交易記錄檔（Transaction Log）過大"></a>1. 交易記錄檔（Transaction Log）過大</h3><p>交易記錄檔是記錄資料庫所有異動的檔案，如果沒有定期做記錄檔備份或截斷，可能會導致檔案持續成長。</p>
<p><strong>診斷方式：</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DBCC</span> SQLPERF<span class="token punctuation">(</span>LOGSPACE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>這個指令可以顯示所有資料庫的記錄檔使用狀況。</p>
<h3 id="2-索引碎片化"><a href="#2-索引碎片化" class="headerlink" title="2. 索引碎片化"></a>2. 索引碎片化</h3><p>頻繁的資料異動可能造成索引碎片化，進而影響備份檔案大小。</p>
<p><strong>診斷方式：</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> OBJECT_NAME<span class="token punctuation">(</span>ind<span class="token punctuation">.</span>OBJECT_ID<span class="token punctuation">)</span> <span class="token keyword">AS</span> TableName<span class="token punctuation">,</span> 
       ind<span class="token punctuation">.</span>name <span class="token keyword">AS</span> IndexName<span class="token punctuation">,</span> 
       indexstats<span class="token punctuation">.</span>avg_fragmentation_in_percent
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_db_index_physical_stats<span class="token punctuation">(</span>DB_ID<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span> indexstats
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>indexes ind 
<span class="token keyword">ON</span> ind<span class="token punctuation">.</span>object_id <span class="token operator">=</span> indexstats<span class="token punctuation">.</span>object_id 
<span class="token operator">AND</span> ind<span class="token punctuation">.</span>index_id <span class="token operator">=</span> indexstats<span class="token punctuation">.</span>index_id
<span class="token keyword">WHERE</span> indexstats<span class="token punctuation">.</span>avg_fragmentation_in_percent <span class="token operator">></span> <span class="token number">30</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> indexstats<span class="token punctuation">.</span>avg_fragmentation_in_percent <span class="token keyword">DESC</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此查詢可以找出碎片率超過 30% 的索引。</p>
<h3 id="3-快照隔離層級的版本存儲"><a href="#3-快照隔離層級的版本存儲" class="headerlink" title="3. 快照隔離層級的版本存儲"></a>3. 快照隔離層級的版本存儲</h3><p>如果啟用了 RCSI（Read Committed Snapshot Isolation）或快照隔離，系統會在 tempdb 中保留資料版本，可能導致備份檔案變大。</p>
<h3 id="4-備份壓縮設定"><a href="#4-備份壓縮設定" class="headerlink" title="4. 備份壓縮設定"></a>4. 備份壓縮設定</h3><p>檢查備份是否有啟用壓縮功能。未壓縮的備份檔案會比壓縮後的檔案大上許多。</p>
<h3 id="5-大型物件（LOB）資料異動"><a href="#5-大型物件（LOB）資料異動" class="headerlink" title="5. 大型物件（LOB）資料異動"></a>5. 大型物件（LOB）資料異動</h3><p>異動大型物件資料（如文字、圖片等）時，即使只修改一小部分，在備份時可能也會包含整個物件。</p>
<h2 id="診斷與解決步驟"><a href="#診斷與解決步驟" class="headerlink" title="診斷與解決步驟"></a>診斷與解決步驟</h2><h3 id="Step-1-檢查資料庫完整性"><a href="#Step-1-檢查資料庫完整性" class="headerlink" title="Step 1: 檢查資料庫完整性"></a>Step 1: 檢查資料庫完整性</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DBCC</span> CHECKDB<span class="token punctuation">(</span><span class="token string">'您的資料庫名稱'</span><span class="token punctuation">)</span> <span class="token keyword">WITH</span> NO_INFOMSGS<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="Step-2-檢查資料庫實際使用空間"><a href="#Step-2-檢查資料庫實際使用空間" class="headerlink" title="Step 2: 檢查資料庫實際使用空間"></a>Step 2: 檢查資料庫實際使用空間</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> sp_spaceused<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="Step-3-重建索引並收縮資料庫"><a href="#Step-3-重建索引並收縮資料庫" class="headerlink" title="Step 3: 重建索引並收縮資料庫"></a>Step 3: 重建索引並收縮資料庫</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 重建所有索引</span>
<span class="token keyword">EXEC</span> sp_MSforeachtable <span class="token variable">@command1</span><span class="token operator">=</span><span class="token string">"print '?' DBCC DBREINDEX ('?', ' ', 80)"</span>
GO

<span class="token comment">-- 收縮資料庫</span>
<span class="token keyword">DBCC</span> SHRINKDATABASE <span class="token punctuation">(</span>N<span class="token string">'您的資料庫名稱'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Step-4-檢查各資料表的大小與記錄數"><a href="#Step-4-檢查各資料表的大小與記錄數" class="headerlink" title="Step 4: 檢查各資料表的大小與記錄數"></a>Step 4: 檢查各資料表的大小與記錄數</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 
    t<span class="token punctuation">.</span>NAME <span class="token keyword">AS</span> TableName<span class="token punctuation">,</span>
    s<span class="token punctuation">.</span>Name <span class="token keyword">AS</span> SchemaName<span class="token punctuation">,</span>
    p<span class="token punctuation">.</span><span class="token keyword">rows</span> <span class="token keyword">AS</span> RowCounts<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>total_pages<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token keyword">AS</span> TotalSpaceKB<span class="token punctuation">,</span> 
    <span class="token function">SUM</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>used_pages<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token keyword">AS</span> UsedSpaceKB<span class="token punctuation">,</span> 
    <span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>total_pages<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">SUM</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>used_pages<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token keyword">AS</span> UnusedSpaceKB
<span class="token keyword">FROM</span> 
    sys<span class="token punctuation">.</span><span class="token keyword">tables</span> t
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span>      
    sys<span class="token punctuation">.</span>indexes i <span class="token keyword">ON</span> t<span class="token punctuation">.</span>OBJECT_ID <span class="token operator">=</span> i<span class="token punctuation">.</span>object_id
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> 
    sys<span class="token punctuation">.</span>partitions p <span class="token keyword">ON</span> i<span class="token punctuation">.</span>object_id <span class="token operator">=</span> p<span class="token punctuation">.</span>OBJECT_ID <span class="token operator">AND</span> i<span class="token punctuation">.</span>index_id <span class="token operator">=</span> p<span class="token punctuation">.</span>index_id
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> 
    sys<span class="token punctuation">.</span>allocation_units a <span class="token keyword">ON</span> p<span class="token punctuation">.</span>partition_id <span class="token operator">=</span> a<span class="token punctuation">.</span>container_id
<span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> 
    sys<span class="token punctuation">.</span>schemas s <span class="token keyword">ON</span> t<span class="token punctuation">.</span>schema_id <span class="token operator">=</span> s<span class="token punctuation">.</span>schema_id
<span class="token keyword">WHERE</span> 
    t<span class="token punctuation">.</span>NAME <span class="token operator">NOT</span> <span class="token operator">LIKE</span> <span class="token string">'dt%'</span> 
    <span class="token operator">AND</span> t<span class="token punctuation">.</span>is_ms_shipped <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token operator">AND</span> i<span class="token punctuation">.</span>OBJECT_ID <span class="token operator">></span> <span class="token number">255</span> 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> 
    t<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> s<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> p<span class="token punctuation">.</span><span class="token keyword">Rows</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 
    TotalSpaceKB <span class="token keyword">DESC</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>Name<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="預防措施"><a href="#預防措施" class="headerlink" title="預防措施"></a>預防措施</h2><ol>
<li><p><strong>定期維護索引</strong></p>
<ul>
<li>定期重建或重組碎片率高的索引</li>
<li>檢查不常使用的索引，考慮是否需要保留</li>
</ul>
</li>
<li><p><strong>適當的備份策略</strong></p>
<ul>
<li>規劃完整備份的頻率</li>
<li>實施交易記錄備份機制</li>
<li>適時清理過期的備份檔案</li>
</ul>
</li>
<li><p><strong>監控資料庫成長</strong></p>
<ul>
<li>定期檢查資料庫和記錄檔的大小</li>
<li>設置警示機制，當檔案超過預期大小時通知管理員</li>
</ul>
</li>
<li><p><strong>最佳化資料庫設定</strong></p>
<ul>
<li>適當配置自動成長設定</li>
<li>根據需求調整復原模式</li>
<li>考慮是否需要啟用壓縮功能</li>
</ul>
</li>
</ol>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>遇到 SQL Server 備份檔案異常增長的情況時，不要驚慌。依照本文提供的步驟逐一檢查，通常都能找出問題的根源。建議將這些檢查步驟納入日常維護程序中，可以及早發現並解決潛在的問題。</p>
<p>記住，預防勝於治療，建立良好的資料庫維護習慣，可以避免許多效能和空間的問題。如果執行這些步驟後仍無法解決問題，建議尋求專業的資料庫管理人員協助，進行更深入的診斷。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/10/19/%E5%AF%A6%E4%BD%9C%E9%9B%B6%E4%BF%A1%E4%BB%BB%E6%9E%B6%E6%A7%8B%E7%9A%84-.NET-Core-Web-API-%E6%95%99%E5%AD%B8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/19/%E5%AF%A6%E4%BD%9C%E9%9B%B6%E4%BF%A1%E4%BB%BB%E6%9E%B6%E6%A7%8B%E7%9A%84-.NET-Core-Web-API-%E6%95%99%E5%AD%B8/" class="post-title-link" itemprop="url">實作零信任架構的 .NET Core Web API 教學</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-10-19 14:30:24" itemprop="dateCreated datePublished" datetime="2024-10-19T14:30:24+08:00">2024-10-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-11-27 14:50:20" itemprop="dateModified" datetime="2024-11-27T14:50:20+08:00">2024-11-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%A8%8B%E5%BC%8F%E6%95%99%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">程式教學</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="實作零信任架構的-NET-Core-Web-API-教學"><a href="#實作零信任架構的-NET-Core-Web-API-教學" class="headerlink" title="實作零信任架構的 .NET Core Web API 教學"></a>實作零信任架構的 .NET Core Web API 教學</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在現代應用程式開發中，安全性是一個不能忽視的重要議題。零信任（Zero Trust）安全模型提供了一個「永不信任，始終驗證」的架構方針，特別適合用於建構安全的 Web API。本文將詳細說明如何在 .NET Core Web API 中實作零信任架構。</p>
<h2 id="零信任架構核心概念"><a href="#零信任架構核心概念" class="headerlink" title="零信任架構核心概念"></a>零信任架構核心概念</h2><p>零信任架構建立在以下幾個核心原則上：</p>
<ol>
<li>永遠驗證 - 對每個請求都進行身分驗證</li>
<li>最小權限 - 只給予必要的存取權限</li>
<li>假設破壞 - 假設網路環境已被入侵</li>
<li>全程加密 - 所有通訊都需要加密</li>
<li>持續監控 - 記錄與分析所有活動</li>
</ol>
<h2 id="專案設定"><a href="#專案設定" class="headerlink" title="專案設定"></a>專案設定</h2><p>首先建立一個新的 .NET Core Web API 專案：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">dotnet new webapi <span class="token parameter variable">-n</span> ZeroTrustApi
<span class="token builtin class-name">cd</span> ZeroTrustApi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="安裝必要的-NuGet-套件："><a href="#安裝必要的-NuGet-套件：" class="headerlink" title="安裝必要的 NuGet 套件："></a>安裝必要的 NuGet 套件：</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">dotnet <span class="token function">add</span> package Microsoft.AspNetCore.Authentication.JwtBearer
dotnet <span class="token function">add</span> package Microsoft.AspNetCore.Identity.EntityFrameworkCore
dotnet <span class="token function">add</span> package Microsoft.EntityFrameworkCore.SqlServer
dotnet <span class="token function">add</span> package AspNetCoreRateLimit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="API檔案與安全測試"><a href="#API檔案與安全測試" class="headerlink" title="API檔案與安全測試"></a>API檔案與安全測試</h2><h3 id="1-Swagger-檔案設定"><a href="#1-Swagger-檔案設定" class="headerlink" title="1. Swagger 檔案設定"></a>1. Swagger 檔案設定</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddEndpointsApiExplorer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddSwaggerGen</span><span class="token punctuation">(</span>c <span class="token operator">=></span>
<span class="token punctuation">&#123;</span>
    c<span class="token punctuation">.</span><span class="token function">SwaggerDoc</span><span class="token punctuation">(</span><span class="token string">"v1"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiInfo</span> 
    <span class="token punctuation">&#123;</span> 
        Title <span class="token operator">=</span> <span class="token string">"Zero Trust API"</span><span class="token punctuation">,</span> 
        Version <span class="token operator">=</span> <span class="token string">"v1"</span><span class="token punctuation">,</span>
        Description <span class="token operator">=</span> <span class="token string">"實作零信任架構的 Web API"</span><span class="token punctuation">,</span>
        Contact <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiContact</span>
        <span class="token punctuation">&#123;</span>
            Name <span class="token operator">=</span> <span class="token string">"Your Name"</span><span class="token punctuation">,</span>
            Email <span class="token operator">=</span> <span class="token string">"your.email@domain.com"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// JWT 驗證設定</span>
    c<span class="token punctuation">.</span><span class="token function">AddSecurityDefinition</span><span class="token punctuation">(</span><span class="token string">"Bearer"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityScheme</span>
    <span class="token punctuation">&#123;</span>
        Type <span class="token operator">=</span> SecuritySchemeType<span class="token punctuation">.</span>Http<span class="token punctuation">,</span>
        Scheme <span class="token operator">=</span> <span class="token string">"bearer"</span><span class="token punctuation">,</span>
        BearerFormat <span class="token operator">=</span> <span class="token string">"JWT"</span><span class="token punctuation">,</span>
        Description <span class="token operator">=</span> <span class="token string">"請在下方輸入 JWT Token"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    c<span class="token punctuation">.</span><span class="token function">AddSecurityRequirement</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityRequirement</span>
    <span class="token punctuation">&#123;</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityScheme</span>
            <span class="token punctuation">&#123;</span>
                Reference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiReference</span> 
                <span class="token punctuation">&#123;</span> 
                    Type <span class="token operator">=</span> ReferenceType<span class="token punctuation">.</span>SecurityScheme<span class="token punctuation">,</span>
                    Id <span class="token operator">=</span> <span class="token string">"Bearer"</span> 
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            Array<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Empty</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-單元測試設定"><a href="#2-單元測試設定" class="headerlink" title="2. 單元測試設定"></a>2. 單元測試設定</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// SecureControllerTests.cs</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecureControllerTests</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">SecureController</span> _controller<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Mock<span class="token punctuation">&lt;</span>ILogger<span class="token punctuation">&lt;</span>SecureController<span class="token punctuation">></span><span class="token punctuation">></span></span> _loggerMock<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">SecureControllerTests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _loggerMock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Mock<span class="token punctuation">&lt;</span>ILogger<span class="token punctuation">&lt;</span>SecureController<span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SecureController</span><span class="token punctuation">(</span>_loggerMock<span class="token punctuation">.</span>Object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 模擬使用者身份</span>
        <span class="token class-name"><span class="token keyword">var</span></span> claims <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token string">"testuser"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>Role<span class="token punctuation">,</span> <span class="token string">"Admin"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> identity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ClaimsIdentity</span><span class="token punctuation">(</span>claims<span class="token punctuation">,</span> <span class="token string">"Test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> claimsPrincipal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ClaimsPrincipal</span><span class="token punctuation">(</span>identity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        _controller<span class="token punctuation">.</span>ControllerContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ControllerContext</span>
        <span class="token punctuation">&#123;</span>
            HttpContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DefaultHttpContext</span> 
            <span class="token punctuation">&#123;</span> 
                User <span class="token operator">=</span> claimsPrincipal 
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Fact</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Get_AuthenticatedUser_ReturnsOkResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// Arrange</span>
        
        <span class="token comment">// Act</span>
        <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _controller<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Assert</span>
        Assert<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">IsType</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OkObjectResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="實作身分驗證"><a href="#實作身分驗證" class="headerlink" title="實作身分驗證"></a>實作身分驗證</h2><h3 id="1-JWT-認證設定"><a href="#1-JWT-認證設定" class="headerlink" title="1. JWT 認證設定"></a>1. JWT 認證設定</h3><p>在 <code>Program.cs</code> 中加入 JWT 認證：</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddJwtBearer</span><span class="token punctuation">(</span>options <span class="token operator">=></span>
    <span class="token punctuation">&#123;</span>
        options<span class="token punctuation">.</span>TokenValidationParameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TokenValidationParameters</span>
        <span class="token punctuation">&#123;</span>
            ValidateIssuer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            ValidateAudience <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            ValidateLifetime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            ValidateIssuerSigningKey <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            ValidIssuer <span class="token operator">=</span> builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">[</span><span class="token string">"Jwt:Issuer"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            ValidAudience <span class="token operator">=</span> builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">[</span><span class="token string">"Jwt:Audience"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

            <span class="token comment">// Token 存活時間設定</span>
            ClockSkew <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span>Zero<span class="token punctuation">,</span>  <span class="token comment">// 避免時間偏差</span>
            RequireExpirationTime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            ValidateLifetime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            
            <span class="token comment">// Token 加密金鑰設定</span>
            IssuerSigningKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>
                Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">[</span><span class="token string">"Jwt:Key"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            TokenDecryptionKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>
                Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">[</span><span class="token string">"Jwt:EncryptionKey"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
               <span class="token comment">// Token 過期事件處理</span>
        options<span class="token punctuation">.</span>Events <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtBearerEvents</span>
        <span class="token punctuation">&#123;</span>
            OnAuthenticationFailed <span class="token operator">=</span> context <span class="token operator">=></span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>Exception<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">SecurityTokenExpiredException</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Token-Expired"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-使用者身分模型"><a href="#2-使用者身分模型" class="headerlink" title="2. 使用者身分模型"></a>2. 使用者身分模型</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationUser</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IdentityUser</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> FirstName <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> LastName <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> LastLoginTime <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-資料庫上下文"><a href="#3-資料庫上下文" class="headerlink" title="3. 資料庫上下文"></a>3. 資料庫上下文</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationDbContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IdentityDbContext<span class="token punctuation">&lt;</span>ApplicationUser<span class="token punctuation">></span></span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token function">ApplicationDbContext</span><span class="token punctuation">(</span><span class="token class-name">DbContextOptions<span class="token punctuation">&lt;</span>ApplicationDbContext<span class="token punctuation">></span></span> options<span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="API-存取控制"><a href="#API-存取控制" class="headerlink" title="API 存取控制"></a>API 存取控制</h2><h3 id="1-實作請求限流"><a href="#1-實作請求限流" class="headerlink" title="1. 實作請求限流"></a>1. 實作請求限流</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Configure</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IpRateLimitOptions<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"IpRateLimit"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IIpPolicyStore<span class="token punctuation">,</span> MemoryCacheIpPolicyStore<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IRateLimitCounterStore<span class="token punctuation">,</span> MemoryCacheRateLimitCounterStore<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="2-自訂授權政策"><a href="#2-自訂授權政策" class="headerlink" title="2. 自訂授權政策"></a>2. 自訂授權政策</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAuthorization</span><span class="token punctuation">(</span>options <span class="token operator">=></span>
<span class="token punctuation">&#123;</span>
    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"RequireAdminRole"</span><span class="token punctuation">,</span> policy <span class="token operator">=></span> 
        policy<span class="token punctuation">.</span><span class="token function">RequireRole</span><span class="token punctuation">(</span><span class="token string">"Admin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"RequireApiAccess"</span><span class="token punctuation">,</span> policy <span class="token operator">=></span>
        policy<span class="token punctuation">.</span><span class="token function">RequireClaim</span><span class="token punctuation">(</span><span class="token string">"scope"</span><span class="token punctuation">,</span> <span class="token string">"api_access"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="API-端點安全性"><a href="#API-端點安全性" class="headerlink" title="API 端點安全性"></a>API 端點安全性</h2><h3 id="1-安全的控制器範例"><a href="#1-安全的控制器範例" class="headerlink" title="1. 安全的控制器範例"></a>1. 安全的控制器範例</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api/[controller]"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecureController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>SecureController<span class="token punctuation">></span></span> _logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">SecureController</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&lt;</span>SecureController<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ProducesResponseType</span><span class="token attribute-arguments"><span class="token punctuation">(</span>StatusCodes<span class="token punctuation">.</span>Status200OK<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ProducesResponseType</span><span class="token attribute-arguments"><span class="token punctuation">(</span>StatusCodes<span class="token punctuation">.</span>Status401Unauthorized<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IActionResult<span class="token punctuation">></span></span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// 記錄存取</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span>
                <span class="token string">"Access attempt by user &#123;User&#125; at &#123;Time&#125;"</span><span class="token punctuation">,</span> 
                User<span class="token punctuation">.</span>Identity<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> 
                DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 驗證請求的其他屬性</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ValidateRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token function">Unauthorized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// 回傳資料</span>
            <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">&#123;</span> message <span class="token operator">=</span> <span class="token string">"Secure data"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token string">"Error occurred while processing request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">StatusCode</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">ValidateRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 實作額外的請求驗證邏輯</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-全域錯誤處理中介軟體"><a href="#2-全域錯誤處理中介軟體" class="headerlink" title="2. 全域錯誤處理中介軟體"></a>2. 全域錯誤處理中介軟體</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityHeadersMiddleware</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">RequestDelegate</span> _next<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">SecurityHeadersMiddleware</span><span class="token punctuation">(</span><span class="token class-name">RequestDelegate</span> next<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _next <span class="token operator">=</span> next<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 加入安全標頭</span>
        context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"X-Frame-Options"</span><span class="token punctuation">,</span> <span class="token string">"DENY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"X-Content-Type-Options"</span><span class="token punctuation">,</span> <span class="token string">"nosniff"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"X-XSS-Protection"</span><span class="token punctuation">,</span> <span class="token string">"1; mode=block"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Referrer-Policy"</span><span class="token punctuation">,</span> <span class="token string">"strict-origin-when-cross-origin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Content-Security-Policy"</span><span class="token punctuation">,</span> 
            <span class="token string">"default-src 'self'; script-src 'self'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> <span class="token function">_next</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="加密與安全通訊"><a href="#加密與安全通訊" class="headerlink" title="加密與安全通訊"></a>加密與安全通訊</h2><h3 id="1-HTTPS-設定"><a href="#1-HTTPS-設定" class="headerlink" title="1. HTTPS 設定"></a>1. HTTPS 設定</h3><p>在 <code>Program.cs</code> 中加入：</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token class-name"><span class="token keyword">var</span></span> app <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">UseHttpsRedirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">UseHsts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-敏感資料加密服務"><a href="#2-敏感資料加密服務" class="headerlink" title="2. 敏感資料加密服務"></a>2. 敏感資料加密服務</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IEncryptionService</span>
<span class="token punctuation">&#123;</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">Encrypt</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> plainText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">Decrypt</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> cipherText<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 注意: 在生產環境中，應該為每次加密操作產生新的 IV</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EncryptionService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IEncryptionService</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">string</span></span> _key<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">string</span></span> _iv<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">EncryptionService</span><span class="token punctuation">(</span><span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _key <span class="token operator">=</span> configuration<span class="token punctuation">[</span><span class="token string">"Encryption:Key"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        _iv <span class="token operator">=</span> configuration<span class="token punctuation">[</span><span class="token string">"Encryption:IV"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">Encrypt</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> plainText<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">Aes</span> aes <span class="token operator">=</span> Aes<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            aes<span class="token punctuation">.</span>Key <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>_key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            aes<span class="token punctuation">.</span>IV <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>_iv<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">ICryptoTransform</span> encryptor <span class="token operator">=</span> aes<span class="token punctuation">.</span><span class="token function">CreateEncryptor</span><span class="token punctuation">(</span>aes<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> aes<span class="token punctuation">.</span>IV<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">MemoryStream</span> msEncrypt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MemoryStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">CryptoStream</span> csEncrypt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CryptoStream</span><span class="token punctuation">(</span>
                    msEncrypt<span class="token punctuation">,</span> encryptor<span class="token punctuation">,</span> CryptoStreamMode<span class="token punctuation">.</span>Write<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">StreamWriter</span> swEncrypt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StreamWriter</span><span class="token punctuation">(</span>csEncrypt<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    swEncrypt<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>plainText<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                <span class="token keyword">return</span> Convert<span class="token punctuation">.</span><span class="token function">ToBase64String</span><span class="token punctuation">(</span>msEncrypt<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">Decrypt</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> cipherText<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 實作解密邏輯</span>
        <span class="token keyword">return</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="日誌記錄與監控"><a href="#日誌記錄與監控" class="headerlink" title="日誌記錄與監控"></a>日誌記錄與監控</h2><h3 id="1-設定結構化日誌"><a href="#1-設定結構化日誌" class="headerlink" title="1. 設定結構化日誌"></a>1. 設定結構化日誌</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp">builder<span class="token punctuation">.</span>Logging<span class="token punctuation">.</span><span class="token function">ClearProviders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Logging<span class="token punctuation">.</span><span class="token function">AddConsole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Logging<span class="token punctuation">.</span><span class="token function">AddDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Logging<span class="token punctuation">.</span><span class="token function">AddEventLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 加入 Serilog</span>
builder<span class="token punctuation">.</span>Logging<span class="token punctuation">.</span><span class="token function">AddSerilog</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">LoggerConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>WriteTo<span class="token punctuation">.</span><span class="token function">File</span><span class="token punctuation">(</span><span class="token string">"logs/api-.txt"</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">rollingInterval</span><span class="token punctuation">:</span> RollingInterval<span class="token punctuation">.</span>Day<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">CreateLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-稽核日誌中介軟體"><a href="#2-稽核日誌中介軟體" class="headerlink" title="2. 稽核日誌中介軟體"></a>2. 稽核日誌中介軟體</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuditLoggingMiddleware</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">RequestDelegate</span> _next<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger</span> _logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">AuditLoggingMiddleware</span><span class="token punctuation">(</span>
        <span class="token class-name">RequestDelegate</span> next<span class="token punctuation">,</span>
        <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>AuditLoggingMiddleware<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _next <span class="token operator">=</span> next<span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> auditLog <span class="token operator">=</span> <span class="token keyword">new</span>
        <span class="token punctuation">&#123;</span>
            Timestamp <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span>
            RequestPath <span class="token operator">=</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Path<span class="token punctuation">,</span>
            RequestMethod <span class="token operator">=</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Method<span class="token punctuation">,</span>
            UserAgent <span class="token operator">=</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Headers<span class="token punctuation">[</span><span class="token string">"User-Agent"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            UserIp <span class="token operator">=</span> context<span class="token punctuation">.</span>Connection<span class="token punctuation">.</span>RemoteIpAddress<span class="token punctuation">?.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            UserId <span class="token operator">=</span> context<span class="token punctuation">.</span>User<span class="token punctuation">.</span>Identity<span class="token punctuation">?.</span>Name
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span>
            <span class="token string">"API Request: &#123;@AuditLog&#125;"</span><span class="token punctuation">,</span> auditLog<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> <span class="token function">_next</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="跨域資源共用-CORS-設定"><a href="#跨域資源共用-CORS-設定" class="headerlink" title="跨域資源共用(CORS)設定"></a>跨域資源共用(CORS)設定</h2><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddCors</span><span class="token punctuation">(</span>options <span class="token operator">=></span>
<span class="token punctuation">&#123;</span>
    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"SecurePolicy"</span><span class="token punctuation">,</span> policy <span class="token operator">=></span>
    <span class="token punctuation">&#123;</span>
        policy
            <span class="token punctuation">.</span><span class="token function">WithOrigins</span><span class="token punctuation">(</span>
                <span class="token comment">// 設定允許的來源網域</span>
                <span class="token string">"https://yourdomain.com"</span><span class="token punctuation">,</span>
                <span class="token string">"https://api.yourdomain.com"</span>
            <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">WithMethods</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">,</span> <span class="token string">"PUT"</span><span class="token punctuation">,</span> <span class="token string">"DELETE"</span><span class="token punctuation">)</span>  <span class="token comment">// 允許的 HTTP 方法</span>
            <span class="token punctuation">.</span><span class="token function">WithHeaders</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">,</span> <span class="token string">"Content-Type"</span><span class="token punctuation">)</span>  <span class="token comment">// 允許的標頭</span>
            <span class="token punctuation">.</span><span class="token function">AllowCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 允許認證資訊</span>
            <span class="token punctuation">.</span><span class="token function">SetPreflightMaxAge</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 預檢請求快取時間</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 在 Program.cs 中啟用 CORS</span>
app<span class="token punctuation">.</span><span class="token function">UseCors</span><span class="token punctuation">(</span><span class="token string">"SecurePolicy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="健康檢查設定"><a href="#健康檢查設定" class="headerlink" title="健康檢查設定"></a>健康檢查設定</h2><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// 註冊健康檢查服務</span>
<span class="token comment">// DiskSpaceHealthCheck 和 CustomHealthCheck 僅為示範用途</span>
<span class="token comment">// 實際使用時應根據專案需求實作完整的檢查邏輯</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddHealthChecks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddDbContextCheck</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ApplicationDbContext<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 檢查資料庫連線</span>
    <span class="token punctuation">.</span><span class="token function">AddUrlGroup</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span><span class="token string">"https://dependent-service.com/health"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 檢查相依服務</span>
    <span class="token punctuation">.</span><span class="token function">AddCheck</span><span class="token punctuation">(</span><span class="token string">"DiskSpace"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DiskSpaceHealthCheck</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 自訂檢查</span>
    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddCheck</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CustomHealthCheck<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token string">"Custom"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 自訂健康檢查邏輯</span>

<span class="token comment">// 自訂健康檢查邏輯</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomHealthCheck</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHealthCheck</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>HealthCheckResult<span class="token punctuation">></span></span> <span class="token function">CheckHealthAsync</span><span class="token punctuation">(</span>
        <span class="token class-name">HealthCheckContext</span> context<span class="token punctuation">,</span> 
        <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// 執行健康檢查邏輯</span>
            <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span>HealthCheckResult<span class="token punctuation">.</span><span class="token function">Healthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span>
                HealthCheckResult<span class="token punctuation">.</span><span class="token function">Unhealthy</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 在 Program.cs 中設定健康檢查端點</span>
app<span class="token punctuation">.</span><span class="token function">MapHealthChecks</span><span class="token punctuation">(</span><span class="token string">"/health"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HealthCheckOptions</span>
<span class="token punctuation">&#123;</span>
    ResponseWriter <span class="token operator">=</span> UIResponseWriter<span class="token punctuation">.</span>WriteHealthCheckUIResponse
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="容器化與部署"><a href="#容器化與部署" class="headerlink" title="容器化與部署"></a>容器化與部署</h2><h3 id="1-Docker-設定"><a href="#1-Docker-設定" class="headerlink" title="1. Docker 設定"></a>1. Docker 設定</h3><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> mcr.microsoft.com/dotnet/aspnet:7.0 <span class="token keyword">AS</span> base</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 80</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 443</span>

<span class="token instruction"><span class="token keyword">FROM</span> mcr.microsoft.com/dotnet/sdk:7.0 <span class="token keyword">AS</span> build</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /src</span>
<span class="token instruction"><span class="token keyword">COPY</span> [<span class="token string">"ZeroTrustApi.csproj"</span>, <span class="token string">"./"</span>]</span>
<span class="token instruction"><span class="token keyword">RUN</span> dotnet restore <span class="token string">"ZeroTrustApi.csproj"</span></span>
<span class="token instruction"><span class="token keyword">COPY</span> . .</span>
<span class="token instruction"><span class="token keyword">RUN</span> dotnet build <span class="token string">"ZeroTrustApi.csproj"</span> -c Release -o /app/build</span>

<span class="token instruction"><span class="token keyword">FROM</span> build <span class="token keyword">AS</span> publish</span>
<span class="token instruction"><span class="token keyword">RUN</span> dotnet publish <span class="token string">"ZeroTrustApi.csproj"</span> -c Release -o /app/publish</span>

<span class="token instruction"><span class="token keyword">FROM</span> base <span class="token keyword">AS</span> final</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">publish</span></span> /app/publish .</span>
<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">"dotnet"</span>, <span class="token string">"ZeroTrustApi.dll"</span>]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-CI-CD-Pipeline-GitHub-Actions"><a href="#2-CI-CD-Pipeline-GitHub-Actions" class="headerlink" title="2. CI/CD Pipeline (GitHub Actions)"></a>2. CI/CD Pipeline (GitHub Actions)</h3><h1 id="這是基本範例，實際使用時應該根據部署環境需求調整設定"><a href="#這是基本範例，實際使用時應該根據部署環境需求調整設定" class="headerlink" title="這是基本範例，實際使用時應該根據部署環境需求調整設定"></a>這是基本範例，實際使用時應該根據部署環境需求調整設定</h1><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">name</span><span class="token punctuation">:</span> .NET Core CI/CD

<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> main <span class="token punctuation">]</span>
  <span class="token key atrule">pull_request</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> main <span class="token punctuation">]</span>

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">build-and-test</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Setup .NET Core
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>dotnet@v1
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">dotnet-version</span><span class="token punctuation">:</span> <span class="token string">'7.0.x'</span>
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Restore dependencies
      <span class="token key atrule">run</span><span class="token punctuation">:</span> dotnet restore
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build
      <span class="token key atrule">run</span><span class="token punctuation">:</span> dotnet build <span class="token punctuation">-</span><span class="token punctuation">-</span>configuration Release <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>restore
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Test
      <span class="token key atrule">run</span><span class="token punctuation">:</span> dotnet test <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>restore <span class="token punctuation">-</span><span class="token punctuation">-</span>verbosity normal
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Publish
      <span class="token key atrule">run</span><span class="token punctuation">:</span> dotnet publish <span class="token punctuation">-</span>c Release <span class="token punctuation">-</span>o published
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build and push Docker image
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/build<span class="token punctuation">-</span>push<span class="token punctuation">-</span>action@v2
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">context</span><span class="token punctuation">:</span> .
        <span class="token key atrule">push</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> yourdockerrepo/zerotrust<span class="token punctuation">-</span>api<span class="token punctuation">:</span>latest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="APM-與監控"><a href="#APM-與監控" class="headerlink" title="APM 與監控"></a>APM 與監控</h2><h3 id="1-Application-Insights-設定"><a href="#1-Application-Insights-設定" class="headerlink" title="1. Application Insights 設定"></a>1. Application Insights 設定</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// 在 Program.cs 中加入</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddApplicationInsightsTelemetry</span><span class="token punctuation">(</span>options <span class="token operator">=></span> 
<span class="token punctuation">&#123;</span>
    options<span class="token punctuation">.</span>ConnectionString <span class="token operator">=</span> builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">[</span><span class="token string">"ApplicationInsights:ConnectionString"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>EnableAdaptiveSampling <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// 在開發環境建議關閉</span>
    options<span class="token punctuation">.</span>EnableDebugLogger <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 自訂遙測</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomTelemetryInitializer</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ITelemetryInitializer</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token class-name">ITelemetry</span> telemetry<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        telemetry<span class="token punctuation">.</span>Context<span class="token punctuation">.</span>Cloud<span class="token punctuation">.</span>RoleName <span class="token operator">=</span> <span class="token string">"ZeroTrustApi"</span><span class="token punctuation">;</span>
        telemetry<span class="token punctuation">.</span>Context<span class="token punctuation">.</span>Cloud<span class="token punctuation">.</span>RoleInstance <span class="token operator">=</span> Environment<span class="token punctuation">.</span>MachineName<span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>telemetry <span class="token keyword">is</span> <span class="token class-name">RequestTelemetry</span> request<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            request<span class="token punctuation">.</span>Properties<span class="token punctuation">[</span><span class="token string">"CustomProperty"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"CustomValue"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-效能監控"><a href="#2-效能監控" class="headerlink" title="2. 效能監控"></a>2. 效能監控</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PerformanceMonitoringMiddleware</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">RequestDelegate</span> _next<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger</span> _logger<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">TelemetryClient</span> _telemetryClient<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">PerformanceMonitoringMiddleware</span><span class="token punctuation">(</span>
        <span class="token class-name">RequestDelegate</span> next<span class="token punctuation">,</span>
        <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>PerformanceMonitoringMiddleware<span class="token punctuation">></span></span> logger<span class="token punctuation">,</span>
        <span class="token class-name">TelemetryClient</span> telemetryClient<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _next <span class="token operator">=</span> next<span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
        _telemetryClient <span class="token operator">=</span> telemetryClient<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> sw <span class="token operator">=</span> Stopwatch<span class="token punctuation">.</span><span class="token function">StartNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">try</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">await</span> <span class="token function">_next</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">finally</span>
        <span class="token punctuation">&#123;</span>
            sw<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> elapsed <span class="token operator">=</span> sw<span class="token punctuation">.</span>ElapsedMilliseconds<span class="token punctuation">;</span>
            
            <span class="token comment">// 記錄執行時間</span>
            _telemetryClient<span class="token punctuation">.</span><span class="token function">TrackMetric</span><span class="token punctuation">(</span>
                <span class="token string">"RequestDuration"</span><span class="token punctuation">,</span>
                elapsed<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span>
                <span class="token punctuation">&#123;</span>
                    <span class="token punctuation">&#123;</span><span class="token string">"Path"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Path<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                    <span class="token punctuation">&#123;</span><span class="token string">"Method"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Method<span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 如果執行時間超過閾值，記錄警告</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>elapsed <span class="token operator">></span> <span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                _logger<span class="token punctuation">.</span><span class="token function">LogWarning</span><span class="token punctuation">(</span>
                    <span class="token string">"Long running request: &#123;Path&#125; took &#123;Elapsed&#125;ms"</span><span class="token punctuation">,</span>
                    context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Path<span class="token punctuation">,</span>
                    elapsed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="最佳實踐建議"><a href="#最佳實踐建議" class="headerlink" title="最佳實踐建議"></a>最佳實踐建議</h2><ol>
<li><p><strong>定期更新套件</strong>：</p>
<ul>
<li>使用 <code>dotnet list package --vulnerable</code> 檢查漏洞</li>
<li>設定自動化更新提醒</li>
</ul>
</li>
<li><p><strong>設定檔管理</strong>：</p>
<ul>
<li>使用 Azure Key Vault 或其他安全的祕密管理服務</li>
<li>不要在程式碼中硬編碼任何祕密</li>
</ul>
</li>
<li><p><strong>API 版本控制</strong>：</p>
<ul>
<li>實作 API 版本管理</li>
<li>提供版本降級機制</li>
</ul>
</li>
<li><p><strong>效能與安全性平衡</strong>：</p>
<ul>
<li>實作快取機制</li>
<li>使用適當的請求限流設定</li>
</ul>
</li>
<li><p><strong>持續監控</strong>：</p>
<ul>
<li>設定警報機制</li>
<li>定期審查日誌</li>
<li>進行安全性掃描</li>
</ul>
</li>
<li><p><strong>災難復原計畫</strong>：</p>
<ul>
<li>  定期備份資料庫和設定檔</li>
<li>  建立自動化還原程序</li>
<li>  設定異地備援機制</li>
<li>  進行定期的災難復原演練</li>
</ul>
</li>
<li><p> <strong>API 限流設定範例</strong>：</p>
</li>
</ol>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Configure</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IpRateLimitOptions<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>options <span class="token operator">=></span>
<span class="token punctuation">&#123;</span>
    options<span class="token punctuation">.</span>GeneralRules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>RateLimitRule<span class="token punctuation">></span></span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RateLimitRule</span>
        <span class="token punctuation">&#123;</span>
            Endpoint <span class="token operator">=</span> <span class="token string">"*"</span><span class="token punctuation">,</span>  <span class="token comment">// 適用所有端點</span>
            Period <span class="token operator">=</span> <span class="token string">"1m"</span><span class="token punctuation">,</span>   <span class="token comment">// 時間區間</span>
            Limit <span class="token operator">=</span> <span class="token number">30</span>       <span class="token comment">// 請求數限制</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RateLimitRule</span>
        <span class="token punctuation">&#123;</span>
            Endpoint <span class="token operator">=</span> <span class="token string">"*"</span><span class="token punctuation">,</span>
            Period <span class="token operator">=</span> <span class="token string">"1h"</span><span class="token punctuation">,</span>
            Limit <span class="token operator">=</span> <span class="token number">500</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="8">
<li> <strong>密碼雜湊設定</strong>：</li>
</ol>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Configure</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IdentityOptions<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>options <span class="token operator">=></span>
<span class="token punctuation">&#123;</span>
    options<span class="token punctuation">.</span>Password<span class="token punctuation">.</span>RequireDigit <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>Password<span class="token punctuation">.</span>RequiredLength <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>Password<span class="token punctuation">.</span>RequireNonAlphanumeric <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>Password<span class="token punctuation">.</span>RequireUppercase <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>Password<span class="token punctuation">.</span>RequireLowercase <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 密碼雜湊設定</span>
    options<span class="token punctuation">.</span>Password<span class="token punctuation">.</span>HasherOptions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PasswordHasherOptions</span>
    <span class="token punctuation">&#123;</span>
        IterationCount <span class="token operator">=</span> <span class="token number">100000</span>  <span class="token comment">// PBKDF2 迭代次數</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>實作零信任架構需要全面性的考量，從身分驗證、授權、加密到監控都需要謹慎規劃。本文提供的範例程式碼和建議可作為建置安全 API 的起點，但記住安全是一個持續進行的過程，需要定期檢視和更新。</p>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ref>
* [ASP.NET Core 安全性文件](https://docs.microsoft.com/zh-tw/aspnet/core/security/)
* [OWASP Top 10 API Security Risks](https://owasp.org/www-project-api-security/)
* [Microsoft Identity Platform](https://docs.microsoft.com/zh-tw/azure/active-directory/develop/)
* [ASP.NET Core 應用程式監控](https://docs.microsoft.com/zh-tw/azure/azure-monitor/app/asp-net-core) 
* [Docker 容器化最佳實踐](https://docs.docker.com/develop/develop-images/dockerfile\_best-practices/) 
* [.NET Core 中的密碼雜湊](https://docs.microsoft.com/zh-tw/aspnet/core/security/data-protection/consumer-apis/password-hashing)
</ref>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/10/17/HTMX%EF%BC%9A%E7%B6%B2%E9%A0%81%E9%96%8B%E7%99%BC%E7%9A%84%E5%84%AA%E9%9B%85%E5%9B%9E%E6%AD%B8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/17/HTMX%EF%BC%9A%E7%B6%B2%E9%A0%81%E9%96%8B%E7%99%BC%E7%9A%84%E5%84%AA%E9%9B%85%E5%9B%9E%E6%AD%B8/" class="post-title-link" itemprop="url">HTMX：網頁開發的優雅回歸</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-10-17 16:13:15" itemprop="dateCreated datePublished" datetime="2024-10-17T16:13:15+08:00">2024-10-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-11-27 14:54:54" itemprop="dateModified" datetime="2024-11-27T14:54:54+08:00">2024-11-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%A8%8B%E5%BC%8F%E6%95%99%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">程式教學</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HTMX：網頁開發的優雅回歸"><a href="#HTMX：網頁開發的優雅回歸" class="headerlink" title="HTMX：網頁開發的優雅回歸"></a>HTMX：網頁開發的優雅回歸</h1><p>在這幾年的網頁開發生態中，我們看到一個有趣的現象：HTMX 這類強調後端渲染的技術框架逐漸受到歡迎。這個趨勢某種程度上打破了過去「前後端分離」的主流思維，值得我們深入探討。</p>
<h2 id="前後端分離時代的挑戰"><a href="#前後端分離時代的挑戰" class="headerlink" title="前後端分離時代的挑戰"></a>前後端分離時代的挑戰</h2><p>過去幾年，前後端分離的開發模式一直是主流。這種架構確實帶來許多好處：</p>
<ul>
<li>前端團隊可以專注在使用者體驗</li>
<li>後端專注在商業邏輯與資料處理</li>
<li>API 可以服務多種客戶端</li>
<li>更容易做到水平擴展</li>
</ul>
<p>但隨著時間推移，開發者也逐漸體會到這種架構的一些痛點：</p>
<ul>
<li>需要維護兩個獨立的程式碼庫</li>
<li>狀態管理變得複雜</li>
<li>開發門檻提高</li>
<li>建置與部署流程變得繁瑣</li>
<li>效能優化需要更多心力</li>
</ul>
<h2 id="HTMX：簡單而強大"><a href="#HTMX：簡單而強大" class="headerlink" title="HTMX：簡單而強大"></a>HTMX：簡單而強大</h2><p>HTMX 提供了一個更簡單的解決方案。它讓我們能夠直接在 HTML 中使用屬性來處理互動，而不需要寫大量的 JavaScript 程式碼。</p>
<h3 id="基本語法示例："><a href="#基本語法示例：" class="headerlink" title="基本語法示例："></a>基本語法示例：</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">hx-post</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/submit<span class="token punctuation">"</span></span> 
        <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#result<span class="token punctuation">"</span></span>
        <span class="token attr-name">hx-swap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>outerHTML<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  送出
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這段程式碼就能處理 AJAX 請求、更新 DOM，還有動態內容載入，簡單明瞭。</p>
<h3 id="HTMX-的主要優勢："><a href="#HTMX-的主要優勢：" class="headerlink" title="HTMX 的主要優勢："></a>HTMX 的主要優勢：</h3><ol>
<li><p><strong>開發效率</strong></p>
<ul>
<li>減少重複的程式碼</li>
<li>更快的開發週期</li>
<li>較低的維護成本</li>
</ul>
</li>
<li><p><strong>效能表現</strong></p>
<ul>
<li>較小的前端資源大小</li>
<li>更快的初始載入時間</li>
<li>較低的記憶體使用量</li>
</ul>
</li>
<li><p><strong>學習曲線</strong></p>
<ul>
<li>容易上手</li>
<li>熟悉 HTML 的開發者可以快速適應</li>
<li>不需要學習複雜的前端框架</li>
</ul>
</li>
</ol>
<h2 id="為什麼現在開始流行？"><a href="#為什麼現在開始流行？" class="headerlink" title="為什麼現在開始流行？"></a>為什麼現在開始流行？</h2><p>這個轉變反映了幾個重要的趨勢：</p>
<ol>
<li><p><strong>複雜度疲勞</strong></p>
<ul>
<li>開發者開始尋找更簡單的解決方案</li>
<li>不是每個專案都需要完整的 SPA 架構</li>
<li>對於較小型的專案，全端分離可能是過度設計</li>
</ul>
</li>
<li><p><strong>效能意識</strong></p>
<ul>
<li>使用者對網站效能的要求提高</li>
<li>行動裝置用戶增加，對載入速度更敏感</li>
<li>搜尋引擎對效能的重視</li>
</ul>
</li>
<li><p><strong>實用主義的回歸</strong></p>
<ul>
<li>開發者開始重視實際需求而非追求潮流</li>
<li>尋找最適合專案的技術，而非最新的技術</li>
<li>重視開發效率與維護性</li>
</ul>
</li>
</ol>
<h2 id="適合的使用場景"><a href="#適合的使用場景" class="headerlink" title="適合的使用場景"></a>適合的使用場景</h2><p>HTMX 特別適合：</p>
<ul>
<li>內部管理系統</li>
<li>資料導向的應用程式</li>
<li>需要快速開發的專案</li>
<li>較小型的網站</li>
<li>需要 SEO 優化的網站</li>
</ul>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>HTMX 的興起並不意味著前後端分離架構就此沒落，而是提供了另一種選擇。對於許多專案來說，這可能是一個更務實的解決方案。重點在於選擇適合專案需求的技術，而不是盲目追隨趨勢。</p>
<p>在評估是否採用 HTMX 時，建議考慮：</p>
<ul>
<li>專案的規模與複雜度</li>
<li>團隊的技術能力</li>
<li>開發時程</li>
<li>效能需求</li>
<li>維護成本</li>
</ul>
<p>最後，這個技術趨勢提醒我們：有時候，更簡單的解決方案可能才是更好的選擇。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/10/02/Visual-Studio-ReSharper-%E6%93%B4%E5%85%85%E5%A5%97%E4%BB%B6%E5%AE%8C%E6%95%B4%E4%BB%8B%E7%B4%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/02/Visual-Studio-ReSharper-%E6%93%B4%E5%85%85%E5%A5%97%E4%BB%B6%E5%AE%8C%E6%95%B4%E4%BB%8B%E7%B4%B9/" class="post-title-link" itemprop="url">Visual Studio ReSharper 擴充套件完整介紹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-10-02 18:59:10" itemprop="dateCreated datePublished" datetime="2024-10-02T18:59:10+08:00">2024-10-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-11-27 14:40:34" itemprop="dateModified" datetime="2024-11-27T14:40:34+08:00">2024-11-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%96%8B%E7%99%BC%E7%9B%B8%E9%97%9C/" itemprop="url" rel="index"><span itemprop="name">開發相關</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Visual-Studio-ReSharper-擴充套件完整介紹"><a href="#Visual-Studio-ReSharper-擴充套件完整介紹" class="headerlink" title="Visual Studio ReSharper 擴充套件完整介紹"></a>Visual Studio ReSharper 擴充套件完整介紹</h1><p>在 Visual Studio 的眾多擴充套件中，ReSharper 可說是最受歡迎的生產力工具之一。本文將詳細介紹 ReSharper 的主要功能，讓你的開發效率更上一層樓！</p>
<h2 id="什麼是-ReSharper？"><a href="#什麼是-ReSharper？" class="headerlink" title="什麼是 ReSharper？"></a>什麼是 ReSharper？</h2><p>ReSharper 是由 JetBrains 公司開發的 Visual Studio 擴充套件，專門用於提升 .NET 開發人員的生產力。它提供了強大的程式碼分析、重構工具和智慧提示功能。</p>
<h2 id="主要功能介紹"><a href="#主要功能介紹" class="headerlink" title="主要功能介紹"></a>主要功能介紹</h2><h3 id="1-即時程式碼分析"><a href="#1-即時程式碼分析" class="headerlink" title="1. 即時程式碼分析"></a>1. 即時程式碼分析</h3><ul>
<li>自動偵測潛在問題和效能瓶頸</li>
<li>提供最佳實踐建議</li>
<li>突顯未使用的程式碼和多餘的參照</li>
<li>即時檢查命名規則符合性</li>
</ul>
<h3 id="2-強大的重構工具"><a href="#2-強大的重構工具" class="headerlink" title="2. 強大的重構工具"></a>2. 強大的重構工具</h3><ul>
<li>變數重命名（支援跨檔案）</li>
<li>方法提取與內嵌</li>
<li>介面提取</li>
<li>程式碼移動與重組</li>
<li>自動產生建構函式、屬性等樣板程式碼</li>
</ul>
<h3 id="3-導覽增強"><a href="#3-導覽增強" class="headerlink" title="3. 導覽增強"></a>3. 導覽增強</h3><ul>
<li>快速搜尋任何內容（Alt+`)</li>
<li>跳至宣告/實作</li>
<li>找出所有參照</li>
<li>檔案結構視圖</li>
<li>繼承階層檢視</li>
</ul>
<h3 id="4-程式碼產生與樣板"><a href="#4-程式碼產生與樣板" class="headerlink" title="4. 程式碼產生與樣板"></a>4. 程式碼產生與樣板</h3><ul>
<li>自動完成常用程式碼片段</li>
<li>客製化程式碼樣板</li>
<li>單元測試產生器</li>
<li>建構函式參數包裝器</li>
</ul>
<h3 id="5-語言支援"><a href="#5-語言支援" class="headerlink" title="5. 語言支援"></a>5. 語言支援</h3><ul>
<li>C#</li>
<li>VB.NET</li>
<li>TypeScript/JavaScript</li>
<li>HTML/CSS</li>
<li>XAML</li>
<li>ASP.NET</li>
<li>ASP.NET Core</li>
</ul>
<h2 id="實用快速鍵"><a href="#實用快速鍵" class="headerlink" title="實用快速鍵"></a>實用快速鍵</h2><p>以下是一些最常用的快速鍵：</p>
<table>
<thead>
<tr>
<th>功能</th>
<th>快速鍵</th>
</tr>
</thead>
<tbody><tr>
<td>快速修正建議</td>
<td>Alt+Enter</td>
</tr>
<tr>
<td>重構選單</td>
<td>Ctrl+Shift+R</td>
</tr>
<tr>
<td>快速搜尋</td>
<td>Alt+`</td>
</tr>
<tr>
<td>前往任何內容</td>
<td>Ctrl+T</td>
</tr>
<tr>
<td>尋找用法</td>
<td>Alt+F7</td>
</tr>
</tbody></table>
<h2 id="安裝方式"><a href="#安裝方式" class="headerlink" title="安裝方式"></a>安裝方式</h2><ol>
<li>開啟 Visual Studio</li>
<li>點選「工具」&gt;「擴充功能和更新」</li>
<li>搜尋 “ReSharper”</li>
<li>點選下載並安裝</li>
<li>重新啟動 Visual Studio</li>
</ol>
<h2 id="授權選擇"><a href="#授權選擇" class="headerlink" title="授權選擇"></a>授權選擇</h2><p>ReSharper 提供多種授權方案：</p>
<ol>
<li><p><strong>個人授權</strong></p>
<ul>
<li>適合個人開發者</li>
<li>可在多台電腦上使用</li>
<li>提供月付或年付選項</li>
</ul>
</li>
<li><p><strong>商業授權</strong></p>
<ul>
<li>適合公司團隊使用</li>
<li>提供團隊版本控管</li>
<li>包含技術支援服務</li>
</ul>
</li>
<li><p><strong>試用版</strong></p>
<ul>
<li>提供 30 天免費試用</li>
<li>功能完全開放</li>
<li>無須信用卡資訊</li>
</ul>
</li>
</ol>
<h2 id="效能考量"><a href="#效能考量" class="headerlink" title="效能考量"></a>效能考量</h2><p>雖然 ReSharper 功能強大，但也需要注意一些使用上的考量：</p>
<ol>
<li><p><strong>記憶體使用</strong></p>
<ul>
<li>ReSharper 會佔用較多系統資源</li>
<li>建議電腦配備至少 16GB RAM</li>
<li>大型專案可能需要更多資源</li>
</ul>
</li>
<li><p><strong>解決方案大小</strong></p>
<ul>
<li>專案越大，初次載入時間越長</li>
<li>建議使用 SSD 以提升效能</li>
<li>可考慮只載入需要的專案</li>
</ul>
</li>
</ol>
<h2 id="使用技巧"><a href="#使用技巧" class="headerlink" title="使用技巧"></a>使用技巧</h2><ol>
<li><p><strong>善用 Solution-Wide Analysis</strong></p>
<ul>
<li>可即時檢查整個方案的問題</li>
<li>適合在 code review 前執行</li>
<li>可找出跨專案的相依性問題</li>
</ul>
</li>
<li><p><strong>客製化程式碼樣式</strong></p>
<ul>
<li>設定符合團隊的編碼規範</li>
<li>統一格式化規則</li>
<li>自動執行程式碼清理</li>
</ul>
</li>
<li><p><strong>整合版本控制</strong></p>
<ul>
<li>支援 Git 操作整合</li>
<li>顯示程式碼變更記錄</li>
<li>衝突解決輔助</li>
</ul>
</li>
</ol>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>ReSharper 是一個功能非常完整的開發工具，雖然需要付費使用，但其提供的生產力提升絕對值得投資。對於經常使用 Visual Studio 進行 .NET 開發的開發者來說，ReSharper 幾乎是必備的工具之一。</p>
<p>透過本文的介紹，相信讀者們已經對 ReSharper 有了基本的認識。建議可以先使用試用版本體驗看看，若覺得適合再購買授權。記得善用快速鍵和自動化功能，讓開發工作更加順暢！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/09/27/SQL%E5%84%AA%E5%8C%96%EF%BC%9A%E8%99%95%E7%90%86%E7%99%BE%E8%90%AC%E7%B4%9A%E8%B3%87%E6%96%99%E8%A1%A8%E7%9A%84%E7%B5%90%E6%A7%8B%E4%BF%AE%E6%94%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/27/SQL%E5%84%AA%E5%8C%96%EF%BC%9A%E8%99%95%E7%90%86%E7%99%BE%E8%90%AC%E7%B4%9A%E8%B3%87%E6%96%99%E8%A1%A8%E7%9A%84%E7%B5%90%E6%A7%8B%E4%BF%AE%E6%94%B9/" class="post-title-link" itemprop="url">SQL優化：處理百萬級資料表的結構修改</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-09-27 09:51:14" itemprop="dateCreated datePublished" datetime="2024-09-27T09:51:14+08:00">2024-09-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-11-27 14:39:06" itemprop="dateModified" datetime="2024-11-27T14:39:06+08:00">2024-11-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%A8%8B%E5%BC%8F%E6%95%99%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">程式教學</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="SQL優化：處理千萬級資料表的結構修改"><a href="#SQL優化：處理千萬級資料表的結構修改" class="headerlink" title="SQL優化：處理千萬級資料表的結構修改"></a>SQL優化：處理千萬級資料表的結構修改</h1><p>在資料庫管理中，當我們面對龐大的資料表時，進行結構修改常常會遇到效能問題。本文將探討如何處理一個資料量達到千萬級別的資料表，並在不造成系統超時的情況下完成結構修改。</p>
<h2 id="問題背景"><a href="#問題背景" class="headerlink" title="問題背景"></a>問題背景</h2><p>當資料表的記錄數量達到千萬級別時，直接執行 <code>ALTER TABLE</code> 指令可能會導致操作超時，影響系統的正常運作。這是因為 MySQL 在執行 <code>ALTER TABLE</code> 時，會鎖定整個資料表，導致其他查詢無法進行，同時也會消耗大量系統資源。</p>
<h2 id="解決方案"><a href="#解決方案" class="headerlink" title="解決方案"></a>解決方案</h2><p>為了解決這個問題，我們可以採用一種漸進式的方法來修改資料表結構。這個方法主要包含以下步驟：</p>
<ol>
<li>建立一個具有新結構的空資料表</li>
<li>複製原始資料到新資料表</li>
<li>重命名資料表</li>
<li>清理舊資料表</li>
</ol>
<p>讓我們來看看具體的 SQL 實現：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 步驟 1：建立新的資料表結構</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> new_table <span class="token operator">LIKE</span> original_table<span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> new_table <span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> new_column <span class="token keyword">INT</span><span class="token punctuation">;</span>

<span class="token comment">-- 步驟 2：分批複製資料</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> new_table 
<span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span> 
<span class="token keyword">FROM</span> original_table 
<span class="token keyword">WHERE</span> id <span class="token operator">></span> <span class="token variable">@last_id</span> 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> id 
<span class="token keyword">LIMIT</span> <span class="token number">10000</span><span class="token punctuation">;</span>

<span class="token comment">-- 步驟 3：重命名資料表</span>
<span class="token keyword">RENAME</span> <span class="token keyword">TABLE</span> original_table <span class="token keyword">TO</span> old_table<span class="token punctuation">,</span> new_table <span class="token keyword">TO</span> original_table<span class="token punctuation">;</span>

<span class="token comment">-- 步驟 4：刪除舊的資料表</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> old_table<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="詳細解說"><a href="#詳細解說" class="headerlink" title="詳細解說"></a>詳細解說</h2><h3 id="步驟-1：建立新的資料表結構"><a href="#步驟-1：建立新的資料表結構" class="headerlink" title="步驟 1：建立新的資料表結構"></a>步驟 1：建立新的資料表結構</h3><p>首先，我們建立一個與原始資料表結構相同的新資料表，然後加入我們想要的新欄位。這樣可以確保新資料表的結構與原始資料表一致，同時包含了我們需要的修改。</p>
<h3 id="步驟-2：分批複製資料"><a href="#步驟-2：分批複製資料" class="headerlink" title="步驟 2：分批複製資料"></a>步驟 2：分批複製資料</h3><p>這是整個過程中最關鍵的步驟。我們使用一個迴圈（這裡沒有顯示迴圈結構），每次複製一小部分資料到新的資料表中。<code>@last_id</code> 是一個變數，用來記錄上一次複製的最後一筆資料的 ID。每次迴圈都會更新這個變數，確保下一次複製時能夠接著上次的進度繼續。</p>
<p><code>LIMIT 10000</code> 限制了每次複製的記錄數量，這個數字可以根據系統的效能和需求進行調整。較小的數值會增加迴圈次數但減少每次操作的負擔，較大的數值則相反。</p>
<h3 id="步驟-3：重命名資料表"><a href="#步驟-3：重命名資料表" class="headerlink" title="步驟 3：重命名資料表"></a>步驟 3：重命名資料表</h3><p>當所有資料都複製完成後，我們使用 <code>RENAME TABLE</code> 指令來交換新舊資料表的名稱。這個操作幾乎是瞬時完成的，不會對系統造成太大負擔。</p>
<h3 id="步驟-4：刪除舊的資料表"><a href="#步驟-4：刪除舊的資料表" class="headerlink" title="步驟 4：刪除舊的資料表"></a>步驟 4：刪除舊的資料表</h3><p>最後，我們可以安全地刪除舊的資料表，釋放儲存空間。</p>
<h2 id="優點"><a href="#優點" class="headerlink" title="優點"></a>優點</h2><ol>
<li>減少系統負擔：通過分批處理，避免了一次性操作大量數據造成的系統負擔。</li>
<li>不影響正常業務：在複製過程中，原始資料表仍然可以正常使用，不會影響日常操作。</li>
<li>安全性高：如果在過程中出現問題，可以隨時中斷操作，不會影響原有數據。</li>
<li>彈性大：可以根據系統負載調整每次處理的數據量，找到最佳平衡點。</li>
</ol>
<h2 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h2><ol>
<li>在執行這個過程時，需要確保有足夠的磁碟空間來存儲額外的資料表。</li>
<li>整個過程可能需要較長時間，建議在系統負載較低的時候進行。</li>
<li>在複製過程中，如果原始資料表有新的寫入操作，可能需要額外的機制來同步這些新數據。</li>
</ol>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>通過這種方法，我們成功地在不影響系統正常運作的情況下，完成了對大型資料表的結構修改。這種技巧不僅適用於新增欄位，也可以應用在其他類型的結構修改上。在處理大型資料庫時，採用這種漸進式的方法可以大大提高操作的安全性和效率。</p>
<h2 id="SQL實戰實現"><a href="#SQL實戰實現" class="headerlink" title="SQL實戰實現"></a>SQL實戰實現</h2><pre class="line-numbers language-SQL" data-language="SQL"><code class="language-SQL">-- 步驟 1: 刪除現有的新表格（如果存在）
IF OBJECT_ID(&#39;WaterLevelGaugeHistory_New&#39;, &#39;U&#39;) IS NOT NULL
    DROP TABLE WaterLevelGaugeHistory_New;

-- 步驟 2: 重新創建新表格，記得將 ID 設置為 IDENTITY
CREATE TABLE WaterLevelGaugeHistory_New (
    ID int IDENTITY(1,1) NOT NULL,
    stt_no nvarchar(50) NULL,
    dev_id nvarchar(50) NULL,
    measure_time datetime NULL,
    upload_time nvarchar(50) NULL,
    val decimal(10, 3) NULL,
    Voltage decimal(10, 3) NULL,
    Power nvarchar(10) NULL,
    DataLogPeriod nvarchar(50) NULL,
    Status int NULL,
    flood_season int NULL,
    cstatus nvarchar(2) NULL,
    nodata bit NULL,
    StationClass int NULL,
    CONSTRAINT PK_WaterLevelGaugeHistory_New PRIMARY KEY CLUSTERED (ID)
);

-- 步驟 3: 創建一個用於跟蹤進度的臨時表格
CREATE TABLE #ProcessedRows (
    BatchID INT IDENTITY(1,1) PRIMARY KEY,
    LastProcessedID INT,
    RowsProcessed INT,
    ProcessedTime DATETIME DEFAULT GETDATE()
);

-- 步驟 4: 分批複製數據
DECLARE @BatchSize INT &#x3D; 50000; -- 減小批次大小
DECLARE @LastProcessedID INT &#x3D; 0;
DECLARE @RowsAffected INT;
DECLARE @TotalRowsProcessed INT &#x3D; 0;
DECLARE @TotalRowsOld INT;
DECLARE @TotalRowsNew INT;
DECLARE @StartTime DATETIME &#x3D; GETDATE();

-- 獲取原表的總行數
SELECT @TotalRowsOld &#x3D; COUNT(*) FROM WaterLevelGaugeHistory;

WHILE @LastProcessedID IS NOT NULL
BEGIN
    BEGIN TRY
        BEGIN TRANSACTION;
        
        -- 插入一批數據到新表格
        INSERT INTO WaterLevelGaugeHistory_New (
            stt_no, dev_id, measure_time, upload_time, val, Voltage, Power, 
            DataLogPeriod, Status, flood_season, cstatus, nodata, StationClass
        )
        SELECT TOP (@BatchSize)
            stt_no, dev_id, measure_time, upload_time, val, Voltage, Power, 
            DataLogPeriod, Status, 0 AS flood_season, cstatus, nodata, StationClass
        FROM WaterLevelGaugeHistory
        WHERE ID &gt; @LastProcessedID
        ORDER BY ID;

        SET @RowsAffected &#x3D; @@ROWCOUNT;
        SET @TotalRowsProcessed &#x3D; @TotalRowsProcessed + @RowsAffected;

        -- 更新最後處理的 ID
        IF @RowsAffected &gt; 0
        BEGIN
            SELECT @LastProcessedID &#x3D; MAX(ID)
            FROM WaterLevelGaugeHistory
            WHERE ID &gt; @LastProcessedID AND ID &lt;&#x3D; @LastProcessedID + @BatchSize;
            
            -- 記錄進度
            INSERT INTO #ProcessedRows (LastProcessedID, RowsProcessed)
            VALUES (@LastProcessedID, @RowsAffected);
        END
        ELSE
        BEGIN
            SET @LastProcessedID &#x3D; NULL; -- 結束循環
        END

        COMMIT TRANSACTION;

        -- 輸出進度
        PRINT &#39;Processed &#39; + CAST(@RowsAffected AS NVARCHAR(10)) + &#39; rows. Last ID: &#39; + ISNULL(CAST(@LastProcessedID AS NVARCHAR(20)), &#39;NULL&#39;) + 
              &#39;. Total Processed: &#39; + CAST(@TotalRowsProcessed AS NVARCHAR(20)) + 
              &#39;. Elapsed Time: &#39; + CAST(DATEDIFF(SECOND, @StartTime, GETDATE()) AS NVARCHAR(10)) + &#39; seconds&#39;;

         -- 可選：新增一個小的延遲以減少資源使用
        WAITFOR DELAY &#39;00:00:00.1&#39;;
    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT &gt; 0
            ROLLBACK TRANSACTION;

        PRINT &#39;Error occurred: &#39; + ERROR_MESSAGE();
        PRINT &#39;Error Line: &#39; + CAST(ERROR_LINE() AS NVARCHAR(10));
        PRINT &#39;Last processed ID: &#39; + ISNULL(CAST(@LastProcessedID AS NVARCHAR(20)), &#39;NULL&#39;);

        -- 繼續下一個批次，而不是退出循環
        SET @LastProcessedID &#x3D; ISNULL(@LastProcessedID + 1, 0);
    END CATCH
END

-- 步驟 5: 驗證數據驗證數據
SELECT @TotalRowsNew &#x3D; COUNT(*) FROM WaterLevelGaugeHistory_New;

IF @TotalRowsOld &#x3D; @TotalRowsNew
BEGIN
    -- 步驟 6: 重新命名表格
    EXEC sp_rename &#39;WaterLevelGaugeHistory&#39;, &#39;WaterLevelGaugeHistory_Old&#39;;
    EXEC sp_rename &#39;WaterLevelGaugeHistory_New&#39;, &#39;WaterLevelGaugeHistory&#39;;
    
    -- 步驟 7: 刪除舊表格（可選，取決於您的需求）
    -- DROP TABLE WaterLevelGaugeHistory_Old
    
    PRINT &#39;表格更新成功完成。&#39;;
    PRINT &#39;總行數: &#39; + CAST(@TotalRowsNew AS NVARCHAR(20));
END
ELSE
BEGIN
    PRINT &#39;數據驗證失敗，請檢查並重試。&#39;;
    PRINT &#39;原表行數: &#39; + CAST(@TotalRowsOld AS NVARCHAR(20));
    PRINT &#39;新表行數: &#39; + CAST(@TotalRowsNew AS NVARCHAR(20));
    PRINT &#39;處理的行數: &#39; + CAST(@TotalRowsProcessed AS NVARCHAR(20));
    
    -- 輸出進度詳情，幫助診斷問題
    SELECT TOP 100 * FROM #ProcessedRows ORDER BY BatchID DESC;
END

-- 清理
DROP TABLE #ProcessedRows;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/09/26/%E4%BD%BF%E7%94%A8-Python-%E5%92%8C-FFmpeg-%E6%89%93%E9%80%A0%E7%B0%A1%E6%98%93%E8%A6%96%E9%A0%BB%E8%BD%89%E6%8F%9B%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/26/%E4%BD%BF%E7%94%A8-Python-%E5%92%8C-FFmpeg-%E6%89%93%E9%80%A0%E7%B0%A1%E6%98%93%E8%A6%96%E9%A0%BB%E8%BD%89%E6%8F%9B%E5%99%A8/" class="post-title-link" itemprop="url">使用 Python 和 FFmpeg 打造簡易視頻轉換器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-09-26 17:56:07" itemprop="dateCreated datePublished" datetime="2024-09-26T17:56:07+08:00">2024-09-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-11-27 14:15:10" itemprop="dateModified" datetime="2024-11-27T14:15:10+08:00">2024-11-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%A8%8B%E5%BC%8F%E9%96%8B%E7%99%BC/" itemprop="url" rel="index"><span itemprop="name">程式開發</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="使用-Python-和-FFmpeg-打造簡易視頻轉換器"><a href="#使用-Python-和-FFmpeg-打造簡易視頻轉換器" class="headerlink" title="使用 Python 和 FFmpeg 打造簡易視頻轉換器"></a>使用 Python 和 FFmpeg 打造簡易視頻轉換器</h1><p>今天我要跟各位分享一個有趣的小專案 - 使用 Python 和 FFmpeg 製作的簡易視頻轉換器。這個應用程式不僅實用，還能讓我們學習到如何結合 Python 的圖形使用者介面（GUI）與強大的視頻處理工具。</p>
<h2 id="專案概述"><a href="#專案概述" class="headerlink" title="專案概述"></a>專案概述</h2><p><img src="20240926060101745.png"><br>這個視頻轉換器具有以下特點：</p>
<ol>
<li>簡潔的圖形使用者介面</li>
<li>可以選擇輸入檔案和指定輸出檔案</li>
<li>使用 FFmpeg 進行視頻轉換</li>
<li>顯示轉換狀態和錯誤訊息</li>
</ol>
<h2 id="使用的技術"><a href="#使用的技術" class="headerlink" title="使用的技術"></a>使用的技術</h2><ul>
<li>Python：程式的主要語言</li>
<li>tkinter：Python 的標準 GUI 函式庫</li>
<li>ffmpeg-python：FFmpeg 的 Python 綁定，用於視頻處理</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 導入必要的模組</span>
<span class="token keyword">import</span> ffmpeg  <span class="token comment"># 用於處理視頻轉換</span>
<span class="token keyword">import</span> tkinter <span class="token keyword">as</span> tk  <span class="token comment"># 用於創建圖形使用者介面 (GUI)</span>
<span class="token keyword">from</span> tkinter <span class="token keyword">import</span> filedialog<span class="token punctuation">,</span> messagebox  <span class="token comment"># 用於檔案選擇和顯示訊息框</span>

<span class="token comment"># 定義選擇檔案的函數</span>
<span class="token keyword">def</span> <span class="token function">select_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 開啟檔案選擇對話框</span>
    filename <span class="token operator">=</span> filedialog<span class="token punctuation">.</span>askopenfilename<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 清除輸入框的現有內容</span>
    input_entry<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> tk<span class="token punctuation">.</span>END<span class="token punctuation">)</span>
    <span class="token comment"># 將選擇的檔案路徑插入輸入框</span>
    input_entry<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>

<span class="token comment"># 定義視頻轉換的函數</span>
<span class="token keyword">def</span> <span class="token function">convert_video</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 獲取輸入和輸出檔案路徑</span>
    input_file <span class="token operator">=</span> input_entry<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
    output_file <span class="token operator">=</span> output_entry<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 讀取輸入檔案</span>
        stream <span class="token operator">=</span> ffmpeg<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span>input_file<span class="token punctuation">)</span>
        <span class="token comment"># 設置輸出參數（這裡使用預設參數）</span>
        stream <span class="token operator">=</span> ffmpeg<span class="token punctuation">.</span>output<span class="token punctuation">(</span>stream<span class="token punctuation">,</span> output_file<span class="token punctuation">)</span>
        <span class="token comment"># 執行 FFmpeg 指令</span>
        ffmpeg<span class="token punctuation">.</span>run<span class="token punctuation">(</span>stream<span class="token punctuation">)</span>
        <span class="token comment"># 更新狀態標籤，顯示成功訊息</span>
        status_label<span class="token punctuation">.</span>config<span class="token punctuation">(</span>text<span class="token operator">=</span><span class="token string">"轉換成功!"</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> ffmpeg<span class="token punctuation">.</span>Error <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token comment"># 如果發生錯誤，更新狀態標籤顯示錯誤訊息</span>
        status_label<span class="token punctuation">.</span>config<span class="token punctuation">(</span>text<span class="token operator">=</span><span class="token string">"轉換失敗。錯誤: "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 創建主視窗</span>
root <span class="token operator">=</span> tk<span class="token punctuation">.</span>Tk<span class="token punctuation">(</span><span class="token punctuation">)</span>
root<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"視頻轉換器 (使用 ffmpeg-python)"</span><span class="token punctuation">)</span>

<span class="token comment"># 創建和放置控制項</span>
<span class="token comment"># 輸入檔案部分</span>
tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>root<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"輸入檔案:"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> sticky<span class="token operator">=</span><span class="token string">"e"</span><span class="token punctuation">)</span>
input_entry <span class="token operator">=</span> tk<span class="token punctuation">.</span>Entry<span class="token punctuation">(</span>root<span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span>
input_entry<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
tk<span class="token punctuation">.</span>Button<span class="token punctuation">(</span>root<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"瀏覽"</span><span class="token punctuation">,</span> command<span class="token operator">=</span>select_file<span class="token punctuation">)</span><span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment"># 輸出檔案部分</span>
tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>root<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"輸出檔案:"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> sticky<span class="token operator">=</span><span class="token string">"e"</span><span class="token punctuation">)</span>
output_entry <span class="token operator">=</span> tk<span class="token punctuation">.</span>Entry<span class="token punctuation">(</span>root<span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span>
output_entry<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># 轉換按鈕</span>
convert_button <span class="token operator">=</span> tk<span class="token punctuation">.</span>Button<span class="token punctuation">(</span>root<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">"轉換"</span><span class="token punctuation">,</span> command<span class="token operator">=</span>convert_video<span class="token punctuation">)</span>
convert_button<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># 狀態標籤</span>
status_label <span class="token operator">=</span> tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>root<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span>
status_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># 啟動主循環</span>
root<span class="token punctuation">.</span>mainloop<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="程式碼解析"><a href="#程式碼解析" class="headerlink" title="程式碼解析"></a>程式碼解析</h2><p>讓我們來看看這個應用程式的主要組成部分：</p>
<ol>
<li>導入必要模組：<br>我們導入了 ffmpeg、tkinter 以及 filedialog 和 messagebox。這些模組分別用於視頻處理、創建 GUI 和處理檔案選擇。</li>
<li>檔案選擇功能：<br>select_file() 函數使用 filedialog.askopenfilename() 來開啟檔案選擇對話框，讓使用者可以輕鬆選擇要轉換的視頻檔案。</li>
<li>視頻轉換功能：<br>convert_video() 函數是這個應用程式的核心。它使用 ffmpeg-python 來讀取輸入檔案、設定輸出參數並執行轉換。如果轉換成功，會顯示成功訊息；如果失敗，則顯示錯誤訊息。</li>
<li>創建 GUI：<br>我們使用 tkinter 創建了一個簡單的視窗，包含輸入檔案和輸出檔案的輸入框、瀏覽按鈕、轉換按鈕和狀態標籤。</li>
</ol>
<h2 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h2><ol>
<li>啟動應用程式後，你會看到一個簡單的視窗。</li>
<li>點擊「瀏覽」按鈕選擇要轉換的視頻檔案。</li>
<li>在「輸出檔案」欄位中輸入想要的輸出檔案名稱（記得加上副檔名）。</li>
<li>點擊「轉換」按鈕開始轉換過程。</li>
<li>轉換完成後，狀態標籤會顯示成功或失敗的訊息。</li>
</ol>
<h2 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h2><p>請確保你的系統上已安裝 FFmpeg。<br>這個程式使用了 FFmpeg 的預設參數進行轉換。如果你需要更多自訂選項，可以修改 convert_video() 函數中的 ffmpeg.output() 部分。</p>
<h2 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h2><p>這個簡單的視頻轉換器展示了如何將強大的命令列工具（FFmpeg）與用戶友善的圖形介面結合。雖然這只是一個基礎版本，但你可以根據自己的需求進行擴展，例如增加更多的轉換選項、支援批次處理等。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/09/19/%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E5%88%AA%E9%99%A4%E5%8C%85%E5%90%AB%E6%95%B8%E7%99%BE%E8%90%AC%E6%96%87%E4%BB%B6%E7%9A%84%E8%B3%87%E6%96%99%E5%A4%BE%EF%BC%9AWindows-%E6%89%B9%E6%AC%A1%E6%AA%94%E6%A1%88%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/19/%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E5%88%AA%E9%99%A4%E5%8C%85%E5%90%AB%E6%95%B8%E7%99%BE%E8%90%AC%E6%96%87%E4%BB%B6%E7%9A%84%E8%B3%87%E6%96%99%E5%A4%BE%EF%BC%9AWindows-%E6%89%B9%E6%AC%A1%E6%AA%94%E6%A1%88%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">如何快速刪除包含數百萬文件的資料夾：Windows 批次檔案解決方案</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-09-19 17:14:05" itemprop="dateCreated datePublished" datetime="2024-09-19T17:14:05+08:00">2024-09-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-11-27 14:37:16" itemprop="dateModified" datetime="2024-11-27T14:37:16+08:00">2024-11-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AF%A6%E7%94%A8%E6%8A%80%E5%B7%A7/" itemprop="url" rel="index"><span itemprop="name">實用技巧</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="如何快速刪除包含數百萬文件的資料夾：Windows-批次檔案解決方案"><a href="#如何快速刪除包含數百萬文件的資料夾：Windows-批次檔案解決方案" class="headerlink" title="如何快速刪除包含數百萬文件的資料夾：Windows 批次檔案解決方案"></a>如何快速刪除包含數百萬文件的資料夾：Windows 批次檔案解決方案</h1><p>在日常工作中，我們偶爾會遇到一些看似簡單，實則棘手的問題。最近，我就遇到了這樣一個挑戰：如何刪除一個包含超過兩百萬個文件的資料夾。</p>
<h2 id="問題描述"><a href="#問題描述" class="headerlink" title="問題描述"></a>問題描述</h2><p>我有一個資料夾，裡面累積了超過兩百萬個文件。當我試圖通過 Windows 檔案總管直接刪除這個資料夾時，系統就會卡死，無法完成操作。這是因為 Windows 在處理如此大量的文件時會變得異常緩慢，甚至完全無響應。</p>
<h2 id="解決方案：使用批次檔案"><a href="#解決方案：使用批次檔案" class="headerlink" title="解決方案：使用批次檔案"></a>解決方案：使用批次檔案</h2><p>在嘗試了多種方法後，我發現使用 Windows 批次檔案（.bat）是最有效的解決方案。這種方法不僅能夠處理大量文件，而且速度相當快。</p>
<p>以下是我使用的批次檔案代碼：</p>
<pre class="line-numbers language-batch" data-language="batch"><code class="language-batch"><span class="token operator">@</span><span class="token command"><span class="token keyword">echo</span> off</span>
<span class="token command"><span class="token keyword">setlocal</span> enabledelayedexpansion</span>

<span class="token command"><span class="token keyword">set</span> <span class="token string">"folder_path=%~dp0"</span></span>

<span class="token command"><span class="token keyword">echo</span> 警告：此批次檔案將快速刪除以下資料夾中的所有檔案和子資料夾：</span>
<span class="token command"><span class="token keyword">echo</span> <span class="token variable">%folder_path%</span></span>
<span class="token command"><span class="token keyword">echo</span>.</span>
<span class="token command"><span class="token keyword">echo</span> 請確認這是您想要清空的正確資料夾。</span>
<span class="token command"><span class="token keyword">echo</span> 按 Y 繼續，或按任意其他鍵取消操作。</span>
<span class="token command"><span class="token keyword">set</span> <span class="token parameter attr-name">/p</span> <span class="token variable">confirm</span><span class="token operator">=</span>確認刪除 <span class="token punctuation">(</span>Y<span class="token parameter attr-name">/N</span></span><span class="token punctuation">)</span>? 

<span class="token command"><span class="token keyword">if</span> <span class="token parameter attr-name">/i</span> <span class="token string">"%confirm%"</span> <span class="token operator">neq</span> <span class="token string">"Y"</span></span> <span class="token punctuation">(</span>
    <span class="token command"><span class="token keyword">echo</span> 操作已取消。</span>
    <span class="token command"><span class="token keyword">goto</span> <span class="token label property">:EOF</span></span>
<span class="token punctuation">)</span>

<span class="token command"><span class="token keyword">echo</span>.</span>
<span class="token command"><span class="token keyword">echo</span> 正在快速刪除所有內容，請稍候...</span>

<span class="token command"><span class="token keyword">pushd</span> <span class="token string">"%folder_path%"</span></span>

<span class="token comment">:: 使用 robocopy 來快速清空資料夾</span>
<span class="token command"><span class="token keyword">mkdir</span> empty_temp</span>
<span class="token command"><span class="token keyword">robocopy</span> empty_temp . <span class="token parameter attr-name">/mir</span> <span class="token parameter attr-name">/mt<span class="token punctuation">:</span></span><span class="token number">32</span></span>

<span class="token comment">:: 刪除臨時資料夾</span>
<span class="token command"><span class="token keyword">rmdir</span> empty_temp</span>

<span class="token command"><span class="token keyword">popd</span></span>

<span class="token command"><span class="token keyword">echo</span> 所有內容已被刪除。</span>

<span class="token command"><span class="token keyword">echo</span>.</span>
<span class="token command"><span class="token keyword">echo</span> 按任意鍵退出。</span>
<span class="token command"><span class="token keyword">pause</span> > nul</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="如何使用這個批次檔案"><a href="#如何使用這個批次檔案" class="headerlink" title="如何使用這個批次檔案"></a>如何使用這個批次檔案</h2><ol>
<li>將上面的代碼複製到一個文本編輯器中（如記事本）。</li>
<li>將文件保存為 <code>.bat</code> 格式，例如 <code>fast_delete_all.bat</code>。</li>
<li>將這個 <code>.bat</code> 文件放在你想要清空的資料夾中。</li>
<li>雙擊運行該 <code>.bat</code> 文件。</li>
<li>仔細閱讀警告信息，確認路徑是否正確。</li>
<li>如果確認無誤，輸入 ‘Y’ 並按 Enter 執行刪除操作。</li>
</ol>
<h2 id="為什麼這個方法有效"><a href="#為什麼這個方法有效" class="headerlink" title="為什麼這個方法有效"></a>為什麼這個方法有效</h2><p>這個批次檔案之所以能夠快速處理大量文件，主要是因為它使用了 <code>robocopy</code> 命令。<code>robocopy</code>（Robust File Copy）是 Windows 的一個強大的文件複製工具，但在這裡我們巧妙地用它來”複製”一個空資料夾，從而達到快速清空目標資料夾的效果。</p>
<p><code>/mir</code> 參數使 <code>robocopy</code> 鏡像空資料夾到目標資料夾，實際上刪除了所有內容。而 <code>/mt:32</code> 參數啟用了多線程操作，大大加快了處理速度。</p>
<h2 id="安全提示"><a href="#安全提示" class="headerlink" title="安全提示"></a>安全提示</h2><p>雖然這個方法非常有效，但也請記住：</p>
<ol>
<li>使用前務必仔細檢查要刪除的資料夾路徑是否正確。</li>
<li>這個批次檔案會刪除指定資料夾中的所有內容，包括子資料夾和隱藏文件，請確保你真的想要刪除所有內容。</li>
<li>建議在執行前先備份重要數據。</li>
</ol>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>當面對需要刪除大量文件的情況時，Windows 內建的刪除功能可能會讓你失望。但是，通過使用這個簡單的批次檔案，你可以輕鬆且快速地解決這個問題。這不僅節省了時間，也避免了系統卡死的風險。</p>
<p>希望這個解決方案能幫助到遇到類似問題的朋友。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">kyosora</p>
  <div class="site-description" itemprop="description">個人技術筆記和學習心得分享</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">99</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">分類</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">118</span>
        <span class="site-state-item-name">標籤</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kyosora</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 強力驅動
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
