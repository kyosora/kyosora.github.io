<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"kyosora.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="在 .NET Core + Vue.js 專案中實作 CSRF 防護前言最近在進行安全性掃描時，發現了 CSRF (Cross-Site Request Forgery) 的漏洞。本文將分享如何在 .NET Core Web API 搭配 Vue.js 的專案中實作完整的 CSRF 防護機制，並提供詳細的最佳實作建議。 CSRF 是什麼？CSRF 是一種強迫使用者在他們已經通過身份驗證的網站上執行">
<meta property="og:type" content="article">
<meta property="og:title" content="在 .NET Core + Vue.js 專案中實作 CSRF 防護">
<meta property="og:url" content="https://kyosora.github.io/2024/11/18/cm82ssaaf006ft497bjx0cv6t/index.html">
<meta property="og:site_name" content="kyosora 虛空筆記">
<meta property="og:description" content="在 .NET Core + Vue.js 專案中實作 CSRF 防護前言最近在進行安全性掃描時，發現了 CSRF (Cross-Site Request Forgery) 的漏洞。本文將分享如何在 .NET Core Web API 搭配 Vue.js 的專案中實作完整的 CSRF 防護機制，並提供詳細的最佳實作建議。 CSRF 是什麼？CSRF 是一種強迫使用者在他們已經通過身份驗證的網站上執行">
<meta property="og:locale" content="zh_TW">
<meta property="article:published_time" content="2024-11-18T06:32:51.000Z">
<meta property="article:modified_time" content="2024-11-27T06:46:32.000Z">
<meta property="article:author" content="kyosora">
<meta property="article:tag" content="CSRF">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://kyosora.github.io/2024/11/18/cm82ssaaf006ft497bjx0cv6t/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: {},
    isHome : false,
    isPost : true,
    lang   : 'zh-TW'
  };
</script>

  <title>在 .NET Core + Vue.js 專案中實作 CSRF 防護 | kyosora 虛空筆記</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">kyosora 虛空筆記</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">技術探索與學習分享</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kyosora.github.io/2024/11/18/cm82ssaaf006ft497bjx0cv6t/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kyosora">
      <meta itemprop="description" content="個人技術筆記和學習心得分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyosora 虛空筆記">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          在 .NET Core + Vue.js 專案中實作 CSRF 防護
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-11-18 14:32:51" itemprop="dateCreated datePublished" datetime="2024-11-18T14:32:51+08:00">2024-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-11-27 14:46:32" itemprop="dateModified" datetime="2024-11-27T14:46:32+08:00">2024-11-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%A8%8B%E5%BC%8F%E6%95%99%E5%AD%B8/" itemprop="url" rel="index"><span itemprop="name">程式教學</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="在-NET-Core-Vue-js-專案中實作-CSRF-防護"><a href="#在-NET-Core-Vue-js-專案中實作-CSRF-防護" class="headerlink" title="在 .NET Core + Vue.js 專案中實作 CSRF 防護"></a>在 .NET Core + Vue.js 專案中實作 CSRF 防護</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近在進行安全性掃描時，發現了 CSRF (Cross-Site Request Forgery) 的漏洞。本文將分享如何在 .NET Core Web API 搭配 Vue.js 的專案中實作完整的 CSRF 防護機制，並提供詳細的最佳實作建議。</p>
<h2 id="CSRF-是什麼？"><a href="#CSRF-是什麼？" class="headerlink" title="CSRF 是什麼？"></a>CSRF 是什麼？</h2><p>CSRF 是一種強迫使用者在他們已經通過身份驗證的網站上執行非預期操作的攻擊。</p>
<h3 id="攻擊場景示例"><a href="#攻擊場景示例" class="headerlink" title="攻擊場景示例"></a>攻擊場景示例</h3><p>考慮以下實際場景：</p>
<ol>
<li>使用者登入了網路銀行</li>
<li>同時瀏覽了含有惡意程式碼的網站</li>
<li>惡意網站自動發送請求到網路銀行</li>
<li>由於使用者已登入，請求會帶著有效的 Cookie 執行</li>
</ol>
<h3 id="實際攻擊範例"><a href="#實際攻擊範例" class="headerlink" title="實際攻擊範例"></a>實際攻擊範例</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- 惡意網站的 HTML --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://bank.example.com/transfer<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hack-form<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>amount<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1000000<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>to<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hacker-account<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'hack-form'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 自動提交表單</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="安全性考量"><a href="#安全性考量" class="headerlink" title="安全性考量"></a>安全性考量</h2><h3 id="Cookie-設定說明"><a href="#Cookie-設定說明" class="headerlink" title="Cookie 設定說明"></a>Cookie 設定說明</h3><ol>
<li><p><strong>SameSite 設定</strong></p>
<ul>
<li><code>Strict</code>: 最嚴格的設定，僅允許來自同一網站的請求</li>
<li><code>Lax</code>: 較寬鬆的設定，允許部分跨站請求（如連結點擊）</li>
<li>建議使用 <code>Strict</code> 以提供最高安全性</li>
</ul>
</li>
<li><p><strong>HttpOnly 與 CSRF Token</strong></p>
<ul>
<li>CSRF Token Cookie 需設定 <code>HttpOnly = false</code></li>
<li>原因：前端 JavaScript 需要讀取 Token 值</li>
<li>其他敏感 Cookie 應設定 <code>HttpOnly = true</code></li>
</ul>
</li>
<li><p><strong>Token 生命週期管理</strong></p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAntiforgery</span><span class="token punctuation">(</span>options <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    options<span class="token punctuation">.</span>Cookie<span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">"X-CSRF-TOKEN"</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>Cookie<span class="token punctuation">.</span>SecurePolicy <span class="token operator">=</span> CookieSecurePolicy<span class="token punctuation">.</span>Always<span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>Cookie<span class="token punctuation">.</span>HttpOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>Cookie<span class="token punctuation">.</span>SameSite <span class="token operator">=</span> SameSiteMode<span class="token punctuation">.</span>Strict<span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>HeaderName <span class="token operator">=</span> <span class="token string">"X-XSRF-TOKEN"</span><span class="token punctuation">;</span>
    <span class="token comment">// 設定 Token 過期時間</span>
    options<span class="token punctuation">.</span>ExpireTimeSpan <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromHours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h2 id="NET-Core-的設定"><a href="#NET-Core-的設定" class="headerlink" title=".NET Core 的設定"></a>.NET Core 的設定</h2><h3 id="1-Program-cs-配置"><a href="#1-Program-cs-配置" class="headerlink" title="1. Program.cs 配置"></a>1. Program.cs 配置</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 加入 Antiforgery 服務</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAntiforgery</span><span class="token punctuation">(</span>options <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    options<span class="token punctuation">.</span>Cookie<span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">"X-CSRF-TOKEN"</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>Cookie<span class="token punctuation">.</span>SecurePolicy <span class="token operator">=</span> CookieSecurePolicy<span class="token punctuation">.</span>Always<span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>Cookie<span class="token punctuation">.</span>HttpOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>Cookie<span class="token punctuation">.</span>SameSite <span class="token operator">=</span> SameSiteMode<span class="token punctuation">.</span>Strict<span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>HeaderName <span class="token operator">=</span> <span class="token string">"X-XSRF-TOKEN"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 配置 CORS</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddCors</span><span class="token punctuation">(</span>options <span class="token operator">=></span>
<span class="token punctuation">&#123;</span>
    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"VueCorsPolicy"</span><span class="token punctuation">,</span> policy <span class="token operator">=></span>
    <span class="token punctuation">&#123;</span>
        policy<span class="token punctuation">.</span><span class="token function">WithOrigins</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080"</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span><span class="token function">AllowCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span><span class="token function">AllowAnyHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span><span class="token function">AllowAnyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-CSRF-Token-中介軟體"><a href="#2-CSRF-Token-中介軟體" class="headerlink" title="2. CSRF Token 中介軟體"></a>2. CSRF Token 中介軟體</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Middleware/Csrf/CsrfTokenMiddleware.cs</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CsrfTokenMiddleware</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">RequestDelegate</span> _next<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IAntiforgery</span> _antiforgery<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>CsrfTokenMiddleware<span class="token punctuation">></span></span> _logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">CsrfTokenMiddleware</span><span class="token punctuation">(</span>
        <span class="token class-name">RequestDelegate</span> next<span class="token punctuation">,</span>
        <span class="token class-name">IAntiforgery</span> antiforgery<span class="token punctuation">,</span>
        <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>CsrfTokenMiddleware<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _next <span class="token operator">=</span> next<span class="token punctuation">;</span>
        _antiforgery <span class="token operator">=</span> antiforgery<span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// 只為 GET 請求生成新的 Token</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Method <span class="token operator">==</span> <span class="token string">"GET"</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token comment">// 生成 Token 並存入 Cookie</span>
                <span class="token class-name"><span class="token keyword">var</span></span> tokens <span class="token operator">=</span> _antiforgery<span class="token punctuation">.</span><span class="token function">GetAndStoreTokens</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
                context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Cookies<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token string">"X-CSRF-TOKEN"</span><span class="token punctuation">,</span> 
                    tokens<span class="token punctuation">.</span>RequestToken<span class="token punctuation">,</span> 
                    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CookieOptions</span>
                    <span class="token punctuation">&#123;</span>
                        HttpOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        Secure <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                        SameSite <span class="token operator">=</span> SameSiteMode<span class="token punctuation">.</span>Strict<span class="token punctuation">,</span>
                        <span class="token comment">// 設定 Cookie 過期時間</span>
                        Expires <span class="token operator">=</span> DateTimeOffset<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddHours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"CSRF Token generation failed: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">ex<span class="token punctuation">.</span>Message</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 不要在生產環境回傳詳細錯誤訊息</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"Security token generation failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">await</span> <span class="token function">_next</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-自訂驗證-Attribute"><a href="#3-自訂驗證-Attribute" class="headerlink" title="3. 自訂驗證 Attribute"></a>3. 自訂驗證 Attribute</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Attributes/Csrf/ValidateCsrfTokenAttribute.cs</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ValidateCsrfTokenAttribute</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">TypeFilterAttribute</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token function">ValidateCsrfTokenAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">CsrfTokenFilter</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">CsrfTokenFilter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAsyncActionFilter</span></span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IAntiforgery</span> _antiforgery<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>CsrfTokenFilter<span class="token punctuation">></span></span> _logger<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">CsrfTokenFilter</span><span class="token punctuation">(</span>
            <span class="token class-name">IAntiforgery</span> antiforgery<span class="token punctuation">,</span>
            <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>CsrfTokenFilter<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            _antiforgery <span class="token operator">=</span> antiforgery<span class="token punctuation">;</span>
            _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">OnActionExecutionAsync</span><span class="token punctuation">(</span>
            <span class="token class-name">ActionExecutingContext</span> context<span class="token punctuation">,</span>
            <span class="token class-name">ActionExecutionDelegate</span> next<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">await</span> _antiforgery<span class="token punctuation">.</span><span class="token function">ValidateRequestAsync</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AntiforgeryValidationException</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                _logger<span class="token punctuation">.</span><span class="token function">LogWarning</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"CSRF validation failed: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">ex<span class="token punctuation">.</span>Message</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 記錄詳細資訊以便調試</span>
                _logger<span class="token punctuation">.</span><span class="token function">LogDebug</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Request headers: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp"><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">", "</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Headers<span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                context<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BadRequestObjectResult</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token punctuation">&#123;</span> error <span class="token operator">=</span> <span class="token string">"Invalid security token"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-API-Controller-實作"><a href="#4-API-Controller-實作" class="headerlink" title="4. API Controller 實作"></a>4. API Controller 實作</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Controllers/UsersController.cs</span>
<span class="token punctuation">[</span>ApiController<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api/[controller]"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UsersController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IUserService</span> _userService<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>UsersController<span class="token punctuation">></span></span> _logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">UsersController</span><span class="token punctuation">(</span>
        <span class="token class-name">IUserService</span> userService<span class="token punctuation">,</span>
        <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>UsersController<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _userService <span class="token operator">=</span> userService<span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ValidateCsrfToken</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IActionResult<span class="token punctuation">></span></span> <span class="token function">CreateUser</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span> <span class="token class-name">CreateUserRequest</span> request<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _userService<span class="token punctuation">.</span><span class="token function">CreateUserAsync</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Create user failed: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">ex<span class="token punctuation">.</span>Message</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">BadRequest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">&#123;</span> error <span class="token operator">=</span> <span class="token string">"Failed to create user"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 檔案上傳的特殊處理</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"upload"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ValidateCsrfToken</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">RequestSizeLimit</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">100_000_000</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> <span class="token comment">// 100MB 限制</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IActionResult<span class="token punctuation">></span></span> <span class="token function">UploadFile</span><span class="token punctuation">(</span><span class="token class-name">IFormFile</span> file<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 實作檔案上傳邏輯</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Vue-js-的設定"><a href="#Vue-js-的設定" class="headerlink" title="Vue.js 的設定"></a>Vue.js 的設定</h2><h3 id="1-Axios-實例配置"><a href="#1-Axios-實例配置" class="headerlink" title="1. Axios 實例配置"></a>1. Axios 實例配置</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// src/api/axios.js</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> handleApiError <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@/utils/errorHandler'</span><span class="token punctuation">;</span>

<span class="token comment">// 建立 axios 實例</span>
<span class="token keyword">const</span> api <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token literal-property property">baseURL</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_APP_API_URL</span><span class="token punctuation">,</span>
    <span class="token literal-property property">withCredentials</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 請求攔截器</span>
api<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
    <span class="token parameter">config</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> token <span class="token operator">=</span> document<span class="token punctuation">.</span>cookie
            <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'; '</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">row</span> <span class="token operator">=></span> row<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'X-CSRF-TOKEN='</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">?.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            config<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'X-XSRF-TOKEN'</span><span class="token punctuation">]</span> <span class="token operator">=</span> token<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'CSRF token not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> config<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Request error:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 響應攔截器</span>
api<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
    <span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">,</span>
    <span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>response<span class="token operator">?.</span>status <span class="token operator">===</span> <span class="token number">400</span> <span class="token operator">&amp;&amp;</span> 
            error<span class="token punctuation">.</span>response<span class="token operator">?.</span>data<span class="token operator">?.</span>error<span class="token operator">?.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'security token'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 處理 CSRF 錯誤</span>
            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Security token validation failed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 重新整理 token</span>
            window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token function">handleApiError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> api<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-Vue-元件實作"><a href="#2-Vue-元件實作" class="headerlink" title="2. Vue 元件實作"></a>2. Vue 元件實作</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// src/components/UserForm.vue</span>
<span class="token operator">&lt;</span>template<span class="token operator">></span>
  <span class="token operator">&lt;</span>form @submit<span class="token punctuation">.</span>prevent<span class="token operator">=</span><span class="token string">"submitForm"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"user-form"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>div v<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">"error"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"error-message"</span><span class="token operator">></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> error <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token operator">&lt;</span>input 
      v<span class="token operator">-</span>model<span class="token operator">=</span><span class="token string">"form.username"</span> 
      placeholder<span class="token operator">=</span><span class="token string">"使用者名稱"</span>
      required 
    <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>input 
      v<span class="token operator">-</span>model<span class="token operator">=</span><span class="token string">"form.email"</span> 
      type<span class="token operator">=</span><span class="token string">"email"</span>
      placeholder<span class="token operator">=</span><span class="token string">"電子郵件"</span>
      required 
    <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>button type<span class="token operator">=</span><span class="token string">"submit"</span> <span class="token operator">:</span>disabled<span class="token operator">=</span><span class="token string">"loading"</span><span class="token operator">></span>
      <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> loading <span class="token operator">?</span> <span class="token string">'處理中...'</span> <span class="token operator">:</span> <span class="token string">'建立使用者'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span>

<span class="token operator">&lt;</span>script<span class="token operator">></span>
<span class="token keyword">import</span> api <span class="token keyword">from</span> <span class="token string">'@/api/axios'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'UserForm'</span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">form</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        <span class="token literal-property property">email</span><span class="token operator">:</span> <span class="token string">''</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">loading</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">async</span> <span class="token function">submitForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      
      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/users'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>form<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'user-created'</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>error <span class="token operator">=</span> error<span class="token punctuation">.</span>response<span class="token operator">?.</span>data<span class="token operator">?.</span>error <span class="token operator">||</span> <span class="token string">'建立使用者失敗'</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token function">resetForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>form<span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>form<span class="token punctuation">.</span>email <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-錯誤處理"><a href="#3-錯誤處理" class="headerlink" title="3. 錯誤處理"></a>3. 錯誤處理</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// src/utils/errorHandler.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">handleApiError</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>response<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> <span class="token number">400</span><span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>error<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'security token'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// CSRF 錯誤處理</span>
                    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Security token validation failed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 觸發重新整理 token 的邏輯</span>
                    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">401</span><span class="token operator">:</span>
                <span class="token comment">// 處理未授權錯誤</span>
                router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">403</span><span class="token operator">:</span>
                <span class="token comment">// 處理權限錯誤</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment">// 處理其他錯誤</span>
                console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'API Error:'</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>response<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 請求已發送但未收到回應</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'No response received:'</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 請求配置錯誤</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Request error:'</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="測試相關"><a href="#測試相關" class="headerlink" title="測試相關"></a>測試相關</h2><h3 id="1-單元測試範例"><a href="#1-單元測試範例" class="headerlink" title="1. 單元測試範例"></a>1. 單元測試範例</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Tests/CsrfTokenMiddlewareTests.cs</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CsrfTokenMiddlewareTests</span>
<span class="token punctuation">&#123;</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Fact</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Should_Add_Csrf_Token_For_Get_Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// Arrange</span>
        <span class="token class-name"><span class="token keyword">var</span></span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DefaultHttpContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Method <span class="token operator">=</span> <span class="token string">"GET"</span><span class="token punctuation">;</span>
        
        <span class="token class-name"><span class="token keyword">var</span></span> antiforgery <span class="token operator">=</span> Mock<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Of</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IAntiforgery<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> logger <span class="token operator">=</span> Mock<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Of</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ILogger<span class="token punctuation">&lt;</span>CsrfTokenMiddleware<span class="token punctuation">></span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name"><span class="token keyword">var</span></span> middleware <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CsrfTokenMiddleware</span><span class="token punctuation">(</span>
            <span class="token named-parameter punctuation">next</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>innerContext<span class="token punctuation">)</span> <span class="token operator">=></span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">antiforgery</span><span class="token punctuation">:</span> antiforgery<span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">logger</span><span class="token punctuation">:</span> logger
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Act</span>
        <span class="token keyword">await</span> middleware<span class="token punctuation">.</span><span class="token function">InvokeAsync</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Assert</span>
        Assert<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>
            context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span>SetCookie<span class="token punctuation">,</span>
            cookie <span class="token operator">=></span> cookie<span class="token punctuation">.</span><span class="token function">StartsWith</span><span class="token punctuation">(</span><span class="token string">"X-CSRF-TOKEN"</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-整合測試範例"><a href="#2-整合測試範例" class="headerlink" title="2. 整合測試範例"></a>2. 整合測試範例</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Tests/Integration/UserControllerTests.cs</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserControllerTests</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IClassFixture<span class="token punctuation">&lt;</span>WebApplicationFactory<span class="token punctuation">&lt;</span>Program<span class="token punctuation">></span><span class="token punctuation">></span></span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">WebApplicationFactory<span class="token punctuation">&lt;</span>Program<span class="token punctuation">></span></span> _factory<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">UserControllerTests</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationFactory<span class="token punctuation">&lt;</span>Program<span class="token punctuation">></span></span> factory<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _factory <span class="token operator">=</span> factory<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Fact</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Should_Reject_Request_Without_Csrf_Token</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// Arrange</span>
        <span class="token class-name"><span class="token keyword">var</span></span> client <span class="token operator">=</span> _factory<span class="token punctuation">.</span><span class="token function">CreateClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CreateUserRequest</span>
        <span class="token punctuation">&#123;</span>
            Username <span class="token operator">=</span> <span class="token string">"test"</span><span class="token punctuation">,</span>
            Email <span class="token operator">=</span> <span class="token string">"test@example.com"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token comment">// Act</span>
        <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">PostAsJsonAsync</span><span class="token punctuation">(</span><span class="token string">"/api/users"</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Assert</span>
        Assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>HttpStatusCode<span class="token punctuation">.</span>BadRequest<span class="token punctuation">,</span> response<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="效能最佳化"><a href="#效能最佳化" class="headerlink" title="效能最佳化"></a>效能最佳化</h2><h3 id="1-Token-快取策略"><a href="#1-Token-快取策略" class="headerlink" title="1. Token 快取策略"></a>1. Token 快取策略</h3><ul>
<li>使用 HTTP Cache Headers 來快取 GET 請求的 Token</li>
<li>實作 Token 重用機制，避免每次請求都生成新 Token</li>
<li>適當設定 Token 過期時間，平衡安全性和使用者體驗</li>
</ul>
<h3 id="2-多頁面應用的處理"><a href="#2-多頁面應用的處理" class="headerlink" title="2. 多頁面應用的處理"></a>2. 多頁面應用的處理</h3><ul>
<li>使用 LocalStorage 暫存 Token（注意安全風險）</li>
<li>實作 Token 重新整理機制</li>
<li>處理頁面切換時的 Token 同步</li>
</ul>
<h2 id="常見問題排除"><a href="#常見問題排除" class="headerlink" title="常見問題排除"></a>常見問題排除</h2><h3 id="1-Token-驗證失敗"><a href="#1-Token-驗證失敗" class="headerlink" title="1. Token 驗證失敗"></a>1. Token 驗證失敗</h3><ul>
<li><strong>常見原因</strong>：<ul>
<li>Cookie 設定不正確</li>
<li>跨域設定問題</li>
<li>Token 過期</li>
<li>請求標頭缺失</li>
</ul>
</li>
<li><strong>診斷步驟</strong>：<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 在瀏覽器控制台檢查 Cookie</span>
document<span class="token punctuation">.</span>cookie<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'; '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cookie</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cookie<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'X-CSRF-TOKEN='</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Found CSRF token:'</span><span class="token punctuation">,</span> cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 檢查請求標頭</span>
axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">request</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Request headers:'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> request<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h3 id="2-跨域問題解決"><a href="#2-跨域問題解決" class="headerlink" title="2. 跨域問題解決"></a>2. 跨域問題解決</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// 完整的 CORS 配置</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddCors</span><span class="token punctuation">(</span>options <span class="token operator">=></span>
<span class="token punctuation">&#123;</span>
    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"VueCorsPolicy"</span><span class="token punctuation">,</span> policy <span class="token operator">=></span>
    <span class="token punctuation">&#123;</span>
        policy<span class="token punctuation">.</span><span class="token function">WithOrigins</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080"</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span><span class="token function">AllowCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span><span class="token function">AllowAnyHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span><span class="token function">AllowAnyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span><span class="token function">WithExposedHeaders</span><span class="token punctuation">(</span><span class="token string">"X-CSRF-TOKEN"</span><span class="token punctuation">)</span>
             <span class="token comment">// 如果有其他自訂標頭也需要在這裡設定</span>
             <span class="token punctuation">.</span><span class="token function">SetIsOriginAllowed</span><span class="token punctuation">(</span>origin <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                 <span class="token comment">// 在開發環境允許本地測試</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>builder<span class="token punctuation">.</span>Environment<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                 <span class="token punctuation">&#123;</span>
                     <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                 <span class="token punctuation">&#125;</span>
                 <span class="token comment">// 在正式環境只允許特定來源</span>
                 <span class="token keyword">return</span> origin<span class="token punctuation">.</span><span class="token function">EndsWith</span><span class="token punctuation">(</span><span class="token string">"yoursite.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-特殊請求處理"><a href="#3-特殊請求處理" class="headerlink" title="3. 特殊請求處理"></a>3. 特殊請求處理</h3><h4 id="WebSocket-連接的-CSRF-防護"><a href="#WebSocket-連接的-CSRF-防護" class="headerlink" title="WebSocket 連接的 CSRF 防護"></a>WebSocket 連接的 CSRF 防護</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// WebSocket 連接範例</span>
<span class="token keyword">const</span> <span class="token function-variable function">connectWebSocket</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> document<span class="token punctuation">.</span>cookie
        <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'; '</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">row</span> <span class="token operator">=></span> row<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'X-CSRF-TOKEN='</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">?.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">wss://api.example.com/ws?csrf=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'WebSocket connected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    
    ws<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'WebSocket error:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> ws<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="檔案上傳處理"><a href="#檔案上傳處理" class="headerlink" title="檔案上傳處理"></a>檔案上傳處理</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 檔案上傳元件</span>
<span class="token comment">// src/components/FileUpload.vue</span>
<span class="token operator">&lt;</span>template<span class="token operator">></span>
  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"file-upload"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>input 
      type<span class="token operator">=</span><span class="token string">"file"</span> 
      @change<span class="token operator">=</span><span class="token string">"handleFileChange"</span>
      <span class="token operator">:</span>accept<span class="token operator">=</span><span class="token string">"acceptTypes"</span>
    <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>div v<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">"progress"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"progress"</span><span class="token operator">></span>
      <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> progress <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token operator">%</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span>

<span class="token operator">&lt;</span>script<span class="token operator">></span>
<span class="token keyword">import</span> api <span class="token keyword">from</span> <span class="token string">'@/api/axios'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'FileUpload'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">acceptTypes</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">'*/*'</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">progress</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">async</span> <span class="token function">handleFileChange</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> file <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/users/upload'</span><span class="token punctuation">,</span> formData<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
          <span class="token function-variable function">onUploadProgress</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">progressEvent</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>progress <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>
              <span class="token punctuation">(</span>progressEvent<span class="token punctuation">.</span>loaded <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> progressEvent<span class="token punctuation">.</span>total
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'upload-complete'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Upload failed:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'upload-error'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="安全性最佳實作"><a href="#安全性最佳實作" class="headerlink" title="安全性最佳實作"></a>安全性最佳實作</h2><h3 id="1-正式環境配置"><a href="#1-正式環境配置" class="headerlink" title="1. 正式環境配置"></a>1. 正式環境配置</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// 生產環境的額外安全配置</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureProductionServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    services<span class="token punctuation">.</span><span class="token function">AddAntiforgery</span><span class="token punctuation">(</span>options <span class="token operator">=></span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 強制使用 HTTPS</span>
        options<span class="token punctuation">.</span>Cookie<span class="token punctuation">.</span>SecurePolicy <span class="token operator">=</span> CookieSecurePolicy<span class="token punctuation">.</span>Always<span class="token punctuation">;</span>
        
        <span class="token comment">// 設定較短的過期時間</span>
        options<span class="token punctuation">.</span>ExpireTimeSpan <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 啟用額外的安全標頭</span>
        options<span class="token punctuation">.</span>Cookie<span class="token punctuation">.</span>HttpOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>Cookie<span class="token punctuation">.</span>SameSite <span class="token operator">=</span> SameSiteMode<span class="token punctuation">.</span>Strict<span class="token punctuation">;</span>
        
        <span class="token comment">// 使用強隨機數生成器</span>
        options<span class="token punctuation">.</span>RandomKey <span class="token operator">=</span> RandomNumberGenerator<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-安全標頭配置"><a href="#2-安全標頭配置" class="headerlink" title="2. 安全標頭配置"></a>2. 安全標頭配置</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// 加入安全標頭中介軟體</span>
app<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=></span>
<span class="token punctuation">&#123;</span>
    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>
        <span class="token string">"X-Content-Type-Options"</span><span class="token punctuation">,</span> <span class="token string">"nosniff"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>
        <span class="token string">"X-Frame-Options"</span><span class="token punctuation">,</span> <span class="token string">"DENY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>
        <span class="token string">"X-XSS-Protection"</span><span class="token punctuation">,</span> <span class="token string">"1; mode=block"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>
        <span class="token string">"Referrer-Policy"</span><span class="token punctuation">,</span> <span class="token string">"strict-origin-when-cross-origin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-監控與日誌"><a href="#3-監控與日誌" class="headerlink" title="3. 監控與日誌"></a>3. 監控與日誌</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// 安全事件日誌服務</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityEventLogger</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>SecurityEventLogger<span class="token punctuation">></span></span> _logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">SecurityEventLogger</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&lt;</span>SecurityEventLogger<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">LogCsrfValidationFailure</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> logEvent <span class="token operator">=</span> <span class="token keyword">new</span>
        <span class="token punctuation">&#123;</span>
            Timestamp <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span>
            IP <span class="token operator">=</span> context<span class="token punctuation">.</span>Connection<span class="token punctuation">.</span>RemoteIpAddress<span class="token punctuation">?.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Path <span class="token operator">=</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Path<span class="token punctuation">,</span>
            Headers <span class="token operator">=</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Headers
                <span class="token punctuation">.</span><span class="token function">ToDictionary</span><span class="token punctuation">(</span>h <span class="token operator">=></span> h<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> h <span class="token operator">=></span> h<span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        _logger<span class="token punctuation">.</span><span class="token function">LogWarning</span><span class="token punctuation">(</span>
            <span class="token string">"CSRF validation failed: &#123;@LogEvent&#125;"</span><span class="token punctuation">,</span> logEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="效能優化建議"><a href="#效能優化建議" class="headerlink" title="效能優化建議"></a>效能優化建議</h2><h3 id="1-Token-管理優化"><a href="#1-Token-管理優化" class="headerlink" title="1. Token 管理優化"></a>1. Token 管理優化</h3><ul>
<li>使用分散式快取（如 Redis）存儲 Token</li>
<li>實作 Token 輪換機制</li>
<li>使用記憶體快取減少資料庫查詢</li>
</ul>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Token 快取服務</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenCacheService</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IDistributedCache</span> _cache<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>TokenCacheService<span class="token punctuation">></span></span> _logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">TokenCacheService</span><span class="token punctuation">(</span>
        <span class="token class-name">IDistributedCache</span> cache<span class="token punctuation">,</span>
        <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>TokenCacheService<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _cache <span class="token operator">=</span> cache<span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span> <span class="token function">GetOrCreateTokenAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> key<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> <span class="token keyword">await</span> _cache<span class="token punctuation">.</span><span class="token function">GetStringAsync</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            token <span class="token operator">=</span> <span class="token function">GenerateNewToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> _cache<span class="token punctuation">.</span><span class="token function">SetStringAsync</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> token<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DistributedCacheEntryOptions</span>
                <span class="token punctuation">&#123;</span>
                    AbsoluteExpirationRelativeToNow <span class="token operator">=</span> 
                        TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> token<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GenerateNewToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> randomBytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> rng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RNGCryptoServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            rng<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>randomBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> Convert<span class="token punctuation">.</span><span class="token function">ToBase64String</span><span class="token punctuation">(</span>randomBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="相關資源與參考"><a href="#相關資源與參考" class="headerlink" title="相關資源與參考"></a>相關資源與參考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/aspnet/core/security/anti-request-forgery">ASP.NET Core 防範跨站請求偽造攻擊</a></li>
<li><a target="_blank" rel="noopener" href="https://vuejs.org/guide/best-practices/security.html">Vue.js 安全性最佳實作</a></li>
<li><a target="_blank" rel="noopener" href="https://owasp.org/www-community/attacks/csrf">OWASP CSRF 防護指南</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/Security">MDN Web 安全性指南</a></li>
</ul>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>實作 CSRF 防護是 Web 應用程式安全性的重要一環。通過本文介紹的實作方式，您可以：</p>
<ol>
<li>建立完整的 CSRF 防護機制</li>
<li>正確處理各種特殊情況</li>
<li>實作適當的錯誤處理</li>
<li>優化效能與使用者體驗</li>
</ol>
<p>記住，安全性是一個持續的過程，需要定期檢視和更新您的防護機制。建議定期進行安全性稽核，並持續關注最新的安全性最佳實作建議。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/CSRF/" rel="tag"># CSRF</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/11/07/cm82ssa8b001bt4970a2ifntb/" rel="prev" title="Hexo 圖片外掛套件使用教學與踩雷指南">
      <i class="fa fa-chevron-left"></i> Hexo 圖片外掛套件使用教學與踩雷指南
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/11/20/cm82ssa7p0005t497gj370q0d/" rel="next" title="API 介面限流完整技術指南">
      API 介面限流完整技術指南 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9C%A8-NET-Core-Vue-js-%E5%B0%88%E6%A1%88%E4%B8%AD%E5%AF%A6%E4%BD%9C-CSRF-%E9%98%B2%E8%AD%B7"><span class="nav-number">1.</span> <span class="nav-text">在 .NET Core + Vue.js 專案中實作 CSRF 防護</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CSRF-%E6%98%AF%E4%BB%80%E9%BA%BC%EF%BC%9F"><span class="nav-number">1.2.</span> <span class="nav-text">CSRF 是什麼？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%BB%E6%93%8A%E5%A0%B4%E6%99%AF%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.2.1.</span> <span class="nav-text">攻擊場景示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%A6%E9%9A%9B%E6%94%BB%E6%93%8A%E7%AF%84%E4%BE%8B"><span class="nav-number">1.2.2.</span> <span class="nav-text">實際攻擊範例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E6%80%A7%E8%80%83%E9%87%8F"><span class="nav-number">1.3.</span> <span class="nav-text">安全性考量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Cookie-%E8%A8%AD%E5%AE%9A%E8%AA%AA%E6%98%8E"><span class="nav-number">1.3.1.</span> <span class="nav-text">Cookie 設定說明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NET-Core-%E7%9A%84%E8%A8%AD%E5%AE%9A"><span class="nav-number">1.4.</span> <span class="nav-text">.NET Core 的設定</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Program-cs-%E9%85%8D%E7%BD%AE"><span class="nav-number">1.4.1.</span> <span class="nav-text">1. Program.cs 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-CSRF-Token-%E4%B8%AD%E4%BB%8B%E8%BB%9F%E9%AB%94"><span class="nav-number">1.4.2.</span> <span class="nav-text">2. CSRF Token 中介軟體</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%87%AA%E8%A8%82%E9%A9%97%E8%AD%89-Attribute"><span class="nav-number">1.4.3.</span> <span class="nav-text">3. 自訂驗證 Attribute</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-API-Controller-%E5%AF%A6%E4%BD%9C"><span class="nav-number">1.4.4.</span> <span class="nav-text">4. API Controller 實作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vue-js-%E7%9A%84%E8%A8%AD%E5%AE%9A"><span class="nav-number">1.5.</span> <span class="nav-text">Vue.js 的設定</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Axios-%E5%AF%A6%E4%BE%8B%E9%85%8D%E7%BD%AE"><span class="nav-number">1.5.1.</span> <span class="nav-text">1. Axios 實例配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Vue-%E5%85%83%E4%BB%B6%E5%AF%A6%E4%BD%9C"><span class="nav-number">1.5.2.</span> <span class="nav-text">2. Vue 元件實作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E9%8C%AF%E8%AA%A4%E8%99%95%E7%90%86"><span class="nav-number">1.5.3.</span> <span class="nav-text">3. 錯誤處理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%AC%E8%A9%A6%E7%9B%B8%E9%97%9C"><span class="nav-number">1.6.</span> <span class="nav-text">測試相關</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%96%AE%E5%85%83%E6%B8%AC%E8%A9%A6%E7%AF%84%E4%BE%8B"><span class="nav-number">1.6.1.</span> <span class="nav-text">1. 單元測試範例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%95%B4%E5%90%88%E6%B8%AC%E8%A9%A6%E7%AF%84%E4%BE%8B"><span class="nav-number">1.6.2.</span> <span class="nav-text">2. 整合測試範例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%88%E8%83%BD%E6%9C%80%E4%BD%B3%E5%8C%96"><span class="nav-number">1.7.</span> <span class="nav-text">效能最佳化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Token-%E5%BF%AB%E5%8F%96%E7%AD%96%E7%95%A5"><span class="nav-number">1.7.1.</span> <span class="nav-text">1. Token 快取策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%A4%9A%E9%A0%81%E9%9D%A2%E6%87%89%E7%94%A8%E7%9A%84%E8%99%95%E7%90%86"><span class="nav-number">1.7.2.</span> <span class="nav-text">2. 多頁面應用的處理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A6%8B%E5%95%8F%E9%A1%8C%E6%8E%92%E9%99%A4"><span class="nav-number">1.8.</span> <span class="nav-text">常見問題排除</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Token-%E9%A9%97%E8%AD%89%E5%A4%B1%E6%95%97"><span class="nav-number">1.8.1.</span> <span class="nav-text">1. Token 驗證失敗</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%B7%A8%E5%9F%9F%E5%95%8F%E9%A1%8C%E8%A7%A3%E6%B1%BA"><span class="nav-number">1.8.2.</span> <span class="nav-text">2. 跨域問題解決</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%89%B9%E6%AE%8A%E8%AB%8B%E6%B1%82%E8%99%95%E7%90%86"><span class="nav-number">1.8.3.</span> <span class="nav-text">3. 特殊請求處理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#WebSocket-%E9%80%A3%E6%8E%A5%E7%9A%84-CSRF-%E9%98%B2%E8%AD%B7"><span class="nav-number">1.8.3.1.</span> <span class="nav-text">WebSocket 連接的 CSRF 防護</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AA%94%E6%A1%88%E4%B8%8A%E5%82%B3%E8%99%95%E7%90%86"><span class="nav-number">1.8.3.2.</span> <span class="nav-text">檔案上傳處理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E6%80%A7%E6%9C%80%E4%BD%B3%E5%AF%A6%E4%BD%9C"><span class="nav-number">1.9.</span> <span class="nav-text">安全性最佳實作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%AD%A3%E5%BC%8F%E7%92%B0%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="nav-number">1.9.1.</span> <span class="nav-text">1. 正式環境配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%AE%89%E5%85%A8%E6%A8%99%E9%A0%AD%E9%85%8D%E7%BD%AE"><span class="nav-number">1.9.2.</span> <span class="nav-text">2. 安全標頭配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%9B%A3%E6%8E%A7%E8%88%87%E6%97%A5%E8%AA%8C"><span class="nav-number">1.9.3.</span> <span class="nav-text">3. 監控與日誌</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%88%E8%83%BD%E5%84%AA%E5%8C%96%E5%BB%BA%E8%AD%B0"><span class="nav-number">1.10.</span> <span class="nav-text">效能優化建議</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Token-%E7%AE%A1%E7%90%86%E5%84%AA%E5%8C%96"><span class="nav-number">1.10.1.</span> <span class="nav-text">1. Token 管理優化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B8%E9%97%9C%E8%B3%87%E6%BA%90%E8%88%87%E5%8F%83%E8%80%83"><span class="nav-number">1.11.</span> <span class="nav-text">相關資源與參考</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B5%90%E8%AB%96"><span class="nav-number">1.12.</span> <span class="nav-text">結論</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">kyosora</p>
  <div class="site-description" itemprop="description">個人技術筆記和學習心得分享</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">99</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">分類</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">118</span>
        <span class="site-state-item-name">標籤</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kyosora</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 強力驅動
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
